cscope 15 $HOME/nvmev-mi               0000425893
	@admin.c

3 
	~"nvmev.h
"

4 
	~"cÚv_ál.h
"

5 
	~"zns_ál.h
"

7 
	#sq_’Œy
(
’Œy_id
) \

8 
queue
->
nvme_sq
[
	`SQ_ENTRY_TO_PAGE_NUM
(
’Œy_id
)][
	`SQ_ENTRY_TO_PAGE_OFFSET
ÓÁry_id)]

	)

9 
	#cq_’Œy
(
’Œy_id
) \

10 
queue
->
nvme_cq
[
	`CQ_ENTRY_TO_PAGE_NUM
(
’Œy_id
)][
	`CQ_ENTRY_TO_PAGE_OFFSET
ÓÁry_id)]

	)

12 
	#´p_add»ss_off£t
(
´p
, 
off£t
) \

13 (
	`·ge_add»ss
(
	`pâ_to_·ge
(
´p
 >> 
PAGE_SHIFT
è+ 
off£t
è+ (´°& ~
PAGE_MASK
))

	)

14 
	#´p_add»ss
(
´p
è
	`´p_add»ss_off£t
Õ½, 0)

	)

16 
	$__make_cq_’Œy_»suÉs
(
eid
, 
u16
 
»t
, 
u32
 
»suÉ0
, u32 
»suÉ1
,

17 
nvmev_dev
 *
nvmev_vdev
)

19 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

20 
nvme_commÚ_commªd
 *
cmd
 = &
	`sq_’Œy
(
eid
).
commÚ
;

21 
cq_h—d
 = 
queue
->cq_head;

23 
	`cq_’Œy
(
cq_h—d
èð(
nvme_com¶‘iÚ
){

24 .
commªd_id
 = 
cmd
->command_id,

25 .
sq_id
 = 0,

26 .
sq_h—d
 = 
eid
,

27 .
»suÉ0
 =„esult0,

28 .
»suÉ1
 =„esult1,

29 .
¡©us
 = 
queue
->
pha£
 | (
»t
 << 1),

32 ià(++
cq_h—d
 =ð
queue
->
cq_d•th
) {

33 
cq_h—d
 = 0;

34 
queue
->
pha£
 = !queue->phase;

36 
queue
->
cq_h—d
 = cq_head;

37 
	}
}

39 
	$__make_cq_’Œy
(
eid
, 
u16
 
»t
, 
nvmev_dev
 *
nvmev_vdev
)

41 
	`__make_cq_’Œy_»suÉs
(
eid
, 
»t
, 0, 0, 
nvmev_vdev
);

42 
	}
}

47 
	$__nvmev_admš_ü—‹_cq
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

49 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

50 
nvmev_com¶‘iÚ_queue
 *
cq
;

51 
nvme_ü—‹_cq
 *
cmd
 = &
	`sq_’Œy
(
eid
).
ü—‹_cq
;

52 
num_·ges
, 
i
;

53 
dbs_idx
;

55 
cq
 = 
	`kz®loc
((
nvmev_com¶‘iÚ_queue
), 
GFP_KERNEL
);

57 
cq
->
qid
 = 
cmd
->
cqid
;

59 
cq
->
œq_’abËd
 = 
cmd
->
cq_æags
 & 
NVME_CQ_IRQ_ENABLED
 ? 
Œue
 : 
çl£
;

60 ià(
cq
->
œq_’abËd
) {

61 
cq
->
œq_veùÜ
 = 
cmd
->irq_vector;

63 
cq
->
š‹¼u±_»ady
 = 
çl£
;

65 
cq
->
queue_size
 = 
cmd
->
qsize
 + 1;

66 
cq
->
pha£
 = 1;

68 
cq
->
cq_h—d
 = 0;

69 
cq
->
cq_ž
 = -1;

71 
	`¥š_lock_š™
(&
cq
->
’Œy_lock
);

72 
	`¥š_lock_š™
(&
cq
->
œq_lock
);

75 
cq
->
phys_cÚtig
 = 
cmd
->
cq_æags
 & 
NVME_QUEUE_PHYS_CONTIG
 ? 
Œue
 : 
çl£
;

76 
	`WARN_ON
(!
cq
->
phys_cÚtig
);

78 
num_·ges
 = 
	`DIV_ROUND_UP
(
cq
->
queue_size
 * (
nvme_com¶‘iÚ
), 
PAGE_SIZE
);

79 
cq
->cq = 
	`kz®loc
((
nvme_com¶‘iÚ
 *è* 
num_·ges
, 
GFP_KERNEL
);

80 
i
 = 0; i < 
num_·ges
; i++) {

81 
cq
->cq[
i
] = 
	`´p_add»ss_off£t
(
cmd
->
´p1
, i);

84 
nvmev_vdev
->
cqes
[
cq
->
qid
] = cq;

86 
dbs_idx
 = 
cq
->
qid
 * 2 + 1;

87 
nvmev_vdev
->
dbs
[
dbs_idx
] =‚vmev_vdev->
Þd_dbs
[dbs_idx] = 0;

89 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

90 
	}
}

92 
	$__nvmev_admš_d–‘e_cq
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

94 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

95 
nvmev_com¶‘iÚ_queue
 *
cq
;

96 
qid
;

98 
qid
 = 
	`sq_’Œy
(
eid
).
d–‘e_queue
.qid;

100 
cq
 = 
nvmev_vdev
->
cqes
[
qid
];

101 
nvmev_vdev
->
cqes
[
qid
] = 
NULL
;

103 ià(
cq
) {

104 
	`kä“
(
cq
->cq);

105 
	`kä“
(
cq
);

108 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

109 
	}
}

111 
	$__nvmev_admš_ü—‹_sq
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

113 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

114 
nvme_ü—‹_sq
 *
cmd
 = &
	`sq_’Œy
(
eid
).
ü—‹_sq
;

115 
nvmev_submissiÚ_queue
 *
sq
;

116 
num_·ges
, 
i
;

117 
dbs_idx
;

119 
sq
 = 
	`kz®loc
((
nvmev_submissiÚ_queue
), 
GFP_KERNEL
);

121 
sq
->
qid
 = 
cmd
->
sqid
;

122 
sq
->
cqid
 = 
cmd
->cqid;

124 
sq
->
´iÜ™y
 = 
cmd
->
sq_æags
 & 0xFFFE;

125 
sq
->
queue_size
 = 
cmd
->
qsize
 + 1;

128 
sq
->
phys_cÚtig
 = (
cmd
->
sq_æags
 & 
NVME_QUEUE_PHYS_CONTIG
è? 
Œue
 : 
çl£
;

129 
	`WARN_ON
(!
sq
->
phys_cÚtig
);

131 
num_·ges
 = 
	`DIV_ROUND_UP
(
sq
->
queue_size
 * (
nvme_commªd
), 
PAGE_SIZE
);

132 
sq
->sq = 
	`kz®loc
((
nvme_commªd
 *è* 
num_·ges
, 
GFP_KERNEL
);

134 
i
 = 0; i < 
num_·ges
; i++) {

135 
sq
->sq[
i
] = 
	`´p_add»ss_off£t
(
cmd
->
´p1
, i);

137 
nvmev_vdev
->
sqes
[
sq
->
qid
] = sq;

139 
dbs_idx
 = 
sq
->
qid
 * 2;

140 
nvmev_vdev
->
dbs
[
dbs_idx
] = 0;

141 
nvmev_vdev
->
Þd_dbs
[
dbs_idx
] = 0;

143 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

144 
	}
}

146 
	$__nvmev_admš_d–‘e_sq
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

148 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

149 
nvme_d–‘e_queue
 *
cmd
 = &
	`sq_’Œy
(
eid
).
d–‘e_queue
;

150 
nvmev_submissiÚ_queue
 *
sq
;

151 
qid
;

153 
qid
 = 
cmd
->qid;

155 
sq
 = 
nvmev_vdev
->
sqes
[
qid
];

156 
nvmev_vdev
->
sqes
[
qid
] = 
NULL
;

158 ià(
sq
) {

159 
	`kä“
(
sq
->sq);

160 
	`kä“
(
sq
);

163 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

164 
	}
}

169 
	$__nvmev_admš_g‘_log_·ge
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

171 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

172 
nvme_g‘_log_·ge_commªd
 *
cmd
 = &
	`sq_’Œy
(
eid
).
g‘_log_·ge
;

173 *
·ge
;

174 
ušt32_t
 
Ën
 = ((((ušt32_t)
cmd
->
numdu
 << 16è| cmd->
numdl
) + 1) << 2;

176 
·ge
 = 
	`´p_add»ss
(
cmd
->
´p1
);

178 
cmd
->
lid
) {

179 
NVME_LOG_SMART
: {

180 cÚ¡ 
nvme_sm¬t_log
 
sm¬t_log
 = {

181 .
ü™iÿl_w¬nšg
 = 0,

182 .
¥¬e_th»sh
 = 20,

183 .
ho¡_»ads
[0] = 
	`ýu_to_Ë64
(0),

184 .
ho¡_wr™es
[0] = 
	`ýu_to_Ë64
(0),

185 .
num_”r_log_’Œ›s
[0] = 
	`ýu_to_Ë64
(0),

186 .
‹m³¿tu»
[0] = 0 & 0xff,

187 .
‹m³¿tu»
[1] = (0 >> 8) & 0xff,

190 
	`__memýy
(
·ge
, &
sm¬t_log
, 
Ën
);

193 
NVME_LOG_CMD_EFFECTS
: {

194 cÚ¡ 
nvme_efãùs_log
 
efãùs_log
 = {

195 .
acs
 = {

196 [
nvme_admš_g‘_log_·ge
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

197 [
nvme_admš_id’tify
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

199 [
nvme_admš_£t_ã©u»s
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

200 [
nvme_admš_g‘_ã©u»s
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

201 [
nvme_admš_async_ev’t
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

204 .
iocs
 = {

205 #ià
	`SUPPORTED_SSD_TYPE
(
ZNS
)

212 [
nvme_cmd_zÚe_­³nd
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

213 [
nvme_cmd_zÚe_mgmt_£nd
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
 | 
NVME_CMD_EFFECTS_LBCC
),

214 [
nvme_cmd_zÚe_mgmt_»cv
] = 
	`ýu_to_Ë32
(
NVME_CMD_EFFECTS_CSUPP
),

217 .
»sv
 = { 0, },

220 
	`__memýy
(
·ge
, &
efãùs_log
, 
Ën
);

234 
	`NVMEV_ERROR
("Unimplemented†og…age identifier: 0x%hhx,"

236 
cmd
->
lid
);

237 
	`__mem£t
(
·ge
, 0, 
Ën
);

241 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

242 
	}
}

247 
	$__nvmev_admš_id’tify_Çme¥aû
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

249 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

250 
nvme_id_ns
 *
ns
;

251 
nvme_id’tify
 *
cmd
 = &
	`sq_’Œy
(
eid
).
id’tify
;

252 
size_t
 
nsid
 = 
cmd
->nsid - 1;

254 
ns
 = 
	`´p_add»ss
(
cmd
->
´p1
);

255 
	`mem£t
(
ns
, 0x0, 
PAGE_SIZE
);

257 
ns
->
lbaf
[0].
ms
 = 0;

258 
ns
->
lbaf
[0].
ds
 = 9;

259 
ns
->
lbaf
[0].
½
 = 
NVME_LBAF_RP_GOOD
;

261 
ns
->
lbaf
[1].
ms
 = 8;

262 
ns
->
lbaf
[1].
ds
 = 9;

263 
ns
->
lbaf
[1].
½
 = 
NVME_LBAF_RP_GOOD
;

265 
ns
->
lbaf
[2].
ms
 = 16;

266 
ns
->
lbaf
[2].
ds
 = 9;

267 
ns
->
lbaf
[2].
½
 = 
NVME_LBAF_RP_GOOD
;

269 
ns
->
lbaf
[3].
ms
 = 0;

270 
ns
->
lbaf
[3].
ds
 = 12;

271 
ns
->
lbaf
[3].
½
 = 
NVME_LBAF_RP_BEST
;

273 
ns
->
lbaf
[4].
ms
 = 8;

274 
ns
->
lbaf
[4].
ds
 = 12;

275 
ns
->
lbaf
[4].
½
 = 
NVME_LBAF_RP_BEST
;

277 
ns
->
lbaf
[5].
ms
 = 64;

278 
ns
->
lbaf
[5].
ds
 = 12;

279 
ns
->
lbaf
[5].
½
 = 
NVME_LBAF_RP_BEST
;

281 
ns
->
lbaf
[6].
ms
 = 128;

282 
ns
->
lbaf
[6].
ds
 = 12;

283 
ns
->
lbaf
[6].
½
 = 
NVME_LBAF_RP_BEST
;

285 
ns
->
nsze
 = (
nvmev_vdev
->ns[
nsid
].
size
 >>‚s->
lbaf
[ns->
æbas
].
ds
);

287 
ns
->
nÿp
 =‚s->
nsze
;

288 
ns
->
nu£
 =‚s->
nsze
;

289 
ns
->
Æbaf
 = 6;

290 
ns
->
æbas
 = 0;

291 
ns
->
dps
 = 0;

293 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

294 
	}
}

296 
	$__nvmev_admš_id’tify_Çme¥aûs
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

298 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

299 
nvme_id’tify
 *
cmd
 = &
	`sq_’Œy
(
eid
).
id’tify
;

300 *
ns
;

301 
i
;

303 
ns
 = 
	`´p_add»ss
(
cmd
->
´p1
);

304 
	`mem£t
(
ns
, 0x00, 
PAGE_SIZE
 * 2);

306 
i
 = 1; i <ð
nvmev_vdev
->
Ä_ns
; i++) {

307 ià(
i
 > 
cmd
->
nsid
) {

308 *
ns
 = 
i
;

309 
ns
++;

313 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

314 
	}
}

316 
	$__nvmev_admš_id’tify_Çme¥aû_desc
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

318 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

319 
nvme_id’tify
 *
cmd
 = &
	`sq_’Œy
(
eid
).
id’tify
;

320 
nvme_id_ns_desc
 *
ns_desc
;

321 
nsid
 = 
cmd
->nsid - 1;

323 
ns_desc
 = 
	`´p_add»ss
(
cmd
->
´p1
);

324 
	`mem£t
(
ns_desc
, 0x00, (*ns_desc));

326 
ns_desc
->
nidt
 = 
NVME_NIDT_CSI
;

327 
ns_desc
->
nidl
 = 1;

329 
ns_desc
->
nid
[0] = 
nvmev_vdev
->
ns
[
nsid
].
csi
;

331 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

332 
	}
}

334 
	$__nvmev_admš_id’tify_zns_Çme¥aû
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

336 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

337 
nvme_id’tify
 *
cmd
 = &
	`sq_’Œy
(
eid
).
id’tify
;

338 
nvme_id_zns_ns
 *
ns
;

339 
nsid
 = 
cmd
->nsid - 1;

340 
zns_ál
 *zns_áÈð(zns_áÈ*)
nvmev_vdev
->
ns
[
nsid
].
áls
;

341 
zn¥¬ams
 *
zµ
 = &
zns_ál
->
zp
;

343 
	`BUG_ON
(
nvmev_vdev
->
ns
[
nsid
].
csi
 !ð
NVME_CSI_ZNS
);

345 
ns
 = 
	`´p_add»ss
(
cmd
->
´p1
);

346 
	`mem£t
(
ns
, 0x00, (*ns));

348 
ns
->
zoc
 = 0;

349 
ns
->
ozcs
 = 0;

350 
ns
->
m¬
 = 
zµ
->
Ä_aùive_zÚes
 - 1;

352 
ns
->
mÜ
 = 
zµ
->
Ä_Ý’_zÚes
 - 1;

355 ià(
zµ
->
Ä_zrwa_zÚes
 > 0) {

356 
ns
->
ozcs
 |ð
OZCS_ZRWA
;

358 
ns
->
numzrwa
 = 
zµ
->
Ä_zrwa_zÚes
 - 1;

360 
ns
->
zrwafg
 = 
zµ
->
zrwafg_size
;

362 
ns
->
zrwasz
 = 
zµ
->
zrwa_size
;

364 
ns
->
zrwaÿp
 = 0;

365 
ns
->
zrwaÿp
 |ð
ZRWACAP_EXPFLUSHSUP
;

368 
ns
->
lbaf
[0].
zsze
 = 
	`BYTE_TO_LBA
(
zµ
->
zÚe_size
);

371 
ns
->
lbaf
[0].
zdes
 = 0;

373 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

374 
	}
}

376 
	$__nvmev_admš_id’tify_zns_ù¾
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

378 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

379 
nvme_id’tify
 *
cmd
 = &
	`sq_’Œy
(
eid
).
id’tify
;

380 
nvme_id_zns_ù¾
 *
»s
;

382 
»s
 = 
	`´p_add»ss
(
cmd
->
´p1
);

384 
»s
->
za¦
 = 0;

386 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

387 
	}
}

389 
	g__úŽid
 = 0;

391 
	$__nvmev_admš_id’tify_ù¾
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

393 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

394 
nvme_id’tify
 *
cmd
 = &
	`sq_’Œy
(
eid
).
id’tify
;

395 
nvme_id_ù¾
 *
ù¾
;

396 
ù¾
 = 
	`´p_add»ss
(
cmd
->
´p1
);

397 
	`mem£t
(
ù¾
, 0x00, (*ctrl));

399 
ù¾
->
Â
 = 
nvmev_vdev
->
Ä_ns
;

400 
ù¾
->
Úcs
 = 0;

401 
ù¾
->
aþ
 = 3;

402 
ù¾
->
vwc
 = 0;

403 
ù¾
->
úŽid
 = 
__úŽid
++;

404 
ù¾
->
mic
 = 1 << 1;

405 
	`¢´štf
(
ù¾
->
¢
, (ctrl->sn), "CSL_Virt_SN_%02d", 1);

406 
	`¢´štf
(
ù¾
->
mn
, (ctrl->mn), "CSL_Virt_MN_%02d", 1);

407 
	`¢´štf
(
ù¾
->
ä
, (ctrl->fr), "CSL_%03d", 2);

408 
ù¾
->
mdts
 = 
nvmev_vdev
->mdts;

409 
ù¾
->
sqes
 = 0x66;

410 
ù¾
->
cqes
 = 0x44;

412 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

413 
	}
}

415 
	$__nvmev_admš_id’tify
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

417 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

418 
ús
 = 
	`sq_’Œy
(
eid
).
id’tify
.cns;

420 
ús
) {

422 
	`__nvmev_admš_id’tify_Çme¥aû
(
eid
, 
nvmev_vdev
);

425 
	`__nvmev_admš_id’tify_ù¾
(
eid
, 
nvmev_vdev
);

428 
	`__nvmev_admš_id’tify_Çme¥aûs
(
eid
, 
nvmev_vdev
);

431 
	`__nvmev_admš_id’tify_Çme¥aû_desc
(
eid
, 
nvmev_vdev
);

434 
	`__nvmev_admš_id’tify_zns_Çme¥aû
(
eid
, 
nvmev_vdev
);

437 
	`__nvmev_admš_id’tify_zns_ù¾
(
eid
, 
nvmev_vdev
);

440 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_INVALID_OPCODE
, 
nvmev_vdev
);

441 
	`NVMEV_ERROR
("I dÚ'ˆknow %d\n", 
ús
);

443 
	}
}

448 
	$__nvmev_admš_£t_ã©u»s
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

450 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

451 
nvme_ã©u»s
 *
cmd
 = &
	`sq_’Œy
(
eid
).
ã©u»s
;

452 
__Ë32
 
»suÉ0
 = 0;

453 
__Ë32
 
»suÉ1
 = 0;

455 
cmd
->
fid
) {

456 
NVME_FEAT_ARBITRATION
:

457 
NVME_FEAT_POWER_MGMT
:

458 
NVME_FEAT_LBA_RANGE
:

459 
NVME_FEAT_TEMP_THRESH
:

460 
NVME_FEAT_ERR_RECOVERY
:

461 
NVME_FEAT_VOLATILE_WC
:

463 
NVME_FEAT_NUM_QUEUES
: {

464 
num_queue
;

467 
num_queue
 = (
	`sq_’Œy
(
eid
).
ã©u»s
.
dwÜd11
 & 0xFFFF) + 1;

468 
nvmev_vdev
->
Ä_sq
 = 
	`mš
(
num_queue
, 
NR_MAX_IO_QUEUE
);

471 
num_queue
 = ((
	`sq_’Œy
(
eid
).
ã©u»s
.
dwÜd11
 >> 16) & 0xFFFF) + 1;

472 
nvmev_vdev
->
Ä_cq
 = 
	`mš
(
num_queue
, 
NR_MAX_IO_QUEUE
);

474 
»suÉ0
 = ((
nvmev_vdev
->
Ä_cq
 - 1è<< 16 | (nvmev_vdev->
Ä_sq
 - 1));

477 
NVME_FEAT_IRQ_COALESCE
:

478 
NVME_FEAT_IRQ_CONFIG
:

479 
NVME_FEAT_WRITE_ATOMIC
:

480 
NVME_FEAT_ASYNC_EVENT
:

481 
NVME_FEAT_AUTO_PST
:

482 
NVME_FEAT_SW_PROGRESS
:

483 
NVME_FEAT_HOST_ID
:

484 
NVME_FEAT_RESV_MASK
:

485 
NVME_FEAT_RESV_PERSIST
:

490 
	`__make_cq_’Œy_»suÉs
(
eid
, 
NVME_SC_SUCCESS
, 
»suÉ0
, 
»suÉ1
, 
nvmev_vdev
);

491 
	}
}

493 
	$__nvmev_admš_g‘_ã©u»s
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

495 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

496 
nvme_ã©u»s
 *
cmd
 = &
	`sq_’Œy
(
eid
).
ã©u»s
;

497 
__Ë32
 
»suÉ0
 = 0;

498 
__Ë32
 
»suÉ1
 = 0;

500 
cmd
->
fid
) {

501 
NVME_FEAT_ARBITRATION
:

502 
NVME_FEAT_POWER_MGMT
:

503 
NVME_FEAT_LBA_RANGE
:

504 
NVME_FEAT_TEMP_THRESH
:

505 
NVME_FEAT_ERR_RECOVERY
:

506 
NVME_FEAT_VOLATILE_WC
:

508 
NVME_FEAT_NUM_QUEUES
:

509 
»suÉ0
 = ((
nvmev_vdev
->
Ä_cq
 - 1è<< 16 | (nvmev_vdev->
Ä_sq
 - 1));

511 
NVME_FEAT_IRQ_COALESCE
:

512 
NVME_FEAT_IRQ_CONFIG
:

513 
NVME_FEAT_WRITE_ATOMIC
:

514 
NVME_FEAT_ASYNC_EVENT
:

515 
NVME_FEAT_AUTO_PST
:

516 
NVME_FEAT_SW_PROGRESS
:

517 
NVME_FEAT_HOST_ID
:

518 
NVME_FEAT_RESV_MASK
:

519 
NVME_FEAT_RESV_PERSIST
:

524 
	`__make_cq_’Œy_»suÉs
(
eid
, 
NVME_SC_SUCCESS
, 
»suÉ0
, 
»suÉ1
, 
nvmev_vdev
);

525 
	}
}

530 
	$__nvmev_admš_async_ev’t
(
eid
, 
nvmev_dev
 *
nvmev_vdev
)

532 
	`__make_cq_’Œy
(
eid
, 
NVME_SC_SUCCESS
, 
nvmev_vdev
);

534 
	}
}

536 
	$__nvmev_´oc_admš_»q
(
’Œy_id
, 
nvmev_dev
 *
nvmev_vdev
)

538 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

539 
nvme_commªd
 *
sqe
 = &
	`sq_’Œy
(
’Œy_id
);

541 
	`NVMEV_DEBUG
("%s: %d 0x%x 0x%x\n", 
__func__
, 
’Œy_id
, 
sqe
->
commÚ
.
Ýcode
,

542 
sqe
->
commÚ
.
commªd_id
);

544 
sqe
->
commÚ
.
Ýcode
) {

545 
nvme_admš_d–‘e_sq
:

546 
	`__nvmev_admš_d–‘e_sq
(
’Œy_id
, 
nvmev_vdev
);

548 
nvme_admš_ü—‹_sq
:

549 
	`__nvmev_admš_ü—‹_sq
(
’Œy_id
, 
nvmev_vdev
);

551 
nvme_admš_g‘_log_·ge
:

552 
	`__nvmev_admš_g‘_log_·ge
(
’Œy_id
, 
nvmev_vdev
);

554 
nvme_admš_d–‘e_cq
:

555 
	`__nvmev_admš_d–‘e_cq
(
’Œy_id
, 
nvmev_vdev
);

557 
nvme_admš_ü—‹_cq
:

558 
	`__nvmev_admš_ü—‹_cq
(
’Œy_id
, 
nvmev_vdev
);

560 
nvme_admš_id’tify
:

561 
	`__nvmev_admš_id’tify
(
’Œy_id
, 
nvmev_vdev
);

562 
nvme_admš_abÜt_cmd
:

564 
nvme_admš_£t_ã©u»s
:

565 
	`__nvmev_admš_£t_ã©u»s
(
’Œy_id
, 
nvmev_vdev
);

567 
nvme_admš_g‘_ã©u»s
:

568 
	`__nvmev_admš_g‘_ã©u»s
(
’Œy_id
, 
nvmev_vdev
);

570 
nvme_admš_async_ev’t
:

571 
	`__nvmev_admš_async_ev’t
(
’Œy_id
, 
nvmev_vdev
);

573 
nvme_admš_aùiv©e_fw
:

574 
nvme_admš_dowÆßd_fw
:

575 
nvme_admš_fÜm©_nvm
:

576 
nvme_admš_£cur™y_£nd
:

577 
nvme_admš_£cur™y_»cv
:

579 
	`__make_cq_’Œy
(
’Œy_id
, 
NVME_SC_INVALID_OPCODE
, 
nvmev_vdev
);

580 
	`NVMEV_ERROR
("UnhªdËd‡dmš„eque¡s: %d", 
sqe
->
commÚ
.
Ýcode
);

583 
	}
}

585 
	$nvmev_´oc_admš_sq
(
Ãw_db
, 
Þd_db
, 
nvmev_dev
 *
nvmev_vdev
)

587 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

588 
num_´oc
 = 
Ãw_db
 - 
Þd_db
;

589 
cu¼
 = 
Þd_db
;

590 
£q
;

592 ià(
num_´oc
 < 0)

593 
num_´oc
 +ð
queue
->
sq_d•th
;

595 
£q
 = 0; seq < 
num_´oc
; seq++) {

596 
	`__nvmev_´oc_admš_»q
(
cu¼
++, 
nvmev_vdev
);

598 ià(
cu¼
 =ð
queue
->
sq_d•th
) {

599 
cu¼
 = 0;

603 
	`nvmev_sigÇl_œq
(
nvmev_vdev
, 0);

604 
	}
}

606 
	$nvmev_´oc_admš_cq
(
Ãw_db
, 
Þd_db
)

608 
	}
}

	@append_only.c

3 
	~"nvmev.h
"

4 
	~<lšux/b™m­.h
>

5 
	~<lšux/ty³s.h
>

6 
	~<asm/b™Ýs.h
>

7 
	~<lšux/log2.h
>

8 
	~<lšux/hashbË.h
>

9 
	~<lšux/k”Ãl.h
>

11 
	gÏ‹¡
;

12 
	gdev_size
;

13 
	gtÙ®_wr™‹n
;

15 
	$­³nd_Úly_®loÿtÜ_š™
(
u64
 
size
)

17 
dev_size
 = 
size
;

18 
Ï‹¡
 = 0;

19 
tÙ®_wr™‹n
 = 0;

20 
	`NVMEV_INFO
("In™Ÿlized‡À­³nd memÜy…oÞ w™h siz%Îu", 
size
);

22 
	}
}

24 
size_t
 
	$­³nd_Úly_®loÿ‹
(
u64
 
Ëngth
, *
¬gs
)

26 
size_t
 
»t
 = 
Ï‹¡
;

27 
Ï‹¡
 +ð
Ëngth
;

28 
tÙ®_wr™‹n
 +ð
Ëngth
;

30 
	`NVMEV_DEBUG
("R‘uºšg off£ˆ%lu fÜ†’gth %Îu", 
»t
, 
Ëngth
);

32 ià(
Ï‹¡
 + 65536 >ð
dev_size
) {

33 
	`NVMEV_ERROR
("append-only‡llocator is‚early full!!");

36  
»t
;

37 
	}
}

39 
	$­³nd_Úly_kžl
()

41 
	}
}

	@append_only.h

3 #iâdeà
_APPEND_ONLY_H_


4 
	#_APPEND_ONLY_H_


	)

6 
	~<lšux/ty³s.h
>

8 
­³nd_Úly_®loÿtÜ_š™
(
u64
 
size
);

9 
size_t
 
­³nd_Úly_®loÿ‹
(
u64
 
Ëngth
, *
¬gs
);

10 
­³nd_Úly_kžl
();

	@bitmap.c

3 
	~"b™m­.h
"

4 
	~"nvmev.h
"

6 
	gsm®l_nb™s
;

7 
	gÏrge_nb™s
;

8 
	gsm®l_b™m­
[600000];

9 
	gÏrge_b™m­
[300000];

10 
	gsm®l_ÿ·c™y
;

11 
	gÏrge_ÿ·c™y
;

13 
size_t
 
	gsm®l_Ï¡_pos
;

14 
size_t
 
	gÏrge_Ï¡_pos
;

16 
	gdev_size
;

17 
	gtÙ®_wr™‹n
;

19 
	$b™s_´št
(*
v
, 
u32
 
nb™s
)

21 
s32
 
i
;

22 
u32
 
wc
 = 
	`BIT_WORD
(
nb™s
);

23 
u64
 
mask1
, 
mask2
 = 
	`BIT
(
	`BITS_PER_TYPE
() - 1);

25 
i
 = 
wc
; i >= 0; i--) {

26 
	`´štk
("v[%d] = ", 
i
);

27 
mask1
 = 
mask2
;

28 
mask1
) {

29 
	`´štk
("%d", (
v
[
i
] & 
mask1
 ? 1 : 0));

30 
mask1
 >>= 1;

32 
	`´štk
("\n");

35 
	`´štk
("\n");

36 
	}
}

38 
	$b™m­_®loÿtÜ_š™
(
u64
 
size
)

40 
dev_size
 = 
size
;

42 
sm®l_nb™s
 = 
size
 / 2 / 
SMALL_LENGTH
;

43 
Ïrge_nb™s
 = 
size
 / 2 / 
LARGE_LENGTH
;

46 
	`NVMEV_INFO
("sm®l_b™m­ sizð%zu b™s, %lu %lu\n", (
sm®l_b™m­
è* 
BITS_PER_BYTE
,

47 
sm®l_nb™s
, 
	`BITS_TO_LONGS
(small_nbits));

48 
	`NVMEV_INFO
("Ïrge_b™m­ sizð%zu b™s, %lu %lu\n", (
Ïrge_b™m­
è* 
BITS_PER_BYTE
,

49 
Ïrge_nb™s
, 
	`BITS_TO_LONGS
(large_nbits));

51 
	`b™m­_z”o
(
sm®l_b™m­
, 
sm®l_nb™s
);

52 
	`b™m­_z”o
(
Ïrge_b™m­
, 
Ïrge_nb™s
);

54 
	`NVMEV_INFO
("In™Ÿlized‡Àb™m­ w™h siz%Îu", 
size
);

56 
	}
}

58 
size_t
 
	$b™m­_®loÿ‹
(
u64
 
Ëngth
, *
¬gs
)

60 
size_t
 
off
;

61 
size_t
 
ÿlcuÏ‹d_off£t
;

63 
tÙ®_wr™‹n
 +ð
Ëngth
;

65 ià(
Ëngth
 > 
LARGE_LENGTH
) {

66 
	`NVMEV_ERROR
("Invalid†ength want bitmap‡llocation!!");

69 ià(
Ëngth
 > 
SMALL_LENGTH
) {

70 
off
 = 
	`b™m­_fšd_Ãxt_z”o_¬—
(
Ïrge_b™m­
, 
Ïrge_nb™s
, 
Ïrge_Ï¡_pos
, 1,

72 
	`b™m­_£t
(
Ïrge_b™m­
, 
off
, 1);

74 
Ïrge_Ï¡_pos
 = 
off
 + 1;

75 ià(
Ïrge_Ï¡_pos
 > 
Ïrge_nb™s
) {

76 
Ïrge_Ï¡_pos
 = 0;

79 
ÿlcuÏ‹d_off£t
 = 
dev_size
 / 2 + 
off
 * 
LARGE_LENGTH
;

81 
	`NVMEV_DEBUG
("large_allocate(%llu):„eturning offset %lu, %luth bitmap index",

82 
Ëngth
, 
ÿlcuÏ‹d_off£t
, 
off
);

84 
Ïrge_ÿ·c™y
++;

85 ià(
Ïrge_ÿ·c™y
 > (
Ïrge_nb™s
 - 10))

86 
	`NVMEV_INFO
("large bitmap is‚early full!!");

88 
off
 = 
	`b™m­_fšd_Ãxt_z”o_¬—
(
sm®l_b™m­
, 
sm®l_nb™s
, 
sm®l_Ï¡_pos
, 1,

90 
	`b™m­_£t
(
sm®l_b™m­
, 
off
, 1);

92 
sm®l_Ï¡_pos
 = 
off
 + 1;

93 ià(
sm®l_Ï¡_pos
 > 
sm®l_nb™s
) {

94 
sm®l_Ï¡_pos
 = 0;

97 
ÿlcuÏ‹d_off£t
 = 
off
 * 
SMALL_LENGTH
;

99 
	`NVMEV_DEBUG
("small_allocate(%llu):„eturning offset %lu, %luth bitmap index",

100 
Ëngth
, 
ÿlcuÏ‹d_off£t
, 
off
);

102 
sm®l_ÿ·c™y
++;

103 ià(
sm®l_ÿ·c™y
 > (
sm®l_nb™s
 - 10))

104 
	`NVMEV_INFO
("small bitmap is‚early full!!");

107  
ÿlcuÏ‹d_off£t
;

108 
	}
}

110 
	$b™m­_kžl
()

112 
	}
}

	@bitmap.h

3 #iâdeà
_BITMAP_H_


4 
	#_BITMAP_H_


	)

6 
	~<lšux/b™m­.h
>

7 
	~<lšux/ty³s.h
>

8 
	~<lšux/b™s.h
>

9 
	~<lšux/b™Ýs.h
>

10 
	~<lšux/k”Ãl.h
>

12 
	#SMALL_LENGTH
 1024

	)

13 
	#LARGE_LENGTH
 4096

	)

15 
b™m­_®loÿtÜ_š™
(
u64
 
size
);

16 
size_t
 
b™m­_®loÿ‹
(
u64
 
Ëngth
, *
¬gs
);

17 
b™m­_kžl
();

	@channel_model.c

3 
	~<lšux/kth»ad.h
>

4 
	~<lšux/ktime.h
>

5 
	~<lšux/highmem.h
>

6 
	~<lšux/sched/þock.h
>

8 
	~"nvmev.h
"

9 
	~"chªÃl_mod–.h
"

11 
šlše
 
	$__g‘_w®lþock
(
nvmev_dev
 *
nvmev_vdev
)

13  
	`ýu_þock
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
);

14 
	}
}

16 
	$chmod–_š™
(
chªÃl_mod–
 *
ch
, 
ušt64_t
 
bªdwidth
 )

18 
ch
->
h—d
 = 0;

19 
ch
->
v®id_Ën
 = 0;

20 
ch
->
cur_time
 = 0;

21 
ch
->
max_üed™s
 = 
	`BANDWIDTH_TO_MAX_CREDITS
(
bªdwidth
);

22 
ch
->
commªd_üed™s
 = 0;

23 
ch
->
xãr_Ït
 = 
	`BANDWIDTH_TO_TX_TIME
(
bªdwidth
);

25 
	`MEMSET
(&(
ch
->
avaž_üed™s
[0]), ch->
max_üed™s
, 
NR_CREDIT_ENTRIES
);

27 
	`NVMEV_INFO
("[%s] bªdwidth %Îu max_üed™ %ux_tim%u\n", 
__func__
, 
bªdwidth
,

28 
ch
->
max_üed™s
, ch->
xãr_Ït
);

29 
	}
}

31 
ušt64_t
 
	$chmod–_»que¡
(
chªÃl_mod–
 *
ch
, 
ušt64_t
 
»que¡_time
, ušt64_ˆ
Ëngth
,

32 
nvmev_dev
 *
nvmev_vdev
)

34 
ušt64_t
 
cur_time
 = 
	`__g‘_w®lþock
(
nvmev_vdev
);

35 
ušt32_t
 
pos
, 
Ãxt_pos
;

36 
ušt32_t
 
»maššg_üed™s
, 
cÚsumed_üed™s
;

37 
ušt32_t
 
deçuÉ_d–ay
, 
d–ay
 = 0;

38 
ušt32_t
 
v®id_Ëngth
;

39 
ušt64_t
 
tÙ®_Ï‹ncy
;

40 
ušt32_t
 
un™s_to_xãr
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
UNIT_XFER_SIZE
);

41 
ušt32_t
 
cur_time_offs
, 
»que¡_time_offs
;

44 
cur_time_offs
 = (
cur_time
 / 
UNIT_TIME_INTERVAL
è- (
ch
->cur_time / UNIT_TIME_INTERVAL);

45 
cur_time_offs
 = (cur_time_off < 
ch
->
v®id_Ën
) ? cur_time_offs : ch->valid_len;

47 ià(
ch
->
h—d
 + 
cur_time_offs
 >ð
NR_CREDIT_ENTRIES
) {

48 
	`MEMSET
(&(
ch
->
avaž_üed™s
[ch->
h—d
]), ch->
max_üed™s
,

49 
NR_CREDIT_ENTRIES
 - 
ch
->
h—d
);

50 
	`MEMSET
(&(
ch
->
avaž_üed™s
[0]), ch->
max_üed™s
,

51 
cur_time_offs
 - (
NR_CREDIT_ENTRIES
 - 
ch
->
h—d
));

53 
	`MEMSET
(&(
ch
->
avaž_üed™s
[ch->
h—d
]), ch->
max_üed™s
, 
cur_time_offs
);

56 
ch
->
h—d
 = (ch->h—d + 
cur_time_offs
è% 
NR_CREDIT_ENTRIES
;

57 
ch
->
cur_time
 = cur_time;

58 
ch
->
v®id_Ën
 = ch->v®id_ËÀ- 
cur_time_offs
;

60 ià(
ch
->
v®id_Ën
 > 
NR_CREDIT_ENTRIES
) {

61 
	`NVMEV_ERROR
("[%s] Inv®id v®id_ËÀ0x%x\n", 
__func__
, 
ch
->
v®id_Ën
);

62 
	`NVMEV_ASSERT
(0);

65 ià(
»que¡_time
 < 
cur_time
) {

66 
	`NVMEV_DEBUG
("[%s] Reqeustime is beforehe currentime 0x%llx 0x%llx\n",

67 
__func__
, 
»que¡_time
, 
cur_time
);

68  
»que¡_time
;

72 
»que¡_time_offs
 = (
»que¡_time
 / 
UNIT_TIME_INTERVAL
è- (
cur_time
 / UNIT_TIME_INTERVAL);

74 ià(
»que¡_time_offs
 >ð
NR_CREDIT_ENTRIES
) {

75 
	`NVMEV_ERROR
("[%s] N“dØšü—£‡¼ay siz0x%Îx 0x%Îx 0x%x\n", 
__func__
,

76 
»que¡_time
, 
cur_time
, 
»que¡_time_offs
);

77  
»que¡_time
;

80 
pos
 = (
ch
->
h—d
 + 
»que¡_time_offs
è% 
NR_CREDIT_ENTRIES
;

81 
»maššg_üed™s
 = 
un™s_to_xãr
 * 
UNIT_XFER_CREDITS
;

82 
»maššg_üed™s
 +ð
ch
->
commªd_üed™s
;

84 
deçuÉ_d–ay
 = 
»maššg_üed™s
 / 
ch
->
max_üed™s
;

85 
d–ay
 = 0;

88 
cÚsumed_üed™s
 = (
»maššg_üed™s
 <ð
ch
->
avaž_üed™s
[
pos
]) ?

89 
»maššg_üed™s
 :

90 
ch
->
avaž_üed™s
[
pos
];

91 
ch
->
avaž_üed™s
[
pos
] -ð
cÚsumed_üed™s
;

92 
»maššg_üed™s
 -ð
cÚsumed_üed™s
;

94 ià(
»maššg_üed™s
) {

95 
Ãxt_pos
 = (
pos
 + 1è% 
NR_CREDIT_ENTRIES
;

97 ià(
Ãxt_pos
 !ð
ch
->
h—d
) {

98 
d–ay
++;

99 
pos
 = 
Ãxt_pos
;

101 
	`NVMEV_ERROR
("[%s] NØä“ƒÁry 0x%Îx 0x%Îx 0x%x\n", 
__func__
,

102 
»que¡_time
, 
cur_time
, 
»que¡_time_offs
);

109 
v®id_Ëngth
 = (
pos
 >ð
ch
->
h—d
) ? (pos - ch->head + 1) :

110 (
NR_CREDIT_ENTRIES
 - (
ch
->
h—d
 - 
pos
 - 1));

112 ià(
v®id_Ëngth
 > 
ch
->
v®id_Ën
)

113 
ch
->
v®id_Ën
 = 
v®id_Ëngth
;

116 
d–ay
 = (d–ay > 
deçuÉ_d–ay
) ? (delay - default_delay) : 0;

118 
tÙ®_Ï‹ncy
 = (
ch
->
xãr_Ït
 * 
un™s_to_xãr
è+ (
d–ay
 * 
UNIT_TIME_INTERVAL
);

120  
»que¡_time
 + 
tÙ®_Ï‹ncy
;

121 
	}
}

124 
ušt64_t
 
	$chmod–_»que¡_cÝy
(
chªÃl_mod–
 *
ch
, 
ušt64_t
 
»que¡_time
, ušt64_ˆ
Ëngth
,

125 
nvmev_dev
 *
nvmev_vdev
)

127 
ušt64_t
 
cur_time
 = 
	`__g‘_w®lþock
(
nvmev_vdev
);

128 
ušt32_t
 
pos
, 
Ãxt_pos
;

129 
ušt32_t
 
»maššg_üed™s
, 
cÚsumed_üed™s
;

130 
ušt32_t
 
deçuÉ_d–ay
, 
d–ay
 = 0;

131 
ušt32_t
 
v®id_Ëngth
;

132 
ušt64_t
 
tÙ®_Ï‹ncy
;

133 
ušt32_t
 
un™s_to_xãr
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
UNIT_XFER_SIZE
);

134 
ušt32_t
 
cur_time_offs
, 
»que¡_time_offs
;

138 
»maššg_üed™s
 = 
un™s_to_xãr
 * 
UNIT_XFER_CREDITS
;

139 
»maššg_üed™s
 +ð
ch
->
commªd_üed™s
;

141 
deçuÉ_d–ay
 = 
»maššg_üed™s
 / 
ch
->
max_üed™s
;

142 
d–ay
 = 0;

145 
cÚsumed_üed™s
 = (
»maššg_üed™s
 <ð
ch
->
max_üed™s
) ?

146 
»maššg_üed™s
 :

147 
ch
->
max_üed™s
;

148 
»maššg_üed™s
 -ð
cÚsumed_üed™s
;

150 ià(
»maššg_üed™s
) {

151 
d–ay
++;

157 
d–ay
 = (d–ay > 
deçuÉ_d–ay
) ? (delay - default_delay) : 0;

159 
tÙ®_Ï‹ncy
 = (
ch
->
xãr_Ït
 * 
un™s_to_xãr
è+ (
d–ay
 * 
UNIT_TIME_INTERVAL
);

161  
»que¡_time
 + 
tÙ®_Ï‹ncy
;

162 
	}
}

	@channel_model.h

3 #iâdeà
_CHANNEL_MODEL_H


4 
	#_CHANNEL_MODEL_H


	)

7 
	#NR_CREDIT_ENTRIES
 (1024 * 96)

	)

8 
	#UNIT_TIME_INTERVAL
 (4000ULL)

9 
	#UNIT_XFER_SIZE
 (128ULL)

10 
	#UNIT_XFER_CREDITS
 (1)

11 

	)

12 
	#SIZE_OF_CREDIT_T
 1

	)

14 #ià(
SIZE_OF_CREDIT_T
 == 1)

15 
ušt8_t
 
	tüed™_t
;

16 
	#MEMSET
(
de¡
, 
v®ue
, 
Ëngth
è
	`mem£t
(de¡, v®ue,†’gth)

	)

18 #–ià(
SIZE_OF_CREDIT_T
 == 2)

19 
ušt16_t
 
	tüed™_t
;

20 
	#MEMSET
(
de¡
, 
v®ue
, 
Ëngth
è
	`mem£t16
(de¡, v®ue,†’gth)

	)

22 #–ià(
SIZE_OF_CREDIT_T
 == 4)

23 
ušt32_t
 
	tüed™_t
;

24 
	#MEMSET
(
de¡
, 
v®ue
, 
Ëngth
è
	`mem£t32
(de¡, v®ue,†’gth)

	)

29 
	~"nvmev.h
"

31 
	schªÃl_mod–
 {

32 
ušt64_t
 
	mcur_time
;

33 
ušt32_t
 
	mh—d
;

34 
ušt32_t
 
	mv®id_Ën
;

35 
ušt32_t
 
	mmax_üed™s
;

36 
ušt32_t
 
	mcommªd_üed™s
;

37 
ušt32_t
 
	mxãr_Ït
;

39 
üed™_t
 
	mavaž_üed™s
[
NR_CREDIT_ENTRIES
];

42 
	#BANDWIDTH_TO_TX_TIME
(
MB_S
è(((
UNIT_XFER_SIZE
)*
	`NS_PER_SEC
(1)è/ (
	`MB
(MB_S)))

	)

43 
	#BANDWIDTH_TO_MAX_CREDITS
(
MB_S
) \

44 (
	`MB
(
MB_S
è* 
UNIT_TIME_INTERVAL
 / 
	`NS_PER_SEC
(1è/ 
UNIT_XFER_SIZE
 * 
UNIT_XFER_CREDITS
)

	)

46 
ušt64_t
 
chmod–_»que¡
(
chªÃl_mod–
 *
ch
, ušt64_ˆ
»que¡_time
, ušt64_ˆ
Ëngth
,

47 
nvmev_dev
 *
nvmev_vdev
);

48 
ušt64_t
 
chmod–_»que¡_cÝy
(
chªÃl_mod–
 *
ch
, ušt64_ˆ
»que¡_time
, ušt64_ˆ
Ëngth
,

49 
nvmev_dev
 *
nvmev_vdev
);

50 
chmod–_š™
(
chªÃl_mod–
 *
ch
, 
ušt64_t
 
bªdwidth
 );

	@check_phfrag.c

1 
	~"check_phäag.h
"

2 
	~<lšux/fs.h
>

3 
	~<lšux/mmª.h
>

4 
	~<lšux/debugfs.h
>

5 
	~<lšux/kobjeù.h
>

6 
	~<lšux/sysfs.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¡ršg.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/Çmei.h
>

12 
	~<lšux/·th.h
>

13 
	~<lšux/uacûss.h
>

14 
	~<lšux/blkdev.h
>

15 
	~<u­i/lšux/fs.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/mouÁ.h
>

18 
	~<lšux/Çmei.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/li¡.h
>

23 
	$PHFRAG_INIT
(
nvmev
 *‚vmev){

24 
	`´štk
("Hello…hfrag\n");

25 
	}
}

27 
	$PHFRAG_EXIT
(){

28 
	`´štk
("Bye Phfrag\n");

29 
	}
}

30 
šlše
 
	$__g‘_w®lþock
(
nvmev_dev
 *
nvmev_vdev
)

32  
	`ýu_þock
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
);

33 
	}
}

34 
šlše
 
ušt64_t
 
	$__g‘_ioþock
(
ssd
 *ssd)

36  
	`ýu_þock
(
ssd
->
ýu_Ä_di¥©ch”
);

37 
	}
}

38 
šlše
 
boÞ
 
	$v®id_µa
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

40 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

41 
ch
 = 
µa
->
g
.ch;

42 
lun
 = 
µa
->
g
.lun;

43 
¶
 = 
µa
->
g
.pl;

44 
blk
 = 
µa
->
g
.blk;

45 
pg
 = 
µa
->
g
.pg;

48 ià(
ch
 < 0 || ch >ð
¥p
->
nchs
)

49  
çl£
;

50 ià(
lun
 < 0 ||†uÀ>ð
¥p
->
luns_³r_ch
)

51  
çl£
;

52 ià(
¶
 < 0 ||…È>ð
¥p
->
¶s_³r_lun
)

53  
çl£
;

54 ià(
blk
 < 0 || blk >ð
¥p
->
blks_³r_¶
)

55  
çl£
;

56 ià(
pg
 < 0 ||…g >ð
¥p
->
pgs_³r_blk
)

57  
çl£
;

59  
Œue
;

60 
	}
}

62 
šlše
 
boÞ
 
	$m­³d_µa
(
µa
 *ppa)

64  !(
µa
->µ¨=ð
UNMAPPED_PPA
);

65 
	}
}

67 
boÞ
 
	$is_§me_æash_·ge
(
cÚv_ál
 *cÚv_ál, 
µa
 
µa1
, µ¨
µa2
)

69 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

70 
ušt32_t
 
µa1_·ge
 = 
µa1
.
g
.
pg
 / 
¥p
->
pgs_³r_æashpg
;

71 
ušt32_t
 
µa2_·ge
 = 
µa2
.
g
.
pg
 / 
¥p
->
pgs_³r_æashpg
;

73  (
µa1
.
h
.
blk_š_ssd
 =ð
µa2
.h.blk_š_ssdè&& (
µa1_·ge
 =ð
µa2_·ge
);

74 
	}
}

76 
ušt64_t
 
	$ssd_advªû_Çnd_cÝy
(
ssd
 *ssd, 
Çnd_cmd
 *
ncmd
,
nvmev_cÚfig
 *
cfg
,
boÞ
 *
fœ¡
)

78 
ušt64_t
 
cmd_¡ime
 = (
ncmd
->
¡ime
 =ð0è? 
	`__g‘_ioþock
(
ssd
) :‚cmd->stime;

79 
ušt64_t
 
Çnd_¡ime
, 
Çnd_‘ime
;

80 
ušt64_t
 
chÆ_¡ime
, 
chÆ_‘ime
;

81 
ušt64_t
 
»maššg
, 
xãr_size
, 
com¶‘ed_time
;

82 
ssd·¿ms
 *
¥p
;

83 
Çnd_lun
 *
lun
;

84 
ssd_chªÃl
 *
ch
;

85 
µa
 *µ¨ð
ncmd
->ppa;

86 
ušt32_t
 
ûÎ
;

87 
ušt64_t
 
d–ay_time
;

89 ià(
µa
->µ¨=ð
UNMAPPED_PPA
) {

90 
	`NVMEV_ERROR
("E¼Ü…· 0x%Îx\n", 
µa
->ppa);

91  
cmd_¡ime
;

94 
¥p
 = &
ssd
->
¥
;

95 
ch
 = &(
ssd
->ch[
µa
->
g
.ch]);

96 
lun
 = &(
ch
->lun[
µa
->
g
.lun]);

97 
ûÎ
 = (
µa
->
g
.
pg
 / 
¥p
->
pgs_³r_æashpg
è% (¥p->
ûÎ_mode
 + 1);

98 
»maššg
 = 
ncmd
->
xãr_size
;

100 
Çnd_¡ime
 = 
	`max
(
lun
->
Ãxt_lun_avaž_time
, 
cmd_¡ime
);

102 if(!
fœ¡
[
µa
->
g
.
ch
 * 
¥p
->
luns_³r_ch
 +…·->g.
lun
]){

103 
d–ay_time
 = 
Çnd_¡ime
 - 
cmd_¡ime
;

104 if(
d–ay_time
 > 0){

105 
cfg
->
ch_d›_couÁ”
 ++;

106 
cfg
->
ch_d›_Ï‹ncy
 +ð
d–ay_time
;

108 
fœ¡
[
µa
->
g
.
ch
 * 
¥p
->
luns_³r_ch
 +…·->g.
lun
] = 
Œue
;

112 ià(
ncmd
->
xãr_size
 == 4096) {

113 
Çnd_‘ime
 = 
Çnd_¡ime
 + 
¥p
->
pg_4kb_rd_Ït
[
ûÎ
];

115 
Çnd_‘ime
 = 
Çnd_¡ime
 + 
¥p
->
pg_rd_Ït
[
ûÎ
];

118 
chÆ_¡ime
 = 
Çnd_‘ime
;

120 
»maššg
) {

121 
xãr_size
 = 
	`mš
(
»maššg
, (
ušt64_t
)
¥p
->
max_ch_xãr_size
);

122 
chÆ_‘ime
 = 
	`chmod–_»que¡
(
ch
->
³rf_mod–
, 
chÆ_¡ime
, 
xãr_size
,

123 
ssd
->
p_ns
->
p_dev
);

125 ià(
ncmd
->
š‹¾—ve_pci_dma
) {

126 
com¶‘ed_time
 = 
	`ssd_advªû_pc›
(
ssd
, 
chÆ_‘ime
, 
xãr_size
);

128 
com¶‘ed_time
 = 
chÆ_‘ime
;

131 
»maššg
 -ð
xãr_size
;

132 
chÆ_¡ime
 = 
com¶‘ed_time
;

135 
lun
->
Ãxt_lun_avaž_time
 = 
chÆ_‘ime
;

137  
com¶‘ed_time
;

138 
	}
}

139 
boÞ
 
	$is_§me_ÚeshÙ_·ge
(
cÚv_ál
 *cÚv_ál, 
µa
 
µa1
, µ¨
µa2
)

141 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

142 
ušt32_t
 
µa1_·ge
 = 
µa1
.
g
.
pg
 / 
¥p
->
pgs_³r_ÚeshÙpg
;

143 
ušt32_t
 
µa2_·ge
 = 
µa2
.
g
.
pg
 / 
¥p
->
pgs_³r_ÚeshÙpg
;

145  (
µa1
.
h
.
blk_š_ssd
 =ð
µa2
.h.blk_š_ssdè&& (
µa1_·ge
 =ð
µa2_·ge
);

146 
	}
}

148 
boÞ
 
	$is_Ãxt_cÜ»ù
(
cÚv_ál
 *cÚv_ál, 
µa
 *
´e
, µ¨*
Ãxt
, 
boÞ
* 
·ge_couÁ”
){

150 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

168 if(
	`is_§me_ÚeshÙ_·ge
(
cÚv_ál
,*(
´e
),*(
Ãxt
))){

173 
´ediù_Ãxt_ch
 = 
´e
->
g
.
ch
 + 1;

174 
´ediù_Ãxt_d›
 = 
´e
->
g
.
lun
;

176 if(
´ediù_Ãxt_ch
 >ð
¥p
->
nchs
){

177 
´ediù_Ãxt_ch
 = 0;

178 
´ediù_Ãxt_d›
 ++;

180 if(
´ediù_Ãxt_d›
 >ð
¥p
->
luns_³r_ch
){

181 
´ediù_Ãxt_d›
 = 0;

184 if(
Ãxt
->
g
.
ch
 =ð
´ediù_Ãxt_ch
 &&‚ext->g.
lun
 =ð
´ediù_Ãxt_d›
){

185 *
·ge_couÁ”
 = 
çl£
;

189 *
·ge_couÁ”
 =
Œue
;

191 
	}
}

193 
boÞ
 
	$phäag_check
(
nvmev_dev
 * 
dev
){

194 
nvmev_cÚfig
 *
cfg
 = &
dev
->
cÚfig
;

195 
nvmev_ns
 *
ns
 = 
dev
->ns;

196 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

197 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

199 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

201 
ušt64_t
 
lba
 = 
cfg
->
šput_lba
;

202 
ušt64_t
 
Ä_lba
 = 
cfg
->
lba_Ën
;

203 
ušt64_t
 
¡¬t_Ín
 = 
lba
 / 
¥p
->
£cs_³r_pg
;

204 
ušt64_t
 
’d_Ín
 = (
lba
 + 
Ä_lba
 -1è/
¥p
->
£cs_³r_pg
;

206 
ušt64_t
 
Ín
;

207 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

208 
ušt32_t
 
i
;

209 
ušt64_t
 
couÁ
 = 0;

210 
µa
 
´ev_µa
;

211 
ušt64_t
 
tÙ®_µa
 = 0;

212 
boÞ
 
·ge_couÁ”
 = 
çl£
;

215 
	`NVMEV_ASSERT
(
cÚv_áls
);

216 
ušt64_t
 
w
=0;

218 if((
’d_Ín
 / 
Ä_·¹s
è>ð
¥p
->
‰_pgs
){

219 
	`NVMEV_ERROR
("lpn…assed FTL„ange in…hfrag");

220  
çl£
;

223 
ušt64_t
 
loÿl_Ín
;

224 
µa
 
cur_µa
;

225 
i
=0; (i<
Ä_·¹s
è&&(
¡¬t_Ín
 <ð
’d_Ín
); i++, start_lpn++){

226 
ušt64_t
 
šdex
 = 
¡¬t_Ín
 % 
Ä_·¹s
;

227 
cÚv_ál
 = &
cÚv_áls
[
šdex
];

229 
´ev_µa
 = 
cÚv_ál
->
m­tbl
[
¡¬t_Ín
 / 
Ä_·¹s
];

231 
Ín
 = 
¡¬t_Ín
;†² <ð
’d_Ín
;†² +ð
Ä_·¹s
){

232 
ušt64_t
 
loÿl_Ín
;

233 
µa
 
cur_µa
;

235 
loÿl_Ín
 = 
Ín
 / 
Ä_·¹s
;

237 
cur_µa
 = 
cÚv_ál
->
m­tbl
[
loÿl_Ín
];

239 if(
	`is_Ãxt_cÜ»ù
(
cÚv_ál
,&
´ev_µa
, &
cur_µa
,&
·ge_couÁ”
))

241 if(
·ge_couÁ”
)

242 
couÁ
++;

245 
couÁ
++;

248 
tÙ®_µa
+=1;

249 
´ev_µa
 = 
cur_µa
;

253 
cfg
->
couÁ
 += count;

255  
Œue
;

257 
	}
}

259 
boÞ
 
	$ch_d›_check
(
nvmev_dev
 * 
dev
,
boÞ
 
checkpošt
){

260 
nvmev_cÚfig
 *
cfg
 = &
dev
->
cÚfig
;

261 
nvmev_ns
 *
ns
 = 
dev
->ns;

263 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

264 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

266 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

268 
ušt64_t
 
lba
 = 
cfg
->
šput_lba
;

269 
ušt64_t
 
Ä_lba
 = 
cfg
->
lba_Ën
;

271 
ušt64_t
 
¡¬t_Ín
 = 
lba
/
¥p
->
£cs_³r_pg
;

272 
ušt64_t
 
’d_Ín
 = (
lba
 + 
Ä_lba
 -1è/ 
¥p
->
£cs_³r_pg
;

274 
ušt64_t
 
Ín
;

275 
ušt64_t
 
n£cs_¡¬t
 = 
	`__g‘_w®lþock
(
dev
);

277 
ušt64_t
 
n£cs_com¶‘ed
, 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

278 
ušt32_t
 
xãr_size
, 
i
;

279 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

283 
µa
 
´ev_µa
;

284 
Çnd_cmd
 
¤d
 = {

285 .
¡ime
 = 
n£cs_¡¬t
,

286 .
ty³
 = 
USER_IO
,

287 .
š‹¾—ve_pci_dma
 = 
Œue
,

290 
	`NVMEV_ASSERT
(
cÚv_áls
);

291 ià((
’d_Ín
 / 
Ä_·¹s
è>ð
¥p
->
‰_pgs
) {

292 
	`NVMEV_ERROR
("%s:†²…as£d FTL„ªg(¡¬t_Ín=%Îd >t_pgs=%ld)\n", 
__func__
,

293 
¡¬t_Ín
, 
¥p
->
‰_pgs
);

294  
çl£
;

297 ià(
	`LBA_TO_BYTE
(
Ä_lba
è<ð(
	`KB
(4è* 
Ä_·¹s
)) {

298 
¤d
.
¡ime
 +ð
¥p
->
fw_4kb_rd_Ït
;

300 
¤d
.
¡ime
 +ð
¥p
->
fw_rd_Ït
;

303 
i
 = 0; (˜< 
Ä_·¹s
è&& (
¡¬t_Ín
 <ð
’d_Ín
); i++, start_lpn++) {

304 
cÚv_ál
 = &
cÚv_áls
[
¡¬t_Ín
 % 
Ä_·¹s
];

305 
xãr_size
 = 0;

306 
´ev_µa
 = 
cÚv_ál
->
m­tbl
[
¡¬t_Ín
 / 
Ä_·¹s
];

308 
Ín
 = 
¡¬t_Ín
;†² <ð
’d_Ín
;†² +ð
Ä_·¹s
) {

309 
ušt64_t
 
loÿl_Ín
;

310 
µa
 
cur_µa
;

312 
loÿl_Ín
 = 
Ín
 / 
Ä_·¹s
;

313 
cur_µa
 = 
cÚv_ál
->
m­tbl
[
loÿl_Ín
];

314 ià(!
	`m­³d_µa
(&
cur_µa
è|| !
	`v®id_µa
(
cÚv_ál
, &cur_ppa)) {

318 ià(
	`m­³d_µa
(&
´ev_µa
) &&

319 
	`is_§me_æash_·ge
(
cÚv_ál
, 
cur_µa
, 
´ev_µa
)) {

320 
xãr_size
 +ð
¥p
->
pgsz
;

324 ià(
xãr_size
 > 0) {

326 
¤d
.
xãr_size
 = xfer_size;

327 
¤d
.
µa
 = &
´ev_µa
;

329 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd_cÝy
(
cÚv_ál
->
ssd
, &
¤d
, 
cfg
, cfg->
fœ¡_io
);

330 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

333 
xãr_size
 = 
¥p
->
pgsz
;

334 
´ev_µa
 = 
cur_µa
;

337 ià(
xãr_size
 > 0) {

339 
¤d
.
xãr_size
 = xfer_size;

340 
¤d
.
µa
 = &
´ev_µa
;

342 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd_cÝy
(
cÚv_ál
->
ssd
, &
¤d
, 
cfg
,cfg->
fœ¡_io
);

343 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

347  
Œue
;

348 
	}
}

	@check_phfrag.h

1 #iâdeà
_NVMEVIRT_FRAG_H


2 
	#_NVMEVIRT_FRAG_H


	)

4 
	~"nvmev.h
"

5 
	~"cÚv_ál.h
"

6 
	~"ssd.h
"

7 
	~"chªÃl_mod–.h
"

8 
	~"pqueue/pqueue_lšked.h
"

10 
	#CH_MAX_MODEL_SIZE
 (1 * 
	`MB
(1))

	)

13 
	mPHFRAG
 = 0,

14 
	mCHDIE
 = 1,

17 
PHFRAG_INIT
(
nvmev
 *‚vmev);

18 
PHFRAG_EXIT
();

19 
boÞ
 
phäag_check
(
nvmev_dev
 * 
dev
);

20 
boÞ
 
ch_d›_check
(
nvmev_dev
 * 
dev
, boÞ 
checkpošt
);

	@conv_ftl.c

3 
	~<lšux/ktime.h
>

4 
	~<lšux/sched/þock.h
>

6 
	~"nvmev.h
"

7 
	~"cÚv_ál.h
"

9 
scheduË_š‹º®_Ý”©iÚ
(
sqid
, 
n£cs_rg‘
,

10 
bufãr
 *
wr™e_bufãr
, 
buffs_to_»Ëa£
,

11 
nvmev_dev
 *
nvmev_vdev
);

13 
šlše
 
boÞ
 
	$Ï¡_pg_š_wÜdlše
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

15 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

16  (
µa
->
g
.
pg
 % 
¥p
->
pgs_³r_ÚeshÙpg
) == (spp->pgs_per_oneshotpg - 1);

17 
	}
}

19 
boÞ
 
	$should_gc
(
cÚv_ál
 *conv_ftl)

21  (
cÚv_ál
->
lm
.
ä“_lše_út
 <ðcÚv_ál->
ý
.
gc_th»s_lšes
);

22 
	}
}

24 
šlše
 
boÞ
 
	$should_gc_high
(
cÚv_ál
 *conv_ftl)

26  
cÚv_ál
->
lm
.
ä“_lše_út
 <ðcÚv_ál->
ý
.
gc_th»s_lšes_high
;

27 
	}
}

29 
šlše
 
µa
 
	$g‘_m­tbl_’t
(
cÚv_ál
 *cÚv_ál, 
ušt64_t
 
Ín
)

31  
cÚv_ál
->
m­tbl
[
Ín
];

32 
	}
}

34 
šlše
 
	$£t_m­tbl_’t
(
cÚv_ál
 *cÚv_ál, 
ušt64_t
 
Ín
, 
µa
 *ppa)

36 
	`NVMEV_ASSERT
(
Ín
 < 
cÚv_ál
->
ssd
->
¥
.
‰_pgs
);

37 
cÚv_ál
->
m­tbl
[
Ín
] = *
µa
;

38 
	}
}

40 
ušt64_t
 
	$µa2pgidx
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

42 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

43 
ušt64_t
 
pgidx
;

45 
	`NVMEV_DEBUG_VERBOSE
("%s: ch:%d,†un:%d,…l:%d, blk:%d,…g:%d\n", 
__func__
, 
µa
->
g
.
ch
,

46 
µa
->
g
.
lun
,…·->g.
¶
,…·->g.
blk
,…·->g.
pg
);

48 
pgidx
 = 
µa
->
g
.
ch
 * 
¥p
->
pgs_³r_ch
 +…·->g.
lun
 * sµ->
pgs_³r_lun
 +

49 
µa
->
g
.
¶
 * 
¥p
->
pgs_³r_¶
 +…·->g.
blk
 * sµ->
pgs_³r_blk
 +…·->g.
pg
;

51 
	`NVMEV_ASSERT
(
pgidx
 < 
¥p
->
‰_pgs
);

53  
pgidx
;

54 
	}
}

56 
šlše
 
ušt64_t
 
	$g‘_rm­_’t
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

58 
ušt64_t
 
pgidx
 = 
	`µa2pgidx
(
cÚv_ál
, 
µa
);

60  
cÚv_ál
->
rm­
[
pgidx
];

61 
	}
}

64 
šlše
 
	$£t_rm­_’t
(
cÚv_ál
 *cÚv_ál, 
ušt64_t
 
Ín
, 
µa
 *ppa)

66 
ušt64_t
 
pgidx
 = 
	`µa2pgidx
(
cÚv_ál
, 
µa
);

68 
cÚv_ál
->
rm­
[
pgidx
] = 
Ín
;

69 
	}
}

71 
šlše
 
	$viùim_lše_cmp_´i
(
pqueue_´i_t
 
Ãxt
,…queue_´i_ˆ
cu¼
)

73  (
Ãxt
 > 
cu¼
);

74 
	}
}

76 
šlše
 
pqueue_´i_t
 
	$viùim_lše_g‘_´i
(*
a
)

78  ((
lše
 *)
a
)->
vpc
;

79 
	}
}

81 
šlše
 
	$viùim_lše_£t_´i
(*
a
, 
pqueue_´i_t
 
´i
)

83 ((
lše
 *)
a
)->
vpc
 = 
´i
;

84 
	}
}

86 
šlše
 
size_t
 
	$viùim_lše_g‘_pos
(*
a
)

88  ((
lše
 *)
a
)->
pos
;

89 
	}
}

91 
šlše
 
	$viùim_lše_£t_pos
(*
a
, 
size_t
 
pos
)

93 ((
lše
 *)
a
)->
pos
 =…os;

94 
	}
}

96 
šlše
 
	$cÚsume_wr™e_üed™
(
cÚv_ál
 *conv_ftl)

98 
cÚv_ál
->
wfc
.
wr™e_üed™s
--;

99 
	}
}

101 
fÜground_gc
(
cÚv_ál
 *conv_ftl);

103 
šlše
 
	$check_ªd_»fžl_wr™e_üed™
(
cÚv_ál
 *conv_ftl)

105 
wr™e_æow_cÚŒÞ
 *
wfc
 = &(
cÚv_ál
->wfc);

106 ià(
wfc
->
wr™e_üed™s
 <= 0) {

107 
	`fÜground_gc
(
cÚv_ál
);

109 
wfc
->
wr™e_üed™s
 +ðwfc->
üed™s_to_»fžl
;

111 
	}
}

113 
	$š™_lšes
(
cÚv_ál
 *conv_ftl)

115 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

116 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

117 
lše
 *line;

118 
i
;

120 
lm
->
‰_lšes
 = 
¥p
->
blks_³r_¶
;

121 
	`NVMEV_ASSERT
(
lm
->
‰_lšes
 =ð
¥p
->tt_lines);

122 
lm
->
lšes
 = 
	`vm®loc
((
lše
è*†m->
‰_lšes
);

124 
	`INIT_LIST_HEAD
(&
lm
->
ä“_lše_li¡
);

125 
	`INIT_LIST_HEAD
(&
lm
->
fuÎ_lše_li¡
);

127 
lm
->
viùim_lše_pq
 = 
	`pqueue_š™
(
¥p
->
‰_lšes
, 
viùim_lše_cmp_´i
, 
viùim_lše_g‘_´i
,

128 
viùim_lše_£t_´i
, 
viùim_lše_g‘_pos
,

129 
viùim_lše_£t_pos
);

131 
lm
->
ä“_lše_út
 = 0;

132 
i
 = 0; i < 
lm
->
‰_lšes
; i++) {

133 
lm
->
lšes
[
i
] = (
lše
){

134 .
id
 = 
i
,

135 .
c
 = 0,

136 .
vpc
 = 0,

137 .
pos
 = 0,

138 .
’Œy
 = 
	`LIST_HEAD_INIT
(
lm
->
lšes
[
i
].entry),

142 
	`li¡_add_ž
(&
lm
->
lšes
[
i
].
’Œy
, &lm->
ä“_lše_li¡
);

143 
lm
->
ä“_lše_út
++;

146 
	`NVMEV_ASSERT
(
lm
->
ä“_lše_út
 =ðlm->
‰_lšes
);

147 
lm
->
viùim_lše_út
 = 0;

148 
lm
->
fuÎ_lše_út
 = 0;

149 
	}
}

151 
	$»move_lšes
(
cÚv_ál
 *conv_ftl)

153 
lše
 *
node
, *
tmp
;

154 
lše
 *
node_2
, *
tmp_2
;

155 
	`pqueue_ä“
(
cÚv_ál
->
lm
.
viùim_lše_pq
);

156 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
tmp
, &
cÚv_ál
->
lm
.
ä“_lše_li¡
, 
’Œy
) {

157 
	`li¡_d–_š™
(&
node
->
’Œy
);

159 
	`li¡_fÜ_—ch_’Œy_§ã
(
node_2
, 
tmp_2
, &
cÚv_ál
->
lm
.
fuÎ_lše_li¡
, 
’Œy
) {

160 
	`li¡_d–_š™
(&
node
->
’Œy
);

162 
	`vä“
(
cÚv_ál
->
lm
.
lšes
);

164 
	}
}

166 
	$š™_wr™e_æow_cÚŒÞ
(
cÚv_ál
 *conv_ftl)

168 
wr™e_æow_cÚŒÞ
 *
wfc
 = &(
cÚv_ál
->wfc);

169 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

171 
wfc
->
wr™e_üed™s
 = 
¥p
->
pgs_³r_lše
;

172 
wfc
->
üed™s_to_»fžl
 = 
¥p
->
pgs_³r_lše
;

173 
	}
}

175 
šlše
 
	$check_addr
(
a
, 
max
)

179 
	`NVMEV_ASSERT
(
a
 >ð0 &&‡ < 
max
);

180 
	}
}

182 
lše
 *
	$g‘_Ãxt_ä“_lše
(
cÚv_ál
 *conv_ftl)

184 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

185 
lše
 *
cu¾še
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
lm
->
ä“_lše_li¡
, lše, 
’Œy
);

187 ià(!
cu¾še
) {

188 
	`NVMEV_ERROR
("No free†ine†eft in VIRT !!!!\n");

189  
NULL
;

192 
	`li¡_d–_š™
(&
cu¾še
->
’Œy
);

193 
lm
->
ä“_lše_út
--;

194 
	`NVMEV_DEBUG
("%s: f»e_lše_úˆ%d\n", 
__func__
, 
lm
->
ä“_lše_út
);

195  
cu¾še
;

196 
	}
}

198 
wr™e_poš‹r
 *
	$__g‘_wp
(
cÚv_ál
 *
ál
, 
ušt32_t
 
io_ty³
)

200 ià(
io_ty³
 =ð
USER_IO
) {

201  &
ál
->
wp
;

202 } ià(
io_ty³
 =ð
GC_IO
) {

203  &
ál
->
gc_wp
;

206 
	`NVMEV_ASSERT
(0);

207  
NULL
;

208 
	}
}

210 
	$´•¬e_wr™e_poš‹r
(
cÚv_ál
 *cÚv_ál, 
ušt32_t
 
io_ty³
)

212 
wr™e_poš‹r
 *
wp
 = 
	`__g‘_wp
(
cÚv_ál
, 
io_ty³
);

213 
lše
 *
cu¾še
 = 
	`g‘_Ãxt_ä“_lše
(
cÚv_ál
);

215 
	`NVMEV_ASSERT
(
wp
);

216 
	`NVMEV_ASSERT
(
cu¾še
);

219 *
wp
 = (
wr™e_poš‹r
){

220 .
cu¾še
 = curline,

221 .
ch
 = 0,

222 .
lun
 = 0,

223 .
pg
 = 0,

224 .
blk
 = 
cu¾še
->
id
,

225 .
¶
 = 0,

227 
	}
}

229 
	$advªû_wr™e_poš‹r
(
cÚv_ál
 *cÚv_ál, 
ušt32_t
 
io_ty³
)

231 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

232 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

233 
wr™e_poš‹r
 *
wµ
 = 
	`__g‘_wp
(
cÚv_ál
, 
io_ty³
);

235 
	`NVMEV_DEBUG_VERBOSE
("cu¼’ˆwµ: ch:%d,†un:%d,…l:%d, blk:%d,…g:%d\n", 
wµ
->
ch
, wµ->
lun
,

236 
wµ
->
¶
, wµ->
blk
, wµ->
pg
);

238 if(
io_ty³
==
USER_IO
){

239 
ušt64_t
 
idx
 = 
wµ
->
ch
 * 
¥p
->
luns_³r_ch
 + wµ->
lun
;

242 
	`check_addr
(
cÚv_ál
->
·ge_couÁ”
[
idx
], 
¥p
->
pgs_³r_blk
);

243 
cÚv_ál
->
·ge_couÁ”
[
idx
]++;

244 ià((
cÚv_ál
->
·ge_couÁ”
[
idx
] % 
¥p
->
pgs_³r_ÚeshÙpg
) != 0)

245 
out
;

247 
¡¬t_ch
 = 
wµ
->
ch
;

248 
¡¬t_lun
 = 
wµ
->
lun
;

251 
	`check_addr
(
wµ
->
ch
, 
¥p
->
nchs
);

252 
wµ
->
ch
++;

253 ià(
wµ
->
ch
 =ð
¥p
->
nchs
){

254 
wµ
->
ch
=0;

255 
	`check_addr
(
wµ
->
lun
, 
¥p
->
luns_³r_ch
);

256 
wµ
->
lun
++;

257 ià(
wµ
->
lun
 =ð
¥p
->
luns_³r_ch
){

258 
wµ
->
lun
=0;

262 
idx
 = 
wµ
->
ch
 * 
¥p
->
luns_³r_ch
 + wµ->
lun
;

263 ià(
cÚv_ál
->
·ge_couÁ”
[
idx
] < 
¥p
->
pgs_³r_blk
) {

264 
out
;

267 } 
wµ
->
ch
 !ð
¡¬t_ch
 || wµ->
lun
 !ð
¡¬t_lun
);

268 
ušt64_t
 
i
,
j
;

270 
i
 = 0; i < 
¥p
->
nchs
; i++) {

271 
j
 = 0; j < 
¥p
->
luns_³r_ch
; j++) {

272 
ušt64_t
 
»£t_idx
 = 
i
 * 
¥p
->
luns_³r_ch
 + 
j
;

273 
	`NVMEV_ASSERT
(
cÚv_ál
->
·ge_couÁ”
[
»£t_idx
] =ð
¥p
->
pgs_³r_blk
);

274 
cÚv_ál
->
·ge_couÁ”
[
»£t_idx
] = 0;

278 ià(
wµ
->
cu¾še
->
vpc
 =ð
¥p
->
pgs_³r_lše
) {

279 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
c
 == 0);

280 
	`li¡_add_ž
(&
wµ
->
cu¾še
->
’Œy
, &
lm
->
fuÎ_lše_li¡
);

281 
lm
->
fuÎ_lše_út
++;

282 
	`NVMEV_DEBUG_VERBOSE
("wpp: move†ineo full_line_list\n");

284 
	`NVMEV_DEBUG_VERBOSE
("wpp:†ine is movedo victim†ist\n");

285 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
vpc
 >ð0 && wµ->cu¾še->vpø< 
¥p
->
pgs_³r_lše
);

286 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
c
 > 0);

287 
	`pqueue_š£¹
(
lm
->
viùim_lše_pq
, 
wµ
->
cu¾še
);

288 
lm
->
viùim_lše_út
++;

290 
	`check_addr
(
wµ
->
blk
, 
¥p
->
blks_³r_¶
);

291 
wµ
->
cu¾še
 = 
	`g‘_Ãxt_ä“_lše
(
cÚv_ál
);

292 
	`NVMEV_DEBUG_VERBOSE
("wµ: gÙ‚ew cËª†š%d\n", 
wµ
->
cu¾še
->
id
);

294 
wµ
->
blk
 = wµ->
cu¾še
->
id
;

295 
wµ
->
ch
=0;

296 
wµ
->
lun
=0;

297 
wµ
->
¶
=0;

298 
	`check_addr
(
wµ
->
blk
, 
¥p
->
blks_³r_¶
);

300 
	`NVMEV_ASSERT
(
cÚv_ál
->
·ge_couÁ”
[0] == 0);

301 
	`NVMEV_ASSERT
(
wµ
->
lun
 == 0);

302 
	`NVMEV_ASSERT
(
wµ
->
ch
 == 0);

303 
	`NVMEV_ASSERT
(
wµ
->
¶
 == 0);

304 
out
:

305 
idx
 = 
wµ
->
ch
 * 
¥p
->
luns_³r_ch
 + wµ->
lun
;

306 
wµ
->
pg
 = 
cÚv_ál
->
·ge_couÁ”
[
idx
];

307 
	`NVMEV_DEBUG_VERBOSE
("advanced wpp: ch:%d,†un:%d,…l:%d, blk:%d,…g:%d (curline %d)\n",

308 
wµ
->
ch
, wµ->
lun
, wµ->
¶
, wµ->
blk
, wµ->
pg
, wµ->
cu¾še
->
id
);

311 
	`check_addr
(
wµ
->
pg
, 
¥p
->
pgs_³r_blk
);

312 
wµ
->
pg
++;

313 ià((
wµ
->
pg
 % 
¥p
->
pgs_³r_ÚeshÙpg
) != 0)

314 
gcout
;

316 
wµ
->
pg
 -ð
¥p
->
pgs_³r_ÚeshÙpg
;

317 
	`check_addr
(
wµ
->
ch
, 
¥p
->
nchs
);

318 
wµ
->
ch
++;

319 ià(
wµ
->
ch
 !ð
¥p
->
nchs
)

320 
gcout
;

322 
wµ
->
ch
 = 0;

323 
	`check_addr
(
wµ
->
lun
, 
¥p
->
luns_³r_ch
);

324 
wµ
->
lun
++;

325 ià(
wµ
->
lun
 !ð
¥p
->
luns_³r_ch
)

326 
gcout
;

328 
wµ
->
lun
 = 0;

329 
wµ
->
pg
 +ð
¥p
->
pgs_³r_ÚeshÙpg
;

330 ià(
wµ
->
pg
 !ð
¥p
->
pgs_³r_blk
)

331 
gcout
;

333 
wµ
->
pg
 = 0;

334 ià(
wµ
->
cu¾še
->
vpc
 =ð
¥p
->
pgs_³r_lše
) {

335 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
c
 == 0);

336 
	`li¡_add_ž
(&
wµ
->
cu¾še
->
’Œy
, &
lm
->
fuÎ_lše_li¡
);

337 
lm
->
fuÎ_lše_út
++;

338 
	`NVMEV_DEBUG_VERBOSE
("wpp: move†ineo full_line_list\n");

340 
	`NVMEV_DEBUG_VERBOSE
("wpp:†ine is movedo victim†ist\n");

341 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
vpc
 >ð0 && wµ->cu¾še->vpø< 
¥p
->
pgs_³r_lše
);

342 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
c
 > 0);

343 
	`pqueue_š£¹
(
lm
->
viùim_lše_pq
, 
wµ
->
cu¾še
);

344 
lm
->
viùim_lše_út
++;

346 
	`check_addr
(
wµ
->
blk
, 
¥p
->
blks_³r_¶
);

347 
wµ
->
cu¾še
 = 
	`g‘_Ãxt_ä“_lše
(
cÚv_ál
);

348 
	`NVMEV_DEBUG_VERBOSE
("wµ: gÙ‚ew cËª†š%d\n", 
wµ
->
cu¾še
->
id
);

350 
wµ
->
blk
 = wµ->
cu¾še
->
id
;

351 
	`check_addr
(
wµ
->
blk
, 
¥p
->
blks_³r_¶
);

353 
	`NVMEV_ASSERT
(
wµ
->
pg
 == 0);

354 
	`NVMEV_ASSERT
(
wµ
->
lun
 == 0);

355 
	`NVMEV_ASSERT
(
wµ
->
ch
 == 0);

356 
	`NVMEV_ASSERT
(
wµ
->
¶
 == 0);

357 
gcout
:

358 
	`NVMEV_DEBUG_VERBOSE
("advanced wpp: ch:%d,†un:%d,…l:%d, blk:%d,…g:%d (curline %d)\n",

359 
wµ
->
ch
, wµ->
lun
, wµ->
¶
, wµ->
blk
, wµ->
pg
, wµ->
cu¾še
->
id
);

422 
	}
}

424 
µa
 
	$g‘_Ãw_·ge
(
cÚv_ál
 *cÚv_ál, 
ušt32_t
 
io_ty³
)

426 
µa
…pa;

427 
wr™e_poš‹r
 *
wp
 = 
	`__g‘_wp
(
cÚv_ál
, 
io_ty³
);

429 
µa
.ppa = 0;

430 
µa
.
g
.
ch
 = 
wp
->ch;

431 
µa
.
g
.
lun
 = 
wp
->lun;

432 
µa
.
g
.
pg
 = 
wp
->pg;

433 
µa
.
g
.
blk
 = 
wp
->blk;

434 
µa
.
g
.
¶
 = 
wp
->pl;

437 
	`NVMEV_ASSERT
(
µa
.
g
.
¶
 == 0);

439  
µa
;

440 
	}
}

442 
	$š™_m­tbl
(
cÚv_ál
 *conv_ftl)

444 
i
;

445 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

447 
cÚv_ál
->
m­tbl
 = 
	`vm®loc
((
µa
è* 
¥p
->
‰_pgs
);

448 
i
 = 0; i < 
¥p
->
‰_pgs
; i++) {

449 
cÚv_ál
->
m­tbl
[
i
].
µa
 = 
UNMAPPED_PPA
;

451 
	}
}

453 
	$»move_m­tbl
(
cÚv_ál
 *conv_ftl)

455 
	`vä“
(
cÚv_ál
->
m­tbl
);

456 
	}
}

458 
	$š™_rm­
(
cÚv_ál
 *conv_ftl)

460 
i
;

461 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

463 
cÚv_ál
->
rm­
 = 
	`vm®loc
((
ušt64_t
è* 
¥p
->
‰_pgs
);

464 
i
 = 0; i < 
¥p
->
‰_pgs
; i++) {

465 
cÚv_ál
->
rm­
[
i
] = 
INVALID_LPN
;

467 
	}
}

469 
	$»move_rm­
(
cÚv_ál
 *conv_ftl)

471 
	`vä“
(
cÚv_ál
->
rm­
);

472 
	}
}

474 
	$cÚv_š™_ál
(
cÚv_ál
 *cÚv_ál, 
cÚv·¿ms
 *
ýp
, 
ssd
 *ssd)

477 
cÚv_ál
->
ý
 = *
ýp
;

479 
cÚv_ál
->
ssd
 = ssd;

482 
	`š™_m­tbl
(
cÚv_ál
);

485 
	`š™_rm­
(
cÚv_ál
);

488 
	`š™_lšes
(
cÚv_ál
);

491 
	`´•¬e_wr™e_poš‹r
(
cÚv_ál
, 
USER_IO
);

492 
	`´•¬e_wr™e_poš‹r
(
cÚv_ál
, 
GC_IO
);

494 
	`š™_wr™e_æow_cÚŒÞ
(
cÚv_ál
);

497 
	`NVMEV_INFO
("In™ FTL in¡ªû w™h %d chªÃl (%ld…ages)\n", 
cÚv_ál
->
ssd
->
¥
.
nchs
,

498 
cÚv_ál
->
ssd
->
¥
.
‰_pgs
);

501 
	}
}

503 
	$cÚv_»move_ál
(
cÚv_ál
 *conv_ftl)

505 
	`»move_lšes
(
cÚv_ál
);

506 
	`»move_rm­
(
cÚv_ál
);

507 
	`»move_m­tbl
(
cÚv_ál
);

508 
	}
}

510 
	$cÚv_š™_·¿ms
(
cÚv·¿ms
 *
ýp
)

512 
ýp
->
Ý_¬—_pûÁ
 = 
CONV_OP_AREA_PERCENT
;

513 
ýp
->
gc_th»s_lšes
 = 2;

514 
ýp
->
gc_th»s_lšes_high
 = 2;

515 
ýp
->
’abË_gc_d–ay
 = 1;

516 
ýp
->
pba_pûÁ
 = ()((1.0 + cµ->
Ý_¬—_pûÁ
) * 100);

517 
	}
}

519 
	$cÚv_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

520 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
)

522 
ssd·¿ms
 
¥p
;

523 
cÚv·¿ms
 
ýp
;

524 
cÚv_ál
 *
cÚv_áls
;

525 
ssd
 *ssd;

526 
ušt32_t
 
i
;

528 
ns
->
Ä_·¹s
 = 
ál_cfgs
->
SSD_PARTITIONS
;

530 
	`ssd_š™_·¿ms
(&
¥p
, 
size
, 
ns
->
Ä_·¹s
, 
ál_cfgs
);

531 
	`cÚv_š™_·¿ms
(&
ýp
);

533 
cÚv_áls
 = 
	`km®loc
((
cÚv_ál
è* 
ns
->
Ä_·¹s
, 
GFP_KERNEL
);

535 
i
 = 0; i < 
ns
->
Ä_·¹s
; i++) {

536 
ssd
 = 
	`km®loc
((ssd), 
GFP_KERNEL
);

537 
	`ssd_š™
(
ssd
, &
¥p
, 
ýu_Ä_di¥©ch”
);

538 
	`cÚv_š™_ál
(&
cÚv_áls
[
i
], &
ýp
, 
ssd
);

539 
cÚv_áls
[
i
].
·ge_couÁ”
ð
	`vz®loc
((
št64_t
è* 
¥p
.
nchs
 * sµ.
luns_³r_ch
);

540 
ssd
->
p_ns
 = 
ns
;

541 
ssd
->
checkšg
=
çl£
;

545 
i
 = 1; i < 
ns
->
Ä_·¹s
; i++) {

546 
	`kä“
(
cÚv_áls
[
i
].
ssd
->
pc›
->
³rf_mod–
);

547 
	`kä“
(
cÚv_áls
[
i
].
ssd
->
pc›
);

548 
	`kä“
(
cÚv_áls
[
i
].
ssd
->
wr™e_bufãr
);

550 
cÚv_áls
[
i
].
ssd
->
pc›
 = conv_ftls[0].ssd->pcie;

551 
cÚv_áls
[
i
].
ssd
->
wr™e_bufãr
 = conv_ftls[0].ssd->write_buffer;

554 
ns
->
id
 = id;

555 
ns
->
csi
 = 
NVME_CSI_NVM
;

557 
ns
->
áls
 = (*)
cÚv_áls
;

558 
ns
->
size
 = (
ušt64_t
)((siz* 100è/ 
ýp
.
pba_pûÁ
);

559 
ns
->
m­³d
 = 
m­³d_addr
;

561 
ns
->
´oc_io_cmd
 = 
cÚv_´oc_nvme_io_cmd
;

563 
	`NVMEV_INFO
("FTL…hysical space: %lld,†ogical space: %lld (physical/logical * 100 = %d)\n",

564 
size
, 
ns
->size, 
ýp
.
pba_pûÁ
);

567 
	}
}

569 
	$cÚv_»move_Çme¥aû
(
nvmev_ns
 *
ns
)

571 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

572 cÚ¡ 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

573 
ušt32_t
 
i
;

576 
i
 = 1; i < 
Ä_·¹s
; i++) {

581 
cÚv_áls
[
i
].
ssd
->
pc›
 = 
NULL
;

582 
cÚv_áls
[
i
].
ssd
->
wr™e_bufãr
 = 
NULL
;

583 
	`vä“
(
cÚv_áls
[
i
].
·ge_couÁ”
);

586 
i
 = 0; i < 
Ä_·¹s
; i++) {

587 
	`cÚv_»move_ál
(&
cÚv_áls
[
i
]);

588 
	`ssd_»move
(
cÚv_áls
[
i
].
ssd
);

589 
	`kä“
(
cÚv_áls
[
i
].
ssd
);

592 
	`kä“
(
cÚv_áls
);

593 
ns
->
áls
 = 
NULL
;

594 
	}
}

596 
šlše
 
boÞ
 
	$v®id_µa
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

598 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

599 
ch
 = 
µa
->
g
.ch;

600 
lun
 = 
µa
->
g
.lun;

601 
¶
 = 
µa
->
g
.pl;

602 
blk
 = 
µa
->
g
.blk;

603 
pg
 = 
µa
->
g
.pg;

606 ià(
ch
 < 0 || ch >ð
¥p
->
nchs
)

607  
çl£
;

608 ià(
lun
 < 0 ||†uÀ>ð
¥p
->
luns_³r_ch
)

609  
çl£
;

610 ià(
¶
 < 0 ||…È>ð
¥p
->
¶s_³r_lun
)

611  
çl£
;

612 ià(
blk
 < 0 || blk >ð
¥p
->
blks_³r_¶
)

613  
çl£
;

614 ià(
pg
 < 0 ||…g >ð
¥p
->
pgs_³r_blk
)

615  
çl£
;

617  
Œue
;

618 
	}
}

620 
šlše
 
boÞ
 
	$v®id_Ín
(
cÚv_ál
 *cÚv_ál, 
ušt64_t
 
Ín
)

622  (
Ín
 < 
cÚv_ál
->
ssd
->
¥
.
‰_pgs
);

623 
	}
}

625 
šlše
 
boÞ
 
	$m­³d_µa
(
µa
 *ppa)

627  !(
µa
->µ¨=ð
UNMAPPED_PPA
);

628 
	}
}

630 
šlše
 
lše
 *
	$g‘_lše
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

632  &(
cÚv_ál
->
lm
.
lšes
[
µa
->
g
.
blk
]);

633 
	}
}

636 
	$m¬k_·ge_šv®id
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

638 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

639 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

640 
Çnd_block
 *
blk
 = 
NULL
;

641 
Çnd_·ge
 *
pg
 = 
NULL
;

642 
boÞ
 
was_fuÎ_lše
 = 
çl£
;

643 
lše
 *line;

646 
pg
 = 
	`g‘_pg
(
cÚv_ál
->
ssd
, 
µa
);

647 
	`NVMEV_ASSERT
(
pg
->
¡©us
 =ð
PG_VALID
);

648 
pg
->
¡©us
 = 
PG_INVALID
;

651 
blk
 = 
	`g‘_blk
(
cÚv_ál
->
ssd
, 
µa
);

652 
	`NVMEV_ASSERT
(
blk
->
c
 >ð0 && blk->ø< 
¥p
->
pgs_³r_blk
);

653 
blk
->
c
++;

654 
	`NVMEV_ASSERT
(
blk
->
vpc
 > 0 && blk->vpø<ð
¥p
->
pgs_³r_blk
);

655 
blk
->
vpc
--;

658 
lše
 = 
	`g‘_lše
(
cÚv_ál
, 
µa
);

659 
	`NVMEV_ASSERT
(
lše
->
c
 >ð0 &&†še->ø< 
¥p
->
pgs_³r_lše
);

660 ià(
lše
->
vpc
 =ð
¥p
->
pgs_³r_lše
) {

661 
	`NVMEV_ASSERT
(
lše
->
c
 == 0);

662 
was_fuÎ_lše
 = 
Œue
;

664 
lše
->
c
++;

665 
	`NVMEV_ASSERT
(
lše
->
vpc
 > 0 &&†še->vpø<ð
¥p
->
pgs_³r_lše
);

667 ià(
lše
->
pos
) {

669 
	`pqueue_chªge_´iÜ™y
(
lm
->
viùim_lše_pq
, 
lše
->
vpc
 - 1,†ine);

671 
lše
->
vpc
--;

674 ià(
was_fuÎ_lše
) {

676 
	`li¡_d–_š™
(&
lše
->
’Œy
);

677 
lm
->
fuÎ_lše_út
--;

678 
	`pqueue_š£¹
(
lm
->
viùim_lše_pq
, 
lše
);

679 
lm
->
viùim_lše_út
++;

681 
	}
}

683 
	$m¬k_·ge_v®id
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

685 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

686 
Çnd_block
 *
blk
 = 
NULL
;

687 
Çnd_·ge
 *
pg
 = 
NULL
;

688 
lše
 *line;

691 
pg
 = 
	`g‘_pg
(
cÚv_ál
->
ssd
, 
µa
);

692 
	`NVMEV_ASSERT
(
pg
->
¡©us
 =ð
PG_FREE
);

693 
pg
->
¡©us
 = 
PG_VALID
;

696 
blk
 = 
	`g‘_blk
(
cÚv_ál
->
ssd
, 
µa
);

697 
	`NVMEV_ASSERT
(
blk
->
vpc
 >ð0 && blk->vpø< 
¥p
->
pgs_³r_blk
);

698 
blk
->
vpc
++;

701 
lše
 = 
	`g‘_lše
(
cÚv_ál
, 
µa
);

702 
	`NVMEV_ASSERT
(
lše
->
vpc
 >ð0 &&†še->vpø< 
¥p
->
pgs_³r_lše
);

703 
lše
->
vpc
++;

704 
	}
}

706 
	$m¬k_block_ä“
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

708 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

709 
Çnd_block
 *
blk
 = 
	`g‘_blk
(
cÚv_ál
->
ssd
, 
µa
);

710 
Çnd_·ge
 *
pg
 = 
NULL
;

711 
i
;

713 
i
 = 0; i < 
¥p
->
pgs_³r_blk
; i++) {

715 
pg
 = &
blk
->pg[
i
];

716 
	`NVMEV_ASSERT
(
pg
->
n£cs
 =ð
¥p
->
£cs_³r_pg
);

717 
pg
->
¡©us
 = 
PG_FREE
;

721 
	`NVMEV_ASSERT
(
blk
->
Ågs
 =ð
¥p
->
pgs_³r_blk
);

722 
blk
->
c
 = 0;

723 
blk
->
vpc
 = 0;

724 
blk
->
”a£_út
++;

725 
	}
}

727 
	$gc_»ad_·ge
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

729 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

730 
cÚv·¿ms
 *
ýp
 = &
cÚv_ál
->
ý
;

732 ià(
ýp
->
’abË_gc_d–ay
) {

733 
Çnd_cmd
 
gü
 = {

734 .
ty³
 = 
GC_IO
,

735 .
cmd
 = 
NAND_READ
,

736 .
¡ime
 = 0,

737 .
xãr_size
 = 
¥p
->
pgsz
,

738 .
š‹¾—ve_pci_dma
 = 
çl£
,

739 .
µa
 =…pa,

741 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
gü
);

743 
	}
}

746 
ušt64_t
 
	$gc_wr™e_·ge
(
cÚv_ál
 *cÚv_ál, 
µa
 *
Þd_µa
)

748 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

749 
cÚv·¿ms
 *
ýp
 = &
cÚv_ál
->
ý
;

750 
µa
 
Ãw_µa
;

751 
ušt64_t
 
Ín
 = 
	`g‘_rm­_’t
(
cÚv_ál
, 
Þd_µa
);

753 
	`NVMEV_ASSERT
(
	`v®id_Ín
(
cÚv_ál
, 
Ín
));

754 
Ãw_µa
 = 
	`g‘_Ãw_·ge
(
cÚv_ál
, 
GC_IO
);

756 
	`£t_m­tbl_’t
(
cÚv_ál
, 
Ín
, &
Ãw_µa
);

758 
	`£t_rm­_’t
(
cÚv_ál
, 
Ín
, &
Ãw_µa
);

760 
	`m¬k_·ge_v®id
(
cÚv_ál
, &
Ãw_µa
);

763 
	`advªû_wr™e_poš‹r
(
cÚv_ál
, 
GC_IO
);

765 ià(
ýp
->
’abË_gc_d–ay
) {

766 
Çnd_cmd
 
gcw
 = {

767 .
ty³
 = 
GC_IO
,

768 .
cmd
 = 
NAND_NOP
,

769 .
¡ime
 = 0,

770 .
š‹¾—ve_pci_dma
 = 
çl£
,

771 .
µa
 = &
Ãw_µa
,

773 ià(
	`Ï¡_pg_š_wÜdlše
(
cÚv_ál
, &
Ãw_µa
)) {

774 
gcw
.
cmd
 = 
NAND_WRITE
;

775 
gcw
.
xãr_size
 = 
¥p
->
pgsz
 * sµ->
pgs_³r_ÚeshÙpg
;

778 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
gcw
);

783 
Ãw_ch
 = 
	`g‘_ch
(
cÚv_ál
, &
Ãw_µa
);

784 
Ãw_ch
->
gc_’dtime
 =‚ew_ch->
Ãxt_ch_avaž_time
;

786 
Ãw_lun
 = 
	`g‘_lun
(
cÚv_ál
, &
Ãw_µa
);

787 
Ãw_lun
->
gc_’dtime
 =‚ew_lun->
Ãxt_lun_avaž_time
;

791 
	}
}

793 
lše
 *
	$£Ëù_viùim_lše
(
cÚv_ál
 *cÚv_ál, 
boÞ
 
fÜû
)

795 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

796 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

797 
lše
 *
viùim_lše
 = 
NULL
;

799 
viùim_lše
 = 
	`pqueue_³ek
(
lm
->
viùim_lše_pq
);

800 ià(!
viùim_lše
) {

801  
NULL
;

804 ià(!
fÜû
 && (
viùim_lše
->
vpc
 > (
¥p
->
pgs_³r_lše
 / 8))) {

805  
NULL
;

808 
	`pqueue_pÝ
(
lm
->
viùim_lše_pq
);

809 
viùim_lše
->
pos
 = 0;

810 
lm
->
viùim_lše_út
--;

813  
viùim_lše
;

814 
	}
}

817 
	$þ—n_Úe_block
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

819 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

820 
Çnd_·ge
 *
pg_™”
 = 
NULL
;

821 
út
 = 0;

822 
pg
;

824 
pg
 = 0;…g < 
¥p
->
pgs_³r_blk
;…g++) {

825 
µa
->
g
.
pg
 =…g;

826 
pg_™”
 = 
	`g‘_pg
(
cÚv_ál
->
ssd
, 
µa
);

828 
	`NVMEV_ASSERT
(
pg_™”
->
¡©us
 !ð
PG_FREE
);

829 ià(
pg_™”
->
¡©us
 =ð
PG_VALID
) {

830 
	`gc_»ad_·ge
(
cÚv_ál
, 
µa
);

832 
	`gc_wr™e_·ge
(
cÚv_ál
, 
µa
);

833 
út
++;

837 
	`NVMEV_ASSERT
(
	`g‘_blk
(
cÚv_ál
->
ssd
, 
µa
)->
vpc
 =ð
út
);

838 
	}
}

841 
	$þ—n_Úe_æashpg
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

843 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

844 
cÚv·¿ms
 *
ýp
 = &
cÚv_ál
->
ý
;

845 
Çnd_·ge
 *
pg_™”
 = 
NULL
;

846 
út
 = 0, 
i
 = 0;

847 
ušt64_t
 
com¶‘ed_time
 = 0;

848 
µa
 
µa_cÝy
 = *ppa;

850 
i
 = 0; i < 
¥p
->
pgs_³r_æashpg
; i++) {

851 
pg_™”
 = 
	`g‘_pg
(
cÚv_ál
->
ssd
, &
µa_cÝy
);

853 
	`NVMEV_ASSERT
(
pg_™”
->
¡©us
 !ð
PG_FREE
);

854 ià(
pg_™”
->
¡©us
 =ð
PG_VALID
)

855 
út
++;

857 
µa_cÝy
.
g
.
pg
++;

860 
µa_cÝy
 = *
µa
;

862 ià(
út
 <= 0)

865 ià(
ýp
->
’abË_gc_d–ay
) {

866 
Çnd_cmd
 
gü
 = {

867 .
ty³
 = 
GC_IO
,

868 .
cmd
 = 
NAND_READ
,

869 .
¡ime
 = 0,

870 .
xãr_size
 = 
¥p
->
pgsz
 * 
út
,

871 .
š‹¾—ve_pci_dma
 = 
çl£
,

872 .
µa
 = &
µa_cÝy
,

874 
com¶‘ed_time
 = 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
gü
);

877 
i
 = 0; i < 
¥p
->
pgs_³r_æashpg
; i++) {

878 
pg_™”
 = 
	`g‘_pg
(
cÚv_ál
->
ssd
, &
µa_cÝy
);

881 ià(
pg_™”
->
¡©us
 =ð
PG_VALID
) {

883 
	`gc_wr™e_·ge
(
cÚv_ál
, &
µa_cÝy
);

886 
µa_cÝy
.
g
.
pg
++;

888 
	}
}

890 
	$m¬k_lše_ä“
(
cÚv_ál
 *cÚv_ál, 
µa
 *ppa)

892 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

893 
lše
 *lšð
	`g‘_lše
(
cÚv_ál
, 
µa
);

894 
lše
->
c
 = 0;

895 
lše
->
vpc
 = 0;

897 
	`li¡_add_ž
(&
lše
->
’Œy
, &
lm
->
ä“_lše_li¡
);

898 
lm
->
ä“_lše_út
++;

899 
	}
}

901 
	$do_gc
(
cÚv_ál
 *cÚv_ál, 
boÞ
 
fÜû
)

903 
lše
 *
viùim_lše
 = 
NULL
;

904 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

905 
µa
…pa;

906 
æashpg
;

908 
viùim_lše
 = 
	`£Ëù_viùim_lše
(
cÚv_ál
, 
fÜû
);

909 ià(!
viùim_lše
) {

913 
µa
.
g
.
blk
 = 
viùim_lše
->
id
;

914 
	`NVMEV_DEBUG_VERBOSE
("GC-šg†še:%d,c=%d(%d),viùim=%d,fuÎ=%d,ä“=%d\n", 
µa
.
g
.
blk
,

915 
viùim_lše
->
c
, viùim_lše->
vpc
, 
cÚv_ál
->
lm
.
viùim_lše_út
,

916 
cÚv_ál
->
lm
.
fuÎ_lše_út
, cÚv_ál->lm.
ä“_lše_út
);

918 
cÚv_ál
->
wfc
.
üed™s_to_»fžl
 = 
viùim_lše
->
c
;

921 
æashpg
 = 0; fÏshpg < 
¥p
->
æashpgs_³r_blk
; flashpg++) {

922 
ch
, 
lun
;

924 
µa
.
g
.
pg
 = 
æashpg
 * 
¥p
->
pgs_³r_æashpg
;

925 
ch
 = 0; ch < 
¥p
->
nchs
; ch++) {

926 
lun
 = 0;†uÀ< 
¥p
->
luns_³r_ch
;†un++) {

927 
Çnd_lun
 *
luÅ
;

929 
µa
.
g
.
ch
 = ch;

930 
µa
.
g
.
lun
 =†un;

931 
µa
.
g
.
¶
 = 0;

932 
luÅ
 = 
	`g‘_lun
(
cÚv_ál
->
ssd
, &
µa
);

933 
	`þ—n_Úe_æashpg
(
cÚv_ál
, &
µa
);

935 ià(
æashpg
 =ð(
¥p
->
æashpgs_³r_blk
 - 1)) {

936 
cÚv·¿ms
 *
ýp
 = &
cÚv_ál
->
ý
;

938 
	`m¬k_block_ä“
(
cÚv_ál
, &
µa
);

940 ià(
ýp
->
’abË_gc_d–ay
) {

941 
Çnd_cmd
 
gû
 = {

942 .
ty³
 = 
GC_IO
,

943 .
cmd
 = 
NAND_ERASE
,

944 .
¡ime
 = 0,

945 .
š‹¾—ve_pci_dma
 = 
çl£
,

946 .
µa
 = &ppa,

948 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
gû
);

951 
luÅ
->
gc_’dtime
 =†uÅ->
Ãxt_lun_avaž_time
;

958 
	`m¬k_lše_ä“
(
cÚv_ál
, &
µa
);

961 
	}
}

963 
	$fÜground_gc
(
cÚv_ál
 *conv_ftl)

965 ià(
	`should_gc_high
(
cÚv_ál
)) {

966 
	`NVMEV_DEBUG_VERBOSE
("should_gc_high…assed");

968 
	`do_gc
(
cÚv_ál
, 
Œue
);

970 
	}
}

972 
boÞ
 
	$is_§me_æash_·ge
(
cÚv_ál
 *cÚv_ál, 
µa
 
µa1
, µ¨
µa2
)

974 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

975 
ušt32_t
 
µa1_·ge
 = 
µa1
.
g
.
pg
 / 
¥p
->
pgs_³r_æashpg
;

976 
ušt32_t
 
µa2_·ge
 = 
µa2
.
g
.
pg
 / 
¥p
->
pgs_³r_æashpg
;

978  (
µa1
.
h
.
blk_š_ssd
 =ð
µa2
.h.blk_š_ssdè&& (
µa1_·ge
 =ð
µa2_·ge
);

979 
	}
}

981 
boÞ
 
	$cÚv_»ad
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

983 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

984 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

986 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

988 
nvme_commªd
 *
cmd
 = 
»q
->cmd;

989 
ušt64_t
 
lba
 = 
cmd
->
rw
.
¦ba
;

990 
ušt64_t
 
Ä_lba
 = (
cmd
->
rw
.
Ëngth
 + 1);

991 
ušt64_t
 
¡¬t_Ín
 = 
lba
 / 
¥p
->
£cs_³r_pg
;

992 
ušt64_t
 
’d_Ín
 = (
lba
 + 
Ä_lba
 - 1è/ 
¥p
->
£cs_³r_pg
;

993 
ušt64_t
 
Ín
;

994 
ušt64_t
 
n£cs_¡¬t
 = 
»q
->nsecs_start;

995 
ušt64_t
 
n£cs_com¶‘ed
, 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

996 
ušt32_t
 
xãr_size
, 
i
,
q
,
w
;

997 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

998 
ssd
 *ssd;

1000 
q
=0;q < 
ns
->
Ä_·¹s
; q++){

1001 
ssd
 = 
cÚv_áls
[
q
].ssd;

1002 
w
=0; w < 
¥p
->
nchs
; w++){

1003 
i
=0; i < 
ssd
->
ch
[
w
].
Æuns
; i++){

1004 
ssd
->
ch
[
w
].
lun
[
i
].
fœ¡_io
 = 
çl£
;

1008 
µa
 
´ev_µa
;

1009 
Çnd_cmd
 
¤d
 = {

1010 .
ty³
 = 
USER_IO
,

1011 .
cmd
 = 
NAND_READ
,

1012 .
¡ime
 = 
n£cs_¡¬t
,

1013 .
š‹¾—ve_pci_dma
 = 
Œue
,

1016 
	`NVMEV_ASSERT
(
cÚv_áls
);

1017 
	`NVMEV_DEBUG_VERBOSE
("%s: s¹_Ín=%Îd,†’=%Îd,ƒnd_Ín=%Îd", 
__func__
, 
¡¬t_Ín
,

1018 
Ä_lba
, 
’d_Ín
);

1019 ià((
’d_Ín
 / 
Ä_·¹s
è>ð
¥p
->
‰_pgs
) {

1020 
	`NVMEV_ERROR
("%s:†²…as£d FTL„ªg(¡¬t_Ín=%Îd >t_pgs=%ld)\n", 
__func__
,

1021 
¡¬t_Ín
, 
¥p
->
‰_pgs
);

1022  
çl£
;

1025 ià(
	`LBA_TO_BYTE
(
Ä_lba
è<ð(
	`KB
(4è* 
Ä_·¹s
)) {

1026 
¤d
.
¡ime
 +ð
¥p
->
fw_4kb_rd_Ït
;

1028 
¤d
.
¡ime
 +ð
¥p
->
fw_rd_Ït
;

1032 
i
 = 0; (˜< 
Ä_·¹s
è&& (
¡¬t_Ín
 <ð
’d_Ín
); i++, start_lpn++) {

1033 
cÚv_ál
 = &
cÚv_áls
[
¡¬t_Ín
 % 
Ä_·¹s
];

1034 
xãr_size
 = 0;

1035 
´ev_µa
 = 
	`g‘_m­tbl_’t
(
cÚv_ál
, 
¡¬t_Ín
 / 
Ä_·¹s
);

1038 
Ín
 = 
¡¬t_Ín
;†² <ð
’d_Ín
;†² +ð
Ä_·¹s
) {

1039 
ušt64_t
 
loÿl_Ín
;

1040 
µa
 
cur_µa
;

1042 
loÿl_Ín
 = 
Ín
 / 
Ä_·¹s
;

1043 
cur_µa
 = 
	`g‘_m­tbl_’t
(
cÚv_ál
, 
loÿl_Ín
);

1044 ià(!
	`m­³d_µa
(&
cur_µa
è|| !
	`v®id_µa
(
cÚv_ál
, &cur_ppa)) {

1045 
	`NVMEV_DEBUG_VERBOSE
("lpn 0x%llx‚ot mappedo valid…pa\n",

1046 
loÿl_Ín
);

1047 
	`NVMEV_DEBUG_VERBOSE
("Invalid…pa,ch:%d,lun:%d,blk:%d,pl:%d,pg:%d\n",

1048 
cur_µa
.
g
.
ch
, cur_µa.g.
lun
, cur_µa.g.
blk
,

1049 
cur_µa
.
g
.
¶
, cur_µa.g.
pg
);

1054 ià(
	`m­³d_µa
(&
´ev_µa
) &&

1055 
	`is_§me_æash_·ge
(
cÚv_ál
, 
cur_µa
, 
´ev_µa
)) {

1056 
xãr_size
 +ð
¥p
->
pgsz
;

1060 ià(
xãr_size
 > 0) {

1061 
¤d
.
xãr_size
 = xfer_size;

1062 
¤d
.
µa
 = &
´ev_µa
;

1064 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
¤d
);

1065 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

1068 
xãr_size
 = 
¥p
->
pgsz
;

1069 
´ev_µa
 = 
cur_µa
;

1073 ià(
xãr_size
 > 0) {

1074 
¤d
.
xãr_size
 = xfer_size;

1075 
¤d
.
µa
 = &
´ev_µa
;

1077 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
¤d
);

1078 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

1082 
»t
->
n£cs_rg‘
 = 
n£cs_Ï‹¡
;

1083 
»t
->
¡©us
 = 
NVME_SC_SUCCESS
;

1084  
Œue
;

1085 
	}
}

1087 
boÞ
 
	$cÚv_wr™e
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

1089 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

1090 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

1093 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

1094 
bufãr
 *
wbuf
 = 
cÚv_ál
->
ssd
->
wr™e_bufãr
;

1096 
nvme_commªd
 *
cmd
 = 
»q
->cmd;

1097 
ušt64_t
 
lba
 = 
cmd
->
rw
.
¦ba
;

1098 
ušt64_t
 
Ä_lba
 = (
cmd
->
rw
.
Ëngth
 + 1);

1099 
ušt64_t
 
¡¬t_Ín
 = 
lba
 / 
¥p
->
£cs_³r_pg
;

1100 
ušt64_t
 
’d_Ín
 = (
lba
 + 
Ä_lba
 - 1è/ 
¥p
->
£cs_³r_pg
;

1102 
ušt64_t
 
Ín
;

1103 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

1105 
ušt64_t
 
n£cs_Ï‹¡
;

1106 
ušt64_t
 
n£cs_xãr_com¶‘ed
;

1107 
ušt32_t
 
®loÿ‹d_buf_size
;

1109 
Çnd_cmd
 
swr
 = {

1110 .
ty³
 = 
USER_IO
,

1111 .
cmd
 = 
NAND_WRITE
,

1112 .
š‹¾—ve_pci_dma
 = 
çl£
,

1113 .
xãr_size
 = 
¥p
->
pgsz
 * sµ->
pgs_³r_ÚeshÙpg
,

1116 
	`NVMEV_DEBUG_VERBOSE
("%s: s¹_Ín=%Îd,†’=%Îd,ƒnd_Ín=%Îd", 
__func__
, 
¡¬t_Ín
,

1117 
Ä_lba
,
’d_Ín
);

1118 ià((
’d_Ín
 / 
Ä_·¹s
è>ð
¥p
->
‰_pgs
) {

1119 
	`NVMEV_ERROR
("%s:†²…as£d FTL„ªg(¡¬t_Ín=%Îd >t_pgs=%ld)\n", 
__func__
,

1120 
¡¬t_Ín
, 
¥p
->
‰_pgs
);

1121  
çl£
;

1124 
®loÿ‹d_buf_size
 = 
	`bufãr_®loÿ‹
(
wbuf
, 
	`LBA_TO_BYTE
(
Ä_lba
));

1125 ià(
®loÿ‹d_buf_size
 < 
	`LBA_TO_BYTE
(
Ä_lba
))

1126  
çl£
;

1128 
n£cs_Ï‹¡
 = 
	`ssd_advªû_wr™e_bufãr
(
cÚv_ál
->
ssd
, 
»q
->
n£cs_¡¬t
,

1129 
	`LBA_TO_BYTE
(
Ä_lba
), 
Œªsãr_4
);

1130 
n£cs_xãr_com¶‘ed
 = 
n£cs_Ï‹¡
;

1132 
swr
.
¡ime
 = 
n£cs_Ï‹¡
;

1134 
Ín
 = 
¡¬t_Ín
;†² <ð
’d_Ín
;†pn++) {

1135 
ušt64_t
 
loÿl_Ín
;

1136 
ušt64_t
 
n£cs_com¶‘ed
 = 0;

1137 
µa
…pa;

1139 
cÚv_ál
 = &
cÚv_áls
[
Ín
 % 
Ä_·¹s
];

1140 
loÿl_Ín
 = 
Ín
 / 
Ä_·¹s
;

1141 
µa
 = 
	`g‘_m­tbl_’t
(

1142 
cÚv_ál
, 
loÿl_Ín
);

1143 ià(
	`m­³d_µa
(&
µa
)) {

1145 
	`m¬k_·ge_šv®id
(
cÚv_ál
, &
µa
);

1146 
	`£t_rm­_’t
(
cÚv_ál
, 
INVALID_LPN
, &
µa
);

1147 
	`NVMEV_DEBUG
("%s: %Îd i šv®id, ", 
__func__
, 
	`µa2pgidx
(
cÚv_ál
, &
µa
));

1151 
µa
 = 
	`g‘_Ãw_·ge
(
cÚv_ál
, 
USER_IO
);

1153 
	`£t_m­tbl_’t
(
cÚv_ál
, 
loÿl_Ín
, &
µa
);

1154 
	`NVMEV_DEBUG
("%s: gÙ‚ew…· %Îd, ", 
__func__
, 
	`µa2pgidx
(
cÚv_ál
, &
µa
));

1156 
	`£t_rm­_’t
(
cÚv_ál
, 
loÿl_Ín
, &
µa
);

1158 
	`m¬k_·ge_v®id
(
cÚv_ál
, &
µa
);

1161 
	`advªû_wr™e_poš‹r
(
cÚv_ál
, 
USER_IO
);

1164 ià(
	`Ï¡_pg_š_wÜdlše
(
cÚv_ál
, &
µa
)) {

1165 
swr
.
µa
 = &ppa;

1167 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd
(
cÚv_ál
->
ssd
, &
swr
);

1168 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

1170 
	`scheduË_š‹º®_Ý”©iÚ
(
»q
->
sq_id
, 
n£cs_com¶‘ed
, 
wbuf
,

1171 
¥p
->
pgs_³r_ÚeshÙpg
 * sµ->
pgsz
, 
ns
->
p_dev
);

1174 
	`cÚsume_wr™e_üed™
(
cÚv_ál
);

1175 
	`check_ªd_»fžl_wr™e_üed™
(
cÚv_ál
);

1178 ià((
cmd
->
rw
.
cÚŒÞ
 & 
NVME_RW_FUA
è|| (
¥p
->
wr™e_—¾y_com¶‘iÚ
 == 0)) {

1180 
»t
->
n£cs_rg‘
 = 
n£cs_Ï‹¡
;

1183 
»t
->
n£cs_rg‘
 = 
n£cs_xãr_com¶‘ed
;

1185 
»t
->
¡©us
 = 
NVME_SC_SUCCESS
;

1187  
Œue
;

1188 
	}
}

1190 
	$cÚv_æush
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

1192 
ušt64_t
 
¡¬t
, 
Ï‹¡
;

1193 
ušt32_t
 
i
;

1194 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

1196 
¡¬t
 = 
	`loÿl_þock
();

1197 
Ï‹¡
 = 
¡¬t
;

1198 
i
 = 0; i < 
ns
->
Ä_·¹s
; i++) {

1199 
Ï‹¡
 = 
	`max
Ö©e¡, 
	`ssd_Ãxt_idË_time
(
cÚv_áls
[
i
].
ssd
));

1202 
	`NVMEV_DEBUG_VERBOSE
("%s:†©’cy=%Îu\n", 
__func__
, 
Ï‹¡
 - 
¡¬t
);

1204 
»t
->
¡©us
 = 
NVME_SC_SUCCESS
;

1205 
»t
->
n£cs_rg‘
 = 
Ï‹¡
;

1207 
	}
}

1209 
boÞ
 
	$cÚv_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
,

1210 
nvmev_dev
 *
nvmev_vdev
)

1212 
nvme_commªd
 *
cmd
 = 
»q
->cmd;

1214 
	`NVMEV_ASSERT
(
ns
->
csi
 =ð
NVME_CSI_NVM
);

1216 
cmd
->
commÚ
.
Ýcode
) {

1217 
nvme_cmd_wr™e
:

1218 ià(!
	`cÚv_wr™e
(
ns
, 
»q
, 
»t
))

1219  
çl£
;

1221 
nvme_cmd_»ad
:

1222 ià(!
	`cÚv_»ad
(
ns
, 
»q
, 
»t
))

1223  
çl£
;

1225 
nvme_cmd_æush
:

1226 
	`cÚv_æush
(
ns
, 
»q
, 
»t
);

1229 
	`NVMEV_ERROR
("%s: commªd‚Ù im¶em’‹d: % (0x%x)\n", 
__func__
,

1230 
	`nvme_Ýcode_¡ršg
(
cmd
->
commÚ
.
Ýcode
), cmd->common.opcode);

1234  
Œue
;

1235 
	}
}

1236 
»wr™e_poš‹r
 * 
	$advªû_wr™e_poš‹r_þ—nv”
(
cÚv_ál
 *cÚv_ál, 
ušt64_t
 
deg»e
,
boÞ
 
no_»tuº
, * 
couÁ”
)

1238 
ušt32_t
 
io_ty³
=
USER_IO
;

1239 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

1240 
lše_mgmt
 *
lm
 = &
cÚv_ál
->lm;

1241 
wr™e_poš‹r
 *
wµ
 = 
	`__g‘_wp
(
cÚv_ál
, 
io_ty³
);

1242 
ušt32_t
 
¿ndom_v®ue
;

1243 
ušt64_t
 
idx
 = 
wµ
->
ch
 * 
¥p
->
luns_³r_ch
 + wµ->
lun
;

1244 
»wr™e_poš‹r
 * 
r
 = 
NULL
;

1246 
	`NVMEV_DEBUG_VERBOSE
("cu¼’ˆwµ: ch:%d,†un:%d,…l:%d, blk:%d,…g:%d\n", 
wµ
->
ch
, wµ->
lun
,

1247 
wµ
->
¶
, wµ->
blk
, wµ->
pg
);

1250 
	`check_addr
(
cÚv_ál
->
·ge_couÁ”
[
idx
], 
¥p
->
pgs_³r_blk
);

1251 
cÚv_ál
->
·ge_couÁ”
[
idx
]++;

1252 ià((
cÚv_ál
->
·ge_couÁ”
[
idx
] % 
¥p
->
pgs_³r_ÚeshÙpg
) != 0)

1253 
out
;

1255 (*
couÁ”
)++;

1257 
¿ndom_v®ue
 = 
	`g‘_¿ndom_št
() % 100 ;

1259 if(
deg»e
 > 
¿ndom_v®ue
){

1260 if(
cÚv_ál
->
·ge_couÁ”
[
idx
] >ð
¥p
->
pgs_³r_blk
){

1261 
r
 = 
	`vm®loc
((
»wr™e_poš‹r
));

1262 
r
->
ch
 = 
wµ
->ch;

1263 
r
->
lun
 = 
wµ
->lun;

1266 
out
;

1269 
¡¬t_ch
 = 
wµ
->
ch
;

1270 
¡¬t_lun
 = 
wµ
->
lun
;

1273 
	`check_addr
(
wµ
->
ch
, 
¥p
->
nchs
);

1274 
wµ
->
ch
++;

1275 ià(
wµ
->
ch
 =ð
¥p
->
nchs
){

1276 
wµ
->
ch
=0;

1277 
	`check_addr
(
wµ
->
lun
, 
¥p
->
luns_³r_ch
);

1278 
wµ
->
lun
++;

1279 ià(
wµ
->
lun
 =ð
¥p
->
luns_³r_ch
){

1280 
wµ
->
lun
=0;

1284 
idx
 = 
wµ
->
ch
 * 
¥p
->
luns_³r_ch
 + wµ->
lun
;

1285 ià(
cÚv_ál
->
·ge_couÁ”
[
idx
] < 
¥p
->
pgs_³r_blk
) {

1286 
out
;

1289 } 
wµ
->
ch
 !ð
¡¬t_ch
 || wµ->
lun
 !ð
¡¬t_lun
);

1290 
ušt64_t
 
i
,
j
;

1291 
i
 = 0; i < 
¥p
->
nchs
; i++) {

1292 
j
 = 0; j < 
¥p
->
luns_³r_ch
; j++) {

1293 
ušt64_t
 
»£t_idx
 = 
i
 * 
¥p
->
luns_³r_ch
 + 
j
;

1295 
	`NVMEV_ASSERT
(
cÚv_ál
->
·ge_couÁ”
[
»£t_idx
] =ð
¥p
->
pgs_³r_blk
);

1296 
cÚv_ál
->
·ge_couÁ”
[
»£t_idx
] = 0;

1301 ià(
wµ
->
cu¾še
->
vpc
 =ð
¥p
->
pgs_³r_lše
) {

1303 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
c
 == 0);

1304 
	`li¡_add_ž
(&
wµ
->
cu¾še
->
’Œy
, &
lm
->
fuÎ_lše_li¡
);

1305 
lm
->
fuÎ_lše_út
++;

1306 
	`NVMEV_DEBUG_VERBOSE
("wpp: move†ineo full_line_list\n");

1308 
	`NVMEV_DEBUG_VERBOSE
("wpp:†ine is movedo victim†ist\n");

1309 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
vpc
 >ð0 && wµ->cu¾še->vpø< 
¥p
->
pgs_³r_lše
);

1311 
	`NVMEV_ASSERT
(
wµ
->
cu¾še
->
c
 > 0);

1312 
	`pqueue_š£¹
(
lm
->
viùim_lše_pq
, 
wµ
->
cu¾še
);

1313 
lm
->
viùim_lše_út
++;

1315 
wµ
->
ch
=0;

1316 
wµ
->
lun
=0;

1318 
	`check_addr
(
wµ
->
blk
, 
¥p
->
blks_³r_¶
);

1319 
wµ
->
cu¾še
 = 
	`g‘_Ãxt_ä“_lše
(
cÚv_ál
);

1320 
	`NVMEV_DEBUG_VERBOSE
("wµ: gÙ‚ew cËª†š%d\n", 
wµ
->
cu¾še
->
id
);

1322 
wµ
->
blk
 = wµ->
cu¾še
->
id
;

1323 
	`check_addr
(
wµ
->
blk
, 
¥p
->
blks_³r_¶
);

1326 
	`NVMEV_ASSERT
(
cÚv_ál
->
·ge_couÁ”
[0] == 0);

1327 
	`NVMEV_ASSERT
(
wµ
->
lun
 == 0);

1328 
	`NVMEV_ASSERT
(
wµ
->
ch
 == 0);

1330 
	`NVMEV_ASSERT
(
wµ
->
¶
 == 0);

1331 
out
:

1332 
idx
 = 
wµ
->
ch
 * 
¥p
->
luns_³r_ch
 + wµ->
lun
;

1333 
wµ
->
pg
 = 
cÚv_ál
->
·ge_couÁ”
[
idx
];

1334 
	`NVMEV_DEBUG_VERBOSE
("advanced wpp: ch:%d,†un:%d,…l:%d, blk:%d,…g:%d (curline %d)\n",

1335 
wµ
->
ch
, wµ->
lun
, wµ->
¶
, wµ->
blk
, wµ->
pg
, wµ->
cu¾še
->
id
);

1336  
r
;

1337 
	}
}

1339 
»wr™e_poš‹r
 * 
	$phäag_þ—Ãr
(
nvmev_ns
 *
ns
, 
ušt64_t
 
¡¬t_Ín
,ušt64_ˆ
’d_Ín
,ušt64_ˆ
deg»e
,
li¡_h—d
 * 
´“m±_li¡
, 
idx
, 
boÞ
 
fÜû
, boÞ 
no_»tuº
,* 
cÚ
, 
num_li¡
, 
cur_chunk
){

1341 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

1342 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[
idx
];

1344 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

1346 
»wr™e_poš‹r
 * 
r
ð
NULL
;

1348 
ušt64_t
 
Ín
;

1349 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

1351 
lba_chunk_t
 * 
´em
;

1352 if(!
	`li¡_em±y
(&
´“m±_li¡
[
idx
 * 
num_li¡
 + 
cur_chunk
]è&& !
fÜû
){

1353 
´em
 = 
	`li¡_fœ¡_’Œy
(&
´“m±_li¡
[
idx
 * 
num_li¡
 + 
cur_chunk
], 
lba_chunk_t
, 
li¡
);

1356 
fÜû
=
Œue
;

1358 
Ín
 = 
¡¬t_Ín
;†² <ð
’d_Ín
;†²+=
Ä_·¹s
) {

1359 if(
fÜû
 =ð
çl£
 && 
no_»tuº
 == false){

1360 
wr™e_poš‹r
 *
wµ
 = 
	`__g‘_wp
(
cÚv_ál
, 
USER_IO
);

1361 if(
wµ
->
ch
 =ð
´em
->ch && wµ->
lun
 ==…rem->lun){

1362 
r
 = 
	`vm®loc
((
»wr™e_poš‹r
));

1363 
r
->
ch
 = -1;

1364 
r
->
lun
 = -1;

1365 
r
->
¡¬ošt
 = 
Ín
;

1366 
r
->
´“m±
 = 
Œue
;

1367  
r
;

1370 
ušt64_t
 
loÿl_Ín
;

1371 
µa
…pa;

1373 
loÿl_Ín
 = 
Ín
 / 
Ä_·¹s
;

1374 
µa
 = 
	`g‘_m­tbl_’t
(

1375 
cÚv_ál
, 
loÿl_Ín
);

1376 ià(
	`m­³d_µa
(&
µa
)) {

1377 
	`m¬k_·ge_šv®id
(
cÚv_ál
, &
µa
);

1378 
	`£t_rm­_’t
(
cÚv_ál
, 
INVALID_LPN
, &
µa
);

1379 
	`NVMEV_DEBUG
("%s: %Îd i šv®id, ", 
__func__
, 
	`µa2pgidx
(
cÚv_ál
, &
µa
));

1382 
µa
 = 
	`g‘_Ãw_·ge
(
cÚv_ál
, 
USER_IO
);

1384 
	`£t_m­tbl_’t
(
cÚv_ál
, 
loÿl_Ín
, &
µa
);

1385 
	`NVMEV_DEBUG
("%s: gÙ‚ew…· %Îd, ", 
__func__
, 
	`µa2pgidx
(
cÚv_ál
, &
µa
));

1387 
	`£t_rm­_’t
(
cÚv_ál
, 
loÿl_Ín
, &
µa
);

1389 
	`m¬k_·ge_v®id
(
cÚv_ál
, &
µa
);

1391 
r
 = 
	`advªû_wr™e_poš‹r_þ—nv”
(
cÚv_ál
,
deg»e
,
no_»tuº
,
cÚ
);

1393 
	`cÚsume_wr™e_üed™
(
cÚv_ál
);

1395 
	`check_ªd_»fžl_wr™e_üed™
(
cÚv_ál
);

1397 if(
r
 !ð
NULL
){

1398 
r
->
¡¬ošt
 = 
Ín
 + 
Ä_·¹s
;

1399 if(
r
->
¡¬ošt
 > 
’d_Ín
){

1400 
	`vä“
(
r
);

1401  
NULL
;

1403 
r
->
´“m±
 = 
çl£
;

1404  
r
;

1405 }if(*
cÚ
 >ð
¥p
->
max_cÚ
){

1406 if((
Ín
+
Ä_·¹s
è> 
’d_Ín
){

1407  
NULL
;

1409 
r
 = 
	`vm®loc
((
»wr™e_poš‹r
));

1410 
r
->
ch
 = -1;

1411 
r
->
lun
 = -1;

1412 
r
->
¡¬ošt
 = 
Ín
 + 
Ä_·¹s
;

1413 
r
->
´“m±
 = 
çl£
;

1414  
r
;

1417  
NULL
;

1418 
	}
}

1459 
	$»move_ál_shÜtcut
(
cÚv_ál
 *
cÚv_áls
, 
ušt64_t
 
Ä_·¹s
){

1460 
ušt32_t
 
i
;

1461 
i
=0; i < 
Ä_·¹s
;i++){

1462 
	`»move_lšes
(&
cÚv_áls
[
i
]);

1463 
	`»move_rm­
(&
cÚv_áls
[
i
]);

1464 
	`»move_m­tbl
(&
cÚv_áls
[
i
]);

1466 
	}
}

1467 
	$š™_ál_shÜtcut
(
cÚv_ál
 *
cÚv_áls
, 
ušt64_t
 
Ä_·¹s
){

1468 
ušt32_t
 
i
;

1469 
i
=0; i < 
Ä_·¹s
;i++){

1470 
	`š™_rm­
(&
cÚv_áls
[
i
]);

1471 
	`š™_m­tbl
(&
cÚv_áls
[
i
]);

1472 
	`š™_lšes
(&
cÚv_áls
[
i
]);

1473 
	`´•¬e_wr™e_poš‹r
(&
cÚv_áls
[
i
], 
USER_IO
);

1474 
	`´•¬e_wr™e_poš‹r
(&
cÚv_áls
[
i
], 
GC_IO
);

1475 
	`š™_wr™e_æow_cÚŒÞ
(&
cÚv_áls
[
i
]);

1477 
	}
}

	@conv_ftl.h

3 #iâdeà
_NVMEVIRT_CONV_FTL_H


4 
	#_NVMEVIRT_CONV_FTL_H


	)

6 
	~<lšux/ty³s.h
>

7 
	~<lšux/¿ndom.h
>

8 
	~"pqueue/pqueue.h
"

9 
	~"ssd_cÚfig.h
"

10 
	~"ssd.h
"

11 
	~"nvmev.h
"

13 
	scÚv·¿ms
 {

14 
ušt32_t
 
	mgc_th»s_lšes
;

15 
ušt32_t
 
	mgc_th»s_lšes_high
;

16 
boÞ
 
	m’abË_gc_d–ay
;

18 
	mÝ_¬—_pûÁ
;

19 
	mpba_pûÁ
;

22 
	slše
 {

23 
	mid
;

24 
	mc
;

25 
	mvpc
;

26 
li¡_h—d
 
	m’Œy
;

28 
size_t
 
	mpos
;

32 
	swr™e_poš‹r
 {

33 
lše
 *
	mcu¾še
;

34 
ušt32_t
 
	mch
;

35 
ušt32_t
 
	mlun
;

36 
ušt32_t
 
	mpg
;

37 
ušt32_t
 
	mblk
;

38 
ušt32_t
 
	m¶
;

41 
	slše_mgmt
 {

42 
lše
 *
	mlšes
;

45 
li¡_h—d
 
	mä“_lše_li¡
;

46 
pqueue_t
 *
	mviùim_lše_pq
;

47 
li¡_h—d
 
	mfuÎ_lše_li¡
;

49 
ušt32_t
 
	m‰_lšes
;

50 
ušt32_t
 
	mä“_lše_út
;

51 
ušt32_t
 
	mviùim_lše_út
;

52 
ušt32_t
 
	mfuÎ_lše_út
;

55 
	swr™e_æow_cÚŒÞ
 {

56 
ušt32_t
 
	mwr™e_üed™s
;

57 
ušt32_t
 
	müed™s_to_»fžl
;

60 
	scÚv_ál
 {

61 
ssd
 *
	mssd
;

63 
cÚv·¿ms
 
	mý
;

64 
µa
 *
	mm­tbl
;

65 
ušt64_t
 *
	mrm­
;

66 
wr™e_poš‹r
 
	mwp
;

67 
wr™e_poš‹r
 
	mgc_wp
;

68 
lše_mgmt
 
	mlm
;

69 
wr™e_æow_cÚŒÞ
 
	mwfc
;

71 
ušt64_t
 *
	m·ge_couÁ”
;

74 
	s»wr™e_poš‹r
 {

75 
	mch
;

76 
	mlun
;

77 
ušt64_t
 
	m¡¬ošt
;

78 
boÞ
 
	m´“m±
;

79 
	mcouÁ”
;

83 
ušt64_t
 
	m¡¬t_Ín
;

84 
ušt64_t
 
	m’d_Ín
;

85 
ušt64_t
 
	mdevide_size
;

86 
ušt64_t
 
	midx
;

88 
	mch
;

89 
	mlun
;

92 
ušt64_t
 
	msize
;

95 
li¡_h—d
 
	mli¡
;

96 
ušt64_t
 
	mÃxt_´oûss_Ín
;

98 
	mcouÁ”
;

100 } 
	tlba_chunk_t
;

102 
cÚv_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

103 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
);

105 
cÚv_»move_Çme¥aû
(
nvmev_ns
 *
ns
);

107 
boÞ
 
cÚv_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
,

108 
nvmev_dev
 *
nvmev_vdev
);

110 
»wr™e_poš‹r
 * 
phäag_þ—Ãr
(
nvmev_ns
 *
ns
, 
ušt64_t
 
¡¬t_Ín
,ušt64_ˆ
’d_Ín
,ušt64_ˆ
deg»e
,
li¡_h—d
 * 
´“m±_li¡
, 
idx
, 
boÞ
 
fÜû
, boÞ 
no_»tuº
, *
cÚ
, 
num_li¡
, 
cur_chunk
);

111 
cÚv_»move_ál
(
cÚv_ál
 *conv_ftl);

112 
»move_ál_shÜtcut
(
cÚv_ál
 *
cÚv_áls
, 
ušt64_t
 
Ä_·¹s
);

113 
š™_ál_shÜtcut
(
cÚv_ál
 *
cÚv_áls
, 
ušt64_t
 
Ä_·¹s
);

114 
cÚv_š™_ál
(
cÚv_ál
 *cÚv_ál, 
cÚv·¿ms
 *
ýp
, 
ssd
 *ssd);

	@dma.c

3 
	~<lšux/”r.h
>

4 
	~<lšux/d–ay.h
>

5 
	~<lšux/dma-m­pšg.h
>

6 
	~<lšux/dm«ngše.h
>

7 
	~<lšux/ä“z”.h
>

8 
	~<lšux/š™.h
>

9 
	~<lšux/sched/sk.h
>

10 
	~<lšux/¦ab.h
>

13 
	g‹¡_buf_size
 = 4096;

16 
	g‹¡_deviû
[32];

19 
	gmax_chªÃls
;

22 
	gtimeout
 = 3000;

25 
	gŒªsãr_size
 = 1024;

28 
boÞ
 
	gpÞËd
 = 
Œue
;

30 
	#CHANNEL_NAME_LEN
 20

	)

42 
	sißt_dma_·¿ms
 {

43 
	mbuf_size
;

44 
	mchªÃl
[
CHANNEL_NAME_LEN
];

45 
	mdeviû
[32];

46 
	mmax_chªÃls
;

47 
	mtimeout
;

48 
	mŒªsãr_size
;

49 
boÞ
 
	mpÞËd
;

61 
	sißt_dma_šfo
 {

63 
ißt_dma_·¿ms
 
	m·¿ms
;

66 
li¡_h—d
 
	mchªÃls
;

67 
	mÄ_chªÃls
;

68 
	mÏ¡_”rÜ
;

69 
mu‹x
 
	mlock
;

70 
boÞ
 
	mdid_š™
;

71 } 
	g‹¡_šfo
 = {

72 .
chªÃls
 = 
LIST_HEAD_INIT
(
‹¡_šfo
.channels),

73 .
	glock
 = 
__MUTEX_INITIALIZER
(
‹¡_šfo
.
lock
),

76 
	sißt_dma_th»ad
 {

77 
ißt_dma_šfo
 *
	mšfo
;

78 
dma_chª
 *
	mchª
;

79 
dma_Œª§ùiÚ_ty³
 
	mty³
;

82 
	sißt_dma_chª
 {

83 
li¡_h—d
 
	mnode
;

84 
dma_chª
 *
	mchª
;

85 
li¡_h—d
 
	mth»ads
;

88 
	g‹¡_chªÃl
[
CHANNEL_NAME_LEN
];

91 
	#MAX_ERROR_COUNT
 32

	)

93 
ißt_dma_th»ad
 
	gdma_th»ad
;

95 
boÞ
 
	$ißt_dma_m©ch_chªÃl
(
ißt_dma_·¿ms
 *
·¿ms
, 
dma_chª
 *
chª
)

97 ià(
·¿ms
->
chªÃl
[0] == '\0')

98  
Œue
;

99  
	`¡rcmp
(
	`dma_chª_Çme
(
chª
), 
·¿ms
->
chªÃl
) == 0;

100 
	}
}

102 
boÞ
 
	$ißt_dma_m©ch_deviû
(
ißt_dma_·¿ms
 *
·¿ms
, 
dma_deviû
 *
deviû
)

104 ià(
·¿ms
->
deviû
[0] == '\0')

105  
Œue
;

106  
	`¡rcmp
(
	`dev_Çme
(
deviû
->
dev
), 
·¿ms
->device) == 0;

107 
	}
}

109 
	$»suÉ
(cÚ¡ *
”r
, 
n
, 
dma_addr_t
 
¤c_addr
, dma_addr_ˆ
d¡_addr
,

110 
Ën
, 
d©a
)

112 
	`´_debug
("%s:„esult #%u: '%s' with src_addr=0x%llx dst_addr=0x%llx†en=0x%x (%ld)\n",

113 
cu¼’t
->
comm
, 
n
, 
”r
, 
¤c_addr
, 
d¡_addr
, 
Ën
, 
d©a
);

114 
	}
}

116 
	$ißt_dma_subm™
(
dma_addr_t
 
¤c_addr
, dma_addr_ˆ
d¡_addr
, 
size
)

118 
ißt_dma_th»ad
 *
th»ad
 = &
dma_th»ad
;

119 
ißt_dma_šfo
 *
šfo
;

120 
dma_chª
 *
chª
;

121 
dma_deviû
 *
dev
;

122 
dma_cook›_t
 
cook›
;

123 
dma_¡©us
 
¡©us
;

124 
dma_ù¾_æags
 
æags
 = 
DMA_CTRL_ACK
;

125 
»t
;

126 
i
;

127 
dma_async_tx_desütÜ
 *
tx
 = 
NULL
;

129 
	`£t_ä“zabË
();

131 
	`´_debug
("START: 0x%Îx -> 0x%Îx,†’: %d\n", 
¤c_addr
, 
d¡_addr
, 
size
);

133 
»t
 = -
ENOMEM
;

135 
	`smp_rmb
();

136 
šfo
 = 
th»ad
->info;

137 
chª
 = 
th»ad
->chan;

138 
dev
 = 
chª
->
deviû
;

141 
tx
 = 
dev
->
	`deviû_´•_dma_memýy
(
chª
, 
d¡_addr
, 
¤c_addr
, 
size
, 
æags
);

143 ià(!
tx
) {

144 
	`»suÉ
("´•ƒ¼Ü", 1, 
¤c_addr
, 
d¡_addr
, 
size
, 
»t
);

145 
	`m¦“p
(100);

146 
out
;

149 
cook›
 = 
tx
->
	`tx_subm™
(tx);

151 ià(
	`dma_subm™_”rÜ
(
cook›
)) {

152 
	`»suÉ
("subm™ƒ¼Ü", 1, 
¤c_addr
, 
d¡_addr
, 
size
, 
»t
);

153 
	`m¦“p
(100);

154 
out
;

158 
¡©us
 = 
	`dma_sync_wa™
(
chª
, 
cook›
);

159 
	`dm«ngše_‹rmš©e_sync
(
chª
);

161 ià(
¡©us
 !ð
DMA_COMPLETE
 &&

162 !(
	`dma_has_ÿp
(
DMA_COMPLETION_NO_ORDER
, 
dev
->
ÿp_mask
è&& 
¡©us
 =ð
DMA_OUT_OF_ORDER
)) {

163 
	`»suÉ
(
¡©us
 =ð
DMA_ERROR
 ? "completionƒrror status" : "completion busy status",

164 1, 
¤c_addr
, 
d¡_addr
, 
size
, 
»t
);

165 
out
;

168 
»t
 = 0;

170 
out
:

171 
	`´_debug
("DONE: 0x%Îx -> 0x%Îx,†’: %d\n", 
¤c_addr
, 
d¡_addr
, 
size
);

174 ià(
»t
)

175 
	`dm«ngše_‹rmš©e_sync
(
chª
);

177  
»t
;

178 
	}
}

180 
	$ißt_dma_add_chªÃl
(
ißt_dma_šfo
 *
šfo
, 
dma_chª
 *
chª
)

182 
ißt_dma_chª
 *
dtc
;

183 
dma_deviû
 *
dma_dev
 = 
chª
->
deviû
;

184 
th»ad_couÁ
 = 0;

186 
dtc
 = 
	`km®loc
((
ißt_dma_chª
), 
GFP_KERNEL
);

187 ià(!
dtc
) {

188 
	`´_w¬n
("NØmemÜy fÜ %s\n", 
	`dma_chª_Çme
(
chª
));

189  -
ENOMEM
;

192 
dtc
->
chª
 = chan;

193 
	`INIT_LIST_HEAD
(&
dtc
->
th»ads
);

195 ià(
	`dma_has_ÿp
(
DMA_COMPLETION_NO_ORDER
, 
dma_dev
->
ÿp_mask
è&& 
šfo
->
·¿ms
.
pÞËd
) {

196 
šfo
->
·¿ms
.
pÞËd
 = 
çl£
;

197 
	`´_w¬n
("DMA_COMPLETION_NO_ORDER,…olled disabled\n");

200 ià(
	`dma_has_ÿp
(
DMA_MEMCPY
, 
dma_dev
->
ÿp_mask
)) {

201 
	`´_šfo
("ioat_dma_add_threads\n");

202 
dma_th»ad
.
šfo
 = info;

203 
dma_th»ad
.
chª
 = 
dtc
->chan;

204 
dma_th»ad
.
ty³
 = 
DMA_MEMCPY
;

207 
	`´_šfo
("Added %uh»ad usšg %s\n", 
th»ad_couÁ
, 
	`dma_chª_Çme
(
chª
));

209 
	`li¡_add_ž
(&
dtc
->
node
, &
šfo
->
chªÃls
);

210 
šfo
->
Ä_chªÃls
++;

213 
	}
}

215 
boÞ
 
	$fž‹r
(
dma_chª
 *
chª
, *
·¿m
)

217  
	`ißt_dma_m©ch_chªÃl
(
·¿m
, 
chª
è&& 
	`ißt_dma_m©ch_deviû
Õ¬am, chª->
deviû
);

218 
	}
}

220 
	$»que¡_chªÃls
(
ißt_dma_šfo
 *
šfo
, 
dma_Œª§ùiÚ_ty³
 
ty³
)

222 
dma_ÿp_mask_t
 
mask
;

224 
	`dma_ÿp_z”o
(
mask
);

225 
	`dma_ÿp_£t
(
ty³
, 
mask
);

227 
ißt_dma_·¿ms
 *
·¿ms
 = &
šfo
->params;

228 
dma_chª
 *
chª
;

230 
chª
 = 
	`dma_»que¡_chªÃl
(
mask
, 
fž‹r
, 
·¿ms
);

231 ià(
chª
) {

232 ià(
	`ißt_dma_add_chªÃl
(
šfo
, 
chª
)) {

233 
	`dma_»Ëa£_chªÃl
(
chª
);

238 ià(
·¿ms
->
max_chªÃls
 && 
šfo
->
Ä_chªÃls
 >=…arams->max_channels)

241 
	}
}

243 
	$add_th»aded_dma
(
ißt_dma_šfo
 *
šfo
)

245 
ißt_dma_·¿ms
 *
·¿ms
 = &
šfo
->params;

248 
·¿ms
->
buf_size
 = 
‹¡_buf_size
;

249 
	`¡¾ýy
(
·¿ms
->
chªÃl
, 
	`¡rim
(
‹¡_chªÃl
), (params->channel));

250 
	`¡¾ýy
(
·¿ms
->
deviû
, 
	`¡rim
(
‹¡_deviû
), (params->device));

251 
·¿ms
->
max_chªÃls
 = max_channels;

252 
·¿ms
->
timeout
 =imeout;

253 
·¿ms
->
Œªsãr_size
 =ransfer_size;

254 
·¿ms
->
pÞËd
 =…olled;

256 
	`»que¡_chªÃls
(
šfo
, 
DMA_MEMCPY
);

257 
	}
}

259 
	$ißt_dma_chª_£t
(cÚ¡ *
v®
)

261 
ißt_dma_šfo
 *
šfo
 = &
‹¡_šfo
;

262 
ißt_dma_chª
 *
dtc
;

263 
»t
 = 0;

265 
	`BUG_ON
(
	`¡¾’
(
v®
è>ð
CHANNEL_NAME_LEN
);

267 
	`mu‹x_lock
(&
šfo
->
lock
);

268 
	`¡rýy
(
‹¡_chªÃl
, 
v®
);

271 
	`li¡_fÜ_—ch_’Œy
(
dtc
, &
šfo
->
chªÃls
, 
node
) {

272 ià(
	`¡rcmp
(
	`dma_chª_Çme
(
dtc
->
chª
), 
	`¡rim
(
‹¡_chªÃl
)) == 0) {

273 
dtc
 = 
	`li¡_Ï¡_’Œy
(&
šfo
->
chªÃls
, 
ißt_dma_chª
, 
node
);

274 
»t
 = -
EBUSY
;

275 
add_chª_”r
;

279 
	`add_th»aded_dma
(
šfo
);

282 ià(!
	`li¡_em±y
(&
šfo
->
chªÃls
)) {

289 
dtc
 = 
	`li¡_Ï¡_’Œy
(&
šfo
->
chªÃls
, 
ißt_dma_chª
, 
node
);

290 ià((
	`¡rcmp
(
	`dma_chª_Çme
(
dtc
->
chª
), 
	`¡rim
(
‹¡_chªÃl
)) != 0) &&

291 (
	`¡rcmp
("", 
	`¡rim
(
‹¡_chªÃl
)) != 0)) {

292 
»t
 = -
EINVAL
;

293 
	`´_”r
("ERROR oÀDMAƒngš%d\n", 
__LINE__
);

294 
add_chª_”r
;

299 
»t
 = -
EBUSY
;

300 
	`´_”r
("ERROR oÀDMAƒngš%d\n", 
__LINE__
);

301 
add_chª_”r
;

304 
šfo
->
Ï¡_”rÜ
 = 
»t
;

305 
	`mu‹x_uÆock
(&
šfo
->
lock
);

307  
»t
;

309 
add_chª_”r
:

310 
šfo
->
Ï¡_”rÜ
 = 
»t
;

311 
	`mu‹x_uÆock
(&
šfo
->
lock
);

313  
»t
;

314 
	}
}

316 
	$ißt_dma_þ—nup_chªÃl
(
ißt_dma_chª
 *
dtc
)

319 
	`dm«ngše_‹rmš©e_sync
(
dtc
->
chª
);

321 
	`kä“
(
dtc
);

322 
	}
}

324 
	$ißt_dma_þ—nup
()

326 
ißt_dma_šfo
 *
šfo
 = &
‹¡_šfo
;

328 
ißt_dma_chª
 *
dtc
, *
_dtc
;

329 
dma_chª
 *
chª
;

331 
	`li¡_fÜ_—ch_’Œy_§ã
(
dtc
, 
_dtc
, &
šfo
->
chªÃls
, 
node
) {

332 
	`li¡_d–
(&
dtc
->
node
);

333 
chª
 = 
dtc
->chan;

334 
	`ißt_dma_þ—nup_chªÃl
(
dtc
);

335 
	`´_debug
("drÝ³d chªÃÈ%s\n", 
	`dma_chª_Çme
(
chª
));

336 
	`dma_»Ëa£_chªÃl
(
chª
);

339 
šfo
->
Ä_chªÃls
 = 0;

340 
	}
}

	@dma.h

3 #iâdeà
_LIB_DMA_H


4 
	#_LIB_DMA_H


	)

7 
ißt_dma_chª_£t
(cÚ¡ *
v®
);

8 
ißt_dma_subm™
(
dma_addr_t
 
¤c_addr
, dma_addr_ˆ
d¡_addr
, 
size
);

9 
ißt_dma_þ—nup
();

	@io.c

3 
	~<lšux/kth»ad.h
>

4 
	~<lšux/ktime.h
>

5 
	~<lšux/highmem.h
>

6 
	~<lšux/sched/þock.h
>

8 
	~"nvmev.h
"

9 
	~"dma.h
"

11 #ià(
SUPPORTED_SSD_TYPE
(
CONV
è|| SUPPORTED_SSD_TYPE(
ZNS
))

12 
	~"ssd.h
"

14 
	gbufãr
;

17 #undeà
PERF_DEBUG


19 
	#sq_’Œy
(
’Œy_id
è
sq
->sq[
	`SQ_ENTRY_TO_PAGE_NUM
ÓÁry_id)][
	`SQ_ENTRY_TO_PAGE_OFFSET
ÓÁry_id)]

	)

20 
	#cq_’Œy
(
’Œy_id
è
cq
->cq[
	`CQ_ENTRY_TO_PAGE_NUM
ÓÁry_id)][
	`CQ_ENTRY_TO_PAGE_OFFSET
ÓÁry_id)]

	)

22 
boÞ
 
io_usšg_dma
;

24 
šlše
 
	$__g‘_io_wÜk”
(
sqid
, 
nvmev_dev
 *
nvmev_vdev
)

26 #ifdeà
CONFIG_NVMEV_IO_WORKER_BY_SQ


27  (
sqid
 - 1è% 
nvmev_vdev
->
cÚfig
.
Ä_io_wÜk”s
;

29  
nvmev_vdev
->
io_wÜk”_tuº
;

31 
	}
}

33 
šlše
 
	$__g‘_w®lþock
(
nvmev_dev
 *
nvmev_vdev
)

35  
	`ýu_þock
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
);

36 
	}
}

38 
	$__do_³rfÜm_io
(
sqid
, 
sq_’Œy
, 
nvmev_dev
 *
nvmev_vdev
)

40 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
sqid
];

41 
nvme_rw_commªd
 *
cmd
 = &
	`sq_’Œy
(
sq_’Œy
).
rw
;

42 
size_t
 
off£t
;

43 
size_t
 
Ëngth
, 
»maššg
;

44 
´p_offs
 = 0;

45 
´p2_offs
 = 0;

46 
u64
 
·ddr
;

47 
u64
 *
·ddr_li¡
 = 
NULL
;

48 
size_t
 
nsid
 = 
cmd
->nsid - 1;

50 
off£t
 = 
cmd
->
¦ba
 << 9;

51 
Ëngth
 = (
cmd
->length + 1) << 9;

52 
»maššg
 = 
Ëngth
;

54 
»maššg
) {

55 
size_t
 
io_size
;

56 *
vaddr
;

57 
size_t
 
mem_offs
 = 0;

59 
´p_offs
++;

60 ià(
´p_offs
 == 1) {

61 
·ddr
 = 
cmd
->
´p1
;

62 } ià(
´p_offs
 == 2) {

63 
·ddr
 = 
cmd
->
´p2
;

64 ià(
»maššg
 > 
PAGE_SIZE
) {

65 
·ddr_li¡
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
)) +

66 (
·ddr
 & 
PAGE_OFFSET_MASK
);

67 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

70 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

73 
vaddr
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
));

75 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

77 ià(
·ddr
 & 
PAGE_OFFSET_MASK
) {

78 
mem_offs
 = 
·ddr
 & 
PAGE_OFFSET_MASK
;

79 ià(
io_size
 + 
mem_offs
 > 
PAGE_SIZE
)

80 
io_size
 = 
PAGE_SIZE
 - 
mem_offs
;

83 ià(
cmd
->
Ýcode
 =ð
nvme_cmd_wr™e
 || cmd->Ýcod=ð
nvme_cmd_zÚe_­³nd
) {

84 
	`memýy
(
nvmev_vdev
->
ns
[
nsid
].
m­³d
 + 
off£t
, 
vaddr
 + 
mem_offs
, 
io_size
);

85 } ià(
cmd
->
Ýcode
 =ð
nvme_cmd_»ad
) {

86 
	`memýy
(
vaddr
 + 
mem_offs
, 
nvmev_vdev
->
ns
[
nsid
].
m­³d
 + 
off£t
, 
io_size
);

89 
	`kunm­_©omic
(
vaddr
);

91 
»maššg
 -ð
io_size
;

92 
off£t
 +ð
io_size
;

95 ià(
·ddr_li¡
 !ð
NULL
)

96 
	`kunm­_©omic
(
·ddr_li¡
);

98  
Ëngth
;

99 
	}
}

101 
u64
 
	g·ddr_li¡
[513] = {

104 
	$__do_³rfÜm_io_usšg_dma
(
sqid
, 
sq_’Œy
, 
nvmev_dev
 *
nvmev_vdev
)

106 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
sqid
];

107 
nvme_rw_commªd
 *
cmd
 = &
	`sq_’Œy
(
sq_’Œy
).
rw
;

108 
size_t
 
off£t
;

109 
size_t
 
Ëngth
, 
»maššg
;

110 
´p_offs
 = 0;

111 
´p2_offs
 = 0;

112 
num_´ps
 = 0;

113 
u64
 
·ddr
;

114 
u64
 *
tmp_·ddr_li¡
 = 
NULL
;

115 
size_t
 
io_size
;

116 
size_t
 
mem_offs
 = 0;

118 
off£t
 = 
cmd
->
¦ba
 << 9;

119 
Ëngth
 = (
cmd
->length + 1) << 9;

120 
»maššg
 = 
Ëngth
;

122 
	`mem£t
(
·ddr_li¡
, 0, (paddr_list));

124 
»maššg
) {

125 
io_size
 = 0;

127 
´p_offs
++;

128 ià(
´p_offs
 == 1) {

129 
·ddr_li¡
[
´p_offs
] = 
cmd
->
´p1
;

130 } ià(
´p_offs
 == 2) {

131 
·ddr_li¡
[
´p_offs
] = 
cmd
->
´p2
;

132 ià(
»maššg
 > 
PAGE_SIZE
) {

133 
tmp_·ddr_li¡
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr_li¡
[
´p_offs
])) +

134 (
·ddr_li¡
[
´p_offs
] & 
PAGE_OFFSET_MASK
);

135 
·ddr_li¡
[
´p_offs
] = 
tmp_·ddr_li¡
[
´p2_offs
++];

138 
·ddr_li¡
[
´p_offs
] = 
tmp_·ddr_li¡
[
´p2_offs
++];

141 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

143 ià(
·ddr_li¡
[
´p_offs
] & 
PAGE_OFFSET_MASK
) {

144 
mem_offs
 = 
·ddr_li¡
[
´p_offs
] & 
PAGE_OFFSET_MASK
;

145 ià(
io_size
 + 
mem_offs
 > 
PAGE_SIZE
)

146 
io_size
 = 
PAGE_SIZE
 - 
mem_offs
;

149 
»maššg
 -ð
io_size
;

151 
num_´ps
 = 
´p_offs
;

153 ià(
tmp_·ddr_li¡
 !ð
NULL
)

154 
	`kunm­_©omic
(
tmp_·ddr_li¡
);

156 
»maššg
 = 
Ëngth
;

157 
´p_offs
 = 1;

160 
»maššg
) {

161 
size_t
 
·ge_size
;

162 
mem_offs
 = 0;

163 
io_size
 = 0;

164 
·ge_size
 = 0;

166 
·ddr
 = 
·ddr_li¡
[
´p_offs
];

167 
·ge_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

170 ià(
·ddr
 & 
PAGE_OFFSET_MASK
) {

171 
mem_offs
 = 
·ddr
 & 
PAGE_OFFSET_MASK
;

172 ià(
·ge_size
 + 
mem_offs
 > 
PAGE_SIZE
) {

173 
·ge_size
 = 
PAGE_SIZE
 - 
mem_offs
;

177 
´p_offs
++;…½_off <ð
num_´ps
;…rp_offs++) {

178 ià(
·ddr_li¡
[
´p_offs
] =ð·ddr_li¡[´p_off - 1] + 
PAGE_SIZE
)

179 
·ge_size
 +ð
PAGE_SIZE
;

184 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
·ge_size
);

186 ià(
cmd
->
Ýcode
 =ð
nvme_cmd_wr™e
 || cmd->Ýcod=ð
nvme_cmd_zÚe_­³nd
) {

187 
	`ißt_dma_subm™
(
·ddr
, 
nvmev_vdev
->
cÚfig
.
¡Üage_¡¬t
 + 
off£t
, 
io_size
);

188 } ià(
cmd
->
Ýcode
 =ð
nvme_cmd_»ad
) {

189 
	`ißt_dma_subm™
(
nvmev_vdev
->
cÚfig
.
¡Üage_¡¬t
 + 
off£t
, 
·ddr
, 
io_size
);

192 
»maššg
 -ð
io_size
;

193 
off£t
 +ð
io_size
;

196  
Ëngth
;

197 
	}
}

199 
	$__š£¹_»q_sÜ‹d
(
’Œy
, 
nvmev_io_wÜk”
 *
wÜk”
,

200 
n£cs_rg‘
)

211 ià(
wÜk”
->
io_£q
 == -1) {

212 
wÜk”
->
io_£q
 = 
’Œy
;

213 
wÜk”
->
io_£q_’d
 = 
’Œy
;

215 
cu¼
 = 
wÜk”
->
io_£q_’d
;

217 
cu¼
 != -1) {

218 ià(
wÜk”
->
wÜk_queue
[
cu¼
].
n£cs_rg‘
 <ðwÜk”->
Ï‹¡_n£cs
)

221 ià(
wÜk”
->
wÜk_queue
[
cu¼
].
n£cs_rg‘
 <=‚secs_target)

224 
cu¼
 = 
wÜk”
->
wÜk_queue
[cu¼].
´ev
;

227 ià(
cu¼
 == -1) {

228 
wÜk”
->
wÜk_queue
[wÜk”->
io_£q
].
´ev
 = 
’Œy
;

229 
wÜk”
->
wÜk_queue
[
’Œy
].
Ãxt
 = wÜk”->
io_£q
;

230 
wÜk”
->
io_£q
 = 
’Œy
;

231 } ià(
wÜk”
->
wÜk_queue
[
cu¼
].
Ãxt
 == -1) {

232 
wÜk”
->
wÜk_queue
[
’Œy
].
´ev
 = 
cu¼
;

233 
wÜk”
->
io_£q_’d
 = 
’Œy
;

234 
wÜk”
->
wÜk_queue
[
cu¼
].
Ãxt
 = 
’Œy
;

236 
wÜk”
->
wÜk_queue
[
’Œy
].
´ev
 = 
cu¼
;

237 
wÜk”
->
wÜk_queue
[
’Œy
].
Ãxt
 = wÜk”->wÜk_queue[
cu¼
].next;

239 
wÜk”
->
wÜk_queue
[wÜk”->wÜk_queue[
’Œy
].
Ãxt
].
´ev
 =ƒntry;

240 
wÜk”
->
wÜk_queue
[
cu¼
].
Ãxt
 = 
’Œy
;

243 
	}
}

245 
nvmev_io_wÜk”
 *
	$__®loÿ‹_wÜk_queue_’Œy
(
sqid
, *
’Œy
,

246 
nvmev_dev
 *
nvmev_vdev
)

248 
io_wÜk”_tuº
 = 
	`__g‘_io_wÜk”
(
sqid
, 
nvmev_vdev
);

249 
nvmev_io_wÜk”
 *
wÜk”
 = &
nvmev_vdev
->
io_wÜk”s
[
io_wÜk”_tuº
];

250 
e
 = 
wÜk”
->
ä“_£q
;

251 
nvmev_io_wÜk
 *
w
 = 
wÜk”
->
wÜk_queue
 + 
e
;

253 ià(
w
->
Ãxt
 >ð
NR_MAX_PARALLEL_IO
) {

254 
	`WARN_ON_ONCE
("IO queue is‡lmost full");

255  
NULL
;

258 ià(++
io_wÜk”_tuº
 =ð
nvmev_vdev
->
cÚfig
.
Ä_io_wÜk”s
)

259 
io_wÜk”_tuº
 = 0;

260 
nvmev_vdev
->
io_wÜk”_tuº
 = io_worker_turn;

262 
wÜk”
->
ä“_£q
 = 
w
->
Ãxt
;

263 
	`BUG_ON
(
wÜk”
->
ä“_£q
 >ð
NR_MAX_PARALLEL_IO
);

264 *
’Œy
 = 
e
;

266  
wÜk”
;

267 
	}
}

269 
	$__’queue_io_»q
(
sqid
, 
cqid
, 
sq_’Œy
, 
n£cs_¡¬t
,

270 
nvmev_»suÉ
 *
»t
, 
nvmev_dev
 *
nvmev_vdev
)

272 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
sqid
];

273 
nvmev_io_wÜk”
 *
wÜk”
;

274 
nvmev_io_wÜk
 *
w
;

275 
’Œy
;

277 
wÜk”
 = 
	`__®loÿ‹_wÜk_queue_’Œy
(
sqid
, &
’Œy
, 
nvmev_vdev
);

278 ià(!
wÜk”
)

281 
w
 = 
wÜk”
->
wÜk_queue
 + 
’Œy
;

283 
	`NVMEV_DEBUG_VERBOSE
("%s/%u[%d], sq %d cq %d,ƒÁry %d, %Îu + %Îu\n", 
wÜk”
->
th»ad_Çme
,

284 
’Œy
, 
	`sq_’Œy
(
sq_’Œy
).
rw
.
Ýcode
, 
sqid
, 
cqid
, sq_’Œy, 
n£cs_¡¬t
,

285 
»t
->
n£cs_rg‘
 - 
n£cs_¡¬t
);

288 
w
->
sqid
 = sqid;

289 
w
->
cqid
 = cqid;

290 
w
->
sq_’Œy
 = sq_entry;

291 
w
->
commªd_id
 = 
	`sq_’Œy
(
sq_’Œy
).
commÚ
.command_id;

292 
w
->
n£cs_¡¬t
 =‚secs_start;

293 
w
->
n£cs_’queue
 = 
	`loÿl_þock
();

294 
w
->
n£cs_rg‘
 = 
»t
->nsecs_target;

295 
w
->
¡©us
 = 
»t
->status;

296 
w
->
is_com¶‘ed
 = 
çl£
;

297 
w
->
is_cÝ›d
 = 
çl£
;

298 
w
->
´ev
 = -1;

299 
w
->
Ãxt
 = -1;

301 
w
->
is_š‹º®
 = 
çl£
;

302 
	`mb
();

304 
	`__š£¹_»q_sÜ‹d
(
’Œy
, 
wÜk”
, 
»t
->
n£cs_rg‘
);

305 
	}
}

307 
	$scheduË_š‹º®_Ý”©iÚ
(
sqid
, 
n£cs_rg‘
,

308 
bufãr
 *
wr™e_bufãr
, 
size_t
 
buffs_to_»Ëa£
,

309 
nvmev_dev
 *
nvmev_vdev
)

311 
nvmev_io_wÜk”
 *
wÜk”
;

312 
nvmev_io_wÜk
 *
w
;

313 
’Œy
;

315 
wÜk”
 = 
	`__®loÿ‹_wÜk_queue_’Œy
(
sqid
, &
’Œy
, 
nvmev_vdev
);

316 ià(!
wÜk”
)

319 
w
 = 
wÜk”
->
wÜk_queue
 + 
’Œy
;

321 
	`NVMEV_DEBUG_VERBOSE
("%s/%u, iÁ”ÇÈsq %d, %Îu + %Îu\n", 
wÜk”
->
th»ad_Çme
, 
’Œy
,

322 
sqid
, 
	`loÿl_þock
(), 
n£cs_rg‘
 -†ocal_clock());

325 
w
->
sqid
 = sqid;

326 
w
->
n£cs_¡¬t
 = w->
n£cs_’queue
 = 
	`loÿl_þock
();

327 
w
->
n£cs_rg‘
 =‚secs_target;

328 
w
->
is_com¶‘ed
 = 
çl£
;

329 
w
->
is_cÝ›d
 = 
Œue
;

330 
w
->
´ev
 = -1;

331 
w
->
Ãxt
 = -1;

333 
w
->
is_š‹º®
 = 
Œue
;

334 
w
->
wr™e_bufãr
 = write_buffer;

335 
w
->
buffs_to_»Ëa£
 = buffs_to_release;

336 
	`mb
();

338 
	`__š£¹_»q_sÜ‹d
(
’Œy
, 
wÜk”
, 
n£cs_rg‘
);

339 
	}
}

341 
	$__»þaim_com¶‘ed_»qs
(
nvmev_dev
 *
nvmev_vdev
)

343 
tuº
;

345 
tuº
 = 0;uº < 
nvmev_vdev
->
cÚfig
.
Ä_io_wÜk”s
;urn++) {

346 
nvmev_io_wÜk”
 *
wÜk”
;

347 
nvmev_io_wÜk
 *
w
;

349 
fœ¡_’Œy
 = -1;

350 
Ï¡_’Œy
 = -1;

351 
cu¼
;

352 
Ä_»þaimed
 = 0;

354 
wÜk”
 = &
nvmev_vdev
->
io_wÜk”s
[
tuº
];

356 
fœ¡_’Œy
 = 
wÜk”
->
io_£q
;

357 
cu¼
 = 
fœ¡_’Œy
;

359 
cu¼
 != -1) {

360 
w
 = &
wÜk”
->
wÜk_queue
[
cu¼
];

361 ià(
w
->
is_com¶‘ed
 =ð
Œue
 && w->
is_cÝ›d
 ==rue &&

362 
w
->
n£cs_rg‘
 <ð
wÜk”
->
Ï‹¡_n£cs
) {

363 
Ï¡_’Œy
 = 
cu¼
;

364 
cu¼
 = 
w
->
Ãxt
;

365 
Ä_»þaimed
++;

371 ià(
Ï¡_’Œy
 != -1) {

372 
w
 = &
wÜk”
->
wÜk_queue
[
Ï¡_’Œy
];

373 
wÜk”
->
io_£q
 = 
w
->
Ãxt
;

374 ià(
w
->
Ãxt
 != -1) {

375 
wÜk”
->
wÜk_queue
[
w
->
Ãxt
].
´ev
 = -1;

377 
w
->
Ãxt
 = -1;

379 
w
 = &
wÜk”
->
wÜk_queue
[
fœ¡_’Œy
];

380 
w
->
´ev
 = 
wÜk”
->
ä“_£q_’d
;

382 
w
 = &
wÜk”
->
wÜk_queue
[wÜk”->
ä“_£q_’d
];

383 
w
->
Ãxt
 = 
fœ¡_’Œy
;

385 
wÜk”
->
ä“_£q_’d
 = 
Ï¡_’Œy
;

386 
	`NVMEV_DEBUG_VERBOSE
("%s: %u -- %u, %d\n", 
__func__
, 
fœ¡_’Œy
, 
Ï¡_’Œy
,

387 
Ä_»þaimed
);

390 
	}
}

392 
size_t
 
	$__nvmev_´oc_io
(
sqid
, 
sq_’Œy
, 
size_t
 *
io_size
, 
nvmev_dev
 *
nvmev_vdev
)

394 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
sqid
];

395 
n£cs_¡¬t
 = 
	`__g‘_w®lþock
(
nvmev_vdev
);

396 
nvme_commªd
 *
cmd
 = &
	`sq_’Œy
(
sq_’Œy
);

397 #ià(
BASE_SSD
 =ð
KV_PROTOTYPE
)

398 
ušt32_t
 
nsid
 = 0;

400 
ušt32_t
 
nsid
 = 
cmd
->
commÚ
.nsid - 1;

402 
nvmev_ns
 *
ns
 = &
nvmev_vdev
->ns[
nsid
];

404 
nvmev_»que¡
 
»q
 = {

405 .
cmd
 = cmd,

406 .
sq_id
 = 
sqid
,

407 .
n£cs_¡¬t
 =‚secs_start,

409 
nvmev_»suÉ
 
»t
 = {

410 .
n£cs_rg‘
 = 
n£cs_¡¬t
,

411 .
¡©us
 = 
NVME_SC_SUCCESS
,

414 #ifdeà
PERF_DEBUG


415 
´ev_þock
 = 
	`loÿl_þock
();

416 
´ev_þock2
 = 0;

417 
´ev_þock3
 = 0;

418 
´ev_þock4
 = 0;

419 
þock1
 = 0;

420 
þock2
 = 0;

421 
þock3
 = 0;

422 
couÁ”
 = 0;

425 ià(!
ns
->
	`´oc_io_cmd
Òs, &
»q
, &
»t
, 
nvmev_vdev
))

426  
çl£
;

427 *
io_size
 = (
cmd
->
rw
.
Ëngth
 + 1) << 9;

429 #ifdeà
PERF_DEBUG


430 
´ev_þock2
 = 
	`loÿl_þock
();

433 
	`__’queue_io_»q
(
sqid
, 
sq
->
cqid
, 
sq_’Œy
, 
n£cs_¡¬t
, &
»t
, 
nvmev_vdev
);

435 #ifdeà
PERF_DEBUG


436 
´ev_þock3
 = 
	`loÿl_þock
();

439 
	`__»þaim_com¶‘ed_»qs
(
nvmev_vdev
);

441 #ifdeà
PERF_DEBUG


442 
´ev_þock4
 = 
	`loÿl_þock
();

444 
þock1
 +ð(
´ev_þock2
 - 
´ev_þock
);

445 
þock2
 +ð(
´ev_þock3
 - 
´ev_þock2
);

446 
þock3
 +ð(
´ev_þock4
 - 
´ev_þock3
);

447 
couÁ”
++;

449 ià(
couÁ”
 > 1000) {

450 
	`NVMEV_DEBUG
("LAT: %Îu, ENQ: %Îu, CLN: %Îu\n", 
þock1
 / 
couÁ”
, 
þock2
 / counter,

451 
þock3
 / 
couÁ”
);

452 
þock1
 = 0;

453 
þock2
 = 0;

454 
þock3
 = 0;

455 
couÁ”
 = 0;

458  
Œue
;

459 
	}
}

461 
	$nvmev_´oc_io_sq
(
sqid
, 
Ãw_db
, 
Þd_db
, 
nvmev_dev
 *
nvmev_vdev
)

463 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
sqid
];

464 
num_´oc
 = 
Ãw_db
 - 
Þd_db
;

465 
£q
;

466 
sq_’Œy
 = 
Þd_db
;

467 
Ï‹¡_db
;

469 ià(
	`uÆik–y
(!
sq
))

470  
Þd_db
;

471 ià(
	`uÆik–y
(
num_´oc
 < 0))

472 
num_´oc
 +ð
sq
->
queue_size
;

474 
£q
 = 0; seq < 
num_´oc
; seq++) {

475 
size_t
 
io_size
;

476 ià(!
	`__nvmev_´oc_io
(
sqid
, 
sq_’Œy
, &
io_size
, 
nvmev_vdev
))

479 ià(++
sq_’Œy
 =ð
sq
->
queue_size
) {

480 
sq_’Œy
 = 0;

482 
sq
->
¡©
.
Ä_di¥©ched
++;

483 
sq
->
¡©
.
Ä_š_æight
++;

484 
sq
->
¡©
.
tÙ®_io
 +ð
io_size
;

486 
sq
->
¡©
.
Ä_di¥©ch
++;

487 
sq
->
¡©
.
max_Ä_š_æight
 = 
	`max_t
(, sq->¡©.max_Ä_š_æight, sq->¡©.
Ä_š_æight
);

489 
Ï‹¡_db
 = (
Þd_db
 + 
£q
è% 
sq
->
queue_size
;

490  
Ï‹¡_db
;

491 
	}
}

493 
	$nvmev_´oc_io_cq
(
cqid
, 
Ãw_db
, 
Þd_db
, 
nvmev_dev
 *
nvmev_vdev
)

495 
nvmev_com¶‘iÚ_queue
 *
cq
 = 
nvmev_vdev
->
cqes
[
cqid
];

496 
i
;

497 
i
 = 
Þd_db
; i !ð
Ãw_db
; i++) {

498 
sqid
 = 
	`cq_’Œy
(
i
).
sq_id
;

499 ià(
i
 >ð
cq
->
queue_size
) {

500 
i
 = -1;

506 ià(!
nvmev_vdev
->
sqes
[
sqid
])

509 
nvmev_vdev
->
sqes
[
sqid
]->
¡©
.
Ä_š_æight
--;

512 
cq
->
cq_ž
 = 
Ãw_db
 - 1;

513 ià(
Ãw_db
 == -1)

514 
cq
->
cq_ž
 = cq->
queue_size
 - 1;

515 
	}
}

517 
	$__fžl_cq_»suÉ
(
nvmev_io_wÜk
 *
w
, 
nvmev_dev
 *
nvmev_vdev
)

519 
sqid
 = 
w
->sqid;

520 
cqid
 = 
w
->cqid;

521 
sq_’Œy
 = 
w
->sq_entry;

522 
commªd_id
 = 
w
->command_id;

523 
¡©us
 = 
w
->status;

524 
»suÉ0
 = 
w
->result0;

525 
»suÉ1
 = 
w
->result1;

527 
nvmev_com¶‘iÚ_queue
 *
cq
 = 
nvmev_vdev
->
cqes
[
cqid
];

528 
cq_h—d
 = 
cq
->cq_head;

529 
nvme_com¶‘iÚ
 *
cqe
 = &
	`cq_’Œy
(
cq_h—d
);

531 
	`¥š_lock
(&
cq
->
’Œy_lock
);

532 
cqe
->
commªd_id
 = command_id;

533 
cqe
->
sq_id
 = 
sqid
;

534 
cqe
->
sq_h—d
 = 
sq_’Œy
;

535 
cqe
->
¡©us
 = 
cq
->
pha£
 | (status << 1);

536 
cqe
->
»suÉ0
 =„esult0;

537 
cqe
->
»suÉ1
 =„esult1;

539 ià(++
cq_h—d
 =ð
cq
->
queue_size
) {

540 
cq_h—d
 = 0;

541 
cq
->
pha£
 = !cq->phase;

544 
cq
->
cq_h—d
 = cq_head;

545 
cq
->
š‹¼u±_»ady
 = 
Œue
;

546 
	`¥š_uÆock
(&
cq
->
’Œy_lock
);

547 
	}
}

549 
	$nvmev_io_wÜk”
(*
d©a
)

551 
nvmev_io_wÜk”
 *
wÜk”
 = (nvmev_io_wÜk” *)
d©a
;

552 
nvmev_dev
 *
nvmev_vdev
 = 
wÜk”
->
·»Á_dev
;

553 
nvmev_ns
 *
ns
;

555 #ifdeà
PERF_DEBUG


556 
šŒ_þock
[
NR_MAX_IO_QUEUE
 + 1];

557 
šŒ_couÁ”
[
NR_MAX_IO_QUEUE
 + 1];

559 
´ev_þock
;

562 
	`NVMEV_INFO
("% ¡¬‹d oÀýu %d (nod%d)\n", 
wÜk”
->
th»ad_Çme
, 
	`smp_´oûssÜ_id
(),

563 
	`ýu_to_node
(
	`smp_´oûssÜ_id
()));

564 !
	`kth»ad_should_¡Ý
()) {

565 
cu¼_n£cs_w®l
 = 
	`__g‘_w®lþock
(
nvmev_vdev
);

566 
cu¼_n£cs_loÿl
 = 
	`loÿl_þock
();

567 
d–
 = 
cu¼_n£cs_w®l
 - 
cu¼_n£cs_loÿl
;

569 vÞ©ž
cu¼
 = 
wÜk”
->
io_£q
;

571 
qidx
;

573 
cu¼
 != -1) {

574 
nvmev_io_wÜk
 *
w
 = &
wÜk”
->
wÜk_queue
[
cu¼
];

575 
cu¼_n£cs
 = 
	`loÿl_þock
(è+ 
d–
;

576 
wÜk”
->
Ï‹¡_n£cs
 = 
cu¼_n£cs
;

578 ià(
w
->
is_com¶‘ed
 =ð
Œue
) {

579 
cu¼
 = 
w
->
Ãxt
;

583 ià(
w
->
is_cÝ›d
 =ð
çl£
) {

584 #ifdeà
PERF_DEBUG


585 
w
->
n£cs_cÝy_¡¬t
 = 
	`loÿl_þock
(è+ 
d–
;

587 ià(
w
->
is_š‹º®
) {

589 } ià(
io_usšg_dma
) {

590 
	`__do_³rfÜm_io_usšg_dma
(
w
->
sqid
, w->
sq_’Œy
, 
nvmev_vdev
);

592 #ià(
BASE_SSD
 =ð
KV_PROTOTYPE
)

593 
nvmev_submissiÚ_queue
 *
sq
 =

594 
nvmev_vdev
->
sqes
[
w
->
sqid
];

595 
ns
 = &
nvmev_vdev
->ns[0];

596 ià(
ns
->
	`id’tify_io_cmd
Òs, 
	`sq_’Œy
(
w
->
sq_’Œy
))) {

597 
w
->
»suÉ0
 = 
ns
->
	`³rfÜm_io_cmd
(

598 
ns
, &
	`sq_’Œy
(
w
->
sq_’Œy
), &(w->
¡©us
));

600 
	`__do_³rfÜm_io
(
w
->
sqid
, w->
sq_’Œy
, 
nvmev_vdev
);

603 
	`__do_³rfÜm_io
(
w
->
sqid
, w->
sq_’Œy
, 
nvmev_vdev
);

606 #ifdeà
PERF_DEBUG


607 
w
->
n£cs_cÝy_dÚe
 = 
	`loÿl_þock
(è+ 
d–
;

609 
w
->
is_cÝ›d
 = 
Œue
;

611 
	`NVMEV_DEBUG_VERBOSE
("%s: copied %u, %d %d %d\n",

612 
wÜk”
->
th»ad_Çme
, 
cu¼
, 
w
->
sqid
, w->
cqid
,

613 
w
->
sq_’Œy
);

616 ià(
w
->
n£cs_rg‘
 <ð
cu¼_n£cs
) {

617 ià(
w
->
is_š‹º®
) {

618 #ià(
	`SUPPORTED_SSD_TYPE
(
CONV
è|| SUPPORTED_SSD_TYPE(
ZNS
))

619 
	`bufãr_»Ëa£
((
bufãr
 *)
w
->
wr™e_bufãr
,

620 
w
->
buffs_to_»Ëa£
);

623 
	`__fžl_cq_»suÉ
(
w
, 
nvmev_vdev
);

626 
	`NVMEV_DEBUG_VERBOSE
("%s: completed %u, %d %d %d\n",

627 
wÜk”
->
th»ad_Çme
, 
cu¼
, 
w
->
sqid
, w->
cqid
,

628 
w
->
sq_’Œy
);

630 #ifdeà
PERF_DEBUG


631 
w
->
n£cs_cq_fžËd
 = 
	`loÿl_þock
(è+ 
d–
;

632 
	`Œaû_´štk
("%Îu %Îu %Îu %Îu %Îu %Îu\n", 
w
->
n£cs_¡¬t
,

633 
w
->
n£cs_’queue
 - w->
n£cs_¡¬t
,

634 
w
->
n£cs_cÝy_¡¬t
 - w->
n£cs_¡¬t
,

635 
w
->
n£cs_cÝy_dÚe
 - w->
n£cs_¡¬t
,

636 
w
->
n£cs_cq_fžËd
 - w->
n£cs_¡¬t
,

637 
w
->
n£cs_rg‘
 - w->
n£cs_¡¬t
);

639 
	`mb
();

640 
w
->
is_com¶‘ed
 = 
Œue
;

643 
cu¼
 = 
w
->
Ãxt
;

646 
qidx
 = 1; qidx <ð
nvmev_vdev
->
Ä_cq
; qidx++) {

647 
nvmev_com¶‘iÚ_queue
 *
cq
 = 
nvmev_vdev
->
cqes
[
qidx
];

649 #ifdeà
CONFIG_NVMEV_IO_WORKER_BY_SQ


650 ià((
wÜk”
->
id
è!ð
	`__g‘_io_wÜk”
(
qidx
, 
nvmev_vdev
))

653 ià(
cq
 =ð
NULL
 || !cq->
œq_’abËd
)

656 ià(
	`¥š_Œylock
(&
cq
->
œq_lock
)) {

657 ià(
cq
->
š‹¼u±_»ady
 =ð
Œue
) {

658 #ifdeà
PERF_DEBUG


659 
´ev_þock
 = 
	`loÿl_þock
();

661 
cq
->
š‹¼u±_»ady
 = 
çl£
;

662 
	`nvmev_sigÇl_œq
(
nvmev_vdev
, 
cq
->
œq_veùÜ
);

664 #ifdeà
PERF_DEBUG


665 
šŒ_þock
[
qidx
] +ð(
	`loÿl_þock
(è- 
´ev_þock
);

666 
šŒ_couÁ”
[
qidx
]++;

668 ià(
šŒ_couÁ”
[
qidx
] > 1000) {

669 
	`NVMEV_DEBUG
("IÁ¸%d: %Îu\n", 
qidx
,

670 
šŒ_þock
[
qidx
] / 
šŒ_couÁ”
[qidx]);

671 
šŒ_þock
[
qidx
] = 0;

672 
šŒ_couÁ”
[
qidx
] = 0;

676 
	`¥š_uÆock
(&
cq
->
œq_lock
);

679 
	`cÚd_»sched
();

683 
	}
}

685 
	$NVMEV_IO_WORKER_INIT
(
nvmev_dev
 *
nvmev_vdev
)

687 
i
, 
wÜk”_id
;

689 
nvmev_vdev
->
io_wÜk”s
 = 
	`kÿÎoc
((
nvmev_io_wÜk”
),

690 
nvmev_vdev
->
cÚfig
.
Ä_io_wÜk”s
, 
GFP_KERNEL
);

691 
nvmev_vdev
->
io_wÜk”_tuº
 = 0;

693 
wÜk”_id
 = 0; wÜk”_id < 
nvmev_vdev
->
cÚfig
.
Ä_io_wÜk”s
; worker_id++) {

694 
nvmev_io_wÜk”
 *
wÜk”
 = &
nvmev_vdev
->
io_wÜk”s
[
wÜk”_id
];

696 
wÜk”
->
wÜk_queue
 =

697 
	`kz®loc
((
nvmev_io_wÜk
è* 
NR_MAX_PARALLEL_IO
, 
GFP_KERNEL
);

698 
i
 = 0; i < 
NR_MAX_PARALLEL_IO
; i++) {

699 
wÜk”
->
wÜk_queue
[
i
].
Ãxt
 = i + 1;

700 
wÜk”
->
wÜk_queue
[
i
].
´ev
 = i - 1;

702 
wÜk”
->
wÜk_queue
[
NR_MAX_PARALLEL_IO
 - 1].
Ãxt
 = -1;

703 
wÜk”
->
id
 = 
wÜk”_id
;

704 
wÜk”
->
ä“_£q
 = 0;

705 
wÜk”
->
ä“_£q_’d
 = 
NR_MAX_PARALLEL_IO
 - 1;

706 
wÜk”
->
io_£q
 = -1;

707 
wÜk”
->
io_£q_’d
 = -1;

708 
wÜk”
->
·»Á_dev
 = 
nvmev_vdev
;

710 
	`¢´štf
(
wÜk”
->
th»ad_Çme
, (worker->thread_name), "nvmev_io/%d:%d",

711 
nvmev_vdev
->
dev_id
, 
wÜk”_id
);

713 
wÜk”
->
sk_¡ruù
 =

714 
	`kth»ad_ü—‹
(
nvmev_io_wÜk”
, 
wÜk”
, "%s", wÜk”->
th»ad_Çme
);

716 
	`kth»ad_bšd
(
wÜk”
->
sk_¡ruù
, 
nvmev_vdev
->
cÚfig
.
ýu_Ä_io_wÜk”s
[
wÜk”_id
]);

717 
	`wake_up_´oûss
(
wÜk”
->
sk_¡ruù
);

719 
	}
}

721 
	$NVMEV_IO_WORKER_FINAL
(
nvmev_dev
 *
nvmev_vdev
)

723 
i
;

725 
i
 = 0; i < 
nvmev_vdev
->
cÚfig
.
Ä_io_wÜk”s
; i++) {

726 
nvmev_io_wÜk”
 *
wÜk”
 = &
nvmev_vdev
->
io_wÜk”s
[
i
];

728 ià(!
	`IS_ERR_OR_NULL
(
wÜk”
->
sk_¡ruù
)) {

729 
	`kth»ad_¡Ý
(
wÜk”
->
sk_¡ruù
);

732 
	`kä“
(
wÜk”
->
wÜk_queue
);

735 
	`kä“
(
nvmev_vdev
->
io_wÜk”s
);

736 
	}
}

	@kv_ftl.c

3 
	~<lšux/ktime.h
>

4 
	~<lšux/highmem.h
>

5 
	~<lšux/sched/þock.h
>

7 
	~"nvmev.h
"

8 
	~"kv_ál.h
"

10 cÚ¡ 
®loÿtÜ_Ýs
 
	g­³nd_Úly_Ýs
 = {

11 .
š™
 = 
­³nd_Úly_®loÿtÜ_š™
,

12 .
	g®loÿ‹
 = 
­³nd_Úly_®loÿ‹
,

13 .
	gkžl
 = 
­³nd_Úly_kžl
,

16 cÚ¡ 
®loÿtÜ_Ýs
 
	gb™m­_Ýs
 = {

17 .
š™
 = 
b™m­_®loÿtÜ_š™
,

18 .
	g®loÿ‹
 = 
b™m­_®loÿ‹
,

19 .
	gkžl
 = 
b™m­_kžl
,

22 
šlše
 
	$__g‘_w®lþock
(
nvmev_dev
 *
nvmev_vdev
)

24  
	`ýu_þock
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
);

25 
	}
}

27 
size_t
 
	$__cmd_io_size
(
nvme_rw_commªd
 *
cmd
)

29 
	`NVMEV_DEBUG
("%d†b¨%Îu†’gth %d, %Îx %Îx\n", 
cmd
->
Ýcode
, cmd->
¦ba
, cmd->
Ëngth
,

30 
cmd
->
´p1
, cmd->
´p2
);

32  (
cmd
->
Ëngth
 + 1) << 9;

33 
	}
}

35 
	$cmd_key_Ëngth
(
nvme_kv_commªd
 
cmd
)

37 ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_¡Üe
) {

38  
cmd
.
kv_¡Üe
.
key_Ën
 + 1;

39 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_»Œ›ve
) {

40  
cmd
.
kv_»Œ›ve
.
key_Ën
 + 1;

41 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_d–‘e
) {

42  
cmd
.
kv_d–‘e
.
key_Ën
 + 1;

44  
cmd
.
kv_¡Üe
.
key_Ën
 + 1;

46 
	}
}

48 
	$cmd_v®ue_Ëngth
(
nvme_kv_commªd
 
cmd
)

50 ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_¡Üe
) {

51  
cmd
.
kv_¡Üe
.
v®ue_Ën
 << 2;

52 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_»Œ›ve
) {

53  
cmd
.
kv_»Œ›ve
.
v®ue_Ën
 << 2;

55  
cmd
.
kv_¡Üe
.
v®ue_Ën
 << 2;

57 
	}
}

60 
	$__scheduË_io_un™s
(
Ýcode
, 
lba
, 
Ëngth
,

61 
n£cs_¡¬t
,

62 
nvmev_dev
 *
nvmev_vdev
)

64 
io_un™_size
 = 1 << 
nvmev_vdev
->
cÚfig
.
io_un™_shiá
;

65 
io_un™
 =

66 (
lba
 >> (
nvmev_vdev
->
cÚfig
.
io_un™_shiá
 - 9)è%‚vmev_vdev->cÚfig.
Ä_io_un™s
;

67 
Ä_io_un™s
 = 
	`mš
(
nvmev_vdev
->
cÚfig
.Ä_io_un™s, 
	`DIV_ROUND_UP
(
Ëngth
, 
io_un™_size
));

69 
Ï‹¡
;

70 
d–ay
 = 0;

71 
Ï‹ncy
 = 0;

72 
Œažšg
 = 0;

74 ià(
Ýcode
 =ð
nvme_cmd_wr™e
 || opcod=ð
nvme_cmd_kv_¡Üe
 ||

75 
Ýcode
 =ð
nvme_cmd_kv_b©ch
) {

76 
d–ay
 = 
nvmev_vdev
->
cÚfig
.
wr™e_d–ay
;

77 
Ï‹ncy
 = 
nvmev_vdev
->
cÚfig
.
wr™e_time
;

78 
Œažšg
 = 
nvmev_vdev
->
cÚfig
.
wr™e_Œažšg
;

79 } ià(
Ýcode
 =ð
nvme_cmd_»ad
 || opcod=ð
nvme_cmd_kv_»Œ›ve
) {

80 
d–ay
 = 
nvmev_vdev
->
cÚfig
.
»ad_d–ay
;

81 
Ï‹ncy
 = 
nvmev_vdev
->
cÚfig
.
»ad_time
;

82 
Œažšg
 = 
nvmev_vdev
->
cÚfig
.
»ad_Œažšg
;

85 
Ï‹¡
 = 
	`max
(
n£cs_¡¬t
, 
nvmev_vdev
->
io_un™_¡©
[
io_un™
]è+ 
d–ay
;

88 
Ï‹¡
 +ð
Ï‹ncy
;

89 
nvmev_vdev
->
io_un™_¡©
[
io_un™
] = 
Ï‹¡
;

91 ià(
Ä_io_un™s
-- > 0) {

92 
nvmev_vdev
->
io_un™_¡©
[
io_un™
] +ð
Œažšg
;

95 
Ëngth
 -ð
	`mš
Ö’gth, 
io_un™_size
);

96 ià(++
io_un™
 >ð
nvmev_vdev
->
cÚfig
.
Ä_io_un™s
)

97 
io_un™
 = 0;

98 } 
Ëngth
 > 0);

100  
Ï‹¡
;

101 
	}
}

103 
	$__scheduË_æush
(
nvmev_»que¡
 *
»q
, 
nvmev_dev
 *
nvmev_vdev
)

105 
Ï‹¡
 = 0;

106 
i
;

108 
i
 = 0; i < 
nvmev_vdev
->
cÚfig
.
Ä_io_un™s
; i++) {

109 
Ï‹¡
 = 
	`max
Ö©e¡, 
nvmev_vdev
->
io_un™_¡©
[
i
]);

112  
Ï‹¡
;

113 
	}
}

117 
size_t
 
	$®loÿ‹_mem_off£t
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
)

119 ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_¡Üe
) {

120 
u64
 
Ëngth_by‹s
 = 
	`cmd_v®ue_Ëngth
(
cmd
);

121 
size_t
 
off£t
;

123 
off£t
 = 
kv_ál
->
®loÿtÜ_Ýs
.
	`®loÿ‹
(
Ëngth_by‹s
, 
NULL
);

125 ià(
off£t
 == -1) {

126 
	`NVMEV_ERROR
("mem‡lloc failed");

129 
	`NVMEV_DEBUG
("®loÿ‹ memÜy off£ˆ%lu fÜ %u %u\n", 
off£t
,

130 
	`cmd_key_Ëngth
(
cmd
), 
	`cmd_v®ue_Ëngth
(cmd));

131  
off£t
;

134 
	`NVMEV_ERROR
("Couldn'ˆ®loÿ‹ mem off£ˆ%d", 
cmd
.
commÚ
.
Ýcode
);

137 
	}
}

139 
size_t
 
	$®loÿ‹_mem_off£t_by_Ëngth
(
kv_ál
 *kv_ál, 
v®_Ën
)

141 
u64
 
Ëngth_by‹s
 = 
v®_Ën
;

142 
size_t
 
off£t
;

144 
off£t
 = 
kv_ál
->
®loÿtÜ_Ýs
.
	`®loÿ‹
(
Ëngth_by‹s
, 
NULL
);

146 ià(
off£t
 == -1) {

147 
	`NVMEV_ERROR
("mem‡lloc failed");

150 
	`NVMEV_DEBUG
("®loÿ‹ memÜy off£ˆ%lu fÜ %u\n", 
off£t
, 
v®_Ën
);

151  
off£t
;

153 
	}
}

155 
	$g‘_hash_¦Ù
(
kv_ál
 *kv_ál, *
key
, 
u32
 
key_Ën
)

157  
	`hash_funùiÚ
(
key
, 
key_Ën
è% 
kv_ál
->
hash_¦Ùs
;

158 
	}
}

160 
	$chaš_m­pšg
(
kv_ál
 *kv_ál, 
´ev
, 
¦Ù
)

162 
kv_ál
->
kv_m­pšg_bË
[
´ev
].
Ãxt_¦Ù
 = 
¦Ù
;

163 
	}
}

165 
	$fšd_Ãxt_¦Ù
(
kv_ál
 *kv_ál, 
Üigš®_¦Ù
, *
´ev_¦Ù
)

167 
»t_¦Ù
 = 
Üigš®_¦Ù
;

169 
kv_ál
->
kv_m­pšg_bË
[
»t_¦Ù
].
mem_off£t
 != -1) {

170 
»t_¦Ù
++;

171 ià(
»t_¦Ù
 >ð
kv_ál
->
hash_¦Ùs
)

172 
»t_¦Ù
 = 0;

175 *
´ev_¦Ù
 = 
Üigš®_¦Ù
;

177 ià(
´ev_¦Ù
 < 0) {

178 
	`NVMEV_ERROR
("Prev slot†esshan 0\n");

181 
	`NVMEV_DEBUG
("CÞlisiÚ‡ˆ¦Ù %d, found‚ew slÙ %u\n", 
Üigš®_¦Ù
, 
»t_¦Ù
);

182 ià(
»t_¦Ù
 - 
Üigš®_¦Ù
 > 3)

183 
	`NVMEV_DEBUG
("SlÙ difã»nû: %d\n", 
»t_¦Ù
 - 
Üigš®_¦Ù
);

185  
»t_¦Ù
;

186 
	}
}

188 
	$Ãw_m­pšg_’Œy
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
,

189 
size_t
 
v®_off£t
, 
nvmev_dev
 *
nvmev_vdev
)

191 
¦Ù
 = -1;

192 
´ev_¦Ù
;

193 
	`BUG_ON
(
v®_off£t
 < 0 || v®_off£ˆ>ð
nvmev_vdev
->
cÚfig
.
¡Üage_size
);

195 
¦Ù
 = 
	`g‘_hash_¦Ù
(
kv_ál
, 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd));

197 
´ev_¦Ù
 = -1;

198 ià(
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 != -1) {

199 
	`NVMEV_DEBUG
("Collision\n");

200 
¦Ù
 = 
	`fšd_Ãxt_¦Ù
(
kv_ál
, slÙ, &
´ev_¦Ù
);

203 ià(
¦Ù
 < 0 || slÙ >ð
kv_ál
->
hash_¦Ùs
) {

204 
	`NVMEV_ERROR
("slot < 0 || slot >= kv_ftl->hash_slots\n");

207 
	`memýy
(
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
key
, 
cmd
.
kv_¡Üe
.key, cmd.kv_¡Üe.
key_Ën
 + 1);

208 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 = 
v®_off£t
;

209 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
Ëngth
 = 
	`cmd_v®ue_Ëngth
(
cmd
);

211 ià(
´ev_¦Ù
 != -1) {

212 
	`NVMEV_DEBUG
("Lškšg slÙ %dØÃw slÙ %d", 
´ev_¦Ù
, 
¦Ù
);

213 
	`chaš_m­pšg
(
kv_ál
, 
´ev_¦Ù
, 
¦Ù
);

216 
	`NVMEV_DEBUG
("New m­pšgƒÁry key % off£ˆ%lu†’gth %u slÙ %u\n", 
cmd
.
kv_¡Üe
.
key
,

217 
v®_off£t
, 
	`cmd_v®ue_Ëngth
(
cmd
), 
¦Ù
);

220 
	}
}

222 
	$Ãw_m­pšg_’Œy_by_key
(
kv_ál
 *kv_ál, *
key
, 
key_Ën
,

223 
v®_Ën
, 
size_t
 
v®_off£t
,

224 
nvmev_dev
 *
nvmev_vdev
)

226 
¦Ù
 = -1;

227 
´ev_¦Ù
;

228 
	`BUG_ON
(
v®_off£t
 < 0 || v®_off£ˆ>ð
nvmev_vdev
->
cÚfig
.
¡Üage_size
);

230 
¦Ù
 = 
	`g‘_hash_¦Ù
(
kv_ál
, 
key
, 
key_Ën
);

232 
´ev_¦Ù
 = -1;

233 ià(
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 != -1) {

234 
	`NVMEV_DEBUG
("Collision\n");

235 
¦Ù
 = 
	`fšd_Ãxt_¦Ù
(
kv_ál
, slÙ, &
´ev_¦Ù
);

238 ià(
¦Ù
 < 0 || slÙ >ð
kv_ál
->
hash_¦Ùs
) {

239 
	`NVMEV_ERROR
("slot < 0 || slot >= kv_ftl->hash_slots\n");

242 
	`memýy
(
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
key
, key, 
key_Ën
);

243 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 = 
v®_off£t
;

244 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
Ëngth
 = 
v®_Ën
;

246 ià(
´ev_¦Ù
 != -1) {

247 
	`NVMEV_DEBUG
("Lškšg slÙ %dØÃw slÙ %d", 
´ev_¦Ù
, 
¦Ù
);

248 
	`chaš_m­pšg
(
kv_ál
, 
´ev_¦Ù
, 
¦Ù
);

251 
	`NVMEV_DEBUG
("New m­pšgƒÁry key % off£ˆ%lu†’gth %u slÙ %u\n", 
key
, 
v®_off£t
,

252 
v®_Ën
, 
¦Ù
);

255 
	}
}

257 
	$upd©e_m­pšg_’Œy
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
)

259 
¦Ù
 = 0;

260 
boÞ
 
found
 = 
çl£
;

262 
u32
 
couÁ
 = 0;

264 
¦Ù
 = 
	`g‘_hash_¦Ù
(
kv_ál
, 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd));

266 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 != -1) {

267 
	`NVMEV_DEBUG
("Com·ršg % | %.*s\n", 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd),

268 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
key
);

269 
couÁ
++;

271 ià(
couÁ
 > 10) {

272 
	`NVMEV_ERROR
("S—rched %uimes", 
couÁ
);

275 ià(
	`memcmp
(
cmd
.
kv_¡Üe
.
key
, 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].key,

276 
	`cmd_key_Ëngth
(
cmd
)) == 0) {

277 
	`NVMEV_DEBUG
("1 Found\n");

278 
found
 = 
Œue
;

282 
¦Ù
 = 
kv_ál
->
kv_m­pšg_bË
[¦Ù].
Ãxt_¦Ù
;

283 ià(
¦Ù
 == -1)

287 ià(
found
) {

288 
	`NVMEV_DEBUG
("Updating mapping†ength %luo %u for key %s\n",

289 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
Ëngth
, 
	`cmd_v®ue_Ëngth
(
cmd
),

290 
cmd
.
kv_¡Üe
.
key
);

291 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
Ëngth
 = 
	`cmd_v®ue_Ëngth
(
cmd
);

294 ià(!
found
) {

295 
	`NVMEV_ERROR
("NØm­pšg found fÜ key %s\n", 
cmd
.
kv_¡Üe
.
key
);

300 
	}
}

302 
m­pšg_’Œy
 
	$g‘_m­pšg_’Œy
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
)

304 
m­pšg_’Œy
 
m­pšg
;

305 
¦Ù
 = 0;

306 
boÞ
 
found
 = 
çl£
;

308 
u32
 
couÁ
 = 0;

310 
	`mem£t
(&
m­pšg
, -1, (
m­pšg_’Œy
));

312 
¦Ù
 = 
	`g‘_hash_¦Ù
(
kv_ál
, 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd));

314 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 != -1) {

315 
	`NVMEV_DEBUG
("Com·ršg % | %.*s\n", 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd),

316 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
key
);

317 
couÁ
++;

319 ià(
couÁ
 > 10) {

320 
	`NVMEV_DEBUG
("S—rched %uimes", 
couÁ
);

323 ià(
	`memcmp
(
cmd
.
kv_¡Üe
.
key
, 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].key,

324 
	`cmd_key_Ëngth
(
cmd
)) == 0) {

325 
	`NVMEV_DEBUG
("1 Found\n");

326 
found
 = 
Œue
;

330 
¦Ù
 = 
kv_ál
->
kv_m­pšg_bË
[¦Ù].
Ãxt_¦Ù
;

331 ià(
¦Ù
 == -1)

333 
	`NVMEV_DEBUG
("Nexˆ¦Ù %d", 
¦Ù
);

336 ià(
found
) {

337 
	`NVMEV_DEBUG
("2 Found\n");

338 
	`memýy
(
m­pšg
.
key
, 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].key, 
	`cmd_key_Ëngth
(
cmd
));

339 
m­pšg
.
mem_off£t
 = 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].mem_offset;

340 
m­pšg
.
Ãxt_¦Ù
 = 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].next_slot;

341 
m­pšg
.
Ëngth
 = 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].length;

344 ià(!
found
)

345 
	`NVMEV_DEBUG
("NØm­pšg found fÜ key %s\n", 
cmd
.
kv_¡Üe
.
key
);

347 
	`NVMEV_DEBUG
("R‘uºšg m­pšg %lu†’gth %lu fÜ key %s\n", 
m­pšg
.
mem_off£t
,

348 
m­pšg
.
Ëngth
, 
cmd
.
kv_¡Üe
.
key
);

350  
m­pšg
;

351 
	}
}

353 
m­pšg_’Œy
 
	$g‘_m­pšg_’Œy_by_key
(
kv_ál
 *kv_ál, *
key
,

354 
key_Ën
)

356 
m­pšg_’Œy
 
m­pšg
;

357 
¦Ù
 = 0;

358 
boÞ
 
found
 = 
çl£
;

360 
u32
 
couÁ
 = 0;

362 
	`mem£t
(&
m­pšg
, -1, (
m­pšg_’Œy
));

364 
¦Ù
 = 
	`g‘_hash_¦Ù
(
kv_ál
, 
key
, 
key_Ën
);

366 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 != -1) {

367 
	`NVMEV_DEBUG
("Com·ršg % | %.*s\n", 
key
, 
key_Ën
,

368 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
key
);

369 
couÁ
++;

371 ià(
couÁ
 > 10) {

372 
	`NVMEV_DEBUG
("S—rched %uimes", 
couÁ
);

375 ià(
	`memcmp
(
key
, 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].key, 
key_Ën
) == 0) {

376 
	`NVMEV_DEBUG
("1 Found\n");

377 
found
 = 
Œue
;

381 
¦Ù
 = 
kv_ál
->
kv_m­pšg_bË
[¦Ù].
Ãxt_¦Ù
;

382 ià(
¦Ù
 == -1)

384 
	`NVMEV_DEBUG
("Nexˆ¦Ù %d", 
¦Ù
);

387 ià(
found
) {

388 
	`NVMEV_DEBUG
("2 Found\n");

389 
	`memýy
(
m­pšg
.
key
, 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].key, 
key_Ën
);

390 
m­pšg
.
mem_off£t
 = 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].mem_offset;

391 
m­pšg
.
Ãxt_¦Ù
 = 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].next_slot;

392 
m­pšg
.
Ëngth
 = 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].length;

395 ià(!
found
)

396 
	`NVMEV_DEBUG
("NØm­pšg found fÜ key %s\n", 
key
);

398 
	`NVMEV_DEBUG
("R‘uºšg m­pšg %lu†’gth %lu fÜ key %s\n", 
m­pšg
.
mem_off£t
,

399 
m­pšg
.
Ëngth
, 
key
);

401  
m­pšg
;

402 
	}
}

404 
m­pšg_’Œy
 
	$d–‘e_m­pšg_’Œy
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
)

406 
m­pšg_’Œy
 
m­pšg
;

407 
¦Ù
 = 0;

408 
boÞ
 
found
 = 
çl£
;

410 
u32
 
couÁ
 = 0;

412 
	`mem£t
(&
m­pšg
, -1, (
m­pšg_’Œy
));

414 
¦Ù
 = 
	`g‘_hash_¦Ù
(
kv_ál
, 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd));

416 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
mem_off£t
 != -1) {

417 
	`NVMEV_DEBUG
("Com·ršg % | %.*s\n", 
cmd
.
kv_¡Üe
.
key
, 
	`cmd_key_Ëngth
(cmd),

418 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].
key
);

419 
couÁ
++;

421 ià(
couÁ
 > 10) {

422 
	`NVMEV_DEBUG
("S—rched %uimes", 
couÁ
);

425 ià(
	`memcmp
(
cmd
.
kv_¡Üe
.
key
, 
kv_ál
->
kv_m­pšg_bË
[
¦Ù
].key,

426 
	`cmd_key_Ëngth
(
cmd
)) == 0) {

427 
	`NVMEV_DEBUG
("1 Found\n");

428 
found
 = 
Œue
;

432 
¦Ù
 = 
kv_ál
->
kv_m­pšg_bË
[¦Ù].
Ãxt_¦Ù
;

433 ià(
¦Ù
 == -1)

435 
	`NVMEV_DEBUG
("Nexˆ¦Ù %d", 
¦Ù
);

438 ià(
found
) {

439 
	`NVMEV_DEBUG
("2 Found\n");

440 
	`mem£t
(&(
kv_ál
->
kv_m­pšg_bË
[
¦Ù
]), -1, (
m­pšg_’Œy
));

443 ià(!
found
)

444 
	`NVMEV_DEBUG
("NØm­pšg found fÜ key %s\n", 
cmd
.
kv_¡Üe
.
key
);

446 
	`NVMEV_DEBUG
("D–‘šg m­pšg %lu†’gth %lu fÜ key %s\n", 
m­pšg
.
mem_off£t
,

447 
m­pšg
.
Ëngth
, 
cmd
.
kv_¡Üe
.
key
);

449  
m­pšg
;

450 
	}
}

463 
	$__do_³rfÜm_kv_io
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
,

464 *
¡©us
, 
nvmev_dev
 *
nvmev_vdev
)

466 
size_t
 
off£t
;

467 
size_t
 
Ëngth
, 
»maššg
;

468 
´p_offs
 = 0;

469 
´p2_offs
 = 0;

470 
u64
 
·ddr
;

471 
u64
 *
·ddr_li¡
 = 
NULL
;

472 
size_t
 
mem_offs
 = 0;

473 
size_t
 
Ãw_off£t
 = 0;

474 
m­pšg_’Œy
 
’Œy
;

475 
is_š£¹
 = 0;

477 
’Œy
 = 
	`g‘_m­pšg_’Œy
(
kv_ál
, 
cmd
);

478 
off£t
 = 
’Œy
.
mem_off£t
;

479 
Ëngth
 = 
	`cmd_v®ue_Ëngth
(
cmd
);

481 ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_¡Üe
) {

482 ià(
’Œy
.
mem_off£t
 == -1) {

483 
Ãw_off£t
 = 
	`®loÿ‹_mem_off£t
(
kv_ál
, 
cmd
);

484 
off£t
 = 
Ãw_off£t
;

485 
is_š£¹
 = 1;

487 
	`NVMEV_DEBUG
("kv_¡Üš£¹ % %lu\n", 
cmd
.
kv_¡Üe
.
key
, 
off£t
);

489 
	`NVMEV_DEBUG
("kv_¡Üupd©% %lu\n", 
cmd
.
kv_¡Üe
.
key
, 
off£t
);

491 ià(
Ëngth
 !ð
’Œy
.length) {

492 ià(
Ëngth
 <ð
SMALL_LENGTH
 && 
’Œy
.length <= SMALL_LENGTH) {

493 
is_š£¹
 = 2;

495 
	`NVMEV_ERROR
("Length size invalid!!");

499 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_»Œ›ve
) {

500 ià(
’Œy
.
mem_off£t
 == -1) {

501 
	`NVMEV_DEBUG
("kv_»Œ›v% nØexi¡\n", 
cmd
.
kv_¡Üe
.
key
);

503 *
¡©us
 = 
KV_ERR_KEY_NOT_EXIST
;

506 
Ëngth
 = 
	`mš
(
’Œy
.length,†ength);

508 
	`NVMEV_DEBUG
("kv_retrieve %sƒxist -†ength %ld, offset %lu\n",

509 
cmd
.
kv_¡Üe
.
key
, 
Ëngth
, 
off£t
);

511 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_exi¡
) {

512 ià(
’Œy
.
mem_off£t
 == -1) {

513 
	`NVMEV_DEBUG
("kv_exi¡ % nØexi¡\n", 
cmd
.
kv_¡Üe
.
key
);

515 *
¡©us
 = 
KV_ERR_KEY_NOT_EXIST
;

518 
	`NVMEV_DEBUG
("kv_exi¡ % exi¡\n", 
cmd
.
kv_¡Üe
.
key
);

522 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_d–‘e
) {

523 ià(
’Œy
.
mem_off£t
 == -1) {

524 
	`NVMEV_DEBUG
("kv_d–‘% nØexi¡\n", 
cmd
.
kv_¡Üe
.
key
);

526 *
¡©us
 = 
KV_ERR_KEY_NOT_EXIST
;

529 
	`NVMEV_DEBUG
("kv_delete %sƒxist -†ength %ld, offset %lu\n",

530 
cmd
.
kv_¡Üe
.
key
, 
Ëngth
, 
off£t
);

532 
	`d–‘e_m­pšg_’Œy
(
kv_ál
, 
cmd
);

536 
	`NVMEV_ERROR
("Cmdype %d, for key %s but‚ot store or„etrieve.„eturn 0\n",

537 
cmd
.
commÚ
.
Ýcode
, cmd.
kv_¡Üe
.
key
);

541 
»maššg
 = 
Ëngth
;

543 
»maššg
) {

544 
size_t
 
io_size
;

545 *
vaddr
;

547 
mem_offs
 = 0;

548 
´p_offs
++;

549 ià(
´p_offs
 == 1) {

550 
·ddr
 = 
	`kv_io_cmd_v®ue_´p
(
cmd
, 1);

551 } ià(
´p_offs
 == 2) {

552 
·ddr
 = 
	`kv_io_cmd_v®ue_´p
(
cmd
, 2);

553 ià(
»maššg
 > 
PAGE_SIZE
) {

554 
·ddr_li¡
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
)) +

555 (
·ddr
 & 
PAGE_OFFSET_MASK
);

556 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

559 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

562 
vaddr
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
));

564 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

566 ià(
·ddr
 & 
PAGE_OFFSET_MASK
) {

567 
mem_offs
 = 
·ddr
 & 
PAGE_OFFSET_MASK
;

568 ià(
io_size
 + 
mem_offs
 > 
PAGE_SIZE
)

569 
io_size
 = 
PAGE_SIZE
 - 
mem_offs
;

571 ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_¡Üe
) {

572 
	`memýy
(
nvmev_vdev
->
¡Üage_m­³d
 + 
off£t
, 
vaddr
 + 
mem_offs
, 
io_size
);

573 } ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_»Œ›ve
) {

574 
	`memýy
(
vaddr
 + 
mem_offs
, 
nvmev_vdev
->
¡Üage_m­³d
 + 
off£t
, 
io_size
);

576 
	`NVMEV_ERROR
("Wrong KV Command…assedo NVMeVirt!!\n");

579 
	`kunm­_©omic
(
vaddr
);

581 
»maššg
 -ð
io_size
;

582 
off£t
 +ð
io_size
;

585 ià(
·ddr_li¡
 !ð
NULL
)

586 
	`kunm­_©omic
(
·ddr_li¡
);

588 ià(
is_š£¹
 == 1) {

589 
	`Ãw_m­pšg_’Œy
(
kv_ál
, 
cmd
, 
Ãw_off£t
, 
nvmev_vdev
);

590 } ià(
is_š£¹
 == 2) {

591 
	`upd©e_m­pšg_’Œy
(
kv_ál
, 
cmd
);

594 ià(
cmd
.
commÚ
.
Ýcode
 =ð
nvme_cmd_kv_»Œ›ve
)

595  
Ëngth
;

598 
	}
}

600 
	$__do_³rfÜm_kv_b©ched_io
(
kv_ál
 *kv_ál, 
Ýcode
, *
key
,

601 
key_Ën
, *
v®ue
, 
v®_Ën
,

602 
nvmev_dev
 *
nvmev_vdev
)

604 
size_t
 
off£t
;

605 
size_t
 
Ãw_off£t
 = 0;

606 
m­pšg_’Œy
 
’Œy
;

607 
is_š£¹
 = 0;

609 
’Œy
 = 
	`g‘_m­pšg_’Œy_by_key
(
kv_ál
, 
key
, 
key_Ën
);

610 
off£t
 = 
’Œy
.
mem_off£t
;

612 ià(
Ýcode
 =ð
nvme_cmd_kv_¡Üe
) {

613 ià(
’Œy
.
mem_off£t
 == -1) {

614 
	`NVMEV_DEBUG
("kv_¡Üš£¹ %s\n", 
key
);

616 
Ãw_off£t
 = 
	`®loÿ‹_mem_off£t_by_Ëngth
(
kv_ál
, 
v®_Ën
);

617 
off£t
 = 
Ãw_off£t
;

618 
is_š£¹
 = 1;

620 
	`NVMEV_DEBUG
("kv_¡Üupd©% %lu\n", 
key
, 
off£t
);

622 ià(
v®_Ën
 !ð
’Œy
.
Ëngth
) {

623 ià(
v®_Ën
 <ð
SMALL_LENGTH
 && 
’Œy
.
Ëngth
 <= SMALL_LENGTH) {

624 
is_š£¹
 = 2;

626 
	`NVMEV_ERROR
("Length size invalid!!");

631 
	`NVMEV_ERROR
("Cmdy³ %d, fÜ key % buˆnÙ stÜÜ„‘r›ve.„‘uº 0\n", 
Ýcode
,

632 
key
);

637 
	`NVMEV_DEBUG
("V®uwr™Ëngth %dØpos™iÚ %lu %s\n", 
v®_Ën
, 
off£t
, 
v®ue
);

638 
	`memýy
(
nvmev_vdev
->
¡Üage_m­³d
 + 
off£t
, 
v®ue
, 
v®_Ën
);

640 ià(
is_š£¹
 == 1) {

641 
	`Ãw_m­pšg_’Œy_by_key
(
kv_ál
, 
key
, 
key_Ën
, 
v®_Ën
, 
Ãw_off£t
, 
nvmev_vdev
);

648 
	}
}

650 
	$__do_³rfÜm_kv_b©ch
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
,

651 *
¡©us
, 
nvmev_dev
 *
nvmev_vdev
)

653 
size_t
 
off£t
;

654 
size_t
 
Ëngth
, 
»maššg
;

655 
´p_offs
 = 0;

656 
´p2_offs
 = 0;

657 
u64
 
·ddr
;

658 
u64
 *
·ddr_li¡
 = 
NULL
;

659 
size_t
 
mem_offs
 = 0;

660 
i
;

661 
·ylßd_fÜm©
 *
·ylßd
;

662 *
bufãr
 = 
NULL
;

663 
key
[20];

664 *
v®ue
;

665 
sub_cmd_út
;

666 
Ýcode
, 
sub_Ën
, 
key_Ën
, 
v®_Ën
, 
·ylßd_off£t
 = 0;

668 
sub_cmd_út
 = 
cmd
.
kv_b©ch
.
rsvd4
;

669 
Ëngth
 = 
	`cmd_v®ue_Ëngth
(
cmd
);

671 
v®ue
 = 
	`km®loc
(4097, 
GFP_KERNEL
);

672 
bufãr
 = 
	`km®loc
(
Ëngth
, 
GFP_KERNEL
);

674 
»maššg
 = 
Ëngth
;

675 
off£t
 = 0;

677 
»maššg
) {

678 
size_t
 
io_size
;

679 *
vaddr
;

681 
mem_offs
 = 0;

682 
´p_offs
++;

683 ià(
´p_offs
 == 1) {

684 
·ddr
 = 
	`kv_io_cmd_v®ue_´p
(
cmd
, 1);

685 } ià(
´p_offs
 == 2) {

686 
·ddr
 = 
	`kv_io_cmd_v®ue_´p
(
cmd
, 2);

687 ià(
»maššg
 > 
PAGE_SIZE
) {

688 
·ddr_li¡
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
)) +

689 (
·ddr
 & 
PAGE_OFFSET_MASK
);

690 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

693 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

696 
vaddr
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
));

698 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

700 ià(
·ddr
 & 
PAGE_OFFSET_MASK
) {

701 
mem_offs
 = 
·ddr
 & 
PAGE_OFFSET_MASK
;

702 ià(
io_size
 + 
mem_offs
 > 
PAGE_SIZE
)

703 
io_size
 = 
PAGE_SIZE
 - 
mem_offs
;

706 
	`NVMEV_DEBUG
("Value write†ength %luo…osition %lu, io size: %ld, mem_off: %lu\n",

707 
»maššg
, 
off£t
, 
io_size
, 
mem_offs
);

708 
	`memýy
(
bufãr
 + 
off£t
, 
vaddr
 + 
mem_offs
, 
io_size
);

710 
	`kunm­_©omic
(
vaddr
);

712 
»maššg
 -ð
io_size
;

713 
off£t
 +ð
io_size
;

717 
·ylßd
 = (
·ylßd_fÜm©
 *)
bufãr
;

718 
·ylßd_off£t
 = 
ALIGN_LEN
;

719 
i
 = 0; i < 
sub_cmd_út
; i++) {

720 
	`mem£t
(
key
, 0, 20);

721 
	`mem£t
(
v®ue
, 0, 4097);

722 
sub_Ën
 = 0;

723 
Ýcode
 = 
·ylßd
->
b©ch_h—d
.
©Œ
[
i
].opcode;

724 
key_Ën
 = 
·ylßd
->
b©ch_h—d
.
©Œ
[
i
].
keySize
;

725 
v®_Ën
 = 
·ylßd
->
b©ch_h—d
.
©Œ
[
i
].
v®ueSize
;

726 
sub_Ën
 +ð((
key_Ën
 - 1è/ 
ALIGN_LEN
 + 1) * ALIGN_LEN;

727 
sub_Ën
 +ð((
v®_Ën
 - 1è/ 
ALIGN_LEN
 + 1) * ALIGN_LEN;

728 
sub_Ën
 +ð
ALIGN_LEN
;

730 
	`memýy
(
key
, 
·ylßd
->
sub_·ylßd
 + 
·ylßd_off£t
, 
key_Ën
);

731 
	`memýy
(
v®ue
,

732 
·ylßd
->
sub_·ylßd
 + 
·ylßd_off£t
 +

733 ((
key_Ën
 - 1è/ 
ALIGN_LEN
 + 1) * ALIGN_LEN,

734 
v®_Ën
);

735 
·ylßd_off£t
 +ð
sub_Ën
;

736 
	`NVMEV_DEBUG
("sub-·ylßd %d %d %d %d % %s", 
·ylßd
->
b©ch_h—d
.
©Œ
[
i
].
Ýcode
,

737 
key_Ën
, 
v®_Ën
, 
sub_Ën
, 
key
, 
v®ue
);

739 
	`__do_³rfÜm_kv_b©ched_io
(
kv_ál
, 
Ýcode
, 
key
, 
key_Ën
, 
v®ue
, 
v®_Ën
,

740 
nvmev_vdev
);

743 
	`NVMEV_DEBUG
("fšished kv_b©ch w™h %d sub-commªds", 
sub_cmd_út
);

745 ià(
·ddr_li¡
 !ð
NULL
)

746 
	`kunm­_©omic
(
·ddr_li¡
);

748 ià(
v®ue
 !ð
NULL
)

749 
	`kä“
(
v®ue
);

751 ià(
bufãr
 !ð
NULL
)

752 
	`kä“
(
bufãr
);

755 
	}
}

757 
	$kv_™”_Ý’
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
, *
¡©us
)

759 
™”
 = 0;

760 
boÞ
 
æag
 = 
çl£
;

762 
™”
 = 1; iter <= 16; iter++) {

763 ià(
kv_ál
->
™”_hªdË
[
™”
] =ð
NULL
) {

764 
æag
 = 
Œue
;

769 ià(!
æag
)

772 
kv_ál
->
™”_hªdË
[
™”
] = 
	`km®loc
((
kv_™”_cÚ‹xt
), 
GFP_KERNEL
);

773 
kv_ál
->
™”_hªdË
[
™”
]->
buf
 = 
	`km®loc
(32768, 
GFP_KERNEL
);

774 
kv_ál
->
™”_hªdË
[
™”
]->
’d
 = 0;

775 
kv_ál
->
™”_hªdË
[
™”
]->
by‹swr™‹n
 = 0;

776 
kv_ál
->
™”_hªdË
[
™”
]->
bufoff£t
 = 0;

777 
kv_ál
->
™”_hªdË
[
™”
]->
cu¼’t_pos
 = 0;

778 
kv_ál
->
™”_hªdË
[
™”
]->
b™mask
 = 
cmd
.
kv_™”_»q
.
™”_b™mask
;

779 
kv_ál
->
™”_hªdË
[
™”
]->
´efix
 = 
cmd
.
kv_™”_»q
.
™”_v®
;

781 *
¡©us
 = 0;

782  
™”
;

783 
	}
}

785 
	$kv_™”_þo£
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
, *
¡©us
)

787 
™”
 = 
cmd
.
kv_™”_»q
.
™”_hªdË
;

789 ià(
kv_ál
->
™”_hªdË
[
™”
]) {

790 
	`kä“
(
kv_ál
->
™”_hªdË
[
™”
]->
buf
);

791 
	`kä“
(
kv_ál
->
™”_hªdË
[
™”
]);

793 
kv_ál
->
™”_hªdË
[
™”
] = 
NULL
;

796 *
¡©us
 = 0;

798 
	}
}

800 
	$kv_™”_»ad
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
,

801 *
¡©us
)

803 
™”
 = 
cmd
.
kv_™”_»q
.
™”_hªdË
;

804 
kv_™”_cÚ‹xt
 *
hªdË
 = 
kv_ál
->
™”_hªdË
[
™”
];

805 
pos
 = 0, 
keyËn
 = 16, 
buf_off£t
 = 4, 
Ä_keys
 = 0;

806 
key
;

807 
boÞ
 
fuÎ
 = 
çl£
, 
’d
 = false;

808 
size_t
 
»maššg
, 
mem_offs
 = 0, 
off£t
;

809 
´p_offs
 = 0, 
´p2_offs
 = 0;

810 
u64
 
·ddr
;

811 
u64
 *
·ddr_li¡
 = 
NULL
;

813 ià(
hªdË
 =ð
NULL
) {

814 
	`NVMEV_ERROR
("Invalid Iterator Handle");

818 
pos
 = 
hªdË
->
cu¼’t_pos
;

820 
pos
 < 
kv_ál
->
hash_¦Ùs
) {

821 ià(
kv_ál
->
kv_m­pšg_bË
[
pos
].
mem_off£t
 != -1) {

822 
	`memýy
(&
key
, 
kv_ál
->
kv_m­pšg_bË
[
pos
].key, 4);

823 ià((
key
 & 
hªdË
->
b™mask
è=ð(hªdË->
´efix
 & handle->bitmask)) {

824 
	`NVMEV_DEBUG
("found % © %d", 
kv_ál
->
kv_m­pšg_bË
[
pos
].
key
,

825 
pos
);

827 ià((
buf_off£t
 + 4 + 
keyËn
) > 1024) {

828 
fuÎ
 = 
Œue
;

832 
	`memýy
(
hªdË
->
buf
 + 
buf_off£t
, &
keyËn
, 4);

833 
buf_off£t
 += 4;

834 
	`memýy
(
hªdË
->
buf
 + 
buf_off£t
, 
kv_ál
->
kv_m­pšg_bË
[
pos
].
key
,

835 
keyËn
);

836 
buf_off£t
 +ð(
keyËn
 + 3) & (~3);

838 
Ä_keys
++;

842 
pos
++;

843 ià(
pos
 =ð
kv_ál
->
hash_¦Ùs
) {

844 
’d
 = 
Œue
;

848 
	`memýy
(
hªdË
->
buf
, &
Ä_keys
, 4);

850 
	`NVMEV_DEBUG
("I‹¿tÜ„—d dÚe, buf_off£ˆ%d,…o %d", 
buf_off£t
, 
pos
);

851 
hªdË
->
cu¼’t_pos
 = 
pos
;

854 
»maššg
 = 
buf_off£t
;

855 
off£t
 = 0;

857 
»maššg
) {

858 
size_t
 
io_size
;

859 *
vaddr
;

861 
mem_offs
 = 0;

862 
´p_offs
++;

863 ià(
´p_offs
 == 1) {

864 
·ddr
 = 
	`kv_io_cmd_v®ue_´p
(
cmd
, 1);

865 } ià(
´p_offs
 == 2) {

866 
·ddr
 = 
	`kv_io_cmd_v®ue_´p
(
cmd
, 2);

867 ià(
»maššg
 > 
PAGE_SIZE
) {

868 
·ddr_li¡
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
)) +

869 (
·ddr
 & 
PAGE_OFFSET_MASK
);

870 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

873 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

876 
vaddr
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
));

878 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

880 ià(
·ddr
 & 
PAGE_OFFSET_MASK
) {

881 
mem_offs
 = 
·ddr
 & 
PAGE_OFFSET_MASK
;

882 ià(
io_size
 + 
mem_offs
 > 
PAGE_SIZE
)

883 
io_size
 = 
PAGE_SIZE
 - 
mem_offs
;

886 
	`NVMEV_DEBUG
(

888 
»maššg
, 
off£t
, 
io_size
, 
mem_offs
);

889 
	`memýy
(
vaddr
 + 
mem_offs
, 
hªdË
->
buf
 + 
off£t
, 
io_size
);

891 
	`kunm­_©omic
(
vaddr
);

893 
»maššg
 -ð
io_size
;

894 
off£t
 +ð
io_size
;

897 ià(
·ddr_li¡
 !ð
NULL
)

898 
	`kunm­_©omic
(
·ddr_li¡
);

900 *
¡©us
 = 0;

901 ià(
’d
) {

902 *
¡©us
 = 0x393;

905  
buf_off£t
;

906 
	}
}

908 
	$__do_³rfÜm_kv_™”_io
(
kv_ál
 *kv_ál, 
nvme_kv_commªd
 
cmd
,

909 *
¡©us
)

911 ià(
	`is_kv_™”_»q_cmd
(
cmd
.
commÚ
.
Ýcode
)) {

912 ià(
cmd
.
kv_™”_»q
.
ÝtiÚ
 & 
ITER_OPTION_OPEN
) {

913  
	`kv_™”_Ý’
(
kv_ál
, 
cmd
, 
¡©us
);

914 } ià(
cmd
.
kv_™”_»q
.
ÝtiÚ
 & 
ITER_OPTION_CLOSE
) {

915  
	`kv_™”_þo£
(
kv_ál
, 
cmd
, 
¡©us
);

917 } ià(
	`is_kv_™”_»ad_cmd
(
cmd
.
commÚ
.
Ýcode
)) {

918  
	`kv_™”_»ad
(
kv_ál
, 
cmd
, 
¡©us
);

922 
	}
}

924 
boÞ
 
	$kv_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
,

925 
nvmev_dev
 *
nvmev_vdev
)

927 
nvme_commªd
 *
cmd
 = 
»q
->cmd;

929 
cmd
->
commÚ
.
Ýcode
) {

930 
nvme_cmd_wr™e
:

931 
nvme_cmd_»ad
:

932 
»t
->
n£cs_rg‘
 =

933 
	`__scheduË_io_un™s
(
cmd
->
commÚ
.
Ýcode
, cmd->
rw
.
¦ba
,

934 
	`__cmd_io_size
((
nvme_rw_commªd
 *)
cmd
),

935 
	`__g‘_w®lþock
(
nvmev_vdev
),‚vmev_vdev);

937 
nvme_cmd_æush
:

938 
»t
->
n£cs_rg‘
 = 
	`__scheduË_æush
(
»q
, 
nvmev_vdev
);

940 
nvme_cmd_kv_¡Üe
:

941 
nvme_cmd_kv_»Œ›ve
:

942 
nvme_cmd_kv_b©ch
:

943 
»t
->
n£cs_rg‘
 = 
	`__scheduË_io_un™s
(

944 
cmd
->
commÚ
.
Ýcode
, 0, 
	`cmd_v®ue_Ëngth
(*((
nvme_kv_commªd
 *)cmd)),

945 
	`__g‘_w®lþock
(
nvmev_vdev
),‚vmev_vdev);

946 
	`NVMEV_INFO
("%d, %Îu, %Îu\n", 
	`cmd_v®ue_Ëngth
(*((
nvme_kv_commªd
 *)
cmd
)),

947 
	`__g‘_w®lþock
(
nvmev_vdev
), 
»t
->
n£cs_rg‘
);

950 
	`NVMEV_ERROR
("%s: commªd‚Ù im¶em’‹d: % (0x%x)\n", 
__func__
,

951 
	`nvme_Ýcode_¡ršg
(
cmd
->
commÚ
.
Ýcode
), cmd->common.opcode);

955  
Œue
;

956 
	}
}

958 
boÞ
 
	$kv_id’tify_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvme_commªd
 
cmd
)

960  
	`is_kv_cmd
(
cmd
.
commÚ
.
Ýcode
);

961 
	}
}

963 
	$kv_³rfÜm_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvme_commªd
 *
cmd
, 
ušt32_t
 *
¡©us
)

965 
kv_ál
 *kv_áÈð(kv_áÈ*)
ns
->
áls
;

966 
nvme_kv_commªd
 *
kv_cmd
 = (nvme_kv_commªd *)
cmd
;

968 
nvmev_dev
 *
nvmev_vdev
 = 
ns
->
p_dev
;

970 ià(
	`is_kv_b©ch_cmd
(
cmd
->
commÚ
.
Ýcode
))

971  
	`__do_³rfÜm_kv_b©ch
(
kv_ál
, *
kv_cmd
, 
¡©us
, 
nvmev_vdev
);

972 ià(
	`is_kv_™”_cmd
(
cmd
->
commÚ
.
Ýcode
))

973  
	`__do_³rfÜm_kv_™”_io
(
kv_ál
, *
kv_cmd
, 
¡©us
);

975  
	`__do_³rfÜm_kv_io
(
kv_ál
, *
kv_cmd
, 
¡©us
, 
nvmev_vdev
);

976 
	}
}

978 
	$kv_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

979 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
)

981 
kv_ál
 *kv_ftl;

982 
i
;

984 
nvmev_dev
 *
nvmev_vdev
 = 
ns
->
p_dev
;

985 
kv_cÚfigs
 *
kv_cfgs
 = &
ál_cfgs
->
exŒa_cÚfigs
.
kv
;

986 
KV_MAPPING_TABLE_SIZE
 = 
kv_cfgs
->KV_MAPPING_TABLE_SIZE;

987 
ALLOCATOR_TYPE
 = 
kv_cfgs
->ALLOCATOR_TYPE;

989 
kv_ál
 = 
	`km®loc
((kv_ál), 
GFP_KERNEL
);

991 
	`NVMEV_INFO
("KV mappingable: %#010lx-%lu\n",

992 
nvmev_vdev
->
cÚfig
.
¡Üage_¡¬t
 +‚vmev_vdev->cÚfig.
¡Üage_size
,

993 
KV_MAPPING_TABLE_SIZE
);

995 
kv_ál
->
kv_m­pšg_bË
 =

996 
	`mem»m­
(
nvmev_vdev
->
cÚfig
.
¡Üage_¡¬t
 +‚vmev_vdev->cÚfig.
¡Üage_size
,

997 
KV_MAPPING_TABLE_SIZE
, 
MEMREMAP_WB
);

999 ià(
kv_ál
->
kv_m­pšg_bË
 =ð
NULL
)

1000 
	`NVMEV_ERROR
("Failedo map kv mappingable.\n");

1002 
	`mem£t
(
kv_ál
->
kv_m­pšg_bË
, 0x0, 
KV_MAPPING_TABLE_SIZE
);

1004 ià(
ALLOCATOR_TYPE
 =ð
ALLOCATOR_TYPE_BITMAP
) {

1005 
kv_ál
->
®loÿtÜ_Ýs
 = 
b™m­_Ýs
;

1006 } ià(
ALLOCATOR_TYPE
 =ð
ALLOCATOR_TYPE_APPEND_ONLY
) {

1007 
kv_ál
->
®loÿtÜ_Ýs
 = 
­³nd_Úly_Ýs
;

1009 
kv_ál
->
®loÿtÜ_Ýs
 = 
­³nd_Úly_Ýs
;

1012 ià(!
kv_ál
->
®loÿtÜ_Ýs
.
	`š™
(
nvmev_vdev
->
cÚfig
.
¡Üage_size
)) {

1013 
	`NVMEV_ERROR
("Allocator init failed\n");

1016 
kv_ál
->
hash_¦Ùs
 = 
KV_MAPPING_TABLE_SIZE
 / 
KV_MAPPING_ENTRY_SIZE
;

1017 
	`NVMEV_INFO
("Hash slÙs: %ld\n", 
kv_ál
->
hash_¦Ùs
);

1019 
i
 = 0; i < 
kv_ál
->
hash_¦Ùs
; i++) {

1020 
kv_ál
->
kv_m­pšg_bË
[
i
].
mem_off£t
 = -1;

1021 
kv_ál
->
kv_m­pšg_bË
[
i
].
Ãxt_¦Ù
 = -1;

1022 
kv_ál
->
kv_m­pšg_bË
[
i
].
Ëngth
 = -1;

1025 
i
 = 0; i < 16; i++)

1026 
kv_ál
->
™”_hªdË
[
i
] = 
NULL
;

1028 
ns
->
id
 = id;

1029 
ns
->
csi
 = 
NVME_CSI_NVM
;

1030 
ns
->
áls
 = (*)
kv_ál
;

1031 
ns
->
size
 = size;

1032 
ns
->
m­³d
 = 
m­³d_addr
;

1034 
ns
->
´oc_io_cmd
 = 
kv_´oc_nvme_io_cmd
;

1036 
ns
->
id’tify_io_cmd
 = 
kv_id’tify_nvme_io_cmd
;

1037 
ns
->
³rfÜm_io_cmd
 = 
kv_³rfÜm_nvme_io_cmd
;

1040 
	}
}

1042 
	$kv_»move_Çme¥aû
(
nvmev_ns
 *
ns
)

1044 
	`kä“
(
ns
->
áls
);

1045 
ns
->
áls
 = 
NULL
;

1046 
	}
}

	@kv_ftl.h

3 #iâdeà
_NVMEVIRT_KV_FTL_H


4 
	#_NVMEVIRT_KV_FTL_H


	)

6 
	~<lšux/hashbË.h
>

7 
	~"nvmev.h
"

8 
	~"nvme_kv.h
"

10 
	~"­³nd_Úly.h
"

11 
	~"b™m­.h
"

13 
	#is_kv_­³nd_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_­³nd
)

	)

14 
	#is_kv_¡Üe_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_¡Üe
)

	)

15 
	#is_kv_»Œ›ve_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_»Œ›ve
)

	)

16 
	#is_kv_d–‘e_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_d–‘e
)

	)

17 
	#is_kv_™”_»q_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_™”_»q
)

	)

18 
	#is_kv_™”_»ad_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_™”_»ad
)

	)

19 
	#is_kv_exi¡_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_exi¡
)

	)

20 
	#is_kv_b©ch_cmd
(
Ýcode
è((Ýcodeè=ð
nvme_cmd_kv_b©ch
)

	)

22 
	#is_kv_cmd
(
Ýcode
) \

23 (
	`is_kv_­³nd_cmd
(
Ýcode
è|| 
	`is_kv_¡Üe_cmd
(Ýcodeè|| 
	`is_kv_»Œ›ve_cmd
(opcode) || \

24 
	`is_kv_d–‘e_cmd
(
Ýcode
è|| 
	`is_kv_™”_»q_cmd
(Ýcodeè|| 
	`is_kv_™”_»ad_cmd
(opcode) || \

25 
	`is_kv_exi¡_cmd
(
Ýcode
)) || \

26 
	`is_kv_b©ch_cmd
(
Ýcode
)

	)

28 
	#is_kv_™”_cmd
(
Ýcode
è(
	`is_kv_™”_»q_cmd
(Ýcodeè|| 
	`is_kv_™”_»ad_cmd
(Ýcode))

	)

32 
	mKV_SUCCESS
 = 0,

33 
	mKV_ERR_KEY_NOT_EXIST
 = 0x310,

34 
	mKV_ERR_DEV_CAPACITY
 = 0x312,

38 
	mKVS_ERR_BUFFER_SMALL
=0x301 ,

39 
	mKVS_ERR_COMMAND_INITIALIZED
=0x002 ,

40 
	mKVS_ERR_COMMAND_SUBMITTED
=0x003 ,

41 
	mKVS_ERR_DEV_CAPACITY
=0x004 ,

42 
	mKVS_ERR_DEV_INIT
=0x005 ,

43 
	mKVS_ERR_DEV_INITIALIZED
=0x006 ,

44 
	mKVS_ERR_DEV_NOT_EXIST
=0x007 ,

45 
	mKVS_ERR_DEV_SANITIZE_FAILED
=0x008 ,

46 
	mKVS_ERR_DEV_SANIZE_IN_PROGRESS
=0x009,

47 
	mKVS_ERR_ITERATOR_COND_INVALID
=0x00A,

48 
	mKVS_ERR_ITERATOR_MAX
=0x00B ,

49 
	mKVS_ERR_ITERATOR_NOT_EXIST
=0x00C ,

50 
	mKVS_ERR_ITERATOR_OPEN
=0x00D ,

51 
	mKVS_ERR_KEY_EXIST
=0x00E ,

52 
	mKVS_ERR_KEY_INVALID
=0x00F ,

53 
	mKVS_ERR_KEY_LENGTH_INVALID
=0x010 ,

54 
	mKVS_ERR_KEY_NOT_EXIST
=0x011 ,

55 
	mKVS_ERR_OPTION_INVALID
=0x012 ,

56 
	mKVS_ERR_PARAM_INVALID
=0x013 ,

57 
	mKVS_ERR_PURGE_IN_PROGRESS
=0x014 ,

58 
	mKVS_ERR_QUEUE_CQID_INVALID
=0x015 ,

59 
	mKVS_ERR_QUEUE_DELETION_INVALID
=0x016 ,

60 
	mKVS_ERR_QUEUE_IN_SUTDOWN
=0x017 ,

61 
	mKVS_ERR_QUEUE_IS_FULL
=0x018 ,

62 
	mKVS_ERR_QUEUE_MAX_QUEUE
=0x019 ,

63 
	mKVS_ERR_QUEUE_QID_INVALID
=0x01A ,

64 
	mKVS_ERR_QUEUE_QSIZE_INVALID
=0x01B,

65 
	mKVS_ERR_QUEUE_SQID_INVALID
=0x01C ,

66 
	mKVS_ERR_SYS_BUSY
=0x01D ,

67 
	mKVS_ERR_SYS_IO
=0x01E ,

68 
	mKVS_ERR_TIMEOUT
=0x01F ,

69 
	mKVS_ERR_UNCORRECTIBLE
=0x020 ,

70 
	mKVS_ERR_VALUE_LENGTH_INVALID
=0x021 ,

71 
	mKVS_ERR_VALUE_LENGTH_MISALIGNED
=0x022 ,

72 
	mKVS_ERR_VALUE_OFFSET_INVALID
=0x023 ,

73 
	mKVS_ERR_VALUE_UPDATE_NOT_ALLOWED
=0x024 ,

74 
	mKVS_ERR_VENDOR
=0x025 ,

75 
	mKVS_ERR_PERMISSION
 = 0x26,

78 
	mKVS_ERR_CACHE_INVALID_PARAM
=0x200 ,

79 
	mKVS_ERR_CACHE_NO_CACHED_KEY
=0x201 ,

80 
	mKVS_ERR_DD_INVALID_QUEUE_TYPE
=0x202 ,

81 
	mKVS_ERR_DD_NO_AVAILABLE_RESOURCE
=0x203 ,

82 
	mKVS_ERR_DD_NO_DEVICE
=0x204 ,

83 
	mKVS_ERR_DD_UNSUPPORTED_CMD
=0x205 ,

84 
	mKVS_ERR_DECOMPRESSION
=0x206 ,

85 
	mKVS_ERR_HEAP_ALLOC_FAILURE
=0x207 ,

86 
	mKVS_ERR_ITERATE_HANDLE_ALREADY_OPENED
=0x208 ,

87 
	mKVS_ERR_ITERATE_REQUEST_FAIL
=0x209 ,

88 
	mKVS_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
=0x20A ,

89 
	mKVS_ERR_MISALIGNED_KEY_SIZE
=0x20B ,

90 
	mKVS_ERR_MISALIGNED_VALUE_OFFSET
=0x20C ,

91 
	mKVS_ERR_SDK_CLOSE
=0x20D ,

92 
	mKVS_ERR_SDK_INVALID_PARAM
=0x20E ,

93 
	mKVS_ERR_SDK_OPEN
=0x20F ,

94 
	mKVS_ERR_SLAB_ALLOC_FAILURE
=0x210 ,

95 
	mKVS_ERR_UNRECOVERED_ERROR
=0x211 ,

98 
	mKVS_ERR_NS_ATTACHED
=0x300 ,

99 
	mKVS_ERR_NS_CAPACITY
=0x301 ,

100 
	mKVS_ERR_NS_DEFAULT
=0x302 ,

101 
	mKVS_ERR_NS_INVALID
=0x303 ,

102 
	mKVS_ERR_NS_MAX
=0x304 ,

103 
	mKVS_ERR_NS_NOT_ATTACHED
=0x305 ,

106 
	mKVS_ERR_CONT_CAPACITY
=0x400 ,

107 
	mKVS_ERR_CONT_CLOSE
=0x401 ,

108 
	mKVS_ERR_CONT_EXIST
=0x402 ,

109 
	mKVS_ERR_CONT_GROUP_BY
=0x403 ,

110 
	mKVS_ERR_CONT_INDEX
=0x404 ,

111 
	mKVS_ERR_CONT_NAME
=0x405 ,

112 
	mKVS_ERR_CONT_NOT_EXIST
=0x406 ,

113 
	mKVS_ERR_CONT_OPEN
=0x407 ,

115 } 
	tkvs_»suÉ
;

117 
šlše
 
__Ë64
 
	$kv_io_cmd_key_´p
(
nvme_kv_commªd
 
cmd
, cÚ¡ 
´p_num
)

119 ià(
´p_num
 != 1 &&…rp_num != 2) {

120 
	`NVMEV_ERROR
("Inv®id PRP‚umb” %d iÀrw_cmd_´p", 
´p_num
);

124 ià(
´p_num
 == 1) {

125  
cmd
.
kv_¡Üe
.
key_´p
;

127  
cmd
.
kv_¡Üe
.
key_´p2
;

131 
	}
}

133 
šlše
 
__Ë64
 
	$kv_io_cmd_v®ue_´p
(
nvme_kv_commªd
 
cmd
, cÚ¡ 
´p_num
)

135 ià(
´p_num
 != 1 &&…rp_num != 2) {

136 
	`NVMEV_ERROR
("Inv®id PRP‚umb” %d iÀrw_cmd_´p", 
´p_num
);

140 ià(
´p_num
 == 1) {

141  
cmd
.
kv_¡Üe
.
d±r
.
´p1
;

143  
cmd
.
kv_¡Üe
.
d±r
.
´p2
;

147 
	}
}

149 
šlše
 
	$hash_funùiÚ
(*
key
, cÚ¡ 
Ëngth
)

151 *
p
 = 
key
;

152 
h
 = 2166136261;

153 
i
;

155 
i
 = 0; i < 
Ëngth
; i++)

156 
h
 = (h * 16777619è^ 
p
[
i
];

158  
h
;

159 
	}
}

161 
	sm­pšg_’Œy
 {

162 
	mkey
[18];

163 
size_t
 
	mmem_off£t
;

164 
size_t
 
	mËngth
;

165 
	mÃxt_¦Ù
;

168 
	#KV_MAPPING_ENTRY_SIZE
 (
m­pšg_’Œy
)

	)

170 (
	tš™_â
)(
	tu64
 
	tsize
);

171 
	$size_t
(
	t®loÿ‹_â
)(
	tu64
 
	tËngth
, *
	t¬gs
);

172 (
	td—Îoÿ‹_â
)(
	tu64
 
	tmem_off£t
, u64 
	tËngth
, 
	tboÞ
 
	tov”wr™e
);

173 (
	tkžl_â
)();

175 
	s®loÿtÜ_Ýs
 {

176 
š™_â
 *
š™
;

177 
®loÿ‹_â
 *
®loÿ‹
;

178 
d—Îoÿ‹_â
 *
d—Îoÿ‹
;

179 
kžl_â
 *
kžl
;

182 
	skv_ál
 {

183 
ssd
 *ssd;

185 
m­pšg_’Œy
 *
kv_m­pšg_bË
;

186 
hash_¦Ùs
;

188 
®loÿtÜ_Ýs
‡llocator_ops;

189 
kv_™”_cÚ‹xt
 *
™”_hªdË
[17];

192 
boÞ
 
	`kv_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
,

193 
nvmev_dev
 *
nvmev_vdev
);

194 
boÞ
 
	`kv_id’tify_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvme_commªd
 
cmd
);

195 
	`kv_³rfÜm_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvme_commªd
 *
cmd
,

196 
ušt32_t
 *
¡©us
);

197 
	`kv_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

198 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
);

199 
	`kv_»move_Çme¥aû
(
nvmev_ns
 *
ns
);

	@main.c

3 
	~<lšux/k”Ãl.h
>

4 
	~<lšux/kth»ad.h
>

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/š™.h
>

7 
	~<lšux/moduË.h
>

8 
	~<lšux/´oc_fs.h
>

9 
	~<lšux/£q_fže.h
>

10 
	~<lšux/d–ay.h
>

11 
	~<lšux/uacûss.h
>

12 
	~<lšux/v”siÚ.h
>

14 
	~<lšux/debugfs.h
>

15 
	~<lšux/kobjeù.h
>

16 
	~<lšux/sysfs.h
>

17 
	~<lšux/sched.h
>

18 
	~<lšux/li¡.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/dÿche.h
>

24 
	~<lšux/fs_¡ruù.h
>

25 
	~<lšux/lim™s.h
>

26 
	~<lšux/¦ab.h
>

28 #ifdeà
CONFIG_X86


29 
	~<asm/e820/ty³s.h
>

30 
	~<asm/e820/­i.h
>

33 
	~"§ve_lßd.h
"

34 
	~"check_phäag.h
"

35 
	~"nvmev.h
"

36 
	~"cÚv_ál.h
"

37 
	~"zns_ál.h
"

38 
	~"sim¶e_ál.h
"

39 
	~"kv_ál.h
"

40 
	~"dma.h
"

67 
LIST_HEAD
(
deviûs
);

69 
nvmev
 *
	gnvmev
 = 
NULL
;

71 
	gio_usšg_dma
 = 
çl£
;

73 *
	gcmd
;

76 
	$nvmev_´oc_dbs
(
nvmev_dev
 *
nvmev_vdev
)

78 
qid
;

79 
dbs_idx
;

80 
Ãw_db
;

81 
Þd_db
;

84 
Ãw_db
 = 
nvmev_vdev
->
dbs
[0];

85 ià(
Ãw_db
 !ð
nvmev_vdev
->
Þd_dbs
[0]) {

86 
	`nvmev_´oc_admš_sq
(
Ãw_db
, 
nvmev_vdev
->
Þd_dbs
[0],‚vmev_vdev);

87 
nvmev_vdev
->
Þd_dbs
[0] = 
Ãw_db
;

89 
Ãw_db
 = 
nvmev_vdev
->
dbs
[1];

90 ià(
Ãw_db
 !ð
nvmev_vdev
->
Þd_dbs
[1]) {

91 
	`nvmev_´oc_admš_cq
(
Ãw_db
, 
nvmev_vdev
->
Þd_dbs
[1]);

92 
nvmev_vdev
->
Þd_dbs
[1] = 
Ãw_db
;

96 
qid
 = 1; qid <ð
nvmev_vdev
->
Ä_sq
; qid++) {

97 ià(
nvmev_vdev
->
sqes
[
qid
] =ð
NULL
)

99 
dbs_idx
 = 
qid
 * 2;

100 
Ãw_db
 = 
nvmev_vdev
->
dbs
[
dbs_idx
];

101 
Þd_db
 = 
nvmev_vdev
->
Þd_dbs
[
dbs_idx
];

102 ià(
Ãw_db
 !ð
Þd_db
) {

103 
nvmev_vdev
->
Þd_dbs
[
dbs_idx
] =

104 
	`nvmev_´oc_io_sq
(
qid
, 
Ãw_db
, 
Þd_db
, 
nvmev_vdev
);

109 
qid
 = 1; qid <ð
nvmev_vdev
->
Ä_cq
; qid++) {

110 ià(
nvmev_vdev
->
cqes
[
qid
] =ð
NULL
)

112 
dbs_idx
 = 
qid
 * 2 + 1;

113 
Ãw_db
 = 
nvmev_vdev
->
dbs
[
dbs_idx
];

114 
Þd_db
 = 
nvmev_vdev
->
Þd_dbs
[
dbs_idx
];

115 ià(
Ãw_db
 !ð
Þd_db
) {

116 
	`nvmev_´oc_io_cq
(
qid
, 
Ãw_db
, 
Þd_db
, 
nvmev_vdev
);

117 
nvmev_vdev
->
Þd_dbs
[
dbs_idx
] = 
Ãw_db
;

120 
	}
}

122 
	$nvmev_di¥©ch”
(*
d©a
)

124 
nvmev_dev
 *
nvmev_vdev
 = (nvmev_dev *)
d©a
;

125 
	`NVMEV_INFO
("nvmev_dispatcher started on cpu %d (node %d)\n",

126 
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
,

127 
	`ýu_to_node
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
));

129 !
	`kth»ad_should_¡Ý
()) {

130 
	`nvmev_´oc_b¬s
(
nvmev_vdev
);

131 
	`nvmev_´oc_dbs
(
nvmev_vdev
);

132 
	`cÚd_»sched
();

136 
	}
}

138 
	$NVMEV_DISPATCHER_INIT
(
nvmev_dev
 *
nvmev_vdev
)

140 
th»ad_Çme
[32];

141 
	`¢´štf
(
th»ad_Çme
, Ñh»ad_Çme), "nvmev_%d_di¥", 
nvmev_vdev
->
dev_id
);

143 
nvmev_vdev
->
nvmev_di¥©ch”
 = 
	`kth»ad_ü—‹
Òvmev_di¥©ch”,‚vmev_vdev, 
th»ad_Çme
);

144 ià(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
 != -1)

145 
	`kth»ad_bšd
(
nvmev_vdev
->
nvmev_di¥©ch”
,‚vmev_vdev->
cÚfig
.
ýu_Ä_di¥©ch”
);

146 
	`wake_up_´oûss
(
nvmev_vdev
->
nvmev_di¥©ch”
);

147 
	}
}

149 
	$NVMEV_DISPATCHER_FINAL
(
nvmev_dev
 *
nvmev_vdev
)

151 ià(!
	`IS_ERR_OR_NULL
(
nvmev_vdev
->
nvmev_di¥©ch”
)) {

152 
	`kth»ad_¡Ý
(
nvmev_vdev
->
nvmev_di¥©ch”
);

153 
nvmev_vdev
->
nvmev_di¥©ch”
 = 
NULL
;

155 
	}
}

157 #ifdeà
CONFIG_X86


158 
	$__v®id©e_cÚfigs_¬ch
(
·¿ms
 *
p
)

160 
»sv_¡¬t_by‹s
;

161 
»sv_’d_by‹s
;

163 
»sv_¡¬t_by‹s
 = 
p
->
memm­_¡¬t
;

164 
»sv_’d_by‹s
 = 
»sv_¡¬t_by‹s
 + 
p
->
memm­_size
 - 1;

166 
	`NVMEV_INFO
("memm­_¡¬ˆð%lx , memm­_sizð%lx\n",
p
->
memm­_¡¬t
,…->
memm­_size
);

169 ià(
	`e820__m­³d_ªy
(
»sv_¡¬t_by‹s
, 
»sv_’d_by‹s
, 
E820_TYPE_RAM
) ||

170 
	`e820__m­³d_ªy
(
»sv_¡¬t_by‹s
, 
»sv_’d_by‹s
, 
E820_TYPE_RESERVED_KERN
)) {

171 
	`NVMEV_ERROR
("[mem %#010lx-%#010lx] is usable,‚ot„eseved„egion\n",

172 ()
»sv_¡¬t_by‹s
, ()
»sv_’d_by‹s
);

173  -
EPERM
;

176 ià(!
	`e820__m­³d_ªy
(
»sv_¡¬t_by‹s
, 
»sv_’d_by‹s
, 
E820_TYPE_RESERVED
)) {

177 
	`NVMEV_ERROR
("[mem %#010lx-%#010lx] is‚ot„eseved„egion\n",

178 ()
»sv_¡¬t_by‹s
, ()
»sv_’d_by‹s
);

179  -
EPERM
;

182 
	}
}

184 
	$__v®id©e_cÚfigs_¬ch
()

188 
	}
}

191 
	$__v®id©e_cÚfigs
(
·¿ms
 *
p
)

193 ià(!
p
->
memm­_¡¬t
) {

194 
	`NVMEV_ERROR
("[memmap_start] should be specified\n");

195  -
EINVAL
;

198 ià(!
p
->
memm­_size
) {

199 
	`NVMEV_ERROR
("[memmap_size] should be specified\n");

200  -
EINVAL
;

201 } ià(
p
->
memm­_size
 <ð
	`MB
(1)) {

202 
	`NVMEV_ERROR
("[memmap_size] should be biggerhan 1 MiB\n");

203  -
EINVAL
;

206 ià(
	`__v®id©e_cÚfigs_¬ch
(
p
)) {

207  -
EPERM
;

210 ià(
p
->
Ä_io_un™s
 =ð0 ||…->
io_un™_shiá
 == 0) {

211 
	`NVMEV_ERROR
("Need‚on-zero IO unit size‡nd‡t†east one IO unit\n");

212  -
EINVAL
;

214 ià(
p
->
»ad_time
 == 0) {

215 
	`NVMEV_ERROR
("Need‚on-zero„eadime\n");

216  -
EINVAL
;

218 ià(
p
->
wr™e_time
 == 0) {

219 
	`NVMEV_ERROR
("Need‚on-zero writeime\n");

220  -
EINVAL
;

224 
	}
}

226 
	$__´št_³rf_cÚfigs
(
nvmev_dev
 *
nvmev_vdev
)

228 #ifdeà
CONFIG_NVMEV_VERBOSE


229 
un™_³rf_kb
 = 
nvmev_vdev
->
cÚfig
.
Ä_io_un™s


230 << (
nvmev_vdev
->
cÚfig
.
io_un™_shiá
 - 10);

231 
nvmev_cÚfig
 *
cfg
 = &
nvmev_vdev
->
cÚfig
;

233 
	`NVMEV_INFO
("=============== Configurations ===============\n");

234 
	`NVMEV_INFO
("* IO un™ : %d x %d\n", 
cfg
->
Ä_io_un™s
, 1 << cfg->
io_un™_shiá
);

235 
	`NVMEV_INFO
("* I/Oimes\n");

236 
	`NVMEV_INFO
(" R—d : %u + %u x + %u‚s\n", 
cfg
->
»ad_d–ay
, cfg->
»ad_time
,

237 
cfg
->
»ad_Œažšg
);

238 
	`NVMEV_INFO
(" Wr™ : %u + %u x + %u‚s\n", 
cfg
->
wr™e_d–ay
, cfg->
wr™e_time
,

239 
cfg
->
wr™e_Œažšg
);

240 
	`NVMEV_INFO
("* Bandwidth\n");

241 
	`NVMEV_INFO
(" Read : %lu MiB/s\n",

242 (1000000000UL / (
cfg
->
»ad_time
 + cfg->
»ad_d–ay
 + cfg->
»ad_Œažšg
)) *

243 
un™_³rf_kb
 >>

245 
	`NVMEV_INFO
(" Write : %lu MiB/s\n",

246 (1000000000UL / (
cfg
->
wr™e_time
 + cfg->
wr™e_d–ay
 + cfg->
wr™e_Œažšg
)) *

247 
un™_³rf_kb
 >>

250 
	}
}

252 
	$__g‘_Ä_’Œ›s
(
dbs_idx
, 
queue_size
, 
nvmev_dev
 *
nvmev_vdev
)

254 
diff
 = 
nvmev_vdev
->
dbs
[
dbs_idx
] -‚vmev_vdev->
Þd_dbs
[dbs_idx];

255 ià(
diff
 < 0) {

256 
diff
 +ð
queue_size
;

258  
diff
;

259 
	}
}

261 
nvmev_dev
 *
	$__g‘_nvmev
(cÚ¡ *
dev_Çme
)

263 
nvmev_dev
 *
cursÜ
, *
Ãxt
;

264 
nvmev_dev
 *
»suÉ
 = 
NULL
;

266 
	`li¡_fÜ_—ch_’Œy_§ã
(
cursÜ
, 
Ãxt
, &
nvmev
->
dev_li¡
, 
li¡_–em
) {

267 ià(
»suÉ
 =ð
NULL
 && 
	`¡rcmp
(
dev_Çme
, 
cursÜ
->dev_name) == 0) {

268 
»suÉ
 = 
cursÜ
;

272 if(
»suÉ
 =ð
NULL
)

273 
	`´štk
("don't have device\n");

274  
»suÉ
;

275 
	}
}

277 
ssize_t
 
	$__sysfs_show
(
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

281 
ssize_t
 
Ën
 = 0;

282 cÚ¡ *
dev_Çme
 = 
kobj
->
Çme
;

283 cÚ¡ *
fže_Çme
 = 
©Œ
->©Œ.
Çme
;

285 
nvmev_dev
 *
nvmev_vdev
 = 
	`__g‘_nvmev
(
dev_Çme
);

286 
nvmev_cÚfig
 *
cfg
 = 
NULL
;

287 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
nvmev_vdev
->
ns
->
áls
;

288 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

290 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

292 
ušt64_t
 
i
,
w
,
q
;

294 
ssd
 *ssd;

295 ià(
nvmev_vdev
 =ð
NULL
) {

296 
	`´štk
("No dev");

300 
cfg
 = &
nvmev_vdev
->
cÚfig
;

302 ià(
	`¡rcmp
(
fže_Çme
, "read_times") == 0) {

303 
Ën
 = 
	`¥rštf
(
buf
, "%u + %u x + %u", 
cfg
->
»ad_d–ay
, cfg->
»ad_time
,

304 
cfg
->
»ad_Œažšg
);

305 } ià(
	`¡rcmp
(
fže_Çme
, "write_times") == 0) {

306 
Ën
 = 
	`¥rštf
(
buf
, "%u + %u x + %u", 
cfg
->
wr™e_d–ay
, cfg->
wr™e_time
,

307 
cfg
->
wr™e_Œažšg
);

308 } ià(
	`¡rcmp
(
fže_Çme
, "io_units") == 0) {

309 
Ën
 = 
	`¥rštf
(
buf
, "%u x %u", 
cfg
->
Ä_io_un™s
, cfg->
io_un™_shiá
);

310 } ià(
	`¡rcmp
(
fže_Çme
, "stat") == 0) {

311 
i
;

312 
Ä_š_æight
 = 0;

313 
Ä_di¥©ch
 = 0;

314 
Ä_di¥©ched
 = 0;

315 
tÙ®_io
 = 0;

316 
i
 = 1; i <ð
nvmev_vdev
->
Ä_sq
; i++) {

317 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
i
];

318 ià(!
sq
)

321 
Ën
 +ð
	`¥rštf
(
buf
, "%2d: %2u %4u %4u %4u %4u %Îu\n", 
i
,

322 
	`__g‘_Ä_’Œ›s
(
i
 * 2, 
sq
->
queue_size
, 
nvmev_vdev
),

323 
sq
->
¡©
.
Ä_š_æight
, sq->¡©.
max_Ä_š_æight
,

324 
sq
->
¡©
.
Ä_di¥©ch
, sq->¡©.
Ä_di¥©ched
,

325 
sq
->
¡©
.
tÙ®_io
);

327 
Ä_š_æight
 +ð
sq
->
¡©
.nr_in_flight;

328 
Ä_di¥©ch
 +ð
sq
->
¡©
.nr_dispatch;

329 
Ä_di¥©ched
 +ð
sq
->
¡©
.nr_dispatched;

330 
tÙ®_io
 +ð
sq
->
¡©
.total_io;

332 
	`b¬r›r
();

333 
sq
->
¡©
.
max_Ä_š_æight
 = 0;

335 
Ën
 +ð
	`¥rštf
(
buf
, "tÙ®: %u %u %u %Îu\n", 
Ä_š_æight
, 
Ä_di¥©ch
,

336 
Ä_di¥©ched
, 
tÙ®_io
);

337 } ià(
	`¡rcmp
(
fže_Çme
, "debug") == 0) {

339 } ià(
	`¡rcmp
(
fže_Çme
, "phfrag") == 0){

341 
Ën
 = 
	`¥rštf
(
buf
, "%Îu\n", 
cfg
->
couÁ
);

342 } ià(
	`¡rcmp
(
fže_Çme
, "chdie") == 0){

343 
cfg
->
ch_d›_couÁ”
 = 0;

344 
cfg
->
ch_d›_Ï‹ncy
 = 0;

345 
cfg
->
couÁ
 = 0;

346 
q
=0;q < 
nvmev_vdev
->
ns
->
Ä_·¹s
; q++){

347 
ssd
 = 
cÚv_áls
[
q
].ssd;

348 
cfg
->
ch_d›_couÁ”
 +ð
ssd
->ch_die_counter;

349 
cfg
->
ch_d›_Ï‹ncy
 +ð
ssd
->ch_die_latency;

353 
Ën
 = 
	`¥rštf
(
buf
, "%Îu %Îu\n", 
cfg
->
ch_d›_couÁ”
, cfg->
ch_d›_Ï‹ncy
);

355  
Ën
;

356 
	}
}

358 
ssize_t
 
	$__sysfs_¡Üe
(
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

359 
size_t
 
couÁ
)

363 
ssize_t
 
Ën
 = 
couÁ
;

364 
»t
;

365 *
Þd_¡©
;

367 cÚ¡ *
dev_Çme
 = 
kobj
->
Çme
;

368 cÚ¡ *
fže_Çme
 = 
©Œ
->©Œ.
Çme
;

370 
nvmev_dev
 *
nvmev_vdev
 = 
	`__g‘_nvmev
(
dev_Çme
);

371 
nvmev_cÚfig
 *
cfg
 = 
NULL
;

373 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
nvmev_vdev
->
ns
->
áls
;

374 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

376 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

378 
ušt64_t
 
i
,
w
,
q
;

380 
ssd
 * ssd = 
cÚv_ál
->ssd;

381 ià(
nvmev_vdev
 =ð
NULL
)

382 
out
;

384 
cfg
 = &
nvmev_vdev
->
cÚfig
;

386 ià(!
	`¡rcmp
(
fže_Çme
, "read_times")) {

387 
»t
 = 
	`ssÿnf
(
buf
, "%u %u %u", &
cfg
->
»ad_d–ay
, &cfg->
»ad_time
,

388 &
cfg
->
»ad_Œažšg
);

389 } ià(!
	`¡rcmp
(
fže_Çme
, "write_times")) {

390 
»t
 = 
	`ssÿnf
(
buf
, "%u %u %u", &
cfg
->
wr™e_d–ay
, &cfg->
wr™e_time
,

391 &
cfg
->
wr™e_Œažšg
);

392 } ià(!
	`¡rcmp
(
fže_Çme
, "io_units")) {

393 
»t
 = 
	`ssÿnf
(
buf
, "%d %d", &
cfg
->
Ä_io_un™s
, &cfg->
io_un™_shiá
);

394 ià(
»t
 < 1)

395 
out
;

397 
Þd_¡©
 = 
nvmev_vdev
->
io_un™_¡©
;

398 
nvmev_vdev
->
io_un™_¡©
 =

399 
	`kz®loc
((*
nvmev_vdev
->
io_un™_¡©
è* 
cfg
->
Ä_io_un™s
, 
GFP_KERNEL
);

401 
	`md–ay
(100);

404 
	`kä“
(
Þd_¡©
);

405 } ià(!
	`¡rcmp
(
fže_Çme
, "stat")) {

406 
i
;

407 
i
 = 1; i <ð
nvmev_vdev
->
Ä_sq
; i++) {

408 
nvmev_submissiÚ_queue
 *
sq
 = 
nvmev_vdev
->
sqes
[
i
];

409 ià(!
sq
)

412 
	`mem£t
(&
sq
->
¡©
, 0x00, (sq->stat));

414 } ià(!
	`¡rcmp
(
fže_Çme
, "debug")) {

416 } ià(!
	`¡rcmp
(
fže_Çme
, "phfrag")){

417 
»t
 = 
	`ssÿnf
(
buf
, "%Îu %Îu", &
cfg
->
šput_lba
, &cfg->
lba_Ën
);

418 if(
cfg
->
šput_lba
==0 && cfg->
lba_Ën
==0){

419 
cfg
->
couÁ
=0;

422 
hi
 = 
	`phäag_check
(
nvmev_vdev
);

424 } ià(!
	`¡rcmp
(
fže_Çme
, "chdie")){

425 
»t
 = 
	`ssÿnf
(
buf
, "%Îu %Îu", &
cfg
->
šput_lba
, &cfg->
lba_Ën
);

426 if(
cfg
->
šput_lba
==0 && cfg->
lba_Ën
==0){

427 
q
=0;q < 
nvmev_vdev
->
ns
->
Ä_·¹s
; q++){

428 
ssd
 = 
cÚv_áls
[
q
].ssd;

429 
ssd
->
ch_d›_couÁ”
=0;

430 
ssd
->
ch_d›_Ï‹ncy
=0;

431 
ssd
->
couÁ
=0;

432 
ssd
->
checkšg
 = 
Œue
;

436 
q
=0;q < 
nvmev_vdev
->
ns
->
Ä_·¹s
; q++){

437 
ssd
 = 
cÚv_áls
[
q
].ssd;

438 
ssd
->
checkšg
 = 
çl£
;

445 
out
:

446 
	`__´št_³rf_cÚfigs
(
nvmev_vdev
);

448  
couÁ
;

449 
	}
}

451 
kobj_©Œibu‹
 
	g»ad_times_©Œ
 =

452 
__ATTR
(
»ad_times
, 0644, 
__sysfs_show
, 
__sysfs_¡Üe
);

453 
kobj_©Œibu‹
 
	gwr™e_times_©Œ
 =

454 
__ATTR
(
wr™e_times
, 0644, 
__sysfs_show
, 
__sysfs_¡Üe
);

455 
kobj_©Œibu‹
 
	gio_un™s_©Œ
 = 
__ATTR
(
io_un™s
, 0644, 
__sysfs_show
, 
__sysfs_¡Üe
);

456 
kobj_©Œibu‹
 
	g¡©_©Œ
 = 
__ATTR
(
¡©
, 0644, 
__sysfs_show
, 
__sysfs_¡Üe
);

457 
kobj_©Œibu‹
 
	gdebug_©Œ
 = 
__ATTR
(
debug
, 0644, 
__sysfs_show
, 
__sysfs_¡Üe
);

458 
kobj_©Œibu‹
 
	gphäag_checkšg
 = 
__ATTR
(
phäag
, 0664, 
__sysfs_show
, 
__sysfs_¡Üe
);

459 
kobj_©Œibu‹
 
	gchd›_checkšg
 = 
__ATTR
(
chd›
, 0664, 
__sysfs_show
, 
__sysfs_¡Üe
);

461 
	$NVMEV_STORAGE_INIT
(
nvmev_dev
 *
nvmev_vdev
)

463 
»t
 = 0;

465 
	`NVMEV_INFO
("StÜage: %#010lx-%#010lx (%lu MiB)\n", 
nvmev_vdev
->
cÚfig
.
¡Üage_¡¬t
,

466 
nvmev_vdev
->
cÚfig
.
¡Üage_¡¬t
 +‚vmev_vdev->cÚfig.
¡Üage_size
,

467 
	`BYTE_TO_MB
(
nvmev_vdev
->
cÚfig
.
¡Üage_size
));

469 
nvmev_vdev
->
io_un™_¡©
 = 
	`kz®loc
(

470 (*
nvmev_vdev
->
io_un™_¡©
è*‚vmev_vdev->
cÚfig
.
Ä_io_un™s
, 
GFP_KERNEL
);

472 
nvmev_vdev
->
¡Üage_m­³d
 = 
	`mem»m­
Òvmev_vdev->
cÚfig
.
¡Üage_¡¬t
,

473 
nvmev_vdev
->
cÚfig
.
¡Üage_size
, 
MEMREMAP_WB
);

477 ià(
nvmev_vdev
->
¡Üage_m­³d
 =ð
NULL
)

478 
	`NVMEV_ERROR
("Failedo map storage memory.\n");

480 
nvmev_vdev
->
sysfs_roÙ
 = 
	`kobjeù_ü—‹_ªd_add
Òvmev_vdev->
dev_Çme
, 
nvmev
->
cÚfig_roÙ
);

481 
nvmev_vdev
->
sysfs_»ad_times
 = &
»ad_times_©Œ
;

482 
nvmev_vdev
->
sysfs_wr™e_times
 = &
wr™e_times_©Œ
;

483 
nvmev_vdev
->
sysfs_io_un™s
 = &
io_un™s_©Œ
;

484 
nvmev_vdev
->
sysfs_¡©
 = &
¡©_©Œ
;

485 
nvmev_vdev
->
sysfs_debug
 = &
debug_©Œ
;

486 
nvmev_vdev
->
sysfs_phäag
 = &
phäag_checkšg
;

487 
nvmev_vdev
->
sysfs_chd›
 = &
chd›_checkšg
;

489 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_»ad_times
->
©Œ
);

490 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_wr™e_times
->
©Œ
);

491 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_io_un™s
->
©Œ
);

492 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_¡©
->
©Œ
);

493 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_debug
->
©Œ
);

494 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_phäag
->
©Œ
);

495 
»t
 = 
	`sysfs_ü—‹_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_chd›
->
©Œ
);

496 
	}
}

498 
	$NVMEV_STORAGE_FINAL
(
nvmev_dev
 *
nvmev_vdev
)

500 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_»ad_times
->
©Œ
);

501 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_wr™e_times
->
©Œ
);

502 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_io_un™s
->
©Œ
);

503 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_¡©
->
©Œ
);

504 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_debug
->
©Œ
);

505 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_phäag
->
©Œ
);

506 
	`sysfs_»move_fže
(
nvmev_vdev
->
sysfs_roÙ
, &nvmev_vdev->
sysfs_chd›
->
©Œ
);

508 
	`kobjeù_put
(
nvmev_vdev
->
sysfs_roÙ
);

510 ià(
nvmev_vdev
->
¡Üage_m­³d
)

511 
	`memunm­
(
nvmev_vdev
->
¡Üage_m­³d
);

513 ià(
nvmev_vdev
->
io_un™_¡©
)

514 
	`kä“
(
nvmev_vdev
->
io_un™_¡©
);

515 
	}
}

517 
boÞ
 
	$__lßd_cÚfigs
(
nvmev_cÚfig
 *
cÚfig
, 
·¿ms
 *
p
)

519 
boÞ
 
fœ¡
 = 
Œue
;

520 
ýu_Ä
;

521 *
ýu
;

523 ià(
	`__v®id©e_cÚfigs
(
p
) < 0) {

524  
çl£
;

527 #ià(
BASE_SSD
 =ð
KV_PROTOTYPE
)

528 
p
->
memm­_size
 -ð
KV_MAPPING_TABLE_SIZE
;

531 
cÚfig
->
memm­_¡¬t
 = 
p
->memmap_start;

532 
cÚfig
->
memm­_size
 = 
p
->memmap_size;

534 
cÚfig
->
¡Üage_¡¬t
 = 
p
->
memm­_¡¬t
 + 
	`MB
(1);

535 
cÚfig
->
¡Üage_size
 = 
p
->
memm­_size
 - 
	`MB
(1);

537 
cÚfig
->
»ad_time
 = 
p
->read_time;

538 
cÚfig
->
»ad_d–ay
 = 
p
->read_delay;

539 
cÚfig
->
»ad_Œažšg
 = 
p
->read_trailing;

540 
cÚfig
->
wr™e_time
 = 
p
->write_time;

541 
cÚfig
->
wr™e_d–ay
 = 
p
->write_delay;

542 
cÚfig
->
wr™e_Œažšg
 = 
p
->write_trailing;

543 
cÚfig
->
Ä_io_un™s
 = 
p
->nr_io_units;

544 
cÚfig
->
io_un™_shiá
 = 
p
->io_unit_shift;

546 
cÚfig
->
Ä_io_wÜk”s
 = 0;

547 
cÚfig
->
ýu_Ä_di¥©ch”
 = -1;

549 (
ýu
 = 
	`¡r£p
(&
p
->
ýus
, ",")è!ð
NULL
) {

550 
ýu_Ä
 = ()
	`sim¶e_¡¹Þ
(
ýu
, 
NULL
, 10);

551 ià(
fœ¡
) {

552 
cÚfig
->
ýu_Ä_di¥©ch”
 = 
ýu_Ä
;

554 
cÚfig
->
ýu_Ä_io_wÜk”s
[cÚfig->
Ä_io_wÜk”s
] = 
ýu_Ä
;

555 
cÚfig
->
Ä_io_wÜk”s
++;

557 
fœ¡
 = 
çl£
;

560  
Œue
;

561 
	}
}

563 
	$NVMEV_NAMESPACE_INIT
(
nvmev_dev
 *
nvmev_vdev
)

565 
»maššg_ÿ·c™y
 = 
nvmev_vdev
->
cÚfig
.
¡Üage_size
;

566 *
ns_addr
 = 
nvmev_vdev
->
¡Üage_m­³d
;

567 cÚ¡ 
Ä_ns
 = 
NR_NAMESPACES
;

568 cÚ¡ 
di¥_no
 = 
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
;

569 
i
;

570 
size
;

572 
nvmev_ns
 *
ns
 = 
	`km®loc
((nvmev_nsè* 
Ä_ns
, 
GFP_KERNEL
);

573 
ál_cÚfigs
 *
ál_cfgs
 = 
	`km®loc
((ál_cÚfigs), 
GFP_KERNEL
);

575 
ál_cfgs
->
max_cÚ
 = 
nvmev_vdev
->max_con;

577 
i
 = 0; i < 
Ä_ns
; i++) {

578 ià(
	`NS_CAPACITY
(
i
) == 0)

579 
size
 = 
»maššg_ÿ·c™y
;

581 
size
 = 
	`mš
(
	`NS_CAPACITY
(
i
), 
»maššg_ÿ·c™y
);

583 ià(
nvmev_vdev
->
ál
 =ð
SSD_TYPE_NVM
) {

584 
	`lßd_sim¶e_cÚfigs
(
ál_cfgs
);

585 
	`sim¶e_š™_Çme¥aû
(&
ns
[
i
], i, 
size
, 
ns_addr
, 
di¥_no
, 
ál_cfgs
);

586 } ià(
nvmev_vdev
->
ál
 =ð
SSD_TYPE_CONV
) {

587 
	`lßd_cÚv_cÚfigs
(
ál_cfgs
);

588 
	`cÚv_š™_Çme¥aû
(&
ns
[
i
], i, 
size
, 
ns_addr
, 
di¥_no
, 
ál_cfgs
);

589 } ià(
nvmev_vdev
->
ál
 =ð
SSD_TYPE_ZNS
) {

590 
	`lßd_zns_cÚfigs
(
ál_cfgs
);

591 
	`zns_š™_Çme¥aû
(&
ns
[
i
], i, 
size
, 
ns_addr
, 
di¥_no
, 
ál_cfgs
);

592 } ià(
nvmev_vdev
->
ál
 =ð
SSD_TYPE_KV
) {

593 
	`lßd_kv_cÚfigs
(
ál_cfgs
);

594 
	`kv_š™_Çme¥aû
(&
ns
[
i
], i, 
size
, 
ns_addr
, 
di¥_no
, 
ál_cfgs
);

596 
	`BUG_ON
(1);

598 
»maššg_ÿ·c™y
 -ð
size
;

599 
ns_addr
 +ð
size
;

600 
	`NVMEV_INFO
("n %d/%d: siz%Îd MiB\n", 
i
, 
Ä_ns
, 
	`BYTE_TO_MB
(
ns
[i].
size
));

602 
ns
[
i
].
p_dev
 = 
nvmev_vdev
;

605 
nvmev_vdev
->
ns
 =‚s;

606 
nvmev_vdev
->
Ä_ns
 =‚r_ns;

607 
nvmev_vdev
->
mdts
 = 
ál_cfgs
->
MDTS
;

608 
	}
}

610 
	$NVMEV_NAMESPACE_FINAL
(
nvmev_dev
 *
nvmev_vdev
)

612 
nvmev_ns
 *
ns
 = 
nvmev_vdev
->ns;

613 cÚ¡ 
Ä_ns
 = 
NR_NAMESPACES
;

614 
i
;

616 
i
 = 0; i < 
Ä_ns
; i++) {

617 ià(
	`NS_SSD_TYPE
(
i
è=ð
SSD_TYPE_NVM
)

618 
	`sim¶e_»move_Çme¥aû
(&
ns
[
i
]);

619 ià(
	`NS_SSD_TYPE
(
i
è=ð
SSD_TYPE_CONV
)

620 
	`cÚv_»move_Çme¥aû
(&
ns
[
i
]);

621 ià(
	`NS_SSD_TYPE
(
i
è=ð
SSD_TYPE_ZNS
)

622 
	`zns_»move_Çme¥aû
(&
ns
[
i
]);

623 ià(
	`NS_SSD_TYPE
(
i
è=ð
SSD_TYPE_KV
)

624 
	`kv_»move_Çme¥aû
(&
ns
[
i
]);

626 
	`BUG_ON
(1);

629 
	`kä“
(
ns
);

630 
nvmev_vdev
->
ns
 = 
NULL
;

631 
	}
}

633 *
	$·r£_to_cmd
(*
cmd_lše
)

635 *
commªd
;

637 ià(
cmd_lše
 =ð
NULL
)

638  
NULL
;

640 
commªd
 = 
	`¡r£p
(&
cmd_lše
, " ");

642  
commªd
;

643 
	}
}

645 
	$·r£_commªd
(*
cmd_lše
, 
·¿ms
 *
p
)

647 *
¬g
;

648 *
·¿m
, *
v®
;

650 ià(
cmd_lše
 =ð
NULL
) {

651 
	`NVMEV_ERROR
("cmd_line is NULL");

655 (
¬g
 = 
	`¡r£p
(&
cmd_lše
, " ")è!ð
NULL
) {

656 
	`Ãxt_¬g
(
¬g
, &
·¿m
, &
v®
);

657 
	`´štk
("·¿m i %s\n",
·¿m
);

658 
	`´štk
("v® i %s\n",
v®
);

660 ià(
	`¡rcmp
(
·¿m
, "memmap_start") == 0)

661 
p
->
memm­_¡¬t
 = 
	`mem·r£
(
v®
, 
NULL
);

663 ià(
	`¡rcmp
(
·¿m
, "memmap_size") == 0)

664 
p
->
memm­_size
 = 
	`mem·r£
(
v®
, 
NULL
);

666 ià(
	`¡rcmp
(
·¿m
, "cpus") == 0)

667 
p
->
ýus
 = 
v®
;

669 ià(
	`¡rcmp
(
·¿m
, "name") == 0){

670 
p
->
Çme
 = 
v®
;

672 ià(
	`¡rcmp
(
·¿m
, "path") == 0){

673 
p
->
·th
 = 
v®
;

675 ià(
	`¡rcmp
(
·¿m
, "ftl") == 0) {

676 ià(
	`¡rcmp
(
v®
, "simple") == 0)

677 
p
->
ál
 = 
SSD_TYPE_NVM
;

678 ià(
	`¡rcmp
(
v®
, "conv") == 0)

679 
p
->
ál
 = 
SSD_TYPE_CONV
;

680 ià(
	`¡rcmp
(
v®
, "kv") == 0)

681 
p
->
ál
 = 
SSD_TYPE_KV
;

682 ià(
	`¡rcmp
(
v®
, "zns") == 0)

683 
p
->
ál
 = 
SSD_TYPE_ZNS
;

685 ià(
	`¡rcmp
(
·¿m
, "degree") == 0) {

686 if(
	`k¡¹Þ
(
v®
,10,&
p
->
deg»e_äag
)){

687 
	`´štk
(
KERN_INFO
 "Can't conver stringo†ong\n");

690 ià(
	`¡rcmp
(
·¿m
, "num_chunk") == 0) {

691 if(
	`k¡¹Þ
(
v®
,10,&
p
->
num_chunk
)){

692 
	`´štk
(
KERN_INFO
 "Can't conver stringo†ong\n");

695 ià(
	`¡rcmp
(
·¿m
, "max_con") == 0) {

696 if(
	`k¡¹ošt
(
v®
,10,&
p
->
max_cÚ
)){

697 
p
->
max_cÚ
 = 0;

698 
	`´štk
(
KERN_INFO
 "Can't conver stringo†ong\n");

702 
	}
}

704 
·¿ms
 *
	$PARAM_INIT
()

706 
·¿ms
 *params;

708 
·¿ms
 = 
	`kz®loc
((·¿ms), 
GFP_KERNEL
);

710 
·¿ms
->
memm­_¡¬t
 = 0;

711 
·¿ms
->
memm­_size
 = 0;

713 
·¿ms
->
»ad_time
 = 1;

714 
·¿ms
->
»ad_d–ay
 = 1;

715 
·¿ms
->
»ad_Œažšg
 = 0;

717 
·¿ms
->
wr™e_time
 = 1;

718 
·¿ms
->
wr™e_d–ay
 = 1;

719 
·¿ms
->
wr™e_Œažšg
 = 0;

721 
·¿ms
->
Ä_io_un™s
 = 8;

722 
·¿ms
->
io_un™_shiá
 = 12;

724 
·¿ms
->
debug
 = 0;

726 
·¿ms
->
Çme
 = 
NULL
;

727 
·¿ms
->
ýus
 = 
NULL
;

729 
·¿ms
->
ál
 = 
SSD_TYPE_NVM
;

731  
·¿ms
;

732 
	}
}

734 
	$__´št_ba£_cÚfig
()

736 cÚ¡ *
ty³
 = "unknown";

737 
BASE_SSD
) {

738 
INTEL_OPTANE
:

739 
ty³
 = "NVM SSD";

740 
	`´štk
("delete implementation…lease");

742 
SAMSUNG_970PRO
:

743 
ty³
 = "Samsung 970 Pro SSD";

745 
ZNS_PROTOTYPE
:

746 
ty³
 = "ZNS SSD Prototype";

748 
KV_PROTOTYPE
:

749 
ty³
 = "KVSSD Prototype";

751 
WD_ZN540
:

752 
ty³
 = "WD ZN540 ZNS SSD";

756 
	`NVMEV_INFO
("V”siÚ %x.%x fÜ >> % <<\n", (
NVMEV_VERSION
 & 0xff00) >> 8,

757 (
NVMEV_VERSION
 & 0x00ff), 
ty³
);

758 
	}
}

760 
	$ü—‹_deviû
(
·¿ms
 *
p
)

762 
	`__´št_ba£_cÚfig
();

763 
nvmev_dev
 *
nvmev_vdev
;

764 
nvmev_vdev
 = 
	`VDEV_INIT
();

766 ià(!
nvmev_vdev
)

767  -
EINVAL
;

769 ià(!
	`__lßd_cÚfigs
(&
nvmev_vdev
->
cÚfig
, 
p
)) {

770 
»t_”r
;

775 
nvmev_vdev
->
dev_id
 = 
nvmev
->
Ä_dev
++;

778 
nvmev_vdev
->
deg»e_äag
 = 0;

781 
nvmev_vdev
->
ál
 = 
p
->ftl;

783 ià(
p
->
Çme
 !ð
NULL
)

784 
	`¡ºýy
(
nvmev_vdev
->
dev_Çme
, 
p
->
Çme
, (nvmev_vdev->dev_name));

787 
	`¢´štf
(
nvmev_vdev
->
dev_Çme
, (nvmev_vdev->dev_name), "nvmev_%d",

788 
nvmev_vdev
->
dev_id
);

790 
	`NVMEV_INFO
("dev‚ami %s\n", 
nvmev_vdev
->
dev_Çme
);

793 
	`INIT_LIST_HEAD
(&
nvmev_vdev
->
li¡_–em
);

794 
	`li¡_add
(&
nvmev_vdev
->
li¡_–em
, &
nvmev
->
dev_li¡
);

796 
	`NVMEV_STORAGE_INIT
(
nvmev_vdev
);

798 
	`NVMEV_NAMESPACE_INIT
(
nvmev_vdev
);

800 ià(
io_usšg_dma
) {

801 ià(
	`ißt_dma_chª_£t
("dma7chan0") != 0) {

802 
io_usšg_dma
 = 
çl£
;

803 
	`NVMEV_ERROR
("Cannot use DMAƒngine, Fall backo memcpy\n");

807 ià(!
	`NVMEV_PCI_INIT
(
nvmev_vdev
)) {

808 
»t_”r
;

811 
	`__´št_³rf_cÚfigs
(
nvmev_vdev
);

813 
	`NVMEV_IO_WORKER_INIT
(
nvmev_vdev
);

815 
	`NVMEV_DISPATCHER_INIT
(
nvmev_vdev
);

817 
	`pci_bus_add_deviûs
(
nvmev_vdev
->
vœt_bus
);

819 
	`NVMEV_INFO
("Virtual NVMe device created\n");

823 
»t_”r
:

824 
	`´štk
("error......\n");

826 
nvmev
->
Ä_dev
--;

827 
	`li¡_d–
(&
nvmev_vdev
->
li¡_–em
);

828 
	`VDEV_FINALIZE
(
nvmev_vdev
);

829  -
EIO
;

830 
	}
}

832 
	$d–‘e_deviû
(
nvmev_dev
 *
nvmev_vdev
)

834 
i
;

836 
nvmev
->
Ä_dev
--;

838 
	`uÄegi¡”_chrdev
(
nvmev_vdev
->
majÜ
,‚vmev_vdev->
dev_Çme
);

840 ià(
nvmev_vdev
->
vœt_bus
 !ð
NULL
) {

841 
	`pci_¡Ý_roÙ_bus
(
nvmev_vdev
->
vœt_bus
);

842 
	`pci_»move_roÙ_bus
(
nvmev_vdev
->
vœt_bus
);

845 
	`NVMEV_DISPATCHER_FINAL
(
nvmev_vdev
);

846 
	`NVMEV_IO_WORKER_FINAL
(
nvmev_vdev
);

848 
	`NVMEV_NAMESPACE_FINAL
(
nvmev_vdev
);

849 
	`NVMEV_STORAGE_FINAL
(
nvmev_vdev
);

851 ià(
io_usšg_dma
) {

852 
	`ißt_dma_þ—nup
();

855 
i
 = 0; i < 
nvmev_vdev
->
Ä_sq
; i++) {

856 
	`kä“
(
nvmev_vdev
->
sqes
[
i
]);

859 
i
 = 0; i < 
nvmev_vdev
->
Ä_cq
; i++) {

860 
	`kä“
(
nvmev_vdev
->
cqes
[
i
]);

863 
	`li¡_d–
(&
nvmev_vdev
->
li¡_–em
);

865 
	`VDEV_FINALIZE
(
nvmev_vdev
);

867 
	`´štk
("Virtual NVMe device deleted\n");

870 
	}
}

872 
	$d–‘e_®l
()

874 
nvmev_dev
 *
cursÜ
, *
Ãxt
;

876 
	`li¡_fÜ_—ch_’Œy_§ã
(
cursÜ
, 
Ãxt
, &
nvmev
->
dev_li¡
, 
li¡_–em
)

877 
	`d–‘e_deviû
(
cursÜ
);

880 
	}
}

881 
	$com·»_by_size
(*
´iv
, cÚ¡ 
li¡_h—d
 *
nodeA
, cÚ¡ li¡_h—d * 
nodeB
)

883 
lba_chunk_t
 *
d©aA
;

884 
lba_chunk_t
 *
d©aB
;

886 
d©aA
 = 
	`li¡_’Œy
(
nodeA
, 
lba_chunk_t
, 
li¡
);

887 
d©aB
 = 
	`li¡_’Œy
(
nodeB
, 
lba_chunk_t
, 
li¡
);

889 ià(
d©aA
->
size
 < 
d©aB
->size)

891 ià(
d©aA
->
size
 > 
d©aB
->size)

895 
	}
}

897 
lba_chunk_t
 * 
	$g’”©e_Ín
(
ušt64_t
 
¡¬t
, ušt64_ˆ
’d
, ušt64_ˆ
size
,ušt64_ˆ
idx
,
ch
, 
lun
){

898 
lba_chunk_t
 * 
Ín
 = 
	`vm®loc
((lba_chunk_t));

899 
Ín
->
¡¬t_Ín
 = 
¡¬t
;

900 
Ín
->
’d_Ín
 = 
’d
;

901 
Ín
->
size
=size;

902 
Ín
->
devide_size
=0;

903 
Ín
->
idx
 = idx;

904 
Ín
->
ch
=ch;

905 
Ín
->
lun
=lun;

906 
Ín
->
couÁ”
 = -1;

908  
Ín
;

909 
	}
}

910 
li¡_h—d
 *
	$ü—‹_li¡_äom_bË
(
ssd·¿ms
 *
¥p
,
nvmev_ns
 *
ns
,
cÚv_ál
 *
cÚv_áls
){

911 
li¡_h—d
 *
h—d
;

912 
h—d
 = 
	`vm®loc
((*head));

913 ià(!
h—d
) {

914 
	`´_”r
("Failedo‡llocate memory for†ist head.\n");

915  
NULL
;

918 
	`INIT_LIST_HEAD
(
h—d
);

920 
lba_chunk_t
 * 
Ín
;

921 
ušt64_t
 
tÙ®_Ín_couÁ
 = 
¥p
->
‰_pgs
 * 
ns
->
Ä_·¹s
;

922 
ušt64_t
 
¡¬t_Ín
=0;

923 
ušt64_t
 
couÁ
 = 0;

924 
ušt64_t
 
glob®_Ín
;

925 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

926 
ušt64_t
 
Ä_·¹s
 = 
ns
->nr_parts;

929 
glob®_Ín
 = 0; glob®_ÍÀ< 
tÙ®_Ín_couÁ
; global_lpn++){

931 
ušt64_t
 
idx
 = 
glob®_Ín
 % 
ns
->
Ä_·¹s
;

932 
ušt64_t
 
loÿl_Ín
 = 
glob®_Ín
 / 
ns
->
Ä_·¹s
;

934 
cÚv_ál
 = &
cÚv_áls
[
idx
];

936 
µa
…· = 
cÚv_ál
->
m­tbl
[
loÿl_Ín
];

938 if(
µa
.µ¨!ð
UNMAPPED_PPA
){

939 if(
couÁ
 == 0){

940 
¡¬t_Ín
=
glob®_Ín
;

942 
couÁ
++;

945 if(
couÁ
 != 0){

946 
Ín
 = 
	`g’”©e_Ín
(
¡¬t_Ín
, 
glob®_Ín
-1,
couÁ
,0,-1,-1);

947 
	`li¡_add_ž
(&
Ín
->
li¡
,
h—d
);

948 
couÁ
 = 0;

952 if(
couÁ
 != 0){

953 
Ín
 = 
	`g’”©e_Ín
(
¡¬t_Ín
, 
glob®_Ín
-1,
couÁ
,0,-1,-1);

954 
	`li¡_add_ž
(&
Ín
->
li¡
,
h—d
);

957  
h—d
;

960 
	}
}

961 
li¡_h—d
 *
	$ü—‹_li¡_äom_bË_¥l™
(
ssd·¿ms
 *
¥p
,
nvmev_ns
 *
ns
,
cÚv_ál
 *
cÚv_áls
,
ušt64_t
 
num_li¡
){

962 
li¡_h—d
 *
h—d
;

963 
ušt64_t
 
Ä_·¹s
 = 
ns
->nr_parts;

964 
h—d
 = 
	`vm®loc
((*h—dè* 
num_li¡
 * 
Ä_·¹s
);

965 ià(!
h—d
) {

966 
	`´_”r
("Failedo‡llocate memory for†ist head.\n");

967  
NULL
;

970 
ušt64_t
 
i
;

972 
i
 = 0; i < 
Ä_·¹s
 * 
num_li¡
; i++)

973 
	`INIT_LIST_HEAD
(&
h—d
[
i
]);

975 
lba_chunk_t
 * 
Ín
;

976 
ušt64_t
 
tÙ®_Ín_couÁ
 = 
¥p
->
‰_pgs
 * 
ns
->
Ä_·¹s
;

977 
ušt64_t
 
¡¬t_Ín
=0;

978 
ušt64_t
 
couÁ
 = 0;

979 
ušt64_t
 
glob®_Ín
;

980 
ušt64_t
 
tÙ®_»®_couÁ
=0;

981 
ušt64_t
 
µa_Ín
 = 0;

982 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

984 
ušt64_t
 
¥l™_couÁ
 = 
tÙ®_Ín_couÁ
 / 
num_li¡
;

985 
cur_chunk
 = 0;

987 
glob®_Ín
 = 0; glob®_ÍÀ< 
tÙ®_Ín_couÁ
; global_lpn++){

988 
tÙ®_»®_couÁ
++;

989 if(
tÙ®_»®_couÁ
 > 
¥l™_couÁ
){

990 
tÙ®_»®_couÁ
=0;

991 
cur_chunk
++;

993 
ušt64_t
 
idx
 = 
glob®_Ín
 % 
ns
->
Ä_·¹s
;

994 
ušt64_t
 
loÿl_Ín
 = 
glob®_Ín
 / 
ns
->
Ä_·¹s
;

996 
cÚv_ál
 = &
cÚv_áls
[
idx
];

998 
µa
…· = 
cÚv_ál
->
m­tbl
[
loÿl_Ín
];

1000 if(
µa
.µ¨!ð
UNMAPPED_PPA
){

1001 if(
couÁ
 == 0){

1002 
¡¬t_Ín
=
glob®_Ín
;

1004 
couÁ
++;

1007 if(
couÁ
 != 0){

1008 
ušt64_t
 
dump_s
;

1009 
ušt64_t
 
dump_e
;

1010 
i
=0; i<
Ä_·¹s
;i++){

1011 
cur_idx
 = 
i
 * 
num_li¡
 + 
cur_chunk
;

1012 
dump_s
 = 
¡¬t_Ín
 + (Ð
i
 - (¡¬t_ÍÀ% 
Ä_·¹s
)) %‚r_parts);

1013 
dump_e
 = (
glob®_Ín
 - 1è- (((glob®_ÍÀ- 1è% 
Ä_·¹s
è- 
i
) %‚r_parts;

1014 
Ín
 = 
	`g’”©e_Ín
(
dump_s
, 
dump_e
,
couÁ
,
i
,-1,-1);

1015 
	`li¡_add_ž
(&
Ín
->
li¡
,&
h—d
[
cur_idx
]);

1017 
couÁ
 = 0;

1021 if(
couÁ
 != 0){

1022 
ušt64_t
 
dump_s
;

1023 
ušt64_t
 
dump_e
;

1024 
i
=0; i<
Ä_·¹s
;i++){

1025 
cur_idx
 = 
i
 * 
num_li¡
 + 
cur_chunk
;

1026 
dump_s
 = 
¡¬t_Ín
 + (Ð
i
 - ((¡¬t_ÍÀ% 
Ä_·¹s
)) %‚r_parts));

1027 
dump_e
 = (
glob®_Ín
 - 1è- ((((glob®_ÍÀ- 1è% 
Ä_·¹s
è- 
i
) %‚r_parts);

1028 
Ín
 = 
	`g’”©e_Ín
(
dump_s
, 
dump_e
,
couÁ
,
i
,-1,-1);

1029 
	`li¡_add_ž
(&
Ín
->
li¡
,&
h—d
[
cur_idx
]);

1033  
h—d
;

1036 
	}
}

1038 
boÞ
 
	$ªy_aùive_nÚem±y
(
li¡_h—d
 *
¬r
, 
ušt32_t
 
n
) {

1039 
ušt32_t
 
i
;

1040 
i
 = 0; i < 
n
; i++) {

1041 ià(!
	`li¡_em±y
(&
¬r
[
i
]))

1042  
Œue
;

1044  
çl£
;

1045 
	}
}

1047 
	$þ—n_ál
(
nvmev_dev
 * 
dev
){

1048 
	`´štk
(
KERN_INFO
 "device's…hysical fragmentation cleaning...\n");

1049 
nvmev_cÚfig
 *
cfg
 = &
dev
->
cÚfig
;

1050 
nvmev_ns
 *
ns
 = 
dev
->ns;

1051 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

1052 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

1054 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

1057 cÚ¡ 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

1059 
ušt32_t
 
i
;

1060 
w
;

1062 
i
 =0 ; i < 
Ä_·¹s
; i++){

1063 
cÚv_áls
[
i
].
ssd
->
¥
.
max_cÚ
 = 
dev
->max_con;

1066 
max_cÚ
 = 
dev
->max_con;

1069 
num_li¡s
 = 
dev
->
num_li¡
;

1071 
li¡_h—d
 *
aùive_lba_chunks_li¡
;

1073 
li¡_h—d
 *
li¡s
;

1074 
li¡s
 = 
	`vm®loc
(
Ä_·¹s
 * 
num_li¡s
 * (
li¡_h—d
));

1075 ià(!
li¡s
) {

1076 
	`´_”r
("Failedo‡llocate memory for†ist head.\n");

1080 
i
 = 0; i < 
Ä_·¹s
 * 
num_li¡s
; i++)

1081 
	`INIT_LIST_HEAD
(&
li¡s
[
i
]);

1083 
	`´štk
(
KERN_INFO
 "1\n");

1084 
	`NVMEV_DISPATCHER_FINAL
(
dev
);

1085 
	`NVMEV_IO_WORKER_FINAL
(
dev
);

1086 
	`´štk
(
KERN_INFO
 "2\n");

1089 
ušt64_t
 
¥ošt
 = 0;

1090 
aùive_lba_chunks_li¡
ð
	`ü—‹_li¡_äom_bË_¥l™
(
¥p
,
ns
,
cÚv_áls
,
num_li¡s
);

1092 
	`´štk
(
KERN_INFO
 "1\n");

1093 
ušt64_t
 
desœed_deg»e
 = 
dev
->
deg»e_äag
;

1094 
	`NVMEV_NAMESPACE_FINAL
(
dev
);

1095 
	`NVMEV_NAMESPACE_INIT
(
dev
);

1096 
ns
 = 
dev
->ns;

1097 
cÚv_áls
 = (
cÚv_ál
 *)
ns
->
áls
;

1098 
	`NVMEV_IO_WORKER_INIT
(
dev
);

1099 
	`NVMEV_DISPATCHER_INIT
(
dev
);

1101 
	`´štk
(
KERN_INFO
 "2\n");

1104 
»wr™e_poš‹r
 *
r
;

1105 
boÞ
 
»¡¬t
 = 
çl£
;

1106 
lba_chunk_t
 * 
»g’”©e
;

1108 
couÁ
 = 0;

1109 
cur_chunk
 = -1;

1111 
cur_šdex
 = 0;

1114 
lba_chunk_t
 *
Ín
, *
tmp
;

1116 if(!
»¡¬t
){

1117 
cur_chunk
++;

1118 if(
cur_chunk
 >ð
num_li¡s
)

1119 
cur_chunk
=0;

1121 
boÞ
 
have_chunk
 = 
çl£
;

1123 
i
=0; i < 
num_li¡s
;i++){

1124 if(!
	`li¡_em±y
(&
aùive_lba_chunks_li¡
[
cur_šdex
 * 
num_li¡s
 + 
i
])){

1125 
have_chunk
 = 
Œue
;

1130 if(!
have_chunk
){

1131 
cur_chunk
=0;

1132 
couÁ
=0;

1133 
cur_šdex
++;

1134 if(
cur_šdex
 >ð
Ä_·¹s
)

1135 
cur_šdex
=0;

1139 
»¡¬t
 = 
çl£
;

1140 
	`li¡_fÜ_—ch_’Œy_§ã
(
Ín
, 
tmp
, &
aùive_lba_chunks_li¡
[
cur_šdex
 * 
num_li¡s
 + 
cur_chunk
], 
li¡
) {

1141 if(
couÁ
 >ð
max_cÚ
){

1142 
couÁ
 = 0;

1145 
r
 = 
	`phäag_þ—Ãr
(
ns
, 
Ín
->
¡¬t_Ín
,†²->
’d_Ín
,
desœed_deg»e
,
li¡s
,†²->
idx
, 
çl£
,çl£,&
couÁ
,
num_li¡s
,
cur_chunk
);

1146 if(
r
!=
NULL
){

1147 if(
r
->
´“m±
){

1148 
Ín
->
¡¬t_Ín
 = 
r
->
¡¬ošt
;

1149 
Ín
->
ch
 = 
r
->ch;

1150 
Ín
->
lun
 = 
r
->lun;

1152 
	`vä“
(
r
);

1154 
lba_chunk_t
 *
´em_Ín
 = 
	`li¡_fœ¡_’Œy
(&
li¡s
[
Ín
->
idx
 * 
num_li¡s
 + 
cur_chunk
],lba_chunk_t, 
li¡
);

1155 
	`li¡_d–
(&
´em_Ín
->
li¡
);

1157 
r
 = 
	`phäag_þ—Ãr
(
ns
, 
´em_Ín
->
¡¬t_Ín
,…»m_Ín->
’d_Ín
,
desœed_deg»e
,
li¡s
,…»m_Ín->
idx
, 
Œue
,Œue,&
couÁ
,
num_li¡s
,
cur_chunk
);

1158 if(
r
 !ð
NULL
){

1159 
´em_Ín
->
¡¬t_Ín
 = 
r
->
¡¬ošt
;

1160 
´em_Ín
->
ch
 = 
r
->ch;

1161 
´em_Ín
->
lun
 = 
r
->lun;

1163 
	`li¡_add_ž
(&
´em_Ín
->
li¡
,&
li¡s
[´em_Ín->
idx
 * 
num_li¡s
 + 
cur_chunk
]);

1164 
	`vä“
(
r
);

1167 
»¡¬t
=
Œue
;

1171 if(
r
->
ch
 =ð-1 ||„->
lun
 ==-1){

1172 
Ín
->
¡¬t_Ín
 = 
r
->
¡¬ošt
;

1175 
	`li¡_d–
(&
Ín
->
li¡
);

1177 
Ín
->
¡¬t_Ín
 = 
r
->
¡¬ošt
;

1178 
Ín
->
ch
 = 
r
->ch;

1179 
Ín
->
lun
 = 
r
->lun;

1181 
	`li¡_add_ž
(&
Ín
->
li¡
,&
li¡s
[Ín->
idx
 * 
num_li¡s
 + 
cur_chunk
]);

1184 
	`vä“
(
r
);

1187 
	`li¡_d–
(&
Ín
->
li¡
);

1188 
	`vä“
(
Ín
);

1192 if(!
»¡¬t
 && !
	`li¡_em±y
(&
li¡s
[
cur_šdex
 * 
num_li¡s
 + 
cur_chunk
])){

1193 
Ín
 = 
	`li¡_fœ¡_’Œy
(&
li¡s
[
cur_šdex
 *
num_li¡s
 + 
cur_chunk
], 
lba_chunk_t
,
li¡
);

1194 
	`li¡_d–
(&
Ín
->
li¡
);

1195 
	`li¡_add_ž
(&
Ín
->
li¡
,&
aùive_lba_chunks_li¡
[
cur_šdex
 * 
num_li¡s
 + 
cur_chunk
]);

1198 } 
»¡¬t
 || 
	`ªy_aùive_nÚem±y
(
aùive_lba_chunks_li¡
, 
num_li¡s
 * 
Ä_·¹s
));

1200 
	`´štk
(
KERN_INFO
 "device's…hysical fragmentation clean done!-first\n");

1201 
	`vä“
(
li¡s
);

1202 
	`vä“
(
aùive_lba_chunks_li¡
);

1203 
	`´štk
(
KERN_INFO
 "device's…hysical fragmentation clean done!\n");

1204 
	}
}

1345 
	$check_physiÿl_äagm’tiÚ
(
nvmev_dev
 * 
dev
,
št32_t
 
ty³
){

1346 
nvmev_cÚfig
 *
cfg
 = &
dev
->
cÚfig
;

1347 
nvmev_ns
 *
ns
 = 
dev
->ns;

1348 
cÚv_ál
 *
cÚv_áls
 = (cÚv_áÈ*)
ns
->
áls
;

1349 
cÚv_ál
 *cÚv_áÈð&
cÚv_áls
[0];

1351 
ssd·¿ms
 *
¥p
 = &
cÚv_ál
->
ssd
->
¥
;

1353 
ušt32_t
 
i
;

1354 
w
;

1356 
ušt64_t
 *
luns
=
NULL
;

1357 if(
ty³
 =ð
CHDIE
){

1358 
cfg
->
ch_d›_couÁ”
=0;

1359 
cfg
->
ch_d›_Ï‹ncy
=0;

1360 
luns
 = 
	`vz®loc
((
ušt64_t
è* 
¥p
->
nchs
 * sµ->
luns_³r_ch
);

1363 
cfg
->
couÁ
=0;

1366 
li¡_h—d
 *
chunks_li¡
;

1367 
	`´štk
(
KERN_INFO
 "1\n");

1370 
ušt64_t
 
¥ošt
 = 0;

1371 
chunks_li¡
ð
	`ü—‹_li¡_äom_bË
(
¥p
,
ns
,
cÚv_áls
);

1373 
	`´štk
(
KERN_INFO
 "2\n");

1376 
lba_chunk_t
 *
Ín
, *
tmp
;

1377 
	#sm®l_chunk_size
 40

	)

1378 
ušt64_t
 
Ï‹ncy
 = 0;

1379 
	`li¡_fÜ_—ch_’Œy_§ã
(
Ín
, 
tmp
, 
chunks_li¡
, 
li¡
) {

1381 ; 
Ín
->
¡¬t_Ín
 <ðÍn->
’d_Ín
;){

1382 
cfg
->
šput_lba
=
Ín
->
¡¬t_Ín
;

1383 
cfg
->
lba_Ën
ð
	`mš
((
Ín
->
’d_Ín
 -†²->
¡¬t_Ín
 + 1),
sm®l_chunk_size
);

1388 
	`phäag_check
(
dev
);

1390 
Ín
->
¡¬t_Ín
 +ð
cfg
->
lba_Ën
;

1391 
Ï‹ncy
++;

1394 
	`li¡_d–
(&
Ín
->
li¡
);

1395 
	`vä“
(
Ín
);

1398 
	`kä“
(
chunks_li¡
);

1399 if(
luns
)

1400 
	`vä“
(
luns
);

1401 
	`´štk
(
KERN_INFO
 "3\n");

1402 
	`´štk
(
KERN_INFO
 "finish check…rocess\n");

1404 
	}
}

1406 
ssize_t
 
	$__cÚfig_show
(
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1409 
	}
}

1411 
ssize_t
 
	$__cÚfig_¡Üe
(
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
,

1412 cÚ¡ 
__u£r
 *
buf
, 
size_t
 
couÁ
)

1414 
ssize_t
 
Ën
 = 
couÁ
;

1415 cÚ¡ *
fž’ame
 = 
©Œ
->©Œ.
Çme
;

1416 
size_t
 
Ä_cÝ›d
;

1417 
šput
[128];

1419 
nvmev_dev
 *
nvmev_vdev
;

1420 
·¿ms
 *
p
;

1421 
·th
 
pwd
;

1422 *
cwd
 = 
NULL
;

1423 *
bufãr
 = 
NULL
;

1425 
	`¡ºýy
(
šput
, 
buf
, 
	`mš
(
couÁ
, (input)));

1427 
p
 = 
	`PARAM_INIT
();

1428 
cmd
 = 
	`·r£_to_cmd
(
šput
);

1429 
	`·r£_commªd
(
šput
 + (
	`¡¾’
(
cmd
)+ 1), 
p
);

1431 
	`´štk
("Çmi %s\n",
p
->
Çme
);

1432 
	`´štk
("cmd i %s\n",
cmd
);

1433 ià(
	`¡rcmp
(
cmd
, "create") == 0) {

1434 
	`´štk
("»tuº = %d\n", 
	`ü—‹_deviû
(
p
));

1435 } ià(
	`¡rcmp
(
cmd
, "delete") == 0) {

1436 ià(
p
->
Çme
 !ð
NULL
) {

1437 
	`´štk
("rg‘ deviû: %s\n", 
p
->
Çme
);

1439 
nvmev_vdev
 = 
	`__g‘_nvmev
(
p
->
Çme
);

1440 
	`d–‘e_deviû
(
nvmev_vdev
);

1442 
	`´štk
("Do‚ot havearget device\n");

1445 if(
	`¡rcmp
(
cmd
,"save") == 0){

1446 ià(
p
->
Çme
 !ð
NULL
) {

1447 if(
p
->
·th
 =ð
NULL
){

1448 
	`g‘_fs_pwd
(
cu¼’t
->
fs
, &
pwd
);

1449 
bufãr
 = 
	`km®loc
(
PATH_MAX
, 
GFP_ATOMIC
 | 
__GFP_NOWARN
 | 
__GFP_ZERO
);

1450 ià(
bufãr
) {

1451 
cwd
 = 
	`d_·th
(&
pwd
, 
bufãr
, 
PATH_MAX
);

1452 
	`kä“
(
bufãr
);

1453 
p
->
·th
 = 
cwd
;

1456 
	`´štk
("rg‘ deviû: %s\n", 
p
->
Çme
);

1457 
	`´štk
("·th: %s\n", 
p
->
·th
);

1459 
nvmev_vdev
 = 
	`__g‘_nvmev
(
p
->
Çme
);

1460 
	`§ve_deviû
(
nvmev_vdev
, 
p
->
·th
);

1462 
	`´štk
("Do‚ot havearget device\n");

1465 if(
	`¡rcmp
(
cmd
,"load") == 0){

1466 ià(
p
->
Çme
 !ð
NULL
) {

1467 if(
p
->
·th
 =ð
NULL
){

1468 
	`g‘_fs_pwd
(
cu¼’t
->
fs
, &
pwd
);

1469 
bufãr
 = 
	`km®loc
(
PATH_MAX
, 
GFP_ATOMIC
 | 
__GFP_NOWARN
 | 
__GFP_ZERO
);

1470 ià(
bufãr
) {

1471 
cwd
 = 
	`d_·th
(&
pwd
, 
bufãr
, 
PATH_MAX
);

1472 
	`kä“
(
bufãr
);

1473 
p
->
·th
=
cwd
;

1476 
	`´štk
("rg‘ deviû: %s\n", 
p
->
Çme
);

1477 
	`´štk
("·th: %s\n", 
p
->
·th
);

1479 
nvmev_vdev
 = 
	`__g‘_nvmev
(
p
->
Çme
);

1480 
	`lßd_deviû
(
nvmev_vdev
,
p
->
·th
);

1482 
	`´štk
("Do‚ot havearget device\n");

1485 if(
	`¡rcmp
(
cmd
,"clean") == 0){

1486 ià(
p
->
Çme
 !ð
NULL
) {

1487 
	`´štk
("rg‘ deviû: %s\n", 
p
->
Çme
);

1489 
nvmev_vdev
 = 
	`__g‘_nvmev
(
p
->
Çme
);

1491 
nvmev_vdev
->
deg»e_äag
 = 
p
->degree_frag;

1492 
nvmev_vdev
->
max_cÚ
 = 
p
->max_con;

1493 
nvmev_vdev
->
num_li¡
 = 
p
->
num_chunk
;

1494 
	`´štk
("chªgdeg»oàphysiÿÈäagm’tiÚØ%ld\n", 
nvmev_vdev
->
deg»e_äag
);

1496 
	`þ—n_ál
(
nvmev_vdev
);

1498 
	`´štk
("Do‚ot havearget device\n");

1501 if(
	`¡rcmp
(
cmd
,"phfrag") == 0){

1502 ià(
p
->
Çme
 !ð
NULL
) {

1503 
	`´štk
("rg‘ deviû: %s\n", 
p
->
Çme
);

1505 
nvmev_vdev
 = 
	`__g‘_nvmev
(
p
->
Çme
);

1507 
	`´štk
("count‡ll of file's…hfrag count\n");

1509 
	`check_physiÿl_äagm’tiÚ
(
nvmev_vdev
,
PHFRAG
);

1511 
	`´štk
("Do‚ot havearget device\n");

1514 if(
	`¡rcmp
(
cmd
,"chdie") == 0){

1515 ià(
p
->
Çme
 !ð
NULL
) {

1516 
	`´štk
("rg‘ deviû: %s\n", 
p
->
Çme
);

1518 
nvmev_vdev
 = 
	`__g‘_nvmev
(
p
->
Çme
);

1520 
	`´štk
("count directly…hysical fragmentation\n");

1522 
	`check_physiÿl_äagm’tiÚ
(
nvmev_vdev
,
CHDIE
);

1524 
	`´štk
("Do‚ot havearget device\n");

1528 
	`NVMEV_ERROR
("Doesn't‚ot command.");

1531  
Ën
;

1532 
	}
}

1534 
kobj_©Œibu‹
 
	gcÚfig_©Œ
 = 
__ATTR
(
cÚfig
, 0664, 
__cÚfig_show
, 
__cÚfig_¡Üe
);

1536 
	$NVMeV_š™
()

1538 
»t
 = 0;

1540 
nvmev
 = 
	`kz®loc
((nvmev), 
GFP_KERNEL
);

1542 
	`INIT_LIST_HEAD
(&
nvmev
->
dev_li¡
);

1543 
nvmev
->
Ä_dev
 = 0;

1545 
nvmev
->
cÚfig_roÙ
 = 
	`kobjeù_ü—‹_ªd_add
("nvmevœt", 
NULL
);

1546 
nvmev
->
cÚfig_©Œ
 = &config_attr;

1548 ià(
	`sysfs_ü—‹_fže
(
nvmev
->
cÚfig_roÙ
, &nvmev->
cÚfig_©Œ
->
©Œ
)) {

1549 
	`´štk
("Cannot create sysfs file...\n");

1550  -
EIO
;

1553 
	`SAVE_LOAD_INIT
(
nvmev
);

1555 
	`NVMEV_INFO
("Successfully†oad Virtual NVMe device module\n");

1557 
	}
}

1559 
	$NVMeV_ex™
()

1561 
	`d–‘e_®l
();

1565 
	`sysfs_»move_fže
(
nvmev
->
cÚfig_roÙ
, &nvmev->
cÚfig_©Œ
->
©Œ
);

1566 
	`kobjeù_put
(
nvmev
->
cÚfig_roÙ
);

1568 
	`kä“
(
nvmev
);

1570 
	`NVMEV_INFO
("Virtual NVMe device closed\n");

1571 
	}
}

1573 
MODULE_LICENSE
("GPL v2");

1574 
moduË_š™
(
NVMeV_š™
);

1575 
moduË_ex™
(
NVMeV_ex™
);

	@nvme.h

7 #iâdeà
_LINUX_NVME_H


8 
	#_LINUX_NVME_H


	)

10 
	~<lšux/ty³s.h
>

12 
	snvme_b¬
 {

13 
__u64
 
	mÿp
;

14 
__u32
 
	mvs
;

15 
__u32
 
	mštms
;

16 
__u32
 
	mštmc
;

17 
__u32
 
	mcc
;

18 
__u32
 
	mrsvd1
;

19 
__u32
 
	mc¡s
;

20 
__u32
 
	mns¤
;

21 
__u32
 
	maqa
;

22 
__u64
 
	masq
;

23 
__u64
 
	macq
;

24 
__u32
 
	mcmbloc
;

25 
__u32
 
	mcmbsz
;

28 
	#NVME_CAP_MQES
(
ÿp
è((ÿp)&0xffff)

	)

29 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

30 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

31 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

32 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

33 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

35 
	#NVME_CMB_BIR
(
cmbloc
è((cmbloc)&0x7)

	)

36 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

37 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

38 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

40 
	#NVME_CMB_WDS
(
cmbsz
è((cmbsz)&0x10)

	)

41 
	#NVME_CMB_RDS
(
cmbsz
è((cmbsz)&0x8)

	)

42 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbsz)&0x4)

	)

43 
	#NVME_CMB_CQS
(
cmbsz
è((cmbsz)&0x2)

	)

44 
	#NVME_CMB_SQS
(
cmbsz
è((cmbsz)&0x1)

	)

47 
	mNVME_CC_ENABLE
 = 1 << 0,

48 
	mNVME_CC_CSS_NVM
 = 0 << 4,

49 
	mNVME_CC_MPS_SHIFT
 = 7,

50 
	mNVME_CC_ARB_RR
 = 0 << 11,

51 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

52 
	mNVME_CC_ARB_VS
 = 7 << 11,

53 
	mNVME_CC_SHN_NONE
 = 0 << 14,

54 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

55 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

56 
	mNVME_CC_SHN_MASK
 = 3 << 14,

57 
	mNVME_CC_IOSQES
 = 6 << 16,

58 
	mNVME_CC_IOCQES
 = 4 << 20,

59 
	mNVME_CSTS_RDY
 = 1 << 0,

60 
	mNVME_CSTS_CFS
 = 1 << 1,

61 
	mNVME_CSTS_NSSRO
 = 1 << 4,

62 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

63 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

64 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

65 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

68 
	snvme_id_pow”_¡©e
 {

69 
__Ë16
 
	mmax_pow”
;

70 
__u8
 
	mrsvd2
;

71 
__u8
 
	mæags
;

72 
__Ë32
 
	m’Œy_Ït
;

73 
__Ë32
 
	mex™_Ït
;

74 
__u8
 
	m»ad_ut
;

75 
__u8
 
	m»ad_Ït
;

76 
__u8
 
	mwr™e_ut
;

77 
__u8
 
	mwr™e_Ït
;

78 
__Ë16
 
	midË_pow”
;

79 
__u8
 
	midË_sÿË
;

80 
__u8
 
	mrsvd19
;

81 
__Ë16
 
	maùive_pow”
;

82 
__u8
 
	maùive_wÜk_sÿË
;

83 
__u8
 
	mrsvd23
[9];

87 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

88 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

91 
	snvme_id_ù¾
 {

92 
__Ë16
 
	mvid
;

93 
__Ë16
 
	mssvid
;

94 
	m¢
[20];

95 
	mmn
[40];

96 
	mä
[8];

97 
__u8
 
	m¿b
;

98 
__u8
 
	m›“
[3];

99 
__u8
 
	mmic
;

100 
__u8
 
	mmdts
;

101 
__Ë16
 
	múŽid
;

102 
__Ë32
 
	mv”
;

103 
__Ë32
 
	m¹d3r
;

104 
__Ë32
 
	m¹d3e
;

105 
__Ë32
 
	mßes
;

106 
__Ë32
 
	mù¿‰
;

107 
__Ë16
 
	m¼ls
;

108 
__u8
 
	múŒÉy³
;

109 
__u8
 
	mrsvd84
[153];

110 
__Ë16
 
	mßcs
;

111 
__u8
 
	maþ
;

112 
__u8
 
	m«¾
;

113 
__u8
 
	mämw
;

114 
__u8
 
	mÍa
;

115 
__u8
 
	m–³
;

116 
__u8
 
	mÅss
;

117 
__u8
 
	mavscc
;

118 
__u8
 
	m­¡a
;

119 
__Ë16
 
	mwùemp
;

120 
__Ë16
 
	mcùemp
;

121 
__u8
 
	mrsvd270
[242];

122 
__u8
 
	msqes
;

123 
__u8
 
	mcqes
;

124 
__u8
 
	mrsvd514
[2];

125 
__Ë32
 
	mÂ
;

126 
__Ë16
 
	mÚcs
;

127 
__Ë16
 
	mfu£s
;

128 
__u8
 
	mâa
;

129 
__u8
 
	mvwc
;

130 
__Ë16
 
	mawun
;

131 
__Ë16
 
	mawupf
;

132 
__u8
 
	mnvscc
;

133 
__u8
 
	mrsvd531
;

134 
__Ë16
 
	macwu
;

135 
__u8
 
	mrsvd534
[2];

136 
__Ë32
 
	msgls
;

137 
__u8
 
	mrsvd540
[1508];

138 
nvme_id_pow”_¡©e
 
	mpsd
[32];

139 
__u8
 
	mvs
[1024];

143 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

144 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

145 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

146 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

149 
	snvme_lbaf
 {

150 
__Ë16
 
	mms
;

151 
__u8
 
	mds
;

152 
__u8
 
	m½
;

155 
	snvme_id_ns
 {

156 
__Ë64
 
	mnsze
;

157 
__Ë64
 
	mnÿp
;

158 
__Ë64
 
	mnu£
;

159 
__u8
 
	mnsã©
;

160 
__u8
 
	mÆbaf
;

161 
__u8
 
	mæbas
;

162 
__u8
 
	mmc
;

163 
__u8
 
	mdpc
;

164 
__u8
 
	mdps
;

165 
__u8
 
	mnmic
;

166 
__u8
 
	m»sÿp
;

167 
__u8
 
	måi
;

168 
__u8
 
	mrsvd33
;

169 
__Ë16
 
	mÇwun
;

170 
__Ë16
 
	mÇwupf
;

171 
__Ë16
 
	mÇcwu
;

172 
__Ë16
 
	mÇb¢
;

173 
__Ë16
 
	mÇbo
;

174 
__Ë16
 
	mÇb¥f
;

175 
__u16
 
	mrsvd46
;

176 
__Ë64
 
	mnvmÿp
[2];

177 
__u8
 
	mrsvd64
[40];

178 
__u8
 
	mnguid
[16];

179 
__u8
 
	meui64
[8];

180 
nvme_lbaf
 
	mlbaf
[16];

181 
__u8
 
	mrsvd192
[192];

182 
__u8
 
	mvs
[3712];

185 
	snvme_id_ns_desc
 {

186 
__u8
 
	mnidt
;

187 
__u8
 
	mnidl
;

188 
__u8
 
	mrsvd
[2];

189 
__u8
 
	mnid
[4092];

192 
	snvme_lba_fÜm©_ex‹nsiÚ
 {

193 
__u8
 
	mzsze
[8];

194 
__u8
 
	mzdes
[8];

195 
__u8
 
	mrsv
[56];

199 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

200 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

201 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

202 
	mNVME_LBAF_RP_BEST
 = 0,

203 
	mNVME_LBAF_RP_BETTER
 = 1,

204 
	mNVME_LBAF_RP_GOOD
 = 2,

205 
	mNVME_LBAF_RP_DEGRADED
 = 3,

206 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

207 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

208 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

209 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

210 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

211 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

212 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

213 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

214 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

215 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

218 
	snvme_sm¬t_log
 {

219 
__u8
 
	mü™iÿl_w¬nšg
;

220 
__u8
 
	m‹m³¿tu»
[2];

221 
__u8
 
	mavaž_¥¬e
;

222 
__u8
 
	m¥¬e_th»sh
;

223 
__u8
 
	m³rûÁ_u£d
;

224 
__u8
 
	mrsvd6
[26];

225 
__u8
 
	md©a_un™s_»ad
[16];

226 
__u8
 
	md©a_un™s_wr™‹n
[16];

227 
__u8
 
	mho¡_»ads
[16];

228 
__u8
 
	mho¡_wr™es
[16];

229 
__u8
 
	mù¾_busy_time
[16];

230 
__u8
 
	mpow”_cyþes
[16];

231 
__u8
 
	mpow”_Ú_hours
[16];

232 
__u8
 
	mun§ã_shutdowns
[16];

233 
__u8
 
	mmedŸ_”rÜs
[16];

234 
__u8
 
	mnum_”r_log_’Œ›s
[16];

235 
__Ë32
 
	mw¬nšg_‹mp_time
;

236 
__Ë32
 
	mü™iÿl_comp_time
;

237 
__Ë16
 
	m‹mp_£nsÜ
[8];

238 
__u8
 
	mrsvd216
[296];

242 
	mNVME_CMD_EFFECTS_CSUPP
 = 1 << 0,

243 
	mNVME_CMD_EFFECTS_LBCC
 = 1 << 1,

244 
	mNVME_CMD_EFFECTS_NCC
 = 1 << 2,

245 
	mNVME_CMD_EFFECTS_NIC
 = 1 << 3,

246 
	mNVME_CMD_EFFECTS_CCC
 = 1 << 4,

247 
	mNVME_CMD_EFFECTS_CSE_MASK
 = 3 << 16,

248 
	mNVME_CMD_EFFECTS_UUID_SEL
 = 1 << 19,

251 
	snvme_efãùs_log
 {

252 
__Ë32
 
	macs
[256];

253 
__Ë32
 
	miocs
[256];

254 
__u8
 
	m»sv
[2048];

258 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

259 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

260 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

261 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

262 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

266 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

269 
	snvme_lba_¿nge_ty³
 {

270 
__u8
 
	mty³
;

271 
__u8
 
	m©Œibu‹s
;

272 
__u8
 
	mrsvd2
[14];

273 
__u64
 
	m¦ba
;

274 
__u64
 
	mÆb
;

275 
__u8
 
	mguid
[16];

276 
__u8
 
	mrsvd48
[16];

280 
	mNVME_LBART_TYPE_FS
 = 0x01,

281 
	mNVME_LBART_TYPE_RAID
 = 0x02,

282 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

283 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

285 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

286 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

289 
	snvme_»£rv©iÚ_¡©us
 {

290 
__Ë32
 
	mg’
;

291 
__u8
 
	m¹y³
;

292 
__u8
 
	m»gùl
[2];

293 
__u8
 
	m»sv5
[2];

294 
__u8
 
	m±¶s
;

295 
__u8
 
	m»sv10
[13];

297 
__Ë16
 
	múŽid
;

298 
__u8
 
	mrc¡s
;

299 
__u8
 
	m»sv3
[5];

300 
__Ë64
 
	mho¡id
;

301 
__Ë64
 
	mrkey
;

302 } 
	m»gùl_ds
[];

307 
	#NVME_OPCODES
(
Ý
) \

308 
	`Ý
(
nvme_cmd_æush
, 0x00èÝ(
nvme_cmd_wr™e
, 0x01èÝ(
nvme_cmd_»ad
, 0x02) op( \

309 
nvme_cmd_wr™e_uncÜ
, 0x04è
	`Ý
(
nvme_cmd_com·»
, 0x05èÝ(
nvme_cmd_wr™e_z”Ûs
, \

311 
	`Ý
(
nvme_cmd_dsm
, 0x09èÝ(
nvme_cmd_v”ify
, 0x0cèÝ(
nvme_cmd_»sv_»gi¡”
, 0x0d) \

312 
	`Ý
(
nvme_cmd_»sv_»pÜt
, 0x0eèÝ(
nvme_cmd_»sv_acquœe
, 0x11) op( \

313 
nvme_cmd_»sv_»Ëa£
, 0x15è
	`Ý
(
nvme_cmd_zÚe_mgmt_£nd
, 0x79) \

314 
	`Ý
(
nvme_cmd_zÚe_mgmt_»cv
, 0x7aèÝ(
nvme_cmd_zÚe_­³nd
, 0x7d) \

315 
	`Ý
(
nvme_cmd_kv_¡Üe
, 0x81èÝ(
nvme_cmd_kv_­³nd
, 0x83) \

316 
	`Ý
(
nvme_cmd_kv_»Œ›ve
, \

317 0x90è
	`Ý
(
nvme_cmd_kv_d–‘e
, \

318 0xA1è
	`Ý
(
nvme_cmd_kv_™”_»q
, 0xB1) \

319 
	`Ý
(
nvme_cmd_kv_™”_»ad
, \

320 0xB2è
	`Ý
(
nvme_cmd_kv_exi¡
, 0xB3) \

321 
	`Ý
(
nvme_cmd_kv_b©ch
, 0x85)

	)

323 
	#ENUM_NVME_OP
(
Çme
, 
v®ue
èÇmðv®ue,

	)

324 
	#STRING_NVME_OP
(
Çme
, 
v®ue
è[Çme] = #Çme,

	)

326 
	envme_Ýcode
 { 
NVME_OPCODES
(
ENUM_NVME_OP
) };

328 cÚ¡ *cÚ¡ 
	g__nvme_Ýcode_¡ršgs
[] = { 
NVME_OPCODES
(
STRING_NVME_OP
) };

330 
	#nvme_Ýcode_¡ršg
(
Ýcode
) \

331 (
__nvme_Ýcode_¡ršgs
[
Ýcode
] ? __nvme_Ýcode_¡ršgs[Ýcode] : "unknown")

	)

333 
	snvme_commÚ_commªd
 {

334 
__u8
 
	mÝcode
;

335 
__u8
 
	mæags
;

336 
__u16
 
	mcommªd_id
;

337 
__Ë32
 
	mnsid
;

338 
__Ë32
 
	mcdw2
[2];

339 
__Ë64
 
	mm‘ad©a
;

340 
__Ë64
 
	m´p1
;

341 
__Ë64
 
	m´p2
;

342 
__Ë32
 
	mcdw10
[6];

345 
	snvme_rw_commªd
 {

346 
__u8
 
	mÝcode
;

347 
__u8
 
	mæags
;

348 
__u16
 
	mcommªd_id
;

349 
__Ë32
 
	mnsid
;

350 
__u64
 
	mrsvd2
;

351 
__Ë64
 
	mm‘ad©a
;

352 
__Ë64
 
	m´p1
;

353 
__Ë64
 
	m´p2
;

354 
__Ë64
 
	m¦ba
;

355 
__Ë16
 
	mËngth
;

356 
__Ë16
 
	mcÚŒÞ
;

357 
__Ë32
 
	mdsmgmt
;

358 
__Ë32
 
	m»áag
;

359 
__Ë16
 
	m­±ag
;

360 
__Ë16
 
	m­pmask
;

363 
	snvme_g‘_log_·ge_commªd
 {

364 
__u8
 
	mÝcode
;

365 
__u8
 
	mæags
;

366 
__u16
 
	mcommªd_id
;

367 
__Ë32
 
	mnsid
;

368 
__u64
 
	mrsvd2
[2];

369 
__Ë64
 
	m´p1
;

370 
__Ë64
 
	m´p2
;

371 
__u8
 
	mlid
;

372 
__u8
 
	ml¥
;

373 
__Ë16
 
	mnumdl
;

374 
__Ë16
 
	mnumdu
;

375 
__u16
 
	mrsvd11
;

378 
__Ë32
 
	mÍÞ
;

379 
__Ë32
 
	mÍou
;

381 
__Ë64
 
	mÍo
;

383 
__u8
 
	mrsvd14
[3];

384 
__u8
 
	mcsi
;

385 
__u32
 
	mrsvd15
;

389 
	mNVME_RW_LR
 = 1 << 15,

390 
	mNVME_RW_FUA
 = 1 << 14,

391 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

392 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

393 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

394 
	mNVME_RW_DSM_FREQ_READS
 = 3,

395 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

396 
	mNVME_RW_DSM_FREQ_RW
 = 5,

397 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

398 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

399 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

400 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

401 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

402 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

403 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

404 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

405 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

406 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

407 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

408 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

409 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

412 
	snvme_dsm_cmd
 {

413 
__u8
 
	mÝcode
;

414 
__u8
 
	mæags
;

415 
__u16
 
	mcommªd_id
;

416 
__Ë32
 
	mnsid
;

417 
__u64
 
	mrsvd2
[2];

418 
__Ë64
 
	m´p1
;

419 
__Ë64
 
	m´p2
;

420 
__Ë32
 
	mÄ
;

421 
__Ë32
 
	m©Œibu‹s
;

422 
__u32
 
	mrsvd12
[4];

426 
	mNVME_DSMGMT_IDR
 = 1 << 0,

427 
	mNVME_DSMGMT_IDW
 = 1 << 1,

428 
	mNVME_DSMGMT_AD
 = 1 << 2,

431 
	snvme_dsm_¿nge
 {

432 
__Ë32
 
	mÿ‰r
;

433 
__Ë32
 
	mÆb
;

434 
__Ë64
 
	m¦ba
;

439 
	envme_admš_Ýcode
 {

440 
	mnvme_admš_d–‘e_sq
 = 0x00,

441 
	mnvme_admš_ü—‹_sq
 = 0x01,

442 
	mnvme_admš_g‘_log_·ge
 = 0x02,

443 
	mnvme_admš_d–‘e_cq
 = 0x04,

444 
	mnvme_admš_ü—‹_cq
 = 0x05,

445 
	mnvme_admš_id’tify
 = 0x06,

446 
	mnvme_admš_abÜt_cmd
 = 0x08,

447 
	mnvme_admš_£t_ã©u»s
 = 0x09,

448 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

449 
	mnvme_admš_async_ev’t
 = 0x0c,

450 
	mnvme_admš_ns_mgmt
 = 0x0d,

451 
	mnvme_admš_aùiv©e_fw
 = 0x10,

452 
	mnvme_admš_dowÆßd_fw
 = 0x11,

453 
	mnvme_admš_dev_£lf_‹¡
 = 0x14,

454 
	mnvme_admš_ns_©ch
 = 0x15,

455 
	mnvme_admš_k“p_®ive
 = 0x18,

456 
	mnvme_admš_dœeùive_£nd
 = 0x19,

457 
	mnvme_admš_dœeùive_»cv
 = 0x1a,

458 
	mnvme_admš_vœtu®_mgmt
 = 0x1c,

459 
	mnvme_admš_nvme_mi_£nd
 = 0x1d,

460 
	mnvme_admš_nvme_mi_»cv
 = 0x1e,

461 
	mnvme_admš_dbbuf
 = 0x7C,

462 
	mnvme_admš_fÜm©_nvm
 = 0x80,

463 
	mnvme_admš_£cur™y_£nd
 = 0x81,

464 
	mnvme_admš_£cur™y_»cv
 = 0x82,

465 
	mnvme_admš_§n™ize_nvm
 = 0x84,

466 
	mnvme_admš_g‘_lba_¡©us
 = 0x86,

467 
	mnvme_admš_v’dÜ_¡¬t
 = 0xC0,

471 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

472 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

473 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

474 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

475 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

476 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

477 
	mNVME_FEAT_ARBITRATION
 = 0x01,

478 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

479 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

480 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

481 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

482 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

483 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

484 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

485 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

486 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

487 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

488 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

489 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

490 
	mNVME_FEAT_HOST_ID
 = 0x81,

491 
	mNVME_FEAT_RESV_MASK
 = 0x82,

492 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

493 
	mNVME_LOG_ERROR
 = 0x01,

494 
	mNVME_LOG_SMART
 = 0x02,

495 
	mNVME_LOG_FW_SLOT
 = 0x03,

496 
	mNVME_LOG_CHANGED_NS
 = 0x04,

497 
	mNVME_LOG_CMD_EFFECTS
 = 0x05,

498 
	mNVME_LOG_DEVICE_SELF_TEST
 = 0x06,

499 
	mNVME_LOG_TELEMETRY_HOST
 = 0x07,

500 
	mNVME_LOG_TELEMETRY_CTRL
 = 0x08,

501 
	mNVME_LOG_ENDURANCE_GROUP
 = 0x09,

502 
	mNVME_LOG_ANA
 = 0x0c,

503 
	mNVME_LOG_DISC
 = 0x70,

504 
	mNVME_LOG_RESERVATION
 = 0x80,

505 
	mNVME_FWACT_REPL
 = (0 << 3),

506 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

507 
	mNVME_FWACT_ACTV
 = (2 << 3),

510 
	snvme_id’tify
 {

511 
__u8
 
	mÝcode
;

512 
__u8
 
	mæags
;

513 
__u16
 
	mcommªd_id
;

514 
__Ë32
 
	mnsid
;

515 
__u64
 
	mrsvd2
[2];

516 
__Ë64
 
	m´p1
;

517 
__Ë64
 
	m´p2
;

518 
__Ë32
 
	mús
;

519 
__u32
 
	mrsvd11
[5];

522 
	snvme_ã©u»s
 {

523 
__u8
 
	mÝcode
;

524 
__u8
 
	mæags
;

525 
__u16
 
	mcommªd_id
;

526 
__Ë32
 
	mnsid
;

527 
__u64
 
	mrsvd2
[2];

528 
__Ë64
 
	m´p1
;

529 
__Ë64
 
	m´p2
;

530 
__Ë32
 
	mfid
;

531 
__Ë32
 
	mdwÜd11
;

532 
__u32
 
	mrsvd12
[4];

535 
	snvme_ü—‹_cq
 {

536 
__u8
 
	mÝcode
;

537 
__u8
 
	mæags
;

538 
__u16
 
	mcommªd_id
;

539 
__u32
 
	mrsvd1
[5];

540 
__Ë64
 
	m´p1
;

541 
__u64
 
	mrsvd8
;

542 
__Ë16
 
	mcqid
;

543 
__Ë16
 
	mqsize
;

544 
__Ë16
 
	mcq_æags
;

545 
__Ë16
 
	mœq_veùÜ
;

546 
__u32
 
	mrsvd12
[4];

549 
	snvme_ü—‹_sq
 {

550 
__u8
 
	mÝcode
;

551 
__u8
 
	mæags
;

552 
__u16
 
	mcommªd_id
;

553 
__u32
 
	mrsvd1
[5];

554 
__Ë64
 
	m´p1
;

555 
__u64
 
	mrsvd8
;

556 
__Ë16
 
	msqid
;

557 
__Ë16
 
	mqsize
;

558 
__Ë16
 
	msq_æags
;

559 
__Ë16
 
	mcqid
;

560 
__u32
 
	mrsvd12
[4];

563 
	snvme_d–‘e_queue
 {

564 
__u8
 
	mÝcode
;

565 
__u8
 
	mæags
;

566 
__u16
 
	mcommªd_id
;

567 
__u32
 
	mrsvd1
[9];

568 
__Ë16
 
	mqid
;

569 
__u16
 
	mrsvd10
;

570 
__u32
 
	mrsvd11
[5];

573 
	snvme_abÜt_cmd
 {

574 
__u8
 
	mÝcode
;

575 
__u8
 
	mæags
;

576 
__u16
 
	mcommªd_id
;

577 
__u32
 
	mrsvd1
[9];

578 
__Ë16
 
	msqid
;

579 
__u16
 
	mcid
;

580 
__u32
 
	mrsvd11
[5];

583 
	snvme_dowÆßd_fœmw¬e
 {

584 
__u8
 
	mÝcode
;

585 
__u8
 
	mæags
;

586 
__u16
 
	mcommªd_id
;

587 
__u32
 
	mrsvd1
[5];

588 
__Ë64
 
	m´p1
;

589 
__Ë64
 
	m´p2
;

590 
__Ë32
 
	mnumd
;

591 
__Ë32
 
	moff£t
;

592 
__u32
 
	mrsvd12
[4];

595 
	snvme_fÜm©_cmd
 {

596 
__u8
 
	mÝcode
;

597 
__u8
 
	mæags
;

598 
__u16
 
	mcommªd_id
;

599 
__Ë32
 
	mnsid
;

600 
__u64
 
	mrsvd2
[4];

601 
__Ë32
 
	mcdw10
;

602 
__u32
 
	mrsvd11
[5];

605 
	snvme_commªd
 {

607 
nvme_commÚ_commªd
 
	mcommÚ
;

608 
nvme_rw_commªd
 
	mrw
;

609 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

610 
nvme_id’tify
 
	mid’tify
;

611 
nvme_ã©u»s
 
	mã©u»s
;

612 
nvme_ü—‹_cq
 
	mü—‹_cq
;

613 
nvme_ü—‹_sq
 
	mü—‹_sq
;

614 
nvme_d–‘e_queue
 
	md–‘e_queue
;

615 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

616 
nvme_fÜm©_cmd
 
	mfÜm©
;

617 
nvme_dsm_cmd
 
	mdsm
;

618 
nvme_abÜt_cmd
 
	mabÜt
;

623 
	mNVME_SCT_GENERIC_CMD_STATUS
 = 0,

624 
	mNVME_SCT_CMD_SPECIFIC_STATUS
,

625 
	mNVME_SCT_MEDIA_INTEGRITY_ERRORS
,

626 
	mNVME_SCT_PATH_RELATED_STATUS


630 
	mNVME_SC_SUCCESS
 = 0x0,

631 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

632 
	mNVME_SC_INVALID_FIELD
 = 0x2,

633 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

634 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

635 
	mNVME_SC_POWER_LOSS
 = 0x5,

636 
	mNVME_SC_INTERNAL
 = 0x6,

637 
	mNVME_SC_ABORT_REQ
 = 0x7,

638 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

639 
	mNVME_SC_FUSED_FAIL
 = 0x9,

640 
	mNVME_SC_FUSED_MISSING
 = 0xa,

641 
	mNVME_SC_INVALID_NS
 = 0xb,

642 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

643 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

644 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

645 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

646 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

647 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

648 
	mNVME_SC_LBA_RANGE
 = 0x80,

649 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

650 
	mNVME_SC_NS_NOT_READY
 = 0x82,

651 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

652 
	mNVME_SC_CQ_INVALID
 = 0x100,

653 
	mNVME_SC_QID_INVALID
 = 0x101,

654 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

655 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

656 
	mNVME_SC_ABORT_MISSING
 = 0x104,

657 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

658 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

659 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

660 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

661 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

662 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

663 
	mNVME_SC_FIRMWARE_NEEDS_RESET
 = 0x10b,

664 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

665 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

666 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

667 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

668 
	mNVME_SC_FW_NEEDS_RESET_SUBSYS
 = 0x110,

669 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

670 
	mNVME_SC_INVALID_PI
 = 0x181,

671 
	mNVME_SC_READ_ONLY
 = 0x182,

672 
	mNVME_SC_WRITE_FAULT
 = 0x280,

673 
	mNVME_SC_READ_ERROR
 = 0x281,

674 
	mNVME_SC_GUARD_CHECK
 = 0x282,

675 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

676 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

677 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

678 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

679 
	mNVME_SC_DNR
 = 0x4000,

682 
	snvme_com¶‘iÚ
 {

683 
__Ë32
 
	m»suÉ0
;

684 
__Ë32
 
	m»suÉ1
;

685 
__Ë16
 
	msq_h—d
;

686 
__Ë16
 
	msq_id
;

687 
__u16
 
	mcommªd_id
;

688 
__Ë16
 
	m¡©us
;

692 
	mNVME_NIDT_EUI
 = 0x1,

693 
	mNVME_NIDT_GUI
 = 0x2,

694 
	mNVME_NIDT_UUID
 = 0x3,

695 
	mNVME_NIDT_CSI
 = 0x4,

699 
	mNVME_CSI_NVM
 = 0x0,

700 
	mNVME_CSI_KV
 = 0x1,

701 
	mNVME_CSI_ZNS
 = 0x2,

703 
	#NVME_VS
(
majÜ
, 
mšÜ
è(((majÜè<< 16è| ((mšÜè<< 8))

	)

	@nvme_kv.h

3 #iâdeà
_NVME_KV_H


4 
	#_NVME_KV_H


	)

6 
	~"nvme.h
"

8 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

9 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

10 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

11 
	#MAX_SUB_CMD
 (8)

	)

12 
	#ALIGN_LEN
 (64)

	)

14 
	unvme_d©a_±r
 {

16 
__Ë64
 
	m´p1
;

17 
__Ë64
 
	m´p2
;

22 
	snvme_kv_¡Üe_commªd
 {

23 
__u8
 
	mÝcode
;

24 
__u8
 
	mæags
;

25 
__u16
 
	mcommªd_id
;

26 
__Ë32
 
	mnsid
;

27 
__u64
 
	mrsvd
;

28 
__Ë32
 
	moff£t
;

29 
__u32
 
	mrsvd2
;

30 
nvme_d©a_±r
 
	md±r
;

31 
__Ë32
 
	mv®ue_Ën
;

32 
__u8
 
	mkey_Ën
;

33 
__u8
 
	mÝtiÚ
;

34 
__u8
 
	mšv®id_by‹
 : 2;

35 
__u8
 
	mrsvd3
 : 6;

36 
__u8
 
	mrsvd4
;

39 
	mkey
[16];

42 
__Ë64
 
	mkey_´p
;

43 
__Ë64
 
	mkey_´p2
;

48 
	snvme_kv_­³nd_commªd
 {

49 
__u8
 
	mÝcode
;

50 
__u8
 
	mæags
;

51 
__u16
 
	mcommªd_id
;

52 
__Ë32
 
	mnsid
;

53 
__u64
 
	mrsvd
;

54 
__Ë32
 
	moff£t
;

55 
__u32
 
	mrsvd2
;

56 
nvme_d©a_±r
 
	md±r
;

57 
__Ë32
 
	mv®ue_Ën
;

58 
__u8
 
	mkey_Ën
;

59 
__u8
 
	mÝtiÚ
;

60 
__u8
 
	mšv®id_by‹
 : 2;

61 
__u8
 
	mrsvd3
 : 6;

62 
__u8
 
	mrsvd4
;

65 
	mkey
[16];

68 
__Ë64
 
	mkey_´p
;

69 
__Ë64
 
	mkey_´p2
;

74 
	snvme_kv_b©ch_commªd
 {

75 
__u8
 
	mÝcode
;

76 
__u8
 
	mæags
;

77 
__u16
 
	mcommªd_id
;

78 
__Ë32
 
	mnsid
;

79 
__u64
 
	mrsvd
;

80 
__Ë32
 
	moff£t
;

81 
__u32
 
	mrsvd2
;

82 
nvme_d©a_±r
 
	md±r
;

83 
__Ë32
 
	mv®ue_Ën
;

84 
__u8
 
	mkey_Ën
;

85 
__u8
 
	mÝtiÚ
;

86 
__u8
 
	mrsvd3
;

87 
__u8
 
	mrsvd4
;

90 
	mkey
[16];

93 
__Ë64
 
	mkey_´p
;

94 
__Ë64
 
	mkey_´p2
;

99 
	snvme_kv_»Œ›ve_commªd
 {

100 
__u8
 
	mÝcode
;

101 
__u8
 
	mæags
;

102 
__u16
 
	mcommªd_id
;

103 
__Ë32
 
	mnsid
;

104 
__u64
 
	mrsvd
;

105 
__Ë32
 
	moff£t
;

106 
__u32
 
	mrsvd2
;

107 
nvme_d©a_±r
 
	md±r
;

108 
__Ë32
 
	mv®ue_Ën
;

109 
__u8
 
	mkey_Ën
;

110 
__u8
 
	mÝtiÚ
;

111 
__u16
 
	mrsvd3
;

114 
	mkey
[16];

117 
__Ë64
 
	mkey_´p
;

118 
__Ë64
 
	mkey_´p2
;

123 
	snvme_kv_d–‘e_commªd
 {

124 
__u8
 
	mÝcode
;

125 
__u8
 
	mæags
;

126 
__u16
 
	mcommªd_id
;

127 
__Ë32
 
	mnsid
;

128 
__u64
 
	mrsvd
;

129 
__Ë32
 
	moff£t
;

130 
__u32
 
	mrsvd2
;

131 
__u64
 
	mrsvd3
[2];

132 
__Ë32
 
	mv®ue_Ën
;

133 
__u8
 
	mkey_Ën
;

134 
__u8
 
	mÝtiÚ
;

135 
__u16
 
	mrsvd4
;

138 
	mkey
[16];

141 
__Ë64
 
	mkey_´p
;

142 
__Ë64
 
	mkey_´p2
;

147 
	snvme_kv_™”_»q_commªd
 {

148 
__u8
 
	mÝcode
;

149 
__u8
 
	mæags
;

150 
__u16
 
	mcommªd_id
;

151 
__Ë32
 
	mnsid
;

152 
__u64
 
	mrsvd
[4];

153 
__Ë32
 
	mz”o
;

154 
__u8
 
	m™”_hªdË
;

155 
__u8
 
	mÝtiÚ
;

156 
__u16
 
	mrsvd2
;

157 
__u32
 
	m™”_v®
;

158 
__u32
 
	m™”_b™mask
;

159 
__u64
 
	mrsvd3
;

162 
	snvme_kv_™”_»ad_commªd
 {

163 
__u8
 
	mÝcode
;

164 
__u8
 
	mæags
;

165 
__u16
 
	mcommªd_id
;

166 
__Ë32
 
	mnsid
;

167 
__u64
 
	mrsvd
[2];

168 
nvme_d©a_±r
 
	md±r
;

169 
__Ë32
 
	mv®ue_Ën
;

170 
__u8
 
	m™”_hªdË
;

171 
__u8
 
	mÝtiÚ
;

172 
__u16
 
	mrsvd2
;

173 
__u64
 
	mrsvd3
[2];

176 
	snvme_kv_exi¡_commªd
 {

177 
__u8
 
	mÝcode
;

178 
__u8
 
	mæags
;

179 
__u16
 
	mcommªd_id
;

180 
__Ë32
 
	mnsid
;

181 
__u64
 
	mrsvd
;

182 
__Ë32
 
	moff£t
;

183 
__u32
 
	mrsvd2
;

184 
__u64
 
	mrsvd3
[2];

185 
__Ë32
 
	mv®ue_Ën
;

186 
__u8
 
	mkey_Ën
;

187 
__u8
 
	mÝtiÚ
;

188 
__u16
 
	mrsvd4
;

191 
	mkey
[16];

194 
__Ë64
 
	mkey_´p
;

195 
__Ë64
 
	mkey_´p2
;

201 
	skv_™”_cÚ‹xt
 {

202 
	mhªdË
;

203 
	m´efix
;

204 
	mb™mask
;

205 *
	mbuf
;

206 
	mbuæ’
;

207 
	mby‹swr™‹n
;

208 
	mbufoff£t
;

209 
boÞ
 
	m’d
;

210 
	mcu¼’t_pos
;

213 
	envme_kv_™”_»q_ÝtiÚ
 {

214 
	mITER_OPTION_NOTHING
 = 0x0,

215 
	mITER_OPTION_OPEN
 = 0x01,

216 
	mITER_OPTION_CLOSE
 = 0x02,

217 
	mITER_OPTION_KEY_ONLY
 = 0x04,

218 
	mITER_OPTION_KEY_VALUE
 = 0x08,

219 
	mITER_OPTION_DEL_KEY_VALUE
 = 0x10,

223 
	ssub_cmd_©Œibu‹
 {

224 
__u8
 
	mÝcode
;

225 
__u8
 
	mkeySize
;

226 
__u8
 
	m»£rvedDw0
[2];

227 
__u32
 
	mv®ueSize
;

228 
__u8
 
	mÝtiÚ
;

229 
__u8
 
	mnsid
;

230 
__u8
 
	m»£rvedDw2
[2];

231 
__u32
 
	mNoU£d
;

234 
	sb©ch_cmd_h—d
 {

235 
sub_cmd_©Œibu‹
 
	m©Œ
[
MAX_SUB_CMD
];

236 
__u8
 
	m»£rved
[384];

239 
	ssub_cmd_h—d
 {

240 
__u8
 
	m»£rved
[
ALIGN_LEN
];

243 
	ssub_·ylßd_fÜm©
 {

244 
sub_cmd_h—d
 
	msub_h—d
;

245 
__u8
 
	md©a
[0];

248 
	s·ylßd_fÜm©
 {

249 
b©ch_cmd_h—d
 
	mb©ch_h—d
;

250 
__u8
 
	msub_·ylßd
[0];

253 
	ssub_·ylßd_©Œibu‹
 {

254 
__u32
 
	msub_·ylßd_Ën
;

255 
__u32
 
	mkey_Ën
;

256 
__u32
 
	mv®ue_Ën
;

259 
	skv_b©ch_d©a
 {

260 
__u8
 
	mkey
[256];

261 
__u32
 
	mkeySize
;

262 
__u8
 
	mv®ue
[4097];

263 
__u32
 
	mv®ueSize
;

264 
__u32
 
	mÝcode
;

267 
	snvme_kv_commªd
 {

269 
nvme_commÚ_commªd
 
	mcommÚ
;

270 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

271 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

272 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

273 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

274 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

275 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

276 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

277 
nvme_kv_b©ch_commªd
 
	mkv_b©ch
;

	@nvme_zns.h

3 #iâdeà
_NVME_ZNS_H


4 
	#_NVME_ZNS_H


	)

6 
	~"nvme.h
"

9 
	snvme_id_zns_ù¾
 {

10 
__u8
 
	mza¦
;

11 
__u8
 
	mrsvd1
[4095];

14 
	snvme_zns_lbaf
 {

15 
__Ë64
 
	mzsze
;

16 
__u8
 
	mzdes
;

17 
__u8
 
	m»sv
[7];

20 
	snvme_id_zns_ns
 {

21 
__u16
 
	mzoc
;

22 
__u16
 
	mozcs
;

24 
__Ë32
 
	mm¬
;

25 
__Ë32
 
	mmÜ
;

26 
__Ë32
 
	m¼l
;

27 
__Ë32
 
	mäl
;

28 
__Ë32
 
	mrsv1
[6];

29 
__Ë32
 
	mnumzrwa
;

30 
__Ë16
 
	mzrwafg
;

31 
__Ë16
 
	mzrwasz
;

32 
__u8
 
	mzrwaÿp
;

33 
__u8
 
	mrsv2
[2763];

34 
nvme_zns_lbaf
 
	mlbaf
[16];

35 
__u8
 
	mrsv3
[768];

36 
__u8
 
	mvs
[256];

40 
	mNVME_SC_ZNS_INVALID_ZONE_OPERATION
 = ((
NVME_SCT_CMD_SPECIFIC_STATUS
 << 8) | 0xB6),

41 
	mNVME_SC_ZNS_ZRWA_RSRC_UNAVAIL
,

42 
	mNVME_SC_ZNS_ERR_BOUNDARY
,

43 
	mNVME_SC_ZNS_ERR_FULL
,

44 
	mNVME_SC_ZNS_ERR_READ_ONLY
,

45 
	mNVME_SC_ZNS_ERR_OFFLINE
,

46 
	mNVME_SC_ZNS_INVALID_WRITE
,

47 
	mNVME_SC_ZNS_NO_ACTIVE_ZONE
,

48 
	mNVME_SC_ZNS_NO_OPEN_ZONE
,

49 
	mNVME_SC_ZNS_INVALID_TRANSITION


53 
	mOZCS_READ_ACROSS_ZONE
 = (1 << 0),

54 
	mOZCS_ZRWA
 = (1 << 1),

58 
	mZRWACAP_EXPFLUSHSUP
 = (1 << 0),

61 ’um { 
	mZONE_TYPE_SEQ_WRITE_REQUIRED
 = 0x2 };

63 
	ezÚe_¡©e
 {

64 
	mZONE_STATE_EMPTY
 = 0x1,

65 
	mZONE_STATE_OPENED_IMPL
 = 0x2,

66 
	mZONE_STATE_OPENED_EXPL
 = 0x3,

67 
	mZONE_STATE_CLOSED
 = 0x4,

68 
	mZONE_STATE_READ_ONLY
 = 0xD,

69 
	mZONE_STATE_FULL
 = 0xE,

70 
	mZONE_STATE_OFFLINE
 = 0xF

73 
	ezÚe_»sourû_ty³
 { 
	mACTIVE_ZONE
, 
	mOPEN_ZONE
, 
	mZRWA_ZONE
, 
	mRES_TYPE_COUNT
 };

75 
	szÚe_desütÜ
 {

76 
__u8
 
	mty³
 : 4;

77 
	m__u8
 : 4;

78 
	m__u8
 : 4;

79 
__u8
 
	m¡©e
 : 4;

82 
__u8
 
	mza
;

85 
__u8
 
	mzfc
 : 1;

86 
__u8
 
	mfzr
 : 1;

87 
__u8
 
	mrzr
 : 1;

88 
__u8
 
	mzrwav
 : 1;

89 
	m__u8
 : 3;

90 
__u8
 
	mzdef
 : 1;

95 
__u8
 
	mzai
;

97 
__u8
 
	mfz¹l
 : 2;

98 
__u8
 
	mrz¹l
 : 2;

99 
	m__u8
 : 4;

103 
__u32
 
	m»£rved
;

104 
__u64
 
	mzÚe_ÿ·c™y
;

105 
__u64
 
	mz¦ba
;

106 
__u64
 
	mwp
;

108 
__u32
 
	mrsvd
[8];

111 
	szÚe_»pÜt
 {

112 
__u64
 
	mÄ_zÚes
;

113 
__u64
 
	mrsvd
[7];

116 
zÚe_desütÜ
 
	mzd
[1];

120 
	snvme_zÚe_mgmt_»cv
 {

121 
__u8
 
	mÝcode
;

122 
__u8
 
	mæags
;

123 
__u16
 
	mcommªd_id
;

124 
__Ë32
 
	mnsid
;

125 
__Ë32
 
	mcdw2
[2];

126 
__Ë64
 
	mm‘ad©a
;

127 
__Ë64
 
	m´p1
;

128 
__Ë64
 
	m´p2
;

129 
__Ë64
 
	m¦ba
;

130 
__Ë32
 
	mÄ_dw
;

133 
__Ë32
 
	mDW13
;

135 
__u8
 
	mz¿
;

136 
__u8
 
	mz¿_¥ecific_f›ld
;

137 
__u16
 
	mz¿_¥ecific_ã©u»s
 : 1;

138 
__u16
 
	m»£rved
 : 15;

142 
__Ë32
 
	mrsvd
[3];

145 
	ezÚe_£nd_aùiÚ
 {

146 
	mZSA_CLOSE_ZONE
 = 0x1,

147 
	mZSA_FINISH_ZONE
,

148 
	mZSA_OPEN_ZONE
,

149 
	mZSA_RESET_ZONE
,

150 
	mZSA_OFFLINE_ZONE
,

151 
	mZSA_SET_ZONE_DESC_EXT
 = 0x10,

152 
	mZSA_FLUSH_EXPL_ZRWA
 = 0x11,

156 
	snvme_zÚe_mgmt_£nd
 {

157 
__u8
 
	mÝcode
;

158 
__u8
 
	mæags
;

159 
__u16
 
	mcommªd_id
;

160 
__Ë32
 
	mnsid
;

161 
__Ë32
 
	mcdw2
[2];

162 
__Ë64
 
	mm‘ad©a
;

163 
__Ë64
 
	m´p1
;

164 
__Ë64
 
	m´p2
;

165 
__Ë64
 
	m¦ba
;

166 
__Ë32
 
	m»£rved
;

169 
__Ë32
 
	mDW13
;

171 
__u32
 
	mz§
 : 8;

175 
__u32
 
	m£Ëù_®l
 : 1;

176 
__u32
 
	mz§so
 : 1;

177 
	m__u32
 : 22;

181 
__Ë32
 
	mrsvd
[3];

184 
	snvme_zÚe_­³nd
 {

185 
__u8
 
	mÝcode
;

186 
__u8
 
	mæags
;

187 
__u16
 
	mcommªd_id
;

188 
__Ë32
 
	mnsid
;

189 
__Ë32
 
	mcdw2
[2];

190 
__Ë64
 
	mm‘ad©a
;

191 
__Ë64
 
	m´p1
;

192 
__Ë64
 
	m´p2
;

193 
__Ë64
 
	m¦ba
;

195 
__Ë32
 
	mDW12
;

197 
__Ë32
 
	mÄ_lba
 : 16;

198 
	m__Ë32
 : 4;

199 
__Ë32
 
	mdty³
 : 4;

200 
__Ë32
 
	m¡c
 : 1;

201 
__Ë32
 
	mpœem­
 : 1;

202 
__Ë32
 
	m´štfo
 : 4;

203 
__Ë32
 
	mfua
 : 1;

204 
__Ë32
 
	mÌ
 : 1;

209 
__Ë32
 
	mDW13
;

211 
	m__Ë32
 : 16;

212 
__Ë32
 
	md¥ec
 : 16;

216 
__Ë32
 
	mDW14
;

219 
__Ë32
 
	mDW15
;

221 
__Ë32
 
	mlb©
 : 16;

222 
__Ë32
 
	mlb©m
 : 16;

	@nvmev.h

3 #iâdeà
_LIB_NVMEV_H


4 
	#_LIB_NVMEV_H


	)

6 
	~<lšux/pci.h
>

7 
	~<lšux/msi.h
>

8 
	~<asm/­ic.h
>

10 
	~"nvme.h
"

12 
	#CONFIG_NVMEV_IO_WORKER_BY_SQ


	)

13 #undeà
CONFIG_NVMEV_FAST_X86_IRQ_HANDLING


15 #undeà
CONFIG_NVMEV_VERBOSE


16 #undeà
CONFIG_NVMEV_DEBUG


17 #undeà
CONFIG_NVMEV_DEBUG_VERBOSE


20 
	#NVMEV_DRV_NAME
 "NVMeVœt"

	)

21 
	#NVMEV_VERSION
 0x0110

	)

22 
	#NVMEV_DEVICE_ID
 
NVMEV_VERSION


	)

23 
	#NVMEV_VENDOR_ID
 0x0c51

	)

24 
	#NVMEV_SUBSYSTEM_ID
 0x370d

	)

25 
	#NVMEV_SUBSYSTEM_VENDOR_ID
 
NVMEV_VENDOR_ID


	)

27 
	#NVMEV_INFO
(
¡ršg
, 
¬gs
...è
	`´štk
(
KERN_INFO
 "%s: " sŒšg, 
NVMEV_DRV_NAME
, ##¬gs)

	)

28 
	#NVMEV_ERROR
(
¡ršg
, 
¬gs
...è
	`´štk
(
KERN_ERR
 "%s: " sŒšg, 
NVMEV_DRV_NAME
, ##¬gs)

	)

29 
	#NVMEV_ASSERT
(
x
è
	`BUG_ON
((!(x)))

	)

31 #ifdeà
CONFIG_NVMEV_DEBUG


32 
	#NVMEV_DEBUG
(
¡ršg
, 
¬gs
...è
	`´štk
(
KERN_INFO
 "%s: " sŒšg, 
NVMEV_DRV_NAME
, ##¬gs)

	)

33 #ifdeà
CONFIG_NVMEV_DEBUG_VERBOSE


34 
	#NVMEV_DEBUG_VERBOSE
(
¡ršg
, 
¬gs
...è
	`´štk
(
KERN_INFO
 "%s: " sŒšg, 
NVMEV_DRV_NAME
, ##¬gs)

	)

36 
	#NVMEV_DEBUG_VERBOSE
(
¡ršg
, 
¬gs
...)

	)

39 
	#NVMEV_DEBUG
(
¡ršg
, 
¬gs
...)

	)

40 
	#NVMEV_DEBUG_VERBOSE
(
¡ršg
, 
¬gs
...)

	)

43 
	#NR_MAX_IO_QUEUE
 72

	)

44 
	#NR_MAX_PARALLEL_IO
 16384

	)

46 
	#NVMEV_INTX_IRQ
 15

	)

48 
	#PAGE_OFFSET_MASK
 (
PAGE_SIZE
 - 1)

	)

49 
	#PRP_PFN
(
x
è(()((xè>> 
PAGE_SHIFT
))

	)

51 
	#KB
(
k
è((kè<< 10)

	)

52 
	#MB
(
m
è((mè<< 20)

	)

53 
	#GB
(
g
è((gè<< 30)

	)

55 
	#BYTE_TO_KB
(
b
è((bè>> 10)

	)

56 
	#BYTE_TO_MB
(
b
è((bè>> 20)

	)

57 
	#BYTE_TO_GB
(
b
è((bè>> 30)

	)

59 
	#MS_PER_SEC
(
s
è((s)*1000)

	)

60 
	#US_PER_SEC
(
s
è(
	`MS_PER_SEC
(sè* 1000)

	)

61 
	#NS_PER_SEC
(
s
è(
	`US_PER_SEC
(sè* 1000)

	)

63 
	#LBA_TO_BYTE
(
lba
è(Öbaè<< 9)

	)

64 
	#BYTE_TO_LBA
(
by‹
è((by‹è>> 9)

	)

66 
	#BITMASK32_ALL
 (0xFFFFFFFF)

	)

67 
	#BITMASK64_ALL
 (0xFFFFFFFFFFFFFFFF)

	)

68 
	#ASSERT
(
X
)

	)

70 
	~"ssd_cÚfig.h
"

72 
	snvmev_sq_¡©
 {

73 
	mÄ_di¥©ched
;

74 
	mÄ_di¥©ch
;

75 
	mÄ_š_æight
;

76 
	mmax_Ä_š_æight
;

77 
	mtÙ®_io
;

80 
	snvmev_submissiÚ_queue
 {

81 
	mqid
;

82 
	mcqid
;

83 
	m´iÜ™y
;

84 
boÞ
 
	mphys_cÚtig
;

86 
	mqueue_size
;

88 
nvmev_sq_¡©
 
	m¡©
;

90 
nvme_commªd
 
__iomem
 **
	msq
;

93 
	snvmev_com¶‘iÚ_queue
 {

94 
	mqid
;

95 
	mœq_veùÜ
;

96 
boÞ
 
	mœq_’abËd
;

97 
boÞ
 
	mš‹¼u±_»ady
;

98 
boÞ
 
	mphys_cÚtig
;

100 
¥šlock_t
 
	m’Œy_lock
;

101 
¥šlock_t
 
	mœq_lock
;

103 
	mqueue_size
;

105 
	mpha£
;

106 
	mcq_h—d
;

107 
	mcq_ž
;

109 
nvme_com¶‘iÚ
 
__iomem
 **
	mcq
;

112 
	snvmev_admš_queue
 {

113 
	mpha£
;

115 
	msq_d•th
;

116 
	mcq_d•th
;

118 
	mcq_h—d
;

120 
nvme_commªd
 
__iomem
 **
	mnvme_sq
;

121 
nvme_com¶‘iÚ
 
__iomem
 **
	mnvme_cq
;

124 
	#NR_SQE_PER_PAGE
 (
PAGE_SIZE
 / (
nvme_commªd
))

	)

125 
	#NR_CQE_PER_PAGE
 (
PAGE_SIZE
 / (
nvme_com¶‘iÚ
))

	)

127 
	#SQ_ENTRY_TO_PAGE_NUM
(
’Œy_id
èÓÁry_id / 
NR_SQE_PER_PAGE
)

	)

128 
	#CQ_ENTRY_TO_PAGE_NUM
(
’Œy_id
èÓÁry_id / 
NR_CQE_PER_PAGE
)

	)

130 
	#SQ_ENTRY_TO_PAGE_OFFSET
(
’Œy_id
èÓÁry_id % 
NR_SQE_PER_PAGE
)

	)

131 
	#CQ_ENTRY_TO_PAGE_OFFSET
(
’Œy_id
èÓÁry_id % 
NR_CQE_PER_PAGE
)

	)

133 
	snvmev_cÚfig
 {

134 
	mmemm­_¡¬t
;

135 
	mmemm­_size
;

137 
	m¡Üage_¡¬t
;

138 
	m¡Üage_size
;

140 
	mýu_Ä_di¥©ch”
;

141 
	mÄ_io_wÜk”s
;

142 
	mýu_Ä_io_wÜk”s
[32];

145 
	mÄ_io_un™s
;

146 
	mio_un™_shiá
;

148 
	m»ad_d–ay
;

149 
	m»ad_time
;

150 
	m»ad_Œažšg
;

151 
	mwr™e_d–ay
;

152 
	mwr™e_time
;

153 
	mwr™e_Œažšg
;

155 
ušt64_t
 
	mšput_lba
;

156 
ušt64_t
 
	mlba_Ën
;

158 
ušt64_t
 
	mcouÁ
;

159 
ušt64_t
 
	mch_d›_couÁ”
;

160 
ušt64_t
 
	mch_d›_Ï‹ncy
;

161 
boÞ
 
	mcheckpošt
;

162 
boÞ
 * 
	mfœ¡_io
;

163 
ušt64_t
 
	mcu¼’t_þock
;

164 
boÞ
 
	mcheckšg
;

167 
	snvmev_io_wÜk
 {

168 
	msqid
;

169 
	mcqid
;

171 
	msq_’Œy
;

172 
	mcommªd_id
;

174 
	mn£cs_¡¬t
;

175 
	mn£cs_rg‘
;

177 
	mn£cs_’queue
;

178 
	mn£cs_cÝy_¡¬t
;

179 
	mn£cs_cÝy_dÚe
;

180 
	mn£cs_cq_fžËd
;

182 
boÞ
 
	mis_cÝ›d
;

183 
boÞ
 
	mis_com¶‘ed
;

185 
	m¡©us
;

186 
	m»suÉ0
;

187 
	m»suÉ1
;

189 
boÞ
 
	mis_š‹º®
;

190 *
	mwr™e_bufãr
;

191 
size_t
 
	mbuffs_to_»Ëa£
;

193 
	mÃxt
, 
	m´ev
;

196 
	snvmev_io_wÜk”
 {

197 
nvmev_dev
 *
	m·»Á_dev
;

198 
nvmev_io_wÜk
 *
	mwÜk_queue
;

200 
	mä“_£q
;

201 
	mä“_£q_’d
;

202 
	mio_£q
;

203 
	mio_£q_’d
;

205 
	mÏ‹¡_n£cs
;

207 
	mid
;

208 
sk_¡ruù
 *
	msk_¡ruù
;

209 
	mth»ad_Çme
[32];

212 
	snvmev_dev
 {

213 
pci_bus
 *
	mvœt_bus
;

214 *
	mvœtDev
;

215 
pci_h—d”
 *
	mpcihdr
;

216 
pci_pm_ÿp
 *
	mpmÿp
;

217 
pci_msix_ÿp
 *
	mmsixÿp
;

218 
pc›_ÿp
 *
	mpc›ÿp
;

219 
pci_ext_ÿp
 *
	mextÿp
;

221 
pci_dev
 *
	mpdev
;

222 
pci_sysd©a
 
	mpci_sysd©a
;

224 
nvmev_cÚfig
 
	mcÚfig
;

225 
sk_¡ruù
 *
	mnvmev_di¥©ch”
;

227 *
	m¡Üage_m­³d
;

229 
nvmev_io_wÜk”
 *
	mio_wÜk”s
;

230 
	mio_wÜk”_tuº
;

232 
__iomem
 *
	mmsix_bË
;

234 
boÞ
 
	mštx_di§bËd
;

236 
__nvme_b¬
 *
	mÞd_b¬
;

237 
nvme_ù¾_»gs
 
__iomem
 *
	mb¬
;

239 
u32
 *
	mÞd_dbs
;

240 
u32
 
__iomem
 *
	mdbs
;

242 
nvmev_ns
 *
	mns
;

243 
	mÄ_ns
;

244 
	mÄ_sq
;

245 
	mÄ_cq
;

247 
nvmev_admš_queue
 *
	madmš_q
;

248 
nvmev_submissiÚ_queue
 *
	msqes
[
NR_MAX_IO_QUEUE
 + 1];

249 
nvmev_com¶‘iÚ_queue
 *
	mcqes
[
NR_MAX_IO_QUEUE
 + 1];

251 
	mmdts
;

253 
d’Œy
 *
	mdebug_roÙ
;

254 
d’Œy
 *
	mdebug_»ad_times
;

255 
d’Œy
 *
	mdebug_wr™e_times
;

256 
d’Œy
 *
	mdebug_io_un™s
;

257 
d’Œy
 *
	mdebug_¡©
;

259 
kobjeù
 *
	msysfs_roÙ
;

260 
kobj_©Œibu‹
 *
	msysfs_»ad_times
;

261 
kobj_©Œibu‹
 *
	msysfs_wr™e_times
;

262 
kobj_©Œibu‹
 *
	msysfs_io_un™s
;

263 
kobj_©Œibu‹
 *
	msysfs_¡©
;

264 
kobj_©Œibu‹
 *
	msysfs_debug
;

265 
kobj_©Œibu‹
 *
	msysfs_phäag
;

266 
kobj_©Œibu‹
 *
	msysfs_chd›
;

268 *
	mio_un™_¡©
;

270 
li¡_h—d
 
	mli¡_–em
;

271 
	mdev_Çme
[30];

273 
	mdev_id
;

275 
	mmajÜ
;

277 
	mál
;

279 
	mdeg»e_äag
;

280 
	mmax_cÚ
;

281 
	mnum_li¡
;

284 
	snvmev_»que¡
 {

285 
nvme_commªd
 *
	mcmd
;

286 
ušt32_t
 
	msq_id
;

287 
ušt64_t
 
	mn£cs_¡¬t
;

290 
	snvmev_»suÉ
 {

291 
ušt32_t
 
	m¡©us
;

292 
ušt64_t
 
	mn£cs_rg‘
;

295 
	snvmev_ns
 {

296 
ušt32_t
 
	mid
;

297 
ušt32_t
 
	mcsi
;

298 
ušt64_t
 
	msize
;

299 *
	mm­³d
;

301 
nvmev_dev
 *
	mp_dev
;

304 
ušt32_t
 
	mÄ_·¹s
;

305 *
	máls
;

308 
boÞ
 (*
´oc_io_cmd
)(
nvmev_ns
 *
	mns
, 
nvmev_»que¡
 *
	m»q
,

309 
nvmev_»suÉ
 *
	m»t
, 
nvmev_dev
 *
	mnvmev_vdev
);

312 
boÞ
 (*
id’tify_io_cmd
)(
nvmev_ns
 *
	mns
, 
nvme_commªd
 
	mcmd
);

314 (*
	m³rfÜm_io_cmd
)(
nvmev_ns
 *
	mns
, 
nvme_commªd
 *
	mcmd
,

315 
ušt32_t
 *
	m¡©us
);

318 
	snvmev
 {

319 
li¡_h—d
 
	mdev_li¡
;

320 
	mÄ_dev
;

322 
kobjeù
 *
	mcÚfig_roÙ
;

323 
kobj_©Œibu‹
 *
	mcÚfig_©Œ
;

326 
	s·¿ms
 {

327 
	mmemm­_¡¬t
;

328 
	mmemm­_size
;

330 
	m»ad_time
;

331 
	m»ad_d–ay
;

332 
	m»ad_Œažšg
;

334 
	mwr™e_time
;

335 
	mwr™e_d–ay
;

336 
	mwr™e_Œažšg
;

338 
	mÄ_io_un™s
;

339 
	mio_un™_shiá
;

341 *
	mýus
;

342 *
	mÇme
;

343 *
	m·th
;

344 
	mdebug
;

346 
	mál
;

348 
	mdeg»e_äag
;

349 
	mnum_chunk
;

350 
	mmax_cÚ
;

354 
nvmev
 *nvmev;

355 
nvmev_dev
 *
VDEV_INIT
();

356 
VDEV_FINALIZE
(
nvmev_dev
 *
nvmev_vdev
);

359 
nvmev_´oc_b¬s
(
nvmev_dev
 *
nvmev_vdev
);

360 
boÞ
 
NVMEV_PCI_INIT
(
nvmev_dev
 *
dev
);

361 
nvmev_sigÇl_œq
(
nvmev_dev
 *
nvmev_vdev
, 
msi_šdex
);

364 
nvmev_´oc_admš_sq
(
Ãw_db
, 
Þd_db
, 
nvmev_dev
 *
nvmev_vdev
);

365 
nvmev_´oc_admš_cq
(
Ãw_db
, 
Þd_db
);

368 
NVMEV_IO_WORKER_INIT
(
nvmev_dev
 *
nvmev_vdev
);

369 
NVMEV_IO_WORKER_FINAL
(
nvmev_dev
 *
nvmev_vdev
);

370 
nvmev_´oc_io_sq
(
qid
, 
Ãw_db
, 
Þd_db
, 
nvmev_dev
 *
nvmev_vdev
);

371 
nvmev_´oc_io_cq
(
qid
, 
Ãw_db
, 
Þd_db
, 
nvmev_dev
 *
nvmev_vdev
);

	@nvmev.mod.c

1 
	~<lšux/moduË.h
>

2 
	#INCLUDE_VERMAGIC


	)

3 
	~<lšux/bužd-§É.h
>

4 
	~<lšux/–âÙe-Éo.h
>

5 
	~<lšux/v”magic.h
>

6 
	~<lšux/compž”.h
>

8 
	gBUILD_SALT
;

9 
	gBUILD_LTO_INFO
;

11 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

12 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

14 
__visibË
 
moduË
 
__this_moduË


15 
__£ùiÚ
(".gnu.linkonce.this_module") = {

16 .
Çme
 = 
KBUILD_MODNAME
,

17 .
	gš™
 = 
š™_moduË
,

18 #ifdeà
CONFIG_MODULE_UNLOAD


19 .
	gex™
 = 
þ—nup_moduË
,

21 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

24 #ifdeà
CONFIG_RETPOLINE


25 
MODULE_INFO
(
»Þše
, "Y");

28 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

29 
__u£d
 
__£ùiÚ
("__versions") = {

120 
MODULE_INFO
(
d•’ds
, "");

	@pci.c

3 
	~<lšux/pci.h
>

4 
	~<lšux/œq.h
>

5 
	~<lšux/v”siÚ.h
>

7 
	~<lšux/³rýu-defs.h
>

8 
	~<lšux/sched/þock.h
>

10 
	~"nvmev.h
"

11 
	~"pci.h
"

13 
	gpci_id_make
 = 0;

14 #ifdeà
CONFIG_NVMEV_FAST_X86_IRQ_HANDLING


15 
	g­icid_to_ýuid
[256];

17 
	$__š™_­icid_to_ýuid
()

19 
i
;

20 
	`fÜ_—ch_possibË_ýu
(
i
) {

21 
­icid_to_ýuid
[
	`³r_ýu
(
x86_ýu_to_­icid
, 
i
)] = i;

23 
	}
}

25 
	$__sigÇl_œq
(cÚ¡ *
ty³
, 
œq
)

27 
œq_d©a
 *
œqd
 = 
	`œq_g‘_œq_d©a
(
œq
);

28 
œq_cfg
 *
œqc
 = 
	`œqd_cfg
(
œqd
);

30 
rg‘
 = 
œqc
->
de¡_­icid
;

31 
rg‘_ýu
 = 
­icid_to_ýuid
[
rg‘
];

33 
	`NVMEV_DEBUG_VERBOSE
("œq: % %d, veùÜ %d,‡piø%d, cpu %d\n", 
ty³
, 
œq
, 
œqc
->
veùÜ
,

34 
rg‘
, 
rg‘_ýu
);

35 
­ic
->
	`£nd_IPI
(
rg‘_ýu
, 
œqc
->
veùÜ
);

38 
	}
}

40 
	$__sigÇl_œq
(cÚ¡ *
ty³
, 
œq
)

42 
œq_d©a
 *
d©a
 = 
	`œq_g‘_œq_d©a
(
œq
);

43 
œq_ch
 *
ch
 = 
	`œq_d©a_g‘_œq_ch
(
d©a
);

45 
	`NVMEV_DEBUG_VERBOSE
("œq: % %d, veùÜ %d\n", 
ty³
, 
œq
, 
	`œqd_cfg
(
d©a
)->
veùÜ
);

46 
	`BUG_ON
(!
ch
->
œq_»Œigg”
);

47 
ch
->
	`œq_»Œigg”
(
d©a
);

50 
	}
}

53 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 17, 0)

54 
	$__´oûss_msi_œq
(
nvmev_dev
 *
nvmev_vdev
, 
msi_šdex
)

56 
vœq
 = 
	`msi_g‘_vœq
(&
nvmev_vdev
->
pdev
->
dev
, 
msi_šdex
);

57 
nvmev_dev
 
	`BUG_ON
(
vœq
 == 0);

58 
	`__sigÇl_œq
("msi", 
vœq
);

59 
	}
}

61 
	$__´oûss_msi_œq
(
nvmev_dev
 *
nvmev_vdev
, 
msi_šdex
)

63 
msi_desc
 *msi_desc, *
tmp
;

65 
	`fÜ_—ch_msi_’Œy_§ã
(
msi_desc
, 
tmp
, (&
nvmev_vdev
->
pdev
->
dev
)) {

66 ià(
msi_desc
->
msi_©Œib
.
’Œy_Ä
 =ð
msi_šdex
) {

67 
	`__sigÇl_œq
("msi", 
msi_desc
->
œq
);

71 
	`NVMEV_INFO
("Failedo send IPI\n");

72 
	`BUG_ON
(!
msi_desc
);

73 
	}
}

76 
	$nvmev_sigÇl_œq
(
nvmev_dev
 *
nvmev_vdev
, 
msi_šdex
)

78 ià(
nvmev_vdev
->
pdev
->
msix_’abËd
) {

79 
	`__´oûss_msi_œq
(
nvmev_vdev
, 
msi_šdex
);

81 
nvmev_vdev
->
pcihdr
->
¡s
.
is
 = 1;

83 
	`__sigÇl_œq
("št", 
nvmev_vdev
->
pdev
->
œq
);

85 
	}
}

99 
	$nvmev_´oc_b¬s
(
nvmev_dev
 *
nvmev_vdev
)

101 vÞ©ž
__nvme_b¬
 *
Þd_b¬
 = 
nvmev_vdev
->old_bar;

102 vÞ©ž
nvme_ù¾_»gs
 *
b¬
 = 
nvmev_vdev
->bar;

103 
nvmev_admš_queue
 *
queue
 = 
nvmev_vdev
->
admš_q
;

104 
num_·ges
, 
i
;

107 ià(
Þd_b¬
->
ÿp
 !ð
b¬
->
u_ÿp
) {

108 
	`memýy
(&
Þd_b¬
->
ÿp
, &
b¬
->cap, (old_bar->cap));

110 ià(
Þd_b¬
->
vs
 !ð
b¬
->
u_vs
) {

111 
	`memýy
(&
Þd_b¬
->
vs
, &
b¬
->vs, (old_bar->vs));

113 ià(
Þd_b¬
->
cmbloc
 !ð
b¬
->
u_cmbloc
) {

114 
	`memýy
(&
Þd_b¬
->
cmbloc
, &
b¬
->cmbloc, (old_bar->cmbloc));

116 ià(
Þd_b¬
->
cmbsz
 !ð
b¬
->
u_cmbsz
) {

117 
	`memýy
(&
Þd_b¬
->
cmbsz
, &
b¬
->cmbsz, (old_bar->cmbsz));

119 ià(
Þd_b¬
->
rsvd1
 !ð
b¬
->rsvd1) {

120 
	`memýy
(&
Þd_b¬
->
rsvd1
, &
b¬
->rsvd1, (old_bar->rsvd1));

122 ià(
Þd_b¬
->
c¡s
 !ð
b¬
->
u_c¡s
) {

123 
	`memýy
(&
Þd_b¬
->
c¡s
, &
b¬
->csts, (old_bar->csts));

127 ià(
Þd_b¬
->
štms
 !ð
b¬
->intms) {

128 
	`memýy
(&
Þd_b¬
->
štms
, &
b¬
->intms, (old_bar->intms));

130 ià(
Þd_b¬
->
štmc
 !ð
b¬
->intmc) {

131 
	`memýy
(&
Þd_b¬
->
štmc
, &
b¬
->intmc, (old_bar->intmc));

133 ià(
Þd_b¬
->
ns¤
 !ð
b¬
->nssr) {

134 
	`memýy
(&
Þd_b¬
->
ns¤
, &
b¬
->nssr, (old_bar->nssr));

137 ià(
Þd_b¬
->
aqa
 !ð
b¬
->
u_aqa
) {

139 
	`NVMEV_DEBUG
("%s:‡q¨0x%x -> 0x%x\n", 
__func__
, 
Þd_b¬
->
aqa
, 
b¬
->
u_aqa
);

140 
Þd_b¬
->
aqa
 = 
b¬
->
u_aqa
;

142 ià(!
queue
) {

143 
queue
 = 
	`kz®loc
((
nvmev_admš_queue
), 
GFP_KERNEL
);

144 
	`BUG_ON
(
queue
 =ð
NULL
);

145 
	`WRITE_ONCE
(
nvmev_vdev
->
admš_q
, 
queue
);

147 
queue
 = 
nvmev_vdev
->
admš_q
;

150 
queue
->
cq_h—d
 = 0;

151 
queue
->
pha£
 = 1;

152 
queue
->
sq_d•th
 = 
b¬
->
aqa
.
asqs
 + 1;

153 
queue
->
cq_d•th
 = 
b¬
->
aqa
.
acqs
 + 1;

155 
nvmev_vdev
->
dbs
[0] =‚vmev_vdev->
Þd_dbs
[0] = 0;

156 
nvmev_vdev
->
dbs
[1] =‚vmev_vdev->
Þd_dbs
[1] = 0;

158 
out
;

160 ià(
Þd_b¬
->
asq
 !ð
b¬
->
u_asq
) {

161 ià(
queue
 =ð
NULL
) {

170 
	`NVMEV_INFO
("asqriggered before‡qa,„etrying\n");

171 
out
;

174 
	`NVMEV_DEBUG
("%s:‡sq 0x%Îx -> 0x%Îx\n", 
__func__
, 
Þd_b¬
->
asq
, 
b¬
->
u_asq
);

175 
Þd_b¬
->
asq
 = 
b¬
->
u_asq
;

177 ià(
queue
->
nvme_sq
) {

178 
	`kä“
(
queue
->
nvme_sq
);

179 
queue
->
nvme_sq
 = 
NULL
;

182 
queue
->
sq_d•th
 = 
b¬
->
aqa
.
asqs
 + 1;

184 
num_·ges
 = 
	`DIV_ROUND_UP
(
queue
->
sq_d•th
 * (
nvme_commªd
), 
PAGE_SIZE
);

185 
queue
->
nvme_sq
 = 
	`kÿÎoc
(
num_·ges
, (
nvme_commªd
 *), 
GFP_KERNEL
);

186 
	`BUG_ON
(!
queue
->
nvme_sq
 && "Error on setup‡dmin submission queue");

188 
i
 = 0; i < 
num_·ges
; i++) {

189 
queue
->
nvme_sq
[
i
] =

190 
	`·ge_add»ss
(
	`pâ_to_·ge
(
nvmev_vdev
->
b¬
->
u_asq
 >> 
PAGE_SHIFT
è+ 
i
);

193 
nvmev_vdev
->
dbs
[0] =‚vmev_vdev->
Þd_dbs
[0] = 0;

195 
out
;

197 ià(
Þd_b¬
->
acq
 !ð
b¬
->
u_acq
) {

198 ià(
queue
 =ð
NULL
) {

200 
	`NVMEV_INFO
("acqriggered before‡qa,„etrying\n");

201 
out
;

204 
	`NVMEV_DEBUG
("%s:‡cq 0x%Îx -> 0x%Îx\n", 
__func__
, 
Þd_b¬
->
acq
, 
b¬
->
u_acq
);

205 
Þd_b¬
->
acq
 = 
b¬
->
u_acq
;

207 ià(
queue
->
nvme_cq
) {

208 
	`kä“
(
queue
->
nvme_cq
);

209 
queue
->
nvme_cq
 = 
NULL
;

212 
queue
->
cq_d•th
 = 
b¬
->
aqa
.
acqs
 + 1;

214 
num_·ges
 =

215 
	`DIV_ROUND_UP
(
queue
->
cq_d•th
 * (
nvme_com¶‘iÚ
), 
PAGE_SIZE
);

216 
queue
->
nvme_cq
 = 
	`kÿÎoc
(
num_·ges
, (
nvme_com¶‘iÚ
 *), 
GFP_KERNEL
);

217 
	`BUG_ON
(!
queue
->
nvme_cq
 && "Error on setup‡dmin completion queue");

218 
queue
->
cq_h—d
 = 0;

220 
i
 = 0; i < 
num_·ges
; i++) {

221 
queue
->
nvme_cq
[
i
] =

222 
	`·ge_add»ss
(
	`pâ_to_·ge
(
nvmev_vdev
->
b¬
->
u_acq
 >> 
PAGE_SHIFT
è+ 
i
);

225 
nvmev_vdev
->
dbs
[1] =‚vmev_vdev->
Þd_dbs
[1] = 0;

227 
out
;

229 ià(
Þd_b¬
->
cc
 !ð
b¬
->
u_cc
) {

230 
	`NVMEV_DEBUG
("%s: cø0x%x:%x -> 0x%x:%x\n", 
__func__
, 
Þd_b¬
->
cc
, old_b¬->
c¡s
,

231 
b¬
->
u_cc
, b¬->
u_c¡s
);

233 ià(
b¬
->
cc
.
’
 == 1) {

234 ià(
nvmev_vdev
->
admš_q
) {

235 
b¬
->
c¡s
.
rdy
 = 1;

237 
	`WARN_ON
("Enable device without init‡dmin q");

239 } ià(
b¬
->
cc
.
’
 == 0) {

240 
b¬
->
c¡s
.
rdy
 = 0;

244 ià(
b¬
->
cc
.
shn
 == 1) {

245 
b¬
->
c¡s
.
sh¡
 = 2;

247 
nvmev_vdev
->
dbs
[0] =‚vmev_vdev->
Þd_dbs
[0] = 0;

248 
nvmev_vdev
->
dbs
[1] =‚vmev_vdev->
Þd_dbs
[1] = 0;

249 
nvmev_vdev
->
admš_q
->
cq_h—d
 = 0;

252 
Þd_b¬
->
cc
 = 
b¬
->
u_cc
;

254 
out
;

256 
out
:

257 
	`smp_mb
();

259 
	}
}

260 
nvmev_dev
 *
	$fšd_nvmev
(
pci_bus
 *
bus
)

262 
nvmev_dev
 *
d©a
, *
Ãxt
;

263 
nvmev_dev
 *
fœ¡_NULL
 = 
NULL
;

264 
	`li¡_fÜ_—ch_’Œy_§ã
(
d©a
, 
Ãxt
, &
nvmev
->
dev_li¡
, 
li¡_–em
) {

265 ià(
fœ¡_NULL
 =ð
NULL
) {

266 ià(
d©a
->
vœt_bus
 =ð
NULL
) {

267 
fœ¡_NULL
 = 
d©a
;

270 ià(
d©a
->
vœt_bus
 =ð
bus
)

271  
d©a
;

273  
fœ¡_NULL
;

274 
	}
}

275 
	$nvmev_pci_»ad
(
pci_bus
 *
bus
, 
devâ
, 
wh”e
, 
size
, 
u32
 *
v®
)

277 
nvmev_dev
 *
nvmev_vdev
;

278 ià(
devâ
 != 0)

281 
nvmev_vdev
 = 
	`fšd_nvmev
(
bus
);

282 
	`memýy
(
v®
, 
nvmev_vdev
->
vœtDev
 + 
wh”e
, 
size
);

283 
	`NVMEV_DEBUG_VERBOSE
("[R] 0x%x, size: %d, v®: 0x%x\n", 
wh”e
, 
size
, *
v®
);

286 
	}
};

288 
	$nvmev_pci_wr™e
(
pci_bus
 *
bus
, 
devâ
, 
wh”e
, 
size
, 
u32
 
_v®
)

290 
u32
 
mask
 = ~(0U);

291 
u32
 
v®
 = 0x00;

292 
rg‘
 = 
wh”e
;

294 
nvmev_dev
 *
nvmev_vdev
 = 
	`fšd_nvmev
(
bus
);

295 
	`WARN_ON
(
size
 > (
_v®
));

296 
	`memýy
(&
v®
, 
nvmev_vdev
->
vœtDev
 + 
wh”e
, 
size
);

297 ià(
wh”e
 < 
OFFS_PCI_PM_CAP
) {

299 ià(
rg‘
 =ð
PCI_COMMAND
) {

300 
mask
 = 
PCI_COMMAND_INTX_DISABLE
;

301 ià((
v®
 ^ 
_v®
è& 
PCI_COMMAND_INTX_DISABLE
) {

302 
nvmev_vdev
->
štx_di§bËd
 = !!(
_v®
 & 
PCI_COMMAND_INTX_DISABLE
);

303 ià(!
nvmev_vdev
->
štx_di§bËd
) {

304 
nvmev_vdev
->
pcihdr
->
¡s
.
is
 = 0;

307 } ià(
rg‘
 =ð
PCI_STATUS
) {

308 
mask
 = 0xF200;

309 } ià(
rg‘
 =ð
PCI_BIST
) {

310 
mask
 = 
PCI_BIST_START
;

311 } ià(
rg‘
 =ð
PCI_BASE_ADDRESS_0
) {

312 
mask
 = 0xFFFFC000;

313 } ià(
rg‘
 =ð
PCI_INTERRUPT_LINE
) {

314 
mask
 = 0xFF;

316 
mask
 = 0x0;

318 } ià(
wh”e
 < 
OFFS_PCI_MSIX_CAP
) {

320 } ià(
wh”e
 < 
OFFS_PCIE_CAP
) {

322 
rg‘
 -ð
OFFS_PCI_MSIX_CAP
;

323 ià(
rg‘
 =ð
PCI_MSIX_FLAGS
) {

324 
mask
 = 
PCI_MSIX_FLAGS_MASKALL
 |

325 
PCI_MSIX_FLAGS_ENABLE
;

327 ià((
nvmev_vdev
->
pdev
è&& ((
v®
 ^ 
_v®
è& 
PCI_MSIX_FLAGS_ENABLE
)) {

328 
nvmev_vdev
->
pdev
->
msix_’abËd
 = !!(
_v®
 & 
PCI_MSIX_FLAGS_ENABLE
);

331 
mask
 = 0x0;

333 } ià(
wh”e
 < 
OFFS_PCI_EXT_CAP
) {

338 
	`NVMEV_DEBUG_VERBOSE
("[W] 0x%x, mask: 0x%x, v®: 0x%x -> 0x%x, size: %d,‚ew: 0x%x\n", 
wh”e
,

339 
mask
, 
v®
, 
_v®
, 
size
, (val & (~mask)) | (_val & mask));

341 
v®
 = (v® & (~
mask
)è| (
_v®
 & mask);

342 
	`memýy
(
nvmev_vdev
->
vœtDev
 + 
wh”e
, &
v®
, 
size
);

344 
	}
};

346 
pci_Ýs
 
	gnvmev_pci_Ýs
 = {

347 .
»ad
 = 
nvmev_pci_»ad
,

348 .
	gwr™e
 = 
nvmev_pci_wr™e
,

351 
	$__dump_pci_dev
(
pci_dev
 *
dev
)

363 
	}
}

365 
	$__š™_nvme_ù¾_»gs
(
nvmev_dev
 *
ndev
, 
pci_dev
 *
dev
)

367 
nvme_ù¾_»gs
 *
b¬
 =

368 
	`mem»m­
(
	`pci_»sourû_¡¬t
(
dev
, 0), 
PAGE_SIZE
 * 2, 
MEMREMAP_WT
);

369 
	`BUG_ON
(!
b¬
);

371 
ndev
->
b¬
 = bar;

372 
	`mem£t
(
b¬
, 0x0, 
PAGE_SIZE
 * 2);

374 
ndev
->
dbs
 = ((*)
b¬
è+ 
PAGE_SIZE
;

376 *
b¬
 = (
nvme_ù¾_»gs
) {

377 .
ÿp
 = {

378 .
to
 = 1,

379 .
mpsmš
 = 0,

380 .
mqes
 = 1024 - 1,

381 #ià(
	`SUPPORTED_SSD_TYPE
(
ZNS
))

382 .
css
 = 
CAP_CSS_BIT_SPECIFIC
,

385 .
vs
 = {

386 .
mjr
 = 1,

387 .
mÄ
 = 0,

390 
	}
}

392 
pci_bus
 *
	$__ü—‹_pci_bus
(
nvmev_dev
 *
nvmev_vdev
)

394 
pci_bus
 *
bus
 = 
NULL
;

395 
pci_dev
 *
dev
;

397 
nvmev_vdev
->
pci_sysd©a
 = (pci_sysdata){

398 .
domaš
 = 
NVMEV_PCI_DOMAIN_NUM
 + 
pci_id_make
,

399 .
node
 = 
	`ýu_to_node
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
),

401 
bus
 = 
	`pci_sÿn_bus
(
NVMEV_PCI_BUS_NUM
 + 
pci_id_make
, &
nvmev_pci_Ýs
,

402 &
nvmev_vdev
->
pci_sysd©a
);

403 
pci_id_make
++;

404 ià(!
bus
) {

405 
	`NVMEV_ERROR
("Unableo create PCI bus\n");

406  
NULL
;

410 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
bus
->
deviûs
, 
bus_li¡
) {

411 
»sourû
 *
»s
 = &
dev
->resource[0];

412 
»s
->
·»Á
 = &
iomem_»sourû
;

414 
nvmev_vdev
->
pdev
 = 
dev
;

415 
dev
->
œq
 = 
nvmev_vdev
->
pcihdr
->
šŒ
.
žše
;

416 
	`__dump_pci_dev
(
dev
);

418 
	`__š™_nvme_ù¾_»gs
(
nvmev_vdev
, 
dev
);

420 
nvmev_vdev
->
Þd_dbs
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

421 
	`BUG_ON
(!
nvmev_vdev
->
Þd_dbs
 && "allocating old DBs memory");

422 
	`memýy
(
nvmev_vdev
->
Þd_dbs
,‚vmev_vdev->
dbs
, (*nvmev_vdev->old_dbs));

424 
nvmev_vdev
->
Þd_b¬
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

425 
	`BUG_ON
(!
nvmev_vdev
->
Þd_b¬
 && "allocating old BAR memory");

426 
	`memýy
(
nvmev_vdev
->
Þd_b¬
,‚vmev_vdev->
b¬
, (*nvmev_vdev->old_bar));

428 
nvmev_vdev
->
msix_bË
 =

429 
	`mem»m­
(
	`pci_»sourû_¡¬t
(
nvmev_vdev
->
pdev
, 0è+ 
PAGE_SIZE
 * 2,

430 
NR_MAX_IO_QUEUE
 * 
PCI_MSIX_ENTRY_SIZE
, 
MEMREMAP_WT
);

431 
	`mem£t
(
nvmev_vdev
->
msix_bË
, 0x00, 
NR_MAX_IO_QUEUE
 * 
PCI_MSIX_ENTRY_SIZE
);

434 
	`NVMEV_INFO
("Vœtu® PCI bu ü—‹d (nod%d)\n", 
nvmev_vdev
->
pci_sysd©a
.
node
);

436  
bus
;

437 
	}
};

439 
nvmev_dev
 *
	$VDEV_INIT
()

441 
nvmev_dev
 *
nvmev_vdev
;

442 
nvmev_vdev
 = 
	`kz®loc
((*nvmev_vdev), 
GFP_KERNEL
);

444 
nvmev_vdev
->
vœtDev
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

446 
nvmev_vdev
->
pcihdr
 =‚vmev_vdev->
vœtDev
 + 
OFFS_PCI_HDR
;

447 
nvmev_vdev
->
pmÿp
 =‚vmev_vdev->
vœtDev
 + 
OFFS_PCI_PM_CAP
;

448 
nvmev_vdev
->
msixÿp
 =‚vmev_vdev->
vœtDev
 + 
OFFS_PCI_MSIX_CAP
;

449 
nvmev_vdev
->
pc›ÿp
 =‚vmev_vdev->
vœtDev
 + 
OFFS_PCIE_CAP
;

450 
nvmev_vdev
->
extÿp
 =‚vmev_vdev->
vœtDev
 + 
OFFS_PCI_EXT_CAP
;

452 
nvmev_vdev
->
admš_q
 = 
NULL
;

454  
nvmev_vdev
;

455 
	}
}

457 
	$VDEV_FINALIZE
(
nvmev_dev
 *
nvmev_vdev
)

459 ià(
nvmev_vdev
->
msix_bË
)

460 
	`memunm­
(
nvmev_vdev
->
msix_bË
);

462 ià(
nvmev_vdev
->
b¬
)

463 
	`memunm­
(
nvmev_vdev
->
b¬
);

465 ià(
nvmev_vdev
->
Þd_b¬
)

466 
	`kä“
(
nvmev_vdev
->
Þd_b¬
);

468 ià(
nvmev_vdev
->
Þd_dbs
)

469 
	`kä“
(
nvmev_vdev
->
Þd_dbs
);

471 ià(
nvmev_vdev
->
admš_q
) {

472 ià(
nvmev_vdev
->
admš_q
->
nvme_cq
)

473 
	`kä“
(
nvmev_vdev
->
admš_q
->
nvme_cq
);

475 ià(
nvmev_vdev
->
admš_q
->
nvme_sq
)

476 
	`kä“
(
nvmev_vdev
->
admš_q
->
nvme_sq
);

478 
	`kä“
(
nvmev_vdev
->
admš_q
);

481 ià(
nvmev_vdev
->
vœtDev
)

482 
	`kä“
(
nvmev_vdev
->
vœtDev
);

484 ià(
nvmev_vdev
)

485 
	`kä“
(
nvmev_vdev
);

486 
	}
}

488 
	$PCI_HEADER_SETTINGS
(
pci_h—d”
 *
pcihdr
, 
ba£_·
)

490 
pcihdr
->
id
.
did
 = 
NVMEV_DEVICE_ID
;

491 
pcihdr
->
id
.
vid
 = 
NVMEV_VENDOR_ID
;

496 
pcihdr
->
cmd
.
m£
 = 1;

497 
pcihdr
->
¡s
.
þ
 = 1;

499 
pcihdr
->
hty³
.
mfd
 = 0;

500 
pcihdr
->
hty³
.
hl
 = 
PCI_HEADER_TYPE_NORMAL
;

502 
pcihdr
->
rid
 = 0x01;

504 
pcihdr
->
cc
.
bcc
 = 
PCI_BASE_CLASS_STORAGE
;

505 
pcihdr
->
cc
.
scc
 = 0x08;

506 
pcihdr
->
cc
.
pi
 = 0x02;

508 
pcihdr
->
mlb¬
.

 = 
PCI_BASE_ADDRESS_MEM_TYPE_64
 >> 1;

509 
pcihdr
->
mlb¬
.
ba
 = (
ba£_·
 & 0xFFFFFFFF) >> 14;

511 
pcihdr
->
mulb¬
 = 
ba£_·
 >> 32;

513 
pcihdr
->
ss
.
ssid
 = 
NVMEV_SUBSYSTEM_ID
;

514 
pcihdr
->
ss
.
ssvid
 = 
NVMEV_SUBSYSTEM_VENDOR_ID
;

516 
pcihdr
->
”om
 = 0x0;

518 
pcihdr
->
ÿp
 = 
OFFS_PCI_PM_CAP
;

520 
pcihdr
->
šŒ
.
š
 = 0;

521 
pcihdr
->
šŒ
.
žše
 = 
NVMEV_INTX_IRQ
;

522 
	}
}

524 
	$PCI_PMCAP_SETTINGS
(
pci_pm_ÿp
 *
pmÿp
)

526 
pmÿp
->
pid
.
cid
 = 
PCI_CAP_ID_PM
;

527 
pmÿp
->
pid
.
Ãxt
 = 
OFFS_PCI_MSIX_CAP
;

529 
pmÿp
->
pc
.
vs
 = 3;

530 
pmÿp
->
pmcs
.
nsä¡
 = 1;

531 
pmÿp
->
pmcs
.
ps
 = 
PCI_PM_CAP_PME_D0
 >> 16;

532 
	}
}

534 
	$PCI_MSIXCAP_SETTINGS
(
pci_msix_ÿp
 *
msixÿp
)

536 
msixÿp
->
mxid
.
cid
 = 
PCI_CAP_ID_MSIX
;

537 
msixÿp
->
mxid
.
Ãxt
 = 
OFFS_PCIE_CAP
;

539 
msixÿp
->
mxc
.
mxe
 = 1;

540 
msixÿp
->
mxc
.
ts
 = 127;

542 
msixÿp
->
mb
.
tbœ
 = 0;

543 
msixÿp
->
mb
.
to
 = 0x400;

545 
msixÿp
->
mpba
.
pbao
 = 0x1000;

546 
msixÿp
->
mpba
.
pbœ
 = 0;

547 
	}
}

549 
	$PCI_PCIECAP_SETTINGS
(
pc›_ÿp
 *
pc›ÿp
)

551 
pc›ÿp
->
pxid
.
cid
 = 
PCI_CAP_ID_EXP
;

552 
pc›ÿp
->
pxid
.
Ãxt
 = 0x0;

554 
pc›ÿp
->
pxÿp
.
v”
 = 
PCI_EXP_FLAGS
;

555 
pc›ÿp
->
pxÿp
.
imn
 = 0;

556 
pc›ÿp
->
pxÿp
.
d±
 = 
PCI_EXP_TYPE_ENDPOINT
;

558 
pc›ÿp
->
pxdÿp
.
mps
 = 1;

559 
pc›ÿp
->
pxdÿp
.
pfs
 = 0;

560 
pc›ÿp
->
pxdÿp
.
‘fs
 = 1;

561 
pc›ÿp
->
pxdÿp
.
l0¦
 = 6;

562 
pc›ÿp
->
pxdÿp
.
l1l
 = 2;

563 
pc›ÿp
->
pxdÿp
.
»r
 = 1;

564 
pc›ÿp
->
pxdÿp
.
c¥lv
 = 0;

565 
pc›ÿp
->
pxdÿp
.
c¥ls
 = 0;

566 
pc›ÿp
->
pxdÿp
.
ærc
 = 1;

567 
	}
}

569 
	$PCI_EXTCAP_SETTINGS
(
pci_ext_ÿp
 *
ext_ÿp
)

571 
off_t
 
off£t
 = 0;

572 *
ext_ÿp_ba£
 = 
ext_ÿp
;

575 
ext_ÿp
->
cid
 = 
PCI_EXT_CAP_ID_ERR
;

576 
ext_ÿp
->
cv”
 = 1;

577 
ext_ÿp
->
Ãxt
 = 
PCI_CFG_SPACE_SIZE
 + 0x50;

579 
ext_ÿp
 = 
ext_ÿp_ba£
 + 0x50;

580 
ext_ÿp
->
cid
 = 
PCI_EXT_CAP_ID_VC
;

581 
ext_ÿp
->
cv”
 = 1;

582 
ext_ÿp
->
Ãxt
 = 
PCI_CFG_SPACE_SIZE
 + 0x80;

584 
ext_ÿp
 = 
ext_ÿp_ba£
 + 0x80;

585 
ext_ÿp
->
cid
 = 
PCI_EXT_CAP_ID_PWR
;

586 
ext_ÿp
->
cv”
 = 1;

587 
ext_ÿp
->
Ãxt
 = 
PCI_CFG_SPACE_SIZE
 + 0x90;

589 
ext_ÿp
 = 
ext_ÿp_ba£
 + 0x90;

590 
ext_ÿp
->
cid
 = 
PCI_EXT_CAP_ID_ARI
;

591 
ext_ÿp
->
cv”
 = 1;

592 
ext_ÿp
->
Ãxt
 = 
PCI_CFG_SPACE_SIZE
 + 0x170;

594 
ext_ÿp
 = 
ext_ÿp_ba£
 + 0x170;

595 
ext_ÿp
->
cid
 = 
PCI_EXT_CAP_ID_DSN
;

596 
ext_ÿp
->
cv”
 = 1;

597 
ext_ÿp
->
Ãxt
 = 
PCI_CFG_SPACE_SIZE
 + 0x1a0;

599 
ext_ÿp
 = 
ext_ÿp_ba£
 + 0x1a0;

600 
ext_ÿp
->
cid
 = 
PCI_EXT_CAP_ID_SECPCI
;

601 
ext_ÿp
->
cv”
 = 1;

602 
ext_ÿp
->
Ãxt
 = 0;

620 
	}
}

622 
boÞ
 
	$NVMEV_PCI_INIT
(
nvmev_dev
 *
nvmev_vdev
)

624 
	`PCI_HEADER_SETTINGS
(
nvmev_vdev
->
pcihdr
,‚vmev_vdev->
cÚfig
.
memm­_¡¬t
);

625 
	`PCI_PMCAP_SETTINGS
(
nvmev_vdev
->
pmÿp
);

626 
	`PCI_MSIXCAP_SETTINGS
(
nvmev_vdev
->
msixÿp
);

627 
	`PCI_PCIECAP_SETTINGS
(
nvmev_vdev
->
pc›ÿp
);

628 
	`PCI_EXTCAP_SETTINGS
(
nvmev_vdev
->
extÿp
);

630 #ifdeà
CONFIG_NVMEV_FAST_X86_IRQ_HANDLING


631 
	`__š™_­icid_to_ýuid
();

633 
nvmev_vdev
->
štx_di§bËd
 = 
çl£
;

635 
nvmev_vdev
->
vœt_bus
 = 
	`__ü—‹_pci_bus
(nvmev_vdev);

636 ià(!
nvmev_vdev
->
vœt_bus
)

637  
çl£
;

638  
Œue
;

639 
	}
}

	@pci.h

3 #iâdeà
_LIB_NVMEV_HDR_H


4 
	#_LIB_NVMEV_HDR_H


	)

6 
	s__nvme_b¬
 {

7 
ušt64_t
 
	mÿp
;

8 
ušt32_t
 
	mvs
;

9 
ušt32_t
 
	mštms
;

10 
ušt32_t
 
	mštmc
;

11 
ušt32_t
 
	mcc
;

12 
ušt32_t
 
	mrsvd1
;

13 
ušt32_t
 
	mc¡s
;

14 
ušt32_t
 
	mns¤
;

15 
ušt32_t
 
	maqa
;

16 
ušt64_t
 
	masq
;

17 
ušt64_t
 
	macq
;

18 
ušt32_t
 
	mcmbloc
;

19 
ušt32_t
 
	mcmbsz
;

22 
	spci_h—d”
 {

24 
u16
 
	mvid
;

25 
u16
 
	mdid
;

26 } 
	mid
;

28 
u8
 
	mio£
 : 1;

29 
u8
 
	mm£
 : 1;

30 
u8
 
	mbme
 : 1;

31 
u8
 
	msû
 : 1;

32 
u8
 
	mmw›
 : 1;

33 
u8
 
	mvga
 : 1;

34 
u8
 
	m³e
 : 1;

35 
u8
 
	mfixed
 : 1;

36 
u8
 
	m£e
 : 1;

37 
u8
 
	mfbe
 : 1;

38 
u8
 
	mid
 : 1;

39 
u8
 
	mrsvd
 : 5;

40 } 
	mcmd
;

42 
u8
 
	mrsvd1
 : 3;

43 
u8
 
	mis
 : 1;

44 
u8
 
	mþ
 : 1;

45 
u8
 
	mc66
 : 1;

46 
u8
 
	mrsvd2
 : 1;

47 
u8
 
	mfbc
 : 1;

48 
u8
 
	mdpd
 : 1;

49 
u8
 
	mdevt
 : 2;

50 
u8
 
	m¡a
 : 1;

51 
u8
 
	m¹a
 : 1;

52 
u8
 
	mrma
 : 1;

53 
u8
 
	ms£
 : 1;

54 
u8
 
	md³
 : 1;

55 } 
	m¡s
;

56 
u8
 
	mrid
;

58 
u8
 
	mpi
;

59 
u8
 
	mscc
;

60 
u8
 
	mbcc
;

61 } 
	mcc
;

62 
u8
 
	mþs
;

63 
u8
 
	mmÉ
;

65 
u8
 
	mhl
 : 7;

66 
u8
 
	mmfd
 : 1;

67 } 
	mhty³
;

69 
u8
 
	mcc
 : 4;

70 
u8
 
	mrsvd
 : 2;

71 
u8
 
	msb
 : 1;

72 
u8
 
	mbc
 : 1;

73 } 
	mbi¡
;

76 
u32
 
	m¹e
 : 1;

77 
u32
 
	m
 : 2;

78 
u32
 
	mpf
 : 1;

79 
u32
 
	mrsvd
 : 10;

80 
u32
 
	mba
 : 18;

81 } 
	mmlb¬
;

83 
u32
 
	mmulb¬
;

84 
u32
 
	midb¬
;

86 
u32
 
	mb¬3
;

87 
u32
 
	mb¬4
;

88 
u32
 
	mb¬5
;

90 
u32
 
	mcýŒ
;

93 
u16
 
	mssvid
;

94 
u16
 
	mssid
;

95 } 
	mss
;

97 
u32
 
	m”om
;

98 
u8
 
	mÿp
;

99 
u8
 
	mrsvd
[7];

101 
u8
 
	mžše
;

102 
u8
 
	mš
;

103 } 
	mšŒ
;

105 
u8
 
	mmgÁ
;

106 
u8
 
	mmÏt
;

109 
	spci_pm_ÿp
 {

111 
u8
 
	mcid
;

112 
u8
 
	mÃxt
;

113 } 
	mpid
;

115 
u16
 
	mvs
 : 3;

116 
u16
 
	mpmec
 : 1;

117 
u16
 
	m»sv
 : 1;

118 
u16
 
	mdsi
 : 1;

119 
u16
 
	mauxc
 : 3;

120 
u16
 
	md1s
 : 1;

121 
u16
 
	md2s
 : 1;

122 
u16
 
	mpsup
 : 5;

123 } 
	mpc
;

125 
u16
 
	mps
 : 2;

126 
u16
 
	mrsvd01
 : 1;

127 
u16
 
	mnsä¡
 : 1;

128 
u16
 
	mrsvd02
 : 4;

129 
u16
 
	mpm“
 : 1;

130 
u16
 
	md£
 : 4;

131 
u16
 
	mdsc
 : 2;

132 
u16
 
	mpmes
 : 1;

133 } 
	mpmcs
;

134 
u8
 
	mext
[2];

137 
	spci_msi_ÿp
 {

139 } 
	mmid
;

141 } 
	mmc
;

143 } 
	mma
;

145 } 
	mmua
;

147 } 
	mmd
;

149 } 
	mmmask
;

151 } 
	mm³nd
;

154 
	spci_msix_ÿp
 {

156 
u8
 
	mcid
;

157 
u8
 
	mÃxt
;

158 } 
	mmxid
;

160 
u16
 
	mts
 : 11;

161 
u16
 
	mrsvd
 : 3;

162 
u16
 
	mfm
 : 1;

163 
u16
 
	mmxe
 : 1;

164 } 
	mmxc
;

166 
u32
 
	mtbœ
 : 3;

167 
u32
 
	mto
 : 29;

168 } 
	mmb
;

170 
u32
 
	mpbœ
 : 3;

171 
u32
 
	mpbao
 : 29;

172 } 
	mmpba
;

175 
	spc›_ÿp
 {

177 
u8
 
	mcid
;

178 
u8
 
	mÃxt
;

179 } 
	mpxid
;

181 
u8
 
	mv”
 : 4;

182 
u8
 
	md±
 : 4;

183 
u8
 
	msi
 : 1;

184 
u8
 
	mimn
 : 5;

185 
u8
 
	mrsvd
 : 2;

186 } 
	mpxÿp
;

188 
u32
 
	mmps
 : 3;

189 
u32
 
	mpfs
 : 2;

190 
u32
 
	m‘fs
 : 1;

191 
u32
 
	ml0¦
 : 3;

192 
u32
 
	ml1l
 : 3;

193 
u32
 
	mrsvd
 : 3;

194 
u32
 
	m»r
 : 1;

195 
u32
 
	mrsvd2
 : 2;

196 
u32
 
	mc¥lv
 : 8;

197 
u32
 
	mc¥ls
 : 2;

198 
u32
 
	mærc
 : 1;

199 
u32
 
	mrsvd3
 : 3;

200 } 
	mpxdÿp
;

202 
u16
 
	mû»
 : 1;

203 
u16
 
	mnã»
 : 1;

204 
u16
 
	mã»
 : 2;

205 
u16
 
	mu¼e
 : 1;

206 
u16
 
	m”o
 : 1;

207 
u16
 
	mmps
 : 3;

208 
u16
 
	m‘e
 : 1;

209 
u16
 
	mpã
 : 1;

210 
u16
 
	m­pme
 : 1;

211 
u16
 
	m’s
 : 1;

212 
u16
 
	mm¼s
 : 3;

213 
u16
 
	miær
 : 1;

214 } 
	mpxdc
;

216 
u16
 
	mûd
 : 1;

217 
u16
 
	mnãd
 : 1;

218 
u16
 
	mãd
 : 1;

219 
u16
 
	murd
 : 1;

220 
u16
 
	m­d
 : 1;

221 
u16
 
	m
 : 1;

222 
u16
 
	mrsvd
 : 10;

223 } 
	mpxds
;

225 
u32
 
	m¦s
 : 4;

226 
u32
 
	mmlw
 : 6;

227 
u32
 
	ma¥ms
 : 2;

228 
u32
 
	ml0£l
 : 3;

229 
u32
 
	ml1–
 : 3;

230 
u32
 
	mým
 : 1;

231 
u32
 
	msd”c
 : 1;

232 
u32
 
	mdÎÏ
 : 20;

233 
u32
 
	mlbnc
 : 1;

234 
u32
 
	maoc
 : 1;

235 
u32
 
	mrsvd
 : 1;

236 
u32
 
	m²
 : 8;

237 } 
	mpxlÿp
;

239 
u16
 
	ma¥mc
 : 2;

240 
u16
 
	mrsvd
 : 1;

241 
u16
 
	mrcb
 : 1;

242 
u16
 
	mrsvd2
 : 2;

243 
u16
 
	mccc
 : 1;

244 
u16
 
	mes
 : 1;

245 
u16
 
	meým
 : 1;

246 
u16
 
	mhawd
 : 1;

247 
u16
 
	mrsvd3
 : 6;

248 } 
	mpxlc
;

250 
u16
 
	mþc
 : 4;

251 
u16
 
	mÆw
 : 6;

252 
u16
 
	mrsvd
 : 2;

253 
u16
 
	mscc
 : 1;

254 
u16
 
	mrsvd2
 : 3;

255 } 
	mpxls
;

257 
u32
 
	mùrs
 : 4;

258 
u32
 
	mùds
 : 1;

259 
u32
 
	m¬ifs
 : 1;

260 
u32
 
	maÜs
 : 1;

261 
u32
 
	maocs32
 : 1;

262 
u32
 
	maocs
 : 1;

263 
u32
 
	mccs128
 : 1;

264 
u32
 
	mÅ½r
 : 1;

265 
u32
 
	mÉrs
 : 1;

266 
u32
 
	mhcs
 : 2;

267 
u32
 
	mrsvd
 : 4;

268 
u32
 
	mobffs
 : 2;

269 
u32
 
	meffs
 : 1;

270 
u32
 
	m“s
 : 1;

271 
u32
 
	mm“
 : 2;

272 
u32
 
	mrsvd2
 : 8;

273 } 
	mpxdÿp2
;

275 
u32
 
	mùv
 : 4;

276 
u32
 
	mùd
 : 1;

277 
u32
 
	mrsvd
 : 5;

278 
u32
 
	mÉrme
 : 1;

279 
u32
 
	mrsvd2
 : 2;

280 
u32
 
	mobfã
 : 2;

281 
u32
 
	mrsvd3
 : 17;

282 } 
	mpxdc2
;

285 
	spci_ext_ÿp
 {

286 
u16
 
	mcid
;

287 
u16
 
	mcv”
 : 4;

288 
u16
 
	mÃxt
 : 12;

291 
	spci_ext_ÿp_«r
 {

292 
pci_ext_ÿp
 
	mid
;

294 
u32
 
	mrsvd
 : 4;

295 
u32
 
	mdÍes
 : 1;

296 
u32
 
	mrsvd2
 : 7;

297 
u32
 
	m±s
 : 1;

298 
u32
 
	mfýes
 : 1;

299 
u32
 
	mùs
 : 1;

300 
u32
 
	mÿs
 : 1;

301 
u32
 
	mucs
 : 1;

302 
u32
 
	mros
 : 1;

303 
u32
 
	mmts
 : 1;

304 
u32
 
	meüûs
 : 1;

305 
u32
 
	mu»s
 : 1;

306 
u32
 
	macsvs
 : 1;

307 
u32
 
	mu›s
 : 1;

308 
u32
 
	mmcbts
 : 1;

309 
u32
 
	maÛbs
 : 1;

310 
u32
 
	mbes
 : 1;

311 
u32
 
	mrsvd3
 : 6;

312 } 
	m«ruûs
;

314 
u32
 
	mrsvd
 : 4;

315 
u32
 
	mdÍem
 : 1;

316 
u32
 
	mrsvd2
 : 7;

317 
u32
 
	m±m
 : 1;

318 
u32
 
	mfýem
 : 1;

319 
u32
 
	mùm
 : 1;

320 
u32
 
	mÿm
 : 1;

321 
u32
 
	mucm
 : 1;

322 
u32
 
	mrom
 : 1;

323 
u32
 
	mmtm
 : 1;

324 
u32
 
	meüûm
 : 1;

325 
u32
 
	mu»m
 : 1;

326 
u32
 
	macsvm
 : 1;

327 
u32
 
	mu›m
 : 1;

328 
u32
 
	mmcbtm
 : 1;

329 
u32
 
	maÛbm
 : 1;

330 
u32
 
	mbem
 : 1;

331 
u32
 
	mrsvd3
 : 6;

332 } 
	m«ruûm
;

334 
u32
 
	mrsvd
 : 4;

335 
u32
 
	mdÍe£v
 : 1;

336 
u32
 
	mrsvd2
 : 7;

337 
u32
 
	m±£v
 : 1;

338 
u32
 
	mfýe£v
 : 1;

339 
u32
 
	mù£v
 : 1;

340 
u32
 
	mÿ£v
 : 1;

341 
u32
 
	muc£v
 : 1;

342 
u32
 
	mro£v
 : 1;

343 
u32
 
	mmt£v
 : 1;

344 
u32
 
	meüû£v
 : 1;

345 
u32
 
	mu»£v
 : 1;

346 
u32
 
	macsv£v
 : 1;

347 
u32
 
	mu›£v
 : 1;

348 
u32
 
	mmcbt£v
 : 1;

349 
u32
 
	maÛb£v
 : 1;

350 
u32
 
	mbe£v
 : 1;

351 
u32
 
	mrsvd3
 : 6;

352 } 
	m«ruû£v
;

354 
u32
 
	m»s
 : 1;

355 
u32
 
	mrsvd
 : 5;

356 
u32
 
	mbts
 : 1;

357 
u32
 
	mbds
 : 1;

358 
u32
 
	m¼s
 : 1;

359 
u32
 
	mrsvd2
 : 3;

360 
u32
 
	m¹s
 : 1;

361 
u32
 
	mªãs
 : 1;

362 
u32
 
	mc›s
 : 1;

363 
u32
 
	mhlos
 : 1;

364 
u32
 
	mrsvd3
 : 16;

365 } 
	m«rûs
;

367 
u32
 
	m»m
 : 1;

368 
u32
 
	mrsvd
 : 5;

369 
u32
 
	mbtm
 : 1;

370 
u32
 
	mbdm
 : 1;

371 
u32
 
	m¼m
 : 1;

372 
u32
 
	mrsvd2
 : 3;

373 
u32
 
	m¹m
 : 1;

374 
u32
 
	mªãm
 : 1;

375 
u32
 
	mc›m
 : 1;

376 
u32
 
	mhlom
 : 1;

377 
u32
 
	mrsvd3
 : 16;

378 } 
	m«rûm
;

380 
u32
 
	mãp
 : 5;

381 
u32
 
	megc
 : 1;

382 
u32
 
	mege
 : 1;

383 
u32
 
	mecc
 : 1;

384 
u32
 
	meû
 : 1;

385 
u32
 
	mmhrc
 : 1;

386 
u32
 
	mmh»
 : 1;

387 
u32
 
	mÍ
 : 1;

388 
u32
 
	mrsvd
 : 20;

389 } 
	m«rcc
;

391 
u8
 
	mhb3
;

392 
u8
 
	mhb2
;

393 
u8
 
	mhb1
;

394 
u8
 
	mhb0
;

395 
u8
 
	mhb7
;

396 
u8
 
	mhb6
;

397 
u8
 
	mhb5
;

398 
u8
 
	mhb4
;

399 
u8
 
	mhb11
;

400 
u8
 
	mhb10
;

401 
u8
 
	mhb9
;

402 
u8
 
	mhb8
;

403 
u8
 
	mhb15
;

404 
u8
 
	mhb14
;

405 
u8
 
	mhb13
;

406 
u8
 
	mhb12
;

407 } 
	m«rhl
;

409 
u8
 
	ml1b3
;

410 
u8
 
	ml1b2
;

411 
u8
 
	ml1b1
;

412 
u8
 
	ml1b0
;

413 
u8
 
	ml2b3
;

414 
u8
 
	ml2b2
;

415 
u8
 
	ml2b1
;

416 
u8
 
	ml2b0
;

417 
u8
 
	ml3b3
;

418 
u8
 
	ml3b2
;

419 
u8
 
	ml3b1
;

420 
u8
 
	ml3b0
;

421 
u8
 
	ml4b3
;

422 
u8
 
	ml4b2
;

423 
u8
 
	ml4b1
;

424 
u8
 
	ml4b0
;

425 } 
	m«¹Í
;

428 
	spci_ext_ÿp_d¢
 {

429 
pci_ext_ÿp
 
	mid
;

430 
u64
 
	m£rŸl
;

433 
	snvme_ù¾_»gs
 {

436 
u16
 
	mmqes
;

437 
u16
 
	mcqr
 : 1;

438 
u16
 
	mams
 : 2;

439 
u16
 
	mrsvd
 : 5;

440 
u16
 
	mto
 : 8;

441 
u16
 
	md¡rd
 : 4;

442 
u16
 
	mns¤s
 : 1;

443 
u16
 
	mcss
 : 8;

444 
u16
 
	mrsvd2
 : 3;

445 
u16
 
	mmpsmš
 : 4;

446 
u16
 
	mmpsmax
 : 4;

447 
u16
 
	mrsvd3
 : 8;

448 } 
	mÿp
;

449 
u64
 
	mu_ÿp
;

454 
u8
 
	mrsvd
;

455 
u8
 
	mmÄ
;

456 
u16
 
	mmjr
;

457 } 
	mvs
;

458 
u32
 
	mu_vs
;

461 
u32
 
	mštms
;

462 
u32
 
	mštmc
;

465 
u16
 
	m’
 : 1;

466 
u16
 
	mrsvd
 : 3;

467 
u16
 
	mcss
 : 3;

468 
u16
 
	mmps
 : 4;

469 
u16
 
	mams
 : 3;

470 
u16
 
	mshn
 : 2;

471 
u16
 
	miosqes
 : 4;

472 
u16
 
	miocqes
 : 4;

473 
u16
 
	mrsvd2
 : 8;

474 } 
	mcc
;

475 
u32
 
	mu_cc
;

478 
u32
 
	mrsvd1
;

481 
u32
 
	mrdy
 : 1;

482 
u32
 
	mcfs
 : 1;

483 
u32
 
	msh¡
 : 2;

484 
u32
 
	mns¤o
 : 1;

485 
u32
 
	mµ
 : 1;

486 
u32
 
	mrsvd
 : 26;

487 } 
	mc¡s
;

488 
u32
 
	mu_c¡s
;

491 
u32
 
	mns¤
;

494 
u32
 
	masqs
 : 12;

495 
u32
 
	mrsvd1
 : 4;

496 
u32
 
	macqs
 : 12;

497 
u32
 
	mrsvd2
 : 4;

498 } 
	maqa
;

499 
u32
 
	mu_aqa
;

504 
u64
 
	mrsvd
 : 12;

505 
u64
 
	masqb
 : 52;

506 } 
	masq
;

507 
u64
 
	mu_asq
;

512 
u64
 
	mrsvd
 : 12;

513 
u64
 
	macqb
 : 52;

514 } 
	macq
;

515 
u64
 
	mu_acq
;

520 
u32
 
	mbœ
 : 3;

521 
u32
 
	mrsvd
 : 9;

522 
u32
 
	mof¡
 : 20;

523 } 
	mcmbloc
;

524 
u32
 
	mu_cmbloc
;

529 
u32
 
	msqs
 : 1;

530 
u32
 
	mcqs
 : 1;

531 
u32
 
	mli¡s
 : 1;

532 
u32
 
	mrds
 : 1;

533 
u32
 
	mwds
 : 1;

534 
u32
 
	mrsvd
 : 3;

535 
u32
 
	mszu
 : 4;

536 
u32
 
	msz
 : 20;

537 } 
	mcmbsz
;

538 
u32
 
	mu_cmbsz
;

543 
	#NVMEV_PCI_DOMAIN_NUM
 0x0001

	)

544 
	#NVMEV_PCI_BUS_NUM
 0x10

	)

547 
	#SZ_PCI_HDR
 (
pci_h—d”
)

548 
	#SZ_PCI_PM_CAP
 (
pci_pm_ÿp
)

549 
	#SZ_PCI_MSIX_CAP
 (
pci_msix_ÿp
)

550 
	#SZ_PCIE_CAP
 (
pc›_ÿp
)

551 

	)

552 
	#OFFS_PCI_HDR
 0x0

	)

553 
	#OFFS_PCI_PM_CAP
 0x40

	)

554 
	#OFFS_PCI_MSIX_CAP
 0x50

	)

555 
	#OFFS_PCIE_CAP
 0x60

	)

557 
	#SZ_HEADER
 (
OFFS_PCIE_CAP
 + 
SZ_PCIE_CAP
)

	)

560 
	#PCI_EXT_CAP_START
 0x50

	)

562 
	#OFFS_PCI_EXT_CAP
 (
PCI_CFG_SPACE_SIZE
)

	)

565 
	mCAP_CSS_BIT_NVM
 = (1 << 0),

566 
	mCAP_CSS_BIT_SPECIFIC
 = (1 << 6),

567 
	mCAP_CSS_BIT_NOT_SUPPORTED
 = (1 << 7),

	@pqueue/pqueue.c

7 
	~"../nvmev.h
"

8 
	~"pqueue.h
"

10 
	#Ëá
(
i
è((iè<< 1)

	)

11 
	#right
(
i
è(((iè<< 1è+ 1)

	)

12 
	#·»Á
(
i
è((iè>> 1)

	)

14 
pqueue_t
 *
	$pqueue_š™
(
size_t
 
n
, 
pqueue_cmp_´i_f
 
cmµri
, 
pqueue_g‘_´i_f
 
g‘´i
,

15 
pqueue_£t_´i_f
 
£ri
, 
pqueue_g‘_pos_f
 
g‘pos
, 
pqueue_£t_pos_f
 
£os
)

17 
pqueue_t
 *
q
;

19 
	`´_šfo_Úû
(
NVMEV_DRV_NAME
 ":…queue: "

23 ià(!(
q
 = 
	`km®loc
((
pqueue_t
), 
GFP_KERNEL
))){

24  
NULL
;

28 
	`NVMEV_DEBUG
("{®loc}‚=%ld, size=%ld\n", 
n
, (n + 1) * (*));

29 ià(!(
q
->
d
 = 
	`km®loc
((
n
 + 1è* (*), 
GFP_KERNEL
))) {

30 
	`kä“
(
q
);

31  
NULL
;

34 
q
->
size
 = 1;

35 
q
->
avaž
 = q->
¡•
 = (
n
 + 1);

36 
q
->
cmµri
 = cmppri;

37 
q
->
£ri
 = setpri;

38 
q
->
g‘´i
 = getpri;

39 
q
->
g‘pos
 = getpos;

40 
q
->
£os
 = setpos;

42  
q
;

43 
	}
}

45 
	$pqueue_ä“
(
pqueue_t
 *
q
)

47 
	`kä“
(
q
->
d
);

48 
	`kä“
(
q
);

49 
	}
}

51 
size_t
 
	$pqueue_size
(
pqueue_t
 *
q
)

54  (
q
->
size
 - 1);

55 
	}
}

57 
	$bubbË_up
(
pqueue_t
 *
q
, 
size_t
 
i
)

59 
size_t
 
·»Á_node
;

60 *
movšg_node
 = 
q
->
d
[
i
];

61 
pqueue_´i_t
 
movšg_´i
 = 
q
->
	`g‘´i
(
movšg_node
);

63 
·»Á_node
 = 
	`·»Á
(
i
);

64 ((
i
 > 1è&& 
q
->
	`cmµri
(q->
	`g‘´i
(q->
d
[
·»Á_node
]), 
movšg_´i
));

65 
i
 = 
·»Á_node
,…¬’t_nodð
	`·»Á
(i)) {

66 
q
->
d
[
i
] = q->d[
·»Á_node
];

67 
q
->
	`£os
(q->
d
[
i
], i);

70 
q
->
d
[
i
] = 
movšg_node
;

71 
q
->
	`£os
(
movšg_node
, 
i
);

72 
	}
}

74 
size_t
 
	$maxchžd
(
pqueue_t
 *
q
, 
size_t
 
i
)

76 
size_t
 
chžd_node
 = 
	`Ëá
(
i
);

78 ià(
chžd_node
 >ð
q
->
size
)

81 ià((
chžd_node
 + 1è< 
q
->
size
 &&

82 
q
->
	`cmµri
(q->
	`g‘´i
(q->
d
[
chžd_node
]), q->getpri(q->d[child_node + 1])))

83 
chžd_node
++;

85  
chžd_node
;

86 
	}
}

88 
	$³rcÞ©e_down
(
pqueue_t
 *
q
, 
size_t
 
i
)

90 
size_t
 
chžd_node
;

91 *
movšg_node
 = 
q
->
d
[
i
];

92 
pqueue_´i_t
 
movšg_´i
 = 
q
->
	`g‘´i
(
movšg_node
);

94 (
chžd_node
 = 
	`maxchžd
(
q
, 
i
)) &&

95 
q
->
	`cmµri
(
movšg_´i
, q->
	`g‘´i
(q->
d
[
chžd_node
]))) {

96 
q
->
d
[
i
] = q->d[
chžd_node
];

97 
q
->
	`£os
(q->
d
[
i
], i);

98 
i
 = 
chžd_node
;

101 
q
->
d
[
i
] = 
movšg_node
;

102 
q
->
	`£os
(
movšg_node
, 
i
);

103 
	}
}

105 
	$pqueue_š£¹
(
pqueue_t
 *
q
, *
d
)

108 
size_t
 
i
;

111 ià(!
q
)

115 ià(
q
->
size
 >ðq->
avaž
) {

116 
	`NVMEV_ERROR
("Need more space in…queue\n");

125 
i
 = 
q
->
size
++;

126 
q
->
d
[
i
] = d;

127 
	`bubbË_up
(
q
, 
i
);

130 
	}
}

131 
	$pqueue_chªge_d©a
(
pqueue_t
 *
q
, 
size_t
 
šdex
, *
d
){

132 
q
->
d
[
šdex
] = d;

133 
	}
}

135 
	$pqueue_chªge_´iÜ™y
(
pqueue_t
 *
q
, 
pqueue_´i_t
 
Ãw_´i
, *
d
)

137 
size_t
 
po¢
;

138 
pqueue_´i_t
 
Þd_´i
 = 
q
->
	`g‘´i
(
d
);

140 
q
->
	`£ri
(
d
, 
Ãw_´i
);

141 
po¢
 = 
q
->
	`g‘pos
(
d
);

142 ià(
q
->
	`cmµri
(
Þd_´i
, 
Ãw_´i
))

143 
	`bubbË_up
(
q
, 
po¢
);

145 
	`³rcÞ©e_down
(
q
, 
po¢
);

146 
	}
}

148 
	$pqueue_»move
(
pqueue_t
 *
q
, *
d
)

150 
size_t
 
po¢
 = 
q
->
	`g‘pos
(
d
);

151 
q
->
d
[
po¢
] = q->d[--q->
size
];

152 ià(
q
->
	`cmµri
(q->
	`g‘´i
(
d
), q->g‘´i(q->d[
po¢
])))

153 
	`bubbË_up
(
q
, 
po¢
);

155 
	`³rcÞ©e_down
(
q
, 
po¢
);

158 
	}
}

160 *
	$pqueue_pÝ
(
pqueue_t
 *
q
)

162 *
h—d
;

164 ià(!
q
 || q->
size
 == 1)

165  
NULL
;

167 
h—d
 = 
q
->
d
[1];

168 
q
->
d
[1] = q->d[--q->
size
];

169 
	`³rcÞ©e_down
(
q
, 1);

171  
h—d
;

172 
	}
}

174 *
	$pqueue_³ek
(
pqueue_t
 *
q
)

176 *
d
;

178 ià(!
q
 || q->
size
 == 1)

179  
NULL
;

180 
d
 = 
q
->d[1];

181  
d
;

182 
	}
}

185 
	$pqueue_dump
(
pqueue_t
 *
q
, 
FILE
 *
out
, 
pqueue_´št_’Œy_f
 
´št
)

187 
i
;

189 
	`årštf
(
¡dout
,"posn\tleft\tright\tparent\tmaxchild\t...\n");

190 
i
 = 1; i < 
q
->
size
 ;i++) {

191 
	`årštf
(
¡dout
,

193 
i
,

194 
	`Ëá
(
i
), 
	`right
(i), 
	`·»Á
(i),

195 ()
	`maxchžd
(
q
, 
i
));

196 
	`´št
(
out
, 
q
->
d
[
i
]);

198 
	}
}

200 
	$£t_pos
(*
d
, 
size_t
 
v®
)

203 
	}
}

205 
	$£t_´i
(*
d
, 
pqueue_´i_t
 
´i
)

208 
	}
}

210 
	$pqueue_´št
(
pqueue_t
 *
q
, 
FILE
 *
out
, 
pqueue_´št_’Œy_f
 
´št
)

212 
pqueue_t
 *
dup
;

213 *
e
;

215 
dup
 = 
	`pqueue_š™
(
q
->
size
, q->
cmµri
, q->
g‘´i
, 
£t_´i
, q->
g‘pos
, 
£t_pos
);

216 
dup
->
size
 = 
q
->size;

217 
dup
->
avaž
 = 
q
->avail;

218 
dup
->
¡•
 = 
q
->step;

220 
	`memýy
(
dup
->
d
, 
q
->d, (q->
size
 * (*)));

222 (
e
 = 
	`pqueue_pÝ
(
dup
)))

223 
	`´št
(
out
, 
e
);

225 
	`pqueue_ä“
(
dup
);

226 
	}
}

229 
	$subŒ“_is_v®id
(
pqueue_t
 *
q
, 
pos
)

231 ià(
	`Ëá
(
pos
è< 
q
->
size
) {

233 ià(
q
->
	`cmµri
(q->
	`g‘´i
(q->
d
[
pos
]), q->g‘´i(q->d[
	`Ëá
(pos)])))

235 ià(!
	`subŒ“_is_v®id
(
q
, 
	`Ëá
(
pos
)))

238 ià(
	`right
(
pos
è< 
q
->
size
) {

240 ià(
q
->
	`cmµri
(q->
	`g‘´i
(q->
d
[
pos
]), q->g‘´i(q->d[
	`right
(pos)])))

242 ià(!
	`subŒ“_is_v®id
(
q
, 
	`right
(
pos
)))

246 
	}
}

248 
	$pqueue_is_v®id
(
pqueue_t
 *
q
)

250  
	`subŒ“_is_v®id
(
q
, 1);

251 
	}
}

	@pqueue/pqueue.h

14 #iâdeà
PQUEUE_H


15 
	#PQUEUE_H


	)

18 
	tpqueue_´i_t
;

21 
	$pqueue_´i_t
 (*
	tpqueue_g‘_´i_f
)(*
	ta
);

22 (*
	tpqueue_£t_´i_f
)(*
	ta
, 
	tpqueue_´i_t
 
	t´i
);

23 (*
	tpqueue_cmp_´i_f
)(
	tpqueue_´i_t
 
	tÃxt
,…queue_´i_ˆ
	tcu¼
);

26 
	$size_t
 (*
	tpqueue_g‘_pos_f
)(*
	ta
);

27 (*
	tpqueue_£t_pos_f
)(*
	ta
, 
	tsize_t
 
	tpos
);

33 
	spqueue_t
 {

34 
size_t
 
size
;

35 
size_t
 
avaž
;

36 
size_t
 
¡•
;

37 
pqueue_cmp_´i_f
 
cmµri
;

38 
pqueue_g‘_´i_f
 
g‘´i
;

39 
pqueue_£t_´i_f
 
£ri
;

40 
pqueue_g‘_pos_f
 
g‘pos
;

41 
pqueue_£t_pos_f
 
£os
;

42 **
d
;

43 } 
	tpqueue_t
;

60 
pqueue_t
 *
	`pqueue_š™
(
size_t
 
n
, 
pqueue_cmp_´i_f
 
cmµri
, 
pqueue_g‘_´i_f
 
g‘´i
,

61 
pqueue_£t_´i_f
 
£ri
, 
pqueue_g‘_pos_f
 
g‘pos
, 
pqueue_£t_pos_f
 
£os
);

67 
	`pqueue_ä“
(
pqueue_t
 *
q
);

73 
size_t
 
	`pqueue_size
(
pqueue_t
 *
q
);

81 
	`pqueue_š£¹
(
pqueue_t
 *
q
, *
d
);

89 
	`pqueue_chªge_´iÜ™y
(
pqueue_t
 *
q
, 
pqueue_´i_t
 
Ãw_´i
, *
d
);

96 *
	`pqueue_pÝ
(
pqueue_t
 *
q
);

104 
	`pqueue_»move
(
pqueue_t
 *
q
, *
d
);

111 *
	`pqueue_³ek
(
pqueue_t
 *
q
);

137 
	`pqueue_is_v®id
(
pqueue_t
 *
q
);

139 
	`pqueue_chªge_d©a
(
pqueue_t
 *
q
, 
size_t
 
šdex
, *
d
);

	@pqueue/pqueue_linked.c

1 
	~"pqueue_lšked.h
"

3 
	$pq_L_š™
(
pqueue_L
 *
pq
){

4 
	`´štk
(
KERN_INFO
 "hey \n");

5 
	`INIT_LIST_HEAD
(&
pq
->
h—d
);

6 
	`´štk
(
KERN_INFO
 "whathe \n");

7 
pq
->
couÁ
=0;

8 
	`´štk
(
KERN_INFO
 "fuck \n");

9 
	}
}

11 
	$pq_L_is_em±y
(
pqueue_L
 *
pq
){

12  
	`li¡_em±y
(&
pq
->
h—d
);

13 
	}
}

15 
	$pq_L_š£¹
(
pqueue_L
 *
pq
, 
lšked_Node
 *
node
){

16 
lšked_Node
 * 
pos
;

18 
	`li¡_fÜ_—ch_’Œy
(
pos
, &
pq
->
h—d
, 
li¡
){

19 if(
node
->
size
 > 
pos
->size){

20 
	`li¡_add_ž
(&
node
->
li¡
, &
pos
->list);

21 
pq
->
couÁ
++;

26 
	`li¡_add_ž
(&
node
->
li¡
, &
pq
->
h—d
);

28 
	}
}

30 
lšked_Node
 * 
	$pq_L_pÝ
(
pqueue_L
 *
pq
){

31 
lšked_Node
 * 
node
 = 
NULL
;

33 if(
	`pq_L_is_em±y
(
pq
)){

34 
	`´štk
(
KERN_INFO
 "Priority Queue isƒmpty\n");

35  
NULL
;

38 
node
 = 
	`li¡_fœ¡_’Œy
(&
pq
->
h—d
, 
lšked_Node
, 
li¡
);

39 
	`li¡_d–
(&
node
->
li¡
);

41  
node
;

42 
	}
}

44 
	$pq_L_size
(
pqueue_L
 *
pq
){

45  
pq
->
couÁ
;

46 
	}
}

	@pqueue/pqueue_linked.h

1 #iâdeà
PQUEUE_L


2 
	#PQUEUE_L


	)

4 
	~"../nvmev.h
"

7 
	scÚtiguous_Ín
{

8 
li¡_h—d
 
	mli¡
;

11 
ušt64_t
 
	m¡¬t_Ín
;

12 
ušt64_t
 
	m’d_Ín
;

13 
	m·¹
;

16 
ušt64_t
 
	msize
;

18 } 
	tlšked_Node
;

21 
li¡_h—d
 
	mh—d
;

22 
	mcouÁ
;

23 } 
	tpqueue_L
;

26 
pq_L_š™
(
pqueue_L
 *
pq
);

28 
pq_L_is_em±y
(
pqueue_L
 *
pq
);

30 
pq_L_š£¹
(
pqueue_L
 *
pq
, 
lšked_Node
 *
node
);

32 
lšked_Node
 * 
pq_L_pÝ
(
pqueue_L
 *
pq
);

34 
pq_L_size
(
pqueue_L
 *
pq
);

	@save_load.c

1 
	~"§ve_lßd.h
"

2 
	~<lšux/fs.h
>

3 
	~<lšux/mmª.h
>

4 
	~<lšux/debugfs.h
>

5 
	~<lšux/kobjeù.h
>

6 
	~<lšux/sysfs.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¡ršg.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/Çmei.h
>

12 
	~<lšux/·th.h
>

13 
	~<lšux/uacûss.h
>

14 
	~<lšux/blkdev.h
>

15 
	~<u­i/lšux/fs.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/mouÁ.h
>

18 
	~<lšux/Çmei.h
>

19 
	~<lšux/sched.h
>

23 
	$SAVE_LOAD_INIT
(
nvmev
 *‚vmev){

24 
	`´štk
("Hello save‡nd†oad -fix\n");

25 
	}
}

27 
	$SAVE_LOAD_EXIT
(){

28 
	`´štk
("Bye save‡nd†oad\n");

29 
	}
}

30 
šlše
 
	$viùim_lše_cmp_´i
(
pqueue_´i_t
 
Ãxt
,…queue_´i_ˆ
cu¼
)

32  (
Ãxt
 > 
cu¼
);

33 
	}
}

35 
šlše
 
pqueue_´i_t
 
	$viùim_lše_g‘_´i
(*
a
)

37  ((
lše
 *)
a
)->
vpc
;

38 
	}
}

40 
šlše
 
	$viùim_lše_£t_´i
(*
a
, 
pqueue_´i_t
 
´i
)

42 ((
lše
 *)
a
)->
vpc
 = 
´i
;

43 
	}
}

45 
šlše
 
size_t
 
	$viùim_lše_g‘_pos
(*
a
)

47  ((
lše
 *)
a
)->
pos
;

48 
	}
}

50 
šlše
 
	$viùim_lše_£t_pos
(*
a
, 
size_t
 
pos
)

52 ((
lše
 *)
a
)->
pos
 =…os;

53 
	}
}

55 
	$ssd_wr™e_pg
(
Çnd_·ge
 *
pg
, 
fže
 *fže, 
loff_t
 *
f_pos
){

56 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
pg
->
n£cs
,(),
f_pos
);

60 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
pg
->
¡©us
,(),
f_pos
);

64 
»t
 = 
	`k”Ãl_wr™e
(
fže
,
pg
->
£c
,(
Çnd_£c_¡©us_t
)*pg->
n£cs
,
f_pos
);

68 
	}
}

69 
	$ssd_wr™e_blk
(
Çnd_block
 *
blk
, 
fže
 *fže, 
loff_t
 *
f_pos
){

70 
i
;

71 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
blk
->
Ågs
,(),
f_pos
);

75 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
blk
->
c
,(),
f_pos
);

79 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
blk
->
vpc
,(),
f_pos
);

83 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
blk
->
”a£_út
,(),
f_pos
);

87 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
blk
->
wp
,(),
f_pos
);

91 
i
=0; i < 
blk
->
Ågs
; i++){

92 
	`ssd_wr™e_pg
(&(
blk
->
pg
[
i
]),
fže
, 
f_pos
);

94 
	}
}

95 
	$ssd_wr™e_¶
(
Çnd_¶ªe
 *
¶
, 
fže
 *fže, 
loff_t
 *
f_pos
){

96 
i
;

98  
i
=0; i < 
¶
->
nblks
; i++){

99 
	`ssd_wr™e_blk
(&(
¶
->
blk
[
i
]),
fže
, 
f_pos
);

101 
	}
}

102 
	$ssd_wr™e_lun
(
Çnd_lun
 *
lun
, 
fže
 *fže, 
loff_t
 *
f_pos
){

103 
i
;

104  
i
=0; i < 
lun
->
Åls
; i++){

105 
	`ssd_wr™e_¶
(&(
lun
->
¶
[
i
]),
fže
, 
f_pos
);

107 
	}
}

109 
	$ssd_wr™e_ch
(
ssd_chªÃl
 *
ch
, 
fže
 *fže, 
loff_t
 *
f_pos
){

110 
i
;

111 
i
=0; i < 
ch
->
Æuns
; i++){

112 
	`ssd_wr™e_lun
(&(
ch
->
lun
[
i
]),
fže
, 
f_pos
);

114 
	}
}

116 
	$§ve_deviû
(
nvmev_dev
 *
nvmev_vdev
,cÚ¡ *
roÙ
)

118 
nvmev_ns
 *
ns
;

119 
cÚv_ál
 *conv_ftl;

120 
cÚv_ál
 *
cÚv_áls
;

121 
ssd·¿ms
 * 
¥p
;

123 
loff_t
 
f_pos
;

124 
loff_t
 
cur
;

126 
q
,
i
,
»t
;

127 
fže
 *file;

128 
fž’ame
[300];

130 
lše
 * 
Ê
;

131 
lše
 *
cursÜ
, *
Ãxt
;

133 
size
;

134 
·th
…ath;

137 
ns
 = 
nvmev_vdev
->ns;

138 
cÚv_ál
 = (cÚv_áÈ*)
ns
->
áls
;

139 cÚ¡ 
ušt32_t
 
Ä_·¹s
 = 
ns
->nr_parts;

141 
block_deviû
 *
bdev
;

142 
su³r_block
 *
esb
;

143 
fže_sy¡em_ty³
 *
fs_ty³
;

144 
s_size
;

146 
	`´štk
("Save Start\n");

148 
f_pos
 = 0;

150 
	`¥rštf
(
fž’ame
,"%s/%s",
roÙ
,"dumpfile");

151 
fže
 = 
	`fžp_Ý’
(
fž’ame
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
 |
O_LARGEFILE
, 0666);

153 if(
	`IS_ERR
(
fže
)){

154 
	`´štk
("filp_openƒrr!\n");

158 
q
=0; q < 
Ä_·¹s
;q++){

160 
cÚv_áls
 = &
cÚv_ál
[
q
];

162 
¥p
 = &
cÚv_áls
->
ssd
->
¥
;

165 
i
=0; i < 
¥p
->
nchs
;i++){

166 
	`ssd_wr™e_ch
(&(
cÚv_áls
->
ssd
->
ch
[
i
]),
fže
, &
f_pos
);

170 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
wp
,(
wr™e_poš‹r
),&
f_pos
);

171 if(
»t
 < 0){

172 
	`´štk
("Failedo write wp\n");

175 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
wp
.
cu¾še
->
id
,(),&
f_pos
);

176 if(
»t
 < 0){

177 
	`´štk
("Failedo write wp id\n");

181 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
gc_wp
,(
wr™e_poš‹r
),&
f_pos
);

182 if(
»t
 < 0){

183 
	`´štk
("Failedo write gc_wp\n");

186 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
gc_wp
.
cu¾še
->
id
,(),&
f_pos
);

187 if(
»t
 < 0){

188 
	`´štk
("Failedo write gc_wp id\n");

192 
»t
 = 
	`k”Ãl_wr™e
(
fže
,
cÚv_áls
->
m­tbl
,(
µa
è* 
¥p
->
‰_pgs
,&
f_pos
);

193 if(
»t
 < 0){

194 
	`´štk
("Failedo write maptbl\n");

198 
»t
 = 
	`k”Ãl_wr™e
(
fže
,
cÚv_áls
->
rm­
,(
ušt64_t
è* 
¥p
->
‰_pgs
,&
f_pos
);

199 if(
»t
 < 0){

200 
	`´štk
("Failedo write„map\n");

204 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
‰_lšes
,(
ušt32_t
),&
f_pos
);

205 if(
»t
 < 0){

206 
	`´štk
("Failedo writet_lines\n");

210 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
ä“_lše_út
,(
ušt32_t
),&
f_pos
);

211 if(
»t
 < 0){

212 
	`´štk
("Failedo write free_line_cnt\n");

215 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_út
,(
ušt32_t
),&
f_pos
);

216 if(
»t
 < 0){

217 
	`´štk
("Failedo write victim_line_cnt\n");

220 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
fuÎ_lše_út
,(
ušt32_t
),&
f_pos
);

221 if(
»t
 < 0){

222 
	`´štk
("Failedo write full_line_cnt\n");

226 
i
=0;i< 
cÚv_áls
->
lm
.
‰_lšes
;i++){

227 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
lšes
[
i
].
id
,(),&
f_pos
);

228 if(
»t
 < 0){

229 
	`´štk
("Failedo write†ine id\n");

231 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
lšes
[
i
].
c
,(),&
f_pos
);

232 if(
»t
 < 0){

233 
	`´štk
("Failedo write†ine ipc\n");

235 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
lšes
[
i
].
vpc
,(),&
f_pos
);

236 if(
»t
 < 0){

237 
	`´štk
("Failedo write†ine vpc\n");

239 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
lšes
[
i
].
pos
,(
size_t
),&
f_pos
);

240 if(
»t
 < 0){

241 
	`´štk
("Failedo write†ine…os\n");

246 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_pq
->
size
,(
size_t
),&
f_pos
);

247 if(
»t
 < 0){

248 
	`´štk
("Failedo write…q size\n");

250 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_pq
->
avaž
,(
size_t
),&
f_pos
);

251 if(
»t
 < 0){

252 
	`´štk
("Failedo write…q‡vail\n");

254 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_pq
->
¡•
,(
size_t
),&
f_pos
);

255 if(
»t
 < 0){

256 
	`´štk
("Failedo write…q step\n");

259 
i
=1;˜<ð
cÚv_áls
->
lm
.
viùim_lše_út
; i ++){

260 
Ê
 = (
lše
 *)
cÚv_áls
->
lm
.
viùim_lše_pq
->
d
[
i
];

261 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
Ê
->
id
,(),&
f_pos
);

262 if(
»t
 < 0){

263 
	`´štk
("Failedo write victim‡rray id\n");

268 
	`li¡_fÜ_—ch_’Œy_§ã
(
cursÜ
, 
Ãxt
, &
cÚv_áls
->
lm
.
ä“_lše_li¡
, 
’Œy
) {

269 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cursÜ
->
id
,(è,&
f_pos
);

270 if(
»t
 < 0){

271 
	`´štk
("Failedo write free†ine id\n");

276 
	`li¡_fÜ_—ch_’Œy_§ã
(
cursÜ
, 
Ãxt
, &
cÚv_áls
->
lm
.
fuÎ_lše_li¡
, 
’Œy
) {

277 
»t
 = 
	`k”Ãl_wr™e
(
fže
,&
cursÜ
->
id
,(è,&
f_pos
);

278 if(
»t
 < 0){

279 
	`´štk
("Failedo write full†ine id\n");

283 
i
=0; i < 
¥p
->
‰_pgs
; i++){

284 if(
cÚv_áls
->
rm­
[
i
]!=
INVALID_LPN
){

285 
cur
 = 0;

286 
cur
 < 
PAGE_SIZE
){

287 
»t
 = 
	`k”Ãl_wr™e
(
fže
,
nvmev_vdev
->
¡Üage_m­³d
 + (((
cÚv_áls
->
rm­
[
i
]*
Ä_·¹s
 + 
q
)*8è<< 9è+ 
cur
,
PAGE_SIZE
 - cur,&
f_pos
);

288 if(
»t
 < 0){

289 
	`´štk
("Failedo write storage\n");

291 
cur
 +ð
»t
;

296 
	`fžp_þo£
(
fže
,
NULL
);

297 
	`´štk
("Save Done..! Finish!\n");

299 
	}
}

301 
	$ssd_»ad_pg
(
Çnd_·ge
 *
pg
, 
fže
 *fže, 
loff_t
 *
f_pos
){

302 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
pg
->
n£cs
,(),
f_pos
);

303 if(
»t
 < 0){

304 
	`´štk
("Failedo„ead…age‚secs\n");

306 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
pg
->
¡©us
,(),
f_pos
);

307 if(
»t
 < 0){

308 
	`´štk
("Failedo„ead…age status\n");

310 
pg
->
£c
 = 
	`km®loc
((
Çnd_£c_¡©us_t
è*…g->
n£cs
, 
GFP_KERNEL
);

312 
»t
 = 
	`k”Ãl_»ad
(
fže
,
pg
->
£c
,(
Çnd_£c_¡©us_t
)*pg->
n£cs
,
f_pos
);

313 if(
»t
 < 0){

314 
	`´štk
("Failedo„ead…age sec\n");

316 
	}
}

317 
	$ssd_»ad_blk
(
Çnd_block
 *
blk
, 
fže
 *fže, 
loff_t
 *
f_pos
){

318 
i
;

319 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
blk
->
Ågs
,(),
f_pos
);

320 if(
»t
 < 0){

321 
	`´štk
("Failedo„ead block‚pgs\n");

323 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
blk
->
c
,(),
f_pos
);

324 if(
»t
 < 0){

325 
	`´štk
("Failedo„ead block ipc\n");

327 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
blk
->
vpc
,(),
f_pos
);

328 if(
»t
 < 0){

329 
	`´štk
("Failedo„ead block vpc\n");

331 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
blk
->
”a£_út
,(),
f_pos
);

332 if(
»t
 < 0){

333 
	`´štk
("Failedo„ead blockƒrase_cnt\n");

335 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
blk
->
wp
,(),
f_pos
);

336 if(
»t
 < 0){

337 
	`´štk
("Failedo„ead block wp\n");

340 
i
=0; i < 
blk
->
Ågs
; i++){

341 
	`ssd_»ad_pg
(&(
blk
->
pg
[
i
]),
fže
, 
f_pos
);

343 
	}
}

344 
	$ssd_»ad_¶
(
Çnd_¶ªe
 *
¶
, 
fže
 *fže, 
loff_t
 *
f_pos
){

345 
i
;

347  
i
=0; i < 
¶
->
nblks
; i++){

348 
	`ssd_»ad_blk
(&(
¶
->
blk
[
i
]),
fže
, 
f_pos
);

350 
	}
}

351 
	$ssd_»ad_lun
(
Çnd_lun
 *
lun
, 
fže
 *fže, 
loff_t
 *
f_pos
){

352 
i
;

353  
i
=0; i < 
lun
->
Åls
; i++){

354 
	`ssd_»ad_¶
(&(
lun
->
¶
[
i
]),
fže
, 
f_pos
);

356 
	}
}

358 
	$ssd_»ad_ch
(
ssd_chªÃl
 *
ch
, 
ssd·¿ms
 *
¥p
, 
fže
 *fže, 
loff_t
 *
f_pos
){

359 
i
;

361 
i
=0; i < 
ch
->
Æuns
; i++){

362 
	`ssd_»ad_lun
(&(
ch
->
lun
[
i
]),
fže
, 
f_pos
);

364 
	}
}

366 
	$ssd_ä“_pg
(
Çnd_·ge
 *
pg
){

367 
	`kä“
(
pg
->
£c
);

368 
	}
}

369 
	$ssd_ä“_blk
(
Çnd_block
 *
blk
){

370 
i
;

371 
i
=0; i < 
blk
->
Ågs
; i++){

372 
	`ssd_ä“_pg
(&(
blk
->
pg
[
i
]));

374 
	}
}

375 
	$ssd_ä“_¶
(
Çnd_¶ªe
 *
¶
){

376 
i
;

377  
i
=0; i < 
¶
->
nblks
; i++){

378 
	`ssd_ä“_blk
(&(
¶
->
blk
[
i
]));

380 
	}
}

381 
	$ssd_ä“_lun
(
Çnd_lun
 *
lun
){

382 
i
;

383  
i
=0; i < 
lun
->
Åls
; i++){

384 
	`ssd_ä“_¶
(&(
lun
->
¶
[
i
]));

386 
	}
}

388 
	$ssd_ä“_ch
(
ssd_chªÃl
 *
ch
){

389 
i
;

390 
i
=0; i < 
ch
->
Æuns
; i++){

391 
	`ssd_ä“_lun
(&(
ch
->
lun
[
i
]));

393 
	}
}

395 
	$lßd_deviû
(
nvmev_dev
 *
nvmev_vdev
,cÚ¡ * 
roÙ
)

397 
nvmev_ns
 *
ns
;

398 
cÚv_ál
 *conv_ftl;

399 
cÚv_ál
 *
cÚv_áls
;

400 
ssd·¿ms
 * 
¥p
;

402 
loff_t
 
f_pos
;

403 
loff_t
 
cur
;

405 
fže
 *file;

406 
fž’ame
[300];

408 
»t
,
i
,
w
,
q
;

409 
wp_id
,
gc_wp_id
;

410 
id
,
c
,
vpc
,
pos
;

412 * 
¬¿y
;

413 *
ä“_lše_id
;

414 *
fuÎ_lše_id
;

416 
checkšg_wp
;

417 
checkšg_gc_wp
;

419 
size
;

421 
block_deviû
 *
bdev
;

422 
s_size
;

423 
su³r_block
 *
esb
;

424 
fže_sy¡em_ty³
 *
fs_ty³
;

426 
	`´štk
("removehe‡ll items\n");

427 
	`mem£t_io
(
nvmev_vdev
->
¡Üage_m­³d
,0,nvmev_vdev->
cÚfig
.
¡Üage_size
);

429 
ns
 = 
nvmev_vdev
->ns;

430 
cÚv_ál
 = (cÚv_áÈ*)
ns
->
áls
;

431 cÚ¡ 
ušt32_t
 
Ä_·¹s
ð
ns
->nr_parts;

433 
i
 = 0; i < 
Ä_·¹s
; i++){

434 
	`cÚv_»move_ál
(&
cÚv_ál
[
i
]);

437 
	`´štk
("Load Start\n");

439 if(!
nvmev_vdev
->
¡Üage_m­³d
)

440 
	`´štk
("Storage is‚ot correctly mapping\n");

442 
	`´štk
("Storage is collect mapping\n");

444 
f_pos
 =0;

446 
	`¥rštf
(
fž’ame
,"%s/%s",
roÙ
,"dumpfile");

447 
fže
 = 
	`fžp_Ý’
(
fž’ame
, 
O_RDONLY
 |
O_LARGEFILE
, 0666);

449 if(
	`IS_ERR
(
fže
)){

450 
	`´štk
("file don'tƒxist\n");

454 
q
=0; q < 
Ä_·¹s
; q++){

456 
cÚv_áls
 = &
cÚv_ál
[
q
];

458 
	`INIT_LIST_HEAD
(&
cÚv_áls
->
lm
.
ä“_lše_li¡
);

459 
	`INIT_LIST_HEAD
(&
cÚv_áls
->
lm
.
fuÎ_lše_li¡
);

463 
¥p
 = &
cÚv_áls
->
ssd
->
¥
;

465 
w
=0; w<
¥p
->
nchs
;w++){

466 
	`ssd_ä“_ch
(&(
cÚv_áls
->
ssd
->
ch
[
w
]));

469 
w
=0; w<
¥p
->
nchs
;w++){

470 
	`ssd_»ad_ch
(&(
cÚv_áls
->
ssd
->
ch
[
w
]),
¥p
,
fže
, &
f_pos
);

474 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
cÚv_áls
->
wp
,(
wr™e_poš‹r
),&
f_pos
);

475 if(
»t
 < 0){

476 
	`´štk
("Failedo„ead wp\n");

478 
ch_wp
;

479 
lun_wp
;

480 
boÞ
 
check_pošt_chd›
 = 
çl£
;

482 
lun_wp
=0;†un_w°< 
¥p
->
luns_³r_ch
;†un_wp++){

483 
ch_wp
=0; ch_w°< 
¥p
->
nchs
; ch_wp++){

484 
ušt64_t
 
idx
 = 
ch_wp
 * 
¥p
->
luns_³r_ch
 + 
lun_wp
;

485 if(
ch_wp
 =ð
cÚv_áls
->
wp
.
ch
 && 
lun_wp
 =ðcÚv_áls->wp.
lun
)

487 
cÚv_áls
->
·ge_couÁ”
[
idx
] = cÚv_áls->
wp
.
pg
;

488 
check_pošt_chd›
 = 
Œue
;

490 if(!
check_pošt_chd›
){

491 
cÚv_áls
->
·ge_couÁ”
[
idx
] = cÚv_áls->
wp
.
pg
 - (cÚv_áls->wp.pg % 
¥p
->
pgs_³r_ÚeshÙpg
) + spp->pgs_per_oneshotpg;

494 
cÚv_áls
->
·ge_couÁ”
[
idx
] = cÚv_áls->
wp
.
pg
 - (cÚv_áls->wp.pg % 
¥p
->
pgs_³r_ÚeshÙpg
);

500 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
wp_id
,(),&
f_pos
);

501 if(
»t
 < 0){

502 
	`´štk
("Failedo„ead wp id\n");

506 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
cÚv_áls
->
gc_wp
,(
wr™e_poš‹r
),&
f_pos
);

507 if(
»t
 < 0){

508 
	`´štk
("Failedo„ead gc_wp\n");

510 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
gc_wp_id
,(),&
f_pos
);

511 if(
»t
 < 0){

512 
	`´štk
("Failedo„ead gc_wp id\n");

516 
cÚv_áls
->
m­tbl
 = 
	`vm®loc
((
µa
è* 
¥p
->
‰_pgs
);

518 
»t
 = 
	`k”Ãl_»ad
(
fže
,
cÚv_áls
->
m­tbl
,(
µa
è* 
¥p
->
‰_pgs
,&
f_pos
);

519 if(
»t
 < 0){

520 
	`´štk
("Failedo„ead maptbl\n");

524 
cÚv_áls
->
rm­
 = 
	`vm®loc
((
ušt64_t
è* 
¥p
->
‰_pgs
);

526 
»t
 = 
	`k”Ãl_»ad
(
fže
,
cÚv_áls
->
rm­
,(
ušt64_t
è* 
¥p
->
‰_pgs
,&
f_pos
);

527 if(
»t
 < 0){

528 
	`´štk
("Failedo„ead„map\n");

531 
lše_mgmt
 *
lm
 = &
cÚv_áls
->lm;

533 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
lm
->
‰_lšes
,(
ušt32_t
),&
f_pos
);

534 if(
»t
 < 0){

535 
	`´štk
("Failedo„eadt_lines\n");

539 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
lm
->
ä“_lše_út
,(
ušt32_t
),&
f_pos
);

540 if(
»t
 < 0){

541 
	`´štk
("Failedo„ead free†ine cnt\n");

544 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
lm
->
viùim_lše_út
,(
ušt32_t
),&
f_pos
);

545 if(
»t
 < 0){

546 
	`´štk
("Failedo„ead victim†ine cnt\n");

549 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
lm
->
fuÎ_lše_út
,(
ušt32_t
),&
f_pos
);

550 if(
»t
 < 0){

551 
	`´štk
("Failedo„ead full†ine cnt\n");

554 
cÚv_áls
->
lm
.
lšes
ð
	`vm®loc
((
lše
è* cÚv_áls->lm.
‰_lšes
);

556 
i
=0;i< 
cÚv_áls
->
lm
.
‰_lšes
;i++){

557 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
id
,(),&
f_pos
);

558 if(
»t
 < 0){

559 
	`´štk
("Failedo„ead†ine id\n");

561 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
c
,(),&
f_pos
);

562 if(
»t
 < 0){

563 
	`´štk
("Failedo„ead†ine ipc\n");

565 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
vpc
,(),&
f_pos
);

566 if(
»t
 < 0){

567 
	`´štk
("Failedo„ead†ine vpc\n");

569 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
pos
,(
size_t
),&
f_pos
);

570 if(
»t
 < 0){

571 
	`´štk
("Failedo„ead†ine…os\n");

574 
cÚv_áls
->
lm
.
lšes
[
i
]ð(
lše
){

575 .
id
=id,

576 .
c
=ipc,

577 .
vpc
=vpc,

578 .
pos
=pos,

579 .
’Œy
ð
	`LIST_HEAD_INIT
(
cÚv_áls
->
lm
.
lšes
[
i
].entry),

583 
cÚv_áls
->
lm
.
viùim_lše_pq
 = 
	`pqueue_š™
(
¥p
->
‰_lšes
, 
viùim_lše_cmp_´i
, 
viùim_lše_g‘_´i
,

584 
viùim_lše_£t_´i
, 
viùim_lše_g‘_pos
, 
viùim_lše_£t_pos
);

586 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_pq
->
size
,(
size_t
),&
f_pos
);

587 if(
»t
 < 0){

588 
	`´štk
("Failedo„ead…q size\n");

590 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_pq
->
avaž
,(
size_t
),&
f_pos
);

591 if(
»t
 < 0){

592 
	`´štk
("Failedo„ead…q‡vail\n");

594 
»t
 = 
	`k”Ãl_»ad
(
fže
,&
cÚv_áls
->
lm
.
viùim_lše_pq
->
¡•
,(
size_t
),&
f_pos
);

595 if(
»t
 < 0){

596 
	`´štk
("Failedo„ead…q step\n");

599 
¬¿y
 = (*)
	`kz®loc
((è* (
cÚv_áls
->
lm
.
viùim_lše_út
),
GFP_KERNEL
);

600 
»t
 = 
	`k”Ãl_»ad
(
fže
,
¬¿y
,(è* 
cÚv_áls
->
lm
.
viùim_lše_út
,&
f_pos
);

601 if(
»t
 < 0){

602 
	`´štk
("Failedo„ead victim id‡rray\n");

605 
i
=0;˜< 
cÚv_áls
->
lm
.
viùim_lše_út
; i ++){

606 
w
=0; w < 
cÚv_áls
->
lm
.
‰_lšes
;w++){

607 if(
¬¿y
[
i
] =ð
cÚv_áls
->
lm
.
lšes
[
w
].
id
){

608 
	`pqueue_chªge_d©a
(
cÚv_áls
->
lm
.
viùim_lše_pq
,
i
+1,&cÚv_áls->lm.
lšes
[
w
]);

615 
ä“_lše_id
 = 
	`kz®loc
((è* 
cÚv_áls
->
lm
.
ä“_lše_út
,
GFP_KERNEL
);

616 
»t
 = 
	`k”Ãl_»ad
(
fže
,
ä“_lše_id
,(è* 
cÚv_áls
->
lm
.
ä“_lše_út
,&
f_pos
);

617 if(
»t
 < 0){

618 
	`´štk
("Failedo„ead free†ine id‡rray\n");

621 
i
=0; i < 
cÚv_áls
->
lm
.
ä“_lše_út
; i ++){

622 
w
=0; w < 
cÚv_áls
->
lm
.
‰_lšes
; w++){

623 if(
cÚv_áls
->
lm
.
lšes
[
w
].
id
 =ð
ä“_lše_id
[
i
])

625 
	`li¡_add_ž
(&
cÚv_áls
->
lm
.
lšes
[
w
].
’Œy
,&cÚv_áls->lm.
ä“_lše_li¡
);

630 
	`kä“
(
ä“_lše_id
);

633 
fuÎ_lše_id
 = 
	`kz®loc
((è* 
cÚv_áls
->
lm
.
fuÎ_lše_út
,
GFP_KERNEL
);

634 
»t
 = 
	`k”Ãl_»ad
(
fže
,
fuÎ_lše_id
,(è* 
cÚv_áls
->
lm
.
fuÎ_lše_út
,&
f_pos
);

635 if(
»t
 < 0){

636 
	`´štk
("Failedo„ead full†ine id‡rray\n");

639 
i
=0; i < 
cÚv_áls
->
lm
.
fuÎ_lše_út
; i ++){

640 
w
=0;w < 
cÚv_áls
->
lm
.
‰_lšes
; w++){

641 if(
cÚv_áls
->
lm
.
lšes
[
w
].
id
 =ð
fuÎ_lše_id
[
i
]){

642 
	`li¡_add_ž
(&
cÚv_áls
->
lm
.
lšes
[
w
].
’Œy
,&cÚv_áls->lm.
fuÎ_lše_li¡
);

648 
	`kä“
(
fuÎ_lše_id
);

650 
checkšg_wp
 = 0;

651 
checkšg_gc_wp
=0;

653 
i
=0; i < 
cÚv_áls
->
lm
.
‰_lšes
;i++){

654 ifÐ!
checkšg_wp
 && 
wp_id
 =ð
cÚv_áls
->
lm
.
lšes
[
i
].
id
){

655 
cÚv_áls
->
wp
.
cu¾še
 = &(cÚv_áls->
lm
.
lšes
[
i
]);

656 
checkšg_wp
=1;

659 ifÐ!
checkšg_gc_wp
 && 
gc_wp_id
 =ð
cÚv_áls
->
lm
.
lšes
[
i
].
id
){

660 
cÚv_áls
->
gc_wp
.
cu¾še
 = &(cÚv_áls->
lm
.
lšes
[
i
]);

661 
checkšg_gc_wp
=1;

664 if(
checkšg_gc_wp
 && 
checkšg_wp
)

669 
i
=0; i < 
¥p
->
‰_pgs
; i++){

670 if(
cÚv_áls
->
rm­
[
i
]!=
INVALID_LPN
){

671 
cur
 = 0;

672 
cur
 < 
PAGE_SIZE
){

673 
»t
 = 
	`k”Ãl_»ad
(
fže
,
nvmev_vdev
->
¡Üage_m­³d
 + (((
cÚv_áls
->
rm­
[
i
]*
Ä_·¹s
+
q
)*8è<< 9è+ 
cur
,
PAGE_SIZE
 - cur,&
f_pos
);

674 if(
»t
 < 0){

675 
	`´štk
("Failedo write storage\n");

677 
cur
 +ð
»t
;

682 
	`fžp_þo£
(
fže
, 
NULL
);

683 
	`´štk
("Load Done..! Finish!\n");

687 
	}
}

	@save_load.h

1 #iâdeà
_NVMEVIRT_TOY_H


2 
	#_NVMEVIRT_TOY_H


	)

4 
	~"nvmev.h
"

5 
	~"cÚv_ál.h
"

6 
	~"ssd.h
"

7 
	~"pqueue/pqueue.h
"

9 
SAVE_LOAD_INIT
(
nvmev
 *‚vmev);

10 
§ve_deviû
(
nvmev_dev
 *
nvmev_vdev
, cÚ¡ * 
roÙ
);

11 
lßd_deviû
(
nvmev_dev
 *
nvmev_vdev
, cÚ¡ * 
roÙ
);

12 
SAVE_LOAD_EXIT
();

	@simple_ftl.c

3 
	~<lšux/ktime.h
>

4 
	~<lšux/sched/þock.h
>

6 
	~"nvmev.h
"

8 
šlše
 
	$__g‘_w®lþock
(
nvmev_dev
 *
nvmev_vdev
)

10  
	`ýu_þock
(
nvmev_vdev
->
cÚfig
.
ýu_Ä_di¥©ch”
);

11 
	}
}

13 
size_t
 
	$__cmd_io_size
(
nvme_rw_commªd
 *
cmd
)

15 
	`NVMEV_DEBUG_VERBOSE
("[%c] %llu + %d,…rp %llx %llx\n",

16 
cmd
->
Ýcode
 =ð
nvme_cmd_wr™e
 ? 'W' : 'R', cmd->
¦ba
, cmd->
Ëngth
,

17 
cmd
->
´p1
, cmd->
´p2
);

19  (
cmd
->
Ëngth
 + 1) << 9;

20 
	}
}

23 
	$__scheduË_io_un™s
(
Ýcode
, 
lba
, 
Ëngth
,

24 
n£cs_¡¬t
,

25 
nvmev_dev
 *
nvmev_vdev
)

27 
io_un™_size
 = 1 << 
nvmev_vdev
->
cÚfig
.
io_un™_shiá
;

28 
io_un™
 =

29 (
lba
 >> (
nvmev_vdev
->
cÚfig
.
io_un™_shiá
 - 9)è%‚vmev_vdev->cÚfig.
Ä_io_un™s
;

30 
Ä_io_un™s
 = 
	`mš
(
nvmev_vdev
->
cÚfig
.Ä_io_un™s, 
	`DIV_ROUND_UP
(
Ëngth
, 
io_un™_size
));

32 
Ï‹¡
;

33 
d–ay
 = 0;

34 
Ï‹ncy
 = 0;

35 
Œažšg
 = 0;

37 ià(
Ýcode
 =ð
nvme_cmd_wr™e
) {

38 
d–ay
 = 
nvmev_vdev
->
cÚfig
.
wr™e_d–ay
;

39 
Ï‹ncy
 = 
nvmev_vdev
->
cÚfig
.
wr™e_time
;

40 
Œažšg
 = 
nvmev_vdev
->
cÚfig
.
wr™e_Œažšg
;

41 } ià(
Ýcode
 =ð
nvme_cmd_»ad
) {

42 
d–ay
 = 
nvmev_vdev
->
cÚfig
.
»ad_d–ay
;

43 
Ï‹ncy
 = 
nvmev_vdev
->
cÚfig
.
»ad_time
;

44 
Œažšg
 = 
nvmev_vdev
->
cÚfig
.
»ad_Œažšg
;

47 
Ï‹¡
 = 
	`max
(
n£cs_¡¬t
, 
nvmev_vdev
->
io_un™_¡©
[
io_un™
]è+ 
d–ay
;

50 
Ï‹¡
 +ð
Ï‹ncy
;

51 
nvmev_vdev
->
io_un™_¡©
[
io_un™
] = 
Ï‹¡
;

53 ià(
Ä_io_un™s
-- > 0) {

54 
nvmev_vdev
->
io_un™_¡©
[
io_un™
] +ð
Œažšg
;

57 
Ëngth
 -ð
	`mš
Ö’gth, 
io_un™_size
);

58 ià(++
io_un™
 >ð
nvmev_vdev
->
cÚfig
.
Ä_io_un™s
)

59 
io_un™
 = 0;

60 } 
Ëngth
 > 0);

62  
Ï‹¡
;

63 
	}
}

65 
	$__scheduË_æush
(
nvmev_»que¡
 *
»q
, 
nvmev_dev
 *
nvmev_vdev
)

67 
Ï‹¡
 = 0;

68 
i
;

70 
i
 = 0; i < 
nvmev_vdev
->
cÚfig
.
Ä_io_un™s
; i++) {

71 
Ï‹¡
 = 
	`max
Ö©e¡, 
nvmev_vdev
->
io_un™_¡©
[
i
]);

74  
Ï‹¡
;

75 
	}
}

77 
boÞ
 
	$sim¶e_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
,

78 
nvmev_»suÉ
 *
»t
, 
nvmev_dev
 *
nvmev_vdev
)

80 
nvme_commªd
 *
cmd
 = 
»q
->cmd;

82 
	`BUG_ON
(
ns
->
csi
 !ð
NVME_CSI_NVM
);

83 
	`BUG_ON
(
BASE_SSD
 !ð
INTEL_OPTANE
 && BASE_SSD !ð
MI
);

85 
cmd
->
commÚ
.
Ýcode
) {

86 
nvme_cmd_wr™e
:

87 
nvme_cmd_»ad
:

88 
»t
->
n£cs_rg‘
 =

89 
	`__scheduË_io_un™s
(
cmd
->
commÚ
.
Ýcode
, cmd->
rw
.
¦ba
,

90 
	`__cmd_io_size
((
nvme_rw_commªd
 *)
cmd
),

91 
	`__g‘_w®lþock
(
nvmev_vdev
),‚vmev_vdev);

93 
nvme_cmd_æush
:

94 
»t
->
n£cs_rg‘
 = 
	`__scheduË_æush
(
»q
, 
nvmev_vdev
);

97 
	`NVMEV_ERROR
("%s: commªd‚Ù im¶em’‹d: % (0x%x)\n", 
__func__
,

98 
	`nvme_Ýcode_¡ršg
(
cmd
->
commÚ
.
Ýcode
), cmd->common.opcode);

102  
Œue
;

103 
	}
}

105 
	$sim¶e_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

106 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
)

108 
ns
->
id
 = id;

109 
ns
->
csi
 = 
NVME_CSI_NVM
;

110 
ns
->
size
 = size;

111 
ns
->
m­³d
 = 
m­³d_addr
;

112 
ns
->
´oc_io_cmd
 = 
sim¶e_´oc_nvme_io_cmd
;

115 
	}
}

117 
	$sim¶e_»move_Çme¥aû
(
nvmev_ns
 *
ns
)

120 
	}
}

	@simple_ftl.h

3 #iâdeà
_NVMEVIRT_SIMPLE_FTL_H


4 
	#_NVMEVIRT_SIMPLE_FTL_H


	)

6 
	~"nvmev.h
"

8 
	ssim¶e_ál
 {

9 
ssd
 *
	mssd
;

12 
boÞ
 
sim¶e_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
,

13 
nvmev_»suÉ
 *
»t
);

14 
sim¶e_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

15 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
);

16 
sim¶e_»move_Çme¥aû
(
nvmev_ns
 *
ns
);

	@ssd.c

3 
	~<lšux/ktime.h
>

4 
	~<lšux/sched/þock.h
>

5 
	~<lšux/mšmax.h
>

7 
	~"nvmev.h
"

8 
	~"ssd.h
"

10 
šlše
 
ušt64_t
 
	$__g‘_ioþock
(
ssd
 *ssd)

12  
	`ýu_þock
(
ssd
->
ýu_Ä_di¥©ch”
);

13 
	}
}

15 
	$bufãr_š™
(
bufãr
 *
buf
, 
size_t
 
size
)

17 
	`¥š_lock_š™
(&
buf
->
lock
);

18 
buf
->
size
 = size;

19 
buf
->
»maššg
 = 
size
;

20 
	}
}

22 
ušt32_t
 
	$bufãr_®loÿ‹
(
bufãr
 *
buf
, 
size_t
 
size
)

24 !
	`¥š_Œylock
(&
buf
->
lock
)) {

25 
	`ýu_»Ïx
();

28 ià(
buf
->
»maššg
 < 
size
) {

29 
size
 = 0;

32 
buf
->
»maššg
 -ð
size
;

34 
	`¥š_uÆock
(&
buf
->
lock
);

35  
size
;

36 
	}
}

38 
boÞ
 
	$bufãr_»Ëa£
(
bufãr
 *
buf
, 
size_t
 
size
)

40 !
	`¥š_Œylock
(&
buf
->
lock
))

42 
buf
->
»maššg
 +ð
size
;

43 
	`¥š_uÆock
(&
buf
->
lock
);

45  
Œue
;

46 
	}
}

48 
	$bufãr_»fžl
(
bufãr
 *
buf
)

50 !
	`¥š_Œylock
(&
buf
->
lock
))

52 
buf
->
»maššg
 = buf->
size
;

53 
	`¥š_uÆock
(&
buf
->
lock
);

54 
	}
}

56 
	$check_·¿ms
(
ssd·¿ms
 *
¥p
)

65 
	}
}

67 
	$ssd_š™_·¿ms
(
ssd·¿ms
 *
¥p
, 
ušt64_t
 
ÿ·c™y
, 
ušt32_t
 
Å¬ts
,

68 
ál_cÚfigs
 *
ál_cfgs
)

70 
ušt64_t
 
blk_size
, 
tÙ®_size
;

71 
ONESHOT_PAGE_SIZE
 = 
ál_cfgs
->ONESHOT_PAGE_SIZE;

72 
FLASH_PAGE_SIZE
 = 
ál_cfgs
->FLASH_PAGE_SIZE;

74 
¥p
->
max_cÚ
=
ál_cfgs
->max_con;

76 
¥p
->
£csz
 = 512;

77 
¥p
->
£cs_³r_pg
 = 8;

78 
¥p
->
pgsz
 = sµ->
£csz
 * sµ->
£cs_³r_pg
;

80 
¥p
->
nchs
 = 
ál_cfgs
->
NAND_CHANNELS
;

81 
¥p
->
¶s_³r_lun
 = 
ál_cfgs
->
PLNS_PER_LUN
;

82 
¥p
->
luns_³r_ch
 = 
ál_cfgs
->
LUNS_PER_NAND_CH
;

83 
¥p
->
ûÎ_mode
 = 
ál_cfgs
->
CELL_MODE
;

86 
	`NVMEV_ASSERT
((
¥p
->
nchs
 % 
Å¬ts
) == 0);

87 
¥p
->
nchs
 /ð
Å¬ts
;

88 
ÿ·c™y
 /ð
Å¬ts
;

90 ià(
ál_cfgs
->
BLKS_PER_PLN
 > 0) {

92 
¥p
->
blks_³r_¶
 = 
ál_cfgs
->
BLKS_PER_PLN
;

93 
blk_size
 = 
	`DIV_ROUND_UP
(
ÿ·c™y
, 
¥p
->
blks_³r_¶
 * sµ->
¶s_³r_lun
 *

94 
¥p
->
luns_³r_ch
 * sµ->
nchs
);

96 
	`NVMEV_ASSERT
(
ál_cfgs
->
BLK_SIZE
 > 0);

97 
blk_size
 = 
ál_cfgs
->
BLK_SIZE
;

98 
¥p
->
blks_³r_¶
 = 
	`DIV_ROUND_UP
(
ÿ·c™y
, 
blk_size
 * sµ->
¶s_³r_lun
 *

99 
¥p
->
luns_³r_ch
 * sµ->
nchs
);

102 
	`NVMEV_ASSERT
((
ONESHOT_PAGE_SIZE
 % 
¥p
->
pgsz
è=ð0 && (
FLASH_PAGE_SIZE
 % spp->pgsz) == 0);

103 
	`NVMEV_ASSERT
((
ONESHOT_PAGE_SIZE
 % 
FLASH_PAGE_SIZE
) == 0);

105 
¥p
->
pgs_³r_ÚeshÙpg
 = 
ONESHOT_PAGE_SIZE
 / (¥p->
pgsz
);

106 
¥p
->
ÚeshÙpgs_³r_blk
 = 
	`DIV_ROUND_UP
(
blk_size
, 
ONESHOT_PAGE_SIZE
);

108 
¥p
->
pgs_³r_æashpg
 = 
FLASH_PAGE_SIZE
 / (¥p->
pgsz
);

109 
¥p
->
æashpgs_³r_blk
 = (
ONESHOT_PAGE_SIZE
 / 
FLASH_PAGE_SIZE
è* sµ->
ÚeshÙpgs_³r_blk
;

111 
¥p
->
pgs_³r_blk
 = sµ->
pgs_³r_ÚeshÙpg
 * sµ->
ÚeshÙpgs_³r_blk
;

113 
¥p
->
wr™e_un™_size
 = 
ál_cfgs
->
WRITE_UNIT_SIZE
;

115 
¥p
->
pg_4kb_rd_Ït
[
CELL_TYPE_LSB
] = 
ál_cfgs
->
NAND_4KB_READ_LATENCY_LSB
;

116 
¥p
->
pg_4kb_rd_Ït
[
CELL_TYPE_MSB
] = 
ál_cfgs
->
NAND_4KB_READ_LATENCY_MSB
;

117 
¥p
->
pg_4kb_rd_Ït
[
CELL_TYPE_CSB
] = 
ál_cfgs
->
NAND_4KB_READ_LATENCY_CSB
;

118 
¥p
->
pg_rd_Ït
[
CELL_TYPE_LSB
] = 
ál_cfgs
->
NAND_READ_LATENCY_LSB
;

119 
¥p
->
pg_rd_Ït
[
CELL_TYPE_MSB
] = 
ál_cfgs
->
NAND_READ_LATENCY_MSB
;

120 
¥p
->
pg_rd_Ït
[
CELL_TYPE_CSB
] = 
ál_cfgs
->
NAND_READ_LATENCY_CSB
;

121 
¥p
->
pg_wr_Ït
 = 
ál_cfgs
->
NAND_PROG_LATENCY
;

122 
¥p
->
blk_”_Ït
 = 
ál_cfgs
->
NAND_ERASE_LATENCY
;

123 
¥p
->
max_ch_xãr_size
 = 
ál_cfgs
->
MAX_CH_XFER_SIZE
;

125 
¥p
->
fw_4kb_rd_Ït
 = 
ál_cfgs
->
FW_4KB_READ_LATENCY
;

126 
¥p
->
fw_rd_Ït
 = 
ál_cfgs
->
FW_READ_LATENCY
;

127 
¥p
->
fw_ch_xãr_Ït
 = 
ál_cfgs
->
FW_CH_XFER_LATENCY
;

128 
¥p
->
fw_wbuf_Ït0
 = 
ál_cfgs
->
FW_WBUF_LATENCY0
;

129 
¥p
->
fw_wbuf_Ït1
 = 
ál_cfgs
->
FW_WBUF_LATENCY1
;

131 
¥p
->
ch_bªdwidth
 = 
ál_cfgs
->
NAND_CHANNEL_BANDWIDTH
;

132 
¥p
->
pc›_bªdwidth
 = 
ál_cfgs
->
PCIE_BANDWIDTH
;

134 
¥p
->
wr™e_bufãr_size
 = 
ál_cfgs
->
GLOBAL_WB_SIZE
;

135 
¥p
->
wr™e_—¾y_com¶‘iÚ
 = 
ál_cfgs
->
WRITE_EARLY_COMPLETION
;

138 
¥p
->
£cs_³r_blk
 = sµ->
£cs_³r_pg
 * sµ->
pgs_³r_blk
;

139 
¥p
->
£cs_³r_¶
 = sµ->
£cs_³r_blk
 * sµ->
blks_³r_¶
;

140 
¥p
->
£cs_³r_lun
 = sµ->
£cs_³r_¶
 * sµ->
¶s_³r_lun
;

141 
¥p
->
£cs_³r_ch
 = sµ->
£cs_³r_lun
 * sµ->
luns_³r_ch
;

142 
¥p
->
‰_£cs
 = sµ->
£cs_³r_ch
 * sµ->
nchs
;

144 
¥p
->
pgs_³r_¶
 = sµ->
pgs_³r_blk
 * sµ->
blks_³r_¶
;

145 
¥p
->
pgs_³r_lun
 = sµ->
pgs_³r_¶
 * sµ->
¶s_³r_lun
;

146 
¥p
->
pgs_³r_ch
 = sµ->
pgs_³r_lun
 * sµ->
luns_³r_ch
;

147 
¥p
->
‰_pgs
 = sµ->
pgs_³r_ch
 * sµ->
nchs
;

149 
¥p
->
blks_³r_lun
 = sµ->
blks_³r_¶
 * sµ->
¶s_³r_lun
;

150 
¥p
->
blks_³r_ch
 = sµ->
blks_³r_lun
 * sµ->
luns_³r_ch
;

151 
¥p
->
‰_blks
 = sµ->
blks_³r_ch
 * sµ->
nchs
;

153 
¥p
->
¶s_³r_ch
 = sµ->
¶s_³r_lun
 * sµ->
luns_³r_ch
;

154 
¥p
->
‰_¶s
 = sµ->
¶s_³r_ch
 * sµ->
nchs
;

156 
¥p
->
‰_luns
 = sµ->
luns_³r_ch
 * sµ->
nchs
;

159 
¥p
->
blks_³r_lše
 = sµ->
‰_luns
;

160 
¥p
->
pgs_³r_lše
 = sµ->
blks_³r_lše
 * sµ->
pgs_³r_blk
;

161 
¥p
->
£cs_³r_lše
 = sµ->
pgs_³r_lše
 * sµ->
£cs_³r_pg
;

162 
¥p
->
‰_lšes
 = sµ->
blks_³r_lun
;

165 
	`check_·¿ms
(
¥p
);

167 
tÙ®_size
 = ()
¥p
->
‰_luns
 * sµ->
blks_³r_lun
 * sµ->
pgs_³r_blk
 *

168 
¥p
->
£csz
 * sµ->
£cs_³r_pg
;

169 
blk_size
 = 
¥p
->
pgs_³r_blk
 * sµ->
£csz
 * sµ->
£cs_³r_pg
;

171 
	`NVMEV_INFO
(

173 
	`BYTE_TO_GB
(
tÙ®_size
), 
	`BYTE_TO_MB
ÑÙ®_size), 
¥p
->
nchs
, sµ->
‰_luns
,

174 
¥p
->
‰_lšes
, 
	`BYTE_TO_MB
(¥p->
pgs_³r_blk
 * sµ->
pgsz
),

175 
	`BYTE_TO_KB
(
¥p
->
pgs_³r_blk
 * sµ->
pgsz
), 
	`BYTE_TO_MB
(¥p->
pgs_³r_lše
 * spp->pgsz),

176 
	`BYTE_TO_KB
(
¥p
->
pgs_³r_lše
 * sµ->
pgsz
));

177 
	}
}

179 
	$ssd_š™_Çnd_·ge
(
Çnd_·ge
 *
pg
, 
ssd·¿ms
 *
¥p
)

181 
i
;

182 
pg
->
n£cs
 = 
¥p
->
£cs_³r_pg
;

183 
pg
->
£c
 = 
	`km®loc
((
Çnd_£c_¡©us_t
è*…g->
n£cs
, 
GFP_KERNEL
);

184 
i
 = 0; i < 
pg
->
n£cs
; i++) {

185 
pg
->
£c
[
i
] = 
SEC_FREE
;

187 
pg
->
¡©us
 = 
PG_FREE
;

188 
	}
}

190 
	$ssd_»move_Çnd_·ge
(
Çnd_·ge
 *
pg
)

192 
	`kä“
(
pg
->
£c
);

193 
	}
}

195 
	$ssd_š™_Çnd_blk
(
Çnd_block
 *
blk
, 
ssd·¿ms
 *
¥p
)

197 
i
;

198 
blk
->
Ågs
 = 
¥p
->
pgs_³r_blk
;

199 
blk
->
pg
 = 
	`km®loc
((
Çnd_·ge
è* blk->
Ågs
, 
GFP_KERNEL
);

200 
i
 = 0; i < 
blk
->
Ågs
; i++) {

201 
	`ssd_š™_Çnd_·ge
(&
blk
->
pg
[
i
], 
¥p
);

203 
blk
->
c
 = 0;

204 
blk
->
vpc
 = 0;

205 
blk
->
”a£_út
 = 0;

206 
blk
->
wp
 = 0;

207 
	}
}

209 
	$ssd_»move_Çnd_blk
(
Çnd_block
 *
blk
)

211 
i
;

213 
i
 = 0; i < 
blk
->
Ågs
; i++)

214 
	`ssd_»move_Çnd_·ge
(&
blk
->
pg
[
i
]);

216 
	`kä“
(
blk
->
pg
);

217 
	}
}

219 
	$ssd_š™_Çnd_¶ªe
(
Çnd_¶ªe
 *
¶
, 
ssd·¿ms
 *
¥p
)

221 
i
;

222 
¶
->
nblks
 = 
¥p
->
blks_³r_¶
;

223 
¶
->
blk
 = 
	`km®loc
((
Çnd_block
è*…l->
nblks
, 
GFP_KERNEL
);

224 
i
 = 0; i < 
¶
->
nblks
; i++) {

225 
	`ssd_š™_Çnd_blk
(&
¶
->
blk
[
i
], 
¥p
);

227 
	}
}

229 
	$ssd_»move_Çnd_¶ªe
(
Çnd_¶ªe
 *
¶
)

231 
i
;

233 
i
 = 0; i < 
¶
->
nblks
; i++)

234 
	`ssd_»move_Çnd_blk
(&
¶
->
blk
[
i
]);

236 
	`kä“
(
¶
->
blk
);

237 
	}
}

239 
	$ssd_š™_Çnd_lun
(
Çnd_lun
 *
lun
, 
ssd·¿ms
 *
¥p
)

241 
i
;

242 
lun
->
Åls
 = 
¥p
->
¶s_³r_lun
;

243 
lun
->
¶
 = 
	`km®loc
((
Çnd_¶ªe
è*†un->
Åls
, 
GFP_KERNEL
);

244 
i
 = 0; i < 
lun
->
Åls
; i++) {

245 
	`ssd_š™_Çnd_¶ªe
(&
lun
->
¶
[
i
], 
¥p
);

247 
lun
->
Ãxt_lun_avaž_time
 = 0;

248 
lun
->
busy
 = 
çl£
;

249 
lun
->
fœ¡_io
=
Œue
;

250 
	}
}

252 
	$ssd_»move_Çnd_lun
(
Çnd_lun
 *
lun
)

254 
i
;

256 
i
 = 0; i < 
lun
->
Åls
; i++)

257 
	`ssd_»move_Çnd_¶ªe
(&
lun
->
¶
[
i
]);

259 
	`kä“
(
lun
->
¶
);

260 
	}
}

262 
	$ssd_š™_ch
(
ssd_chªÃl
 *
ch
, 
ssd·¿ms
 *
¥p
)

264 
i
;

265 
ch
->
Æuns
 = 
¥p
->
luns_³r_ch
;

266 
ch
->
lun
 = 
	`km®loc
((
Çnd_lun
è* ch->
Æuns
, 
GFP_KERNEL
);

267 
i
 = 0; i < 
ch
->
Æuns
; i++) {

268 
	`ssd_š™_Çnd_lun
(&
ch
->
lun
[
i
], 
¥p
);

271 
ch
->
³rf_mod–
 = 
	`km®loc
((
chªÃl_mod–
), 
GFP_KERNEL
);

272 
	`chmod–_š™
(
ch
->
³rf_mod–
, 
¥p
->
ch_bªdwidth
);

275 
ch
->
³rf_mod–
->
xãr_Ït
 +ð(
¥p
->
fw_ch_xãr_Ït
 * 
UNIT_XFER_SIZE
 / 
	`KB
(4));

276 
	}
}

278 
	$ssd_»move_ch
(
ssd_chªÃl
 *
ch
)

280 
i
;

282 
	`kä“
(
ch
->
³rf_mod–
);

284 
i
 = 0; i < 
ch
->
Æuns
; i++)

285 
	`ssd_»move_Çnd_lun
(&
ch
->
lun
[
i
]);

287 
	`kä“
(
ch
->
lun
);

288 
	}
}

290 
	$ssd_š™_pc›
(
ssd_pc›
 *
pc›
, 
ssd·¿ms
 *
¥p
)

292 
pc›
->
³rf_mod–
 = 
	`km®loc
((
chªÃl_mod–
), 
GFP_KERNEL
);

293 
	`chmod–_š™
(
pc›
->
³rf_mod–
, 
¥p
->
pc›_bªdwidth
);

294 
	}
}

296 
	$ssd_»move_pc›
(
ssd_pc›
 *
pc›
)

298 
	`kä“
(
pc›
->
³rf_mod–
);

299 
	}
}

301 
	$ssd_š™
(
ssd
 *ssd, 
ssd·¿ms
 *
¥p
, 
ušt32_t
 
ýu_Ä_di¥©ch”
)

303 
ušt32_t
 
i
;

305 
ssd
->
¥
 = *
¥p
;

308 
ssd
->
ch
 = 
	`km®loc
((
ssd_chªÃl
è* 
¥p
->
nchs
, 
GFP_KERNEL
);

309 
i
 = 0; i < 
¥p
->
nchs
; i++) {

310 
	`ssd_š™_ch
(&(
ssd
->
ch
[
i
]), 
¥p
);

314 
ssd
->
ýu_Ä_di¥©ch”
 = cpu_nr_dispatcher;

316 
ssd
->
pc›
 = 
	`km®loc
((
ssd_pc›
), 
GFP_KERNEL
);

317 
	`ssd_š™_pc›
(
ssd
->
pc›
, 
¥p
);

319 
ssd
->
wr™e_bufãr
 = 
	`km®loc
((
bufãr
), 
GFP_KERNEL
);

320 
	`bufãr_š™
(
ssd
->
wr™e_bufãr
, 
¥p
->
wr™e_bufãr_size
);

323 
	}
}

325 
	$ssd_»move
(
ssd
 *ssd)

327 
ušt32_t
 
i
;

329 
	`kä“
(
ssd
->
wr™e_bufãr
);

330 ià(
ssd
->
pc›
) {

331 
	`kä“
(
ssd
->
pc›
->
³rf_mod–
);

332 
	`kä“
(
ssd
->
pc›
);

335 
i
 = 0; i < 
ssd
->
¥
.
nchs
; i++) {

336 
	`ssd_»move_ch
(&(
ssd
->
ch
[
i
]));

339 
	`kä“
(
ssd
->
ch
);

340 
	}
}

342 
ušt64_t
 
	$ssd_advªû_pc›
(
ssd
 *ssd, 
ušt64_t
 
»que¡_time
, ušt64_ˆ
Ëngth
)

344 
chªÃl_mod–
 *
³rf_mod–
 = 
ssd
->
pc›
->perf_model;

345  
	`chmod–_»que¡
(
³rf_mod–
, 
»que¡_time
, 
Ëngth
, 
ssd
->
p_ns
->
p_dev
);

346 
	}
}

347 
ušt64_t
 
	$ssd_advªû_pc›_cÝy
(
ssd
 *ssd, 
ušt64_t
 
»que¡_time
, ušt64_ˆ
Ëngth
)

349 
chªÃl_mod–
 *
³rf_mod–
 = 
ssd
->
pc›
->perf_model;

350  
	`chmod–_»que¡_cÝy
(
³rf_mod–
, 
»que¡_time
, 
Ëngth
, 
ssd
->
p_ns
->
p_dev
);

351 
	}
}

360 
ušt64_t
 
	$ssd_advªû_wr™e_bufãr
(
ssd
 *ssd, 
ušt64_t
 
»que¡_time
, ušt64_ˆ
Ëngth
,

361 
Œªsãr_size_KB
)

363 
ušt64_t
 
n£cs_Ï‹¡
 = 
»que¡_time
;

364 
ssd·¿ms
 *
¥p
 = &
ssd
->
¥
;

366 
n£cs_Ï‹¡
 +ð
¥p
->
fw_wbuf_Ït0
;

367 
n£cs_Ï‹¡
 +ð
¥p
->
fw_wbuf_Ït1
 * 
	`DIV_ROUND_UP
(
Ëngth
, 
	`KB
(
Œªsãr_size_KB
));

369 
n£cs_Ï‹¡
 = 
	`ssd_advªû_pc›
(
ssd
,‚£cs_Ï‹¡, 
Ëngth
);

371  
n£cs_Ï‹¡
;

372 
	}
}

374 
ušt64_t
 
	$ssd_advªû_Çnd
(
ssd
 *ssd, 
Çnd_cmd
 *
ncmd
)

376 
c
 = 
ncmd
->
cmd
;

377 
ušt64_t
 
cmd_¡ime
 = (
ncmd
->
¡ime
 =ð0è? 
	`__g‘_ioþock
(
ssd
) :‚cmd->stime;

378 
ušt64_t
 
Çnd_¡ime
, 
Çnd_‘ime
;

379 
ušt64_t
 
chÆ_¡ime
, 
chÆ_‘ime
;

380 
ušt64_t
 
»maššg
, 
xãr_size
, 
com¶‘ed_time
;

381 
ssd·¿ms
 *
¥p
;

382 
Çnd_lun
 *
lun
;

383 
ssd_chªÃl
 *
ch
;

384 
µa
 *µ¨ð
ncmd
->ppa;

385 
ušt32_t
 
ûÎ
;

386 
	`NVMEV_DEBUG
(

388 
ssd
, 
ncmd
->
¡ime
, 
µa
->
g
.
ch
,…·->g.
lun
,…·->g.
blk
,…·->g.
pg
, 
c
,…pa->ppa);

390 ià(
µa
->µ¨=ð
UNMAPPED_PPA
) {

391 
	`NVMEV_ERROR
("E¼Ü…· 0x%Îx\n", 
µa
->ppa);

392  
cmd_¡ime
;

395 
¥p
 = &
ssd
->
¥
;

396 
lun
 = 
	`g‘_lun
(
ssd
, 
µa
);

397 
ch
 = 
	`g‘_ch
(
ssd
, 
µa
);

398 
ûÎ
 = 
	`g‘_ûÎ
(
ssd
, 
µa
);

399 
»maššg
 = 
ncmd
->
xãr_size
;

401 
c
) {

402 
NAND_READ
:

404 
Çnd_¡ime
 = 
	`max
(
lun
->
Ãxt_lun_avaž_time
, 
cmd_¡ime
);

407 if(
ssd
->
checkšg
 && !
lun
->
fœ¡_io
){

408 
ušt64_t
 
d–ay
 = 
Çnd_¡ime
 - 
cmd_¡ime
;

409 if(
d–ay
 > 0){

410 
ssd
->
ch_d›_couÁ”
++;

411 
ssd
->
ch_d›_Ï‹ncy
+ð
d–ay
;

413 
lun
->
fœ¡_io
=
Œue
;

418 ià(
ncmd
->
xãr_size
 == 4096) {

419 
Çnd_‘ime
 = 
Çnd_¡ime
 + 
¥p
->
pg_4kb_rd_Ït
[
ûÎ
];

421 
Çnd_‘ime
 = 
Çnd_¡ime
 + 
¥p
->
pg_rd_Ït
[
ûÎ
];

425 
chÆ_¡ime
 = 
Çnd_‘ime
;

427 
»maššg
) {

428 
xãr_size
 = 
	`mš
(
»maššg
, (
ušt64_t
)
¥p
->
max_ch_xãr_size
);

429 
chÆ_‘ime
 = 
	`chmod–_»que¡
(
ch
->
³rf_mod–
, 
chÆ_¡ime
, 
xãr_size
,

430 
ssd
->
p_ns
->
p_dev
);

432 ià(
ncmd
->
š‹¾—ve_pci_dma
) {

433 
com¶‘ed_time
 = 
	`ssd_advªû_pc›
(
ssd
, 
chÆ_‘ime
, 
xãr_size
);

435 
com¶‘ed_time
 = 
chÆ_‘ime
;

438 
»maššg
 -ð
xãr_size
;

439 
chÆ_¡ime
 = 
chÆ_‘ime
;

442 
lun
->
Ãxt_lun_avaž_time
 = 
chÆ_‘ime
;

445 
NAND_WRITE
:

447 
chÆ_¡ime
 = 
	`max
(
lun
->
Ãxt_lun_avaž_time
, 
cmd_¡ime
);

449 
chÆ_‘ime
 = 
	`chmod–_»que¡
(
ch
->
³rf_mod–
, 
chÆ_¡ime
, 
ncmd
->
xãr_size
,

450 
ssd
->
p_ns
->
p_dev
);

453 
Çnd_¡ime
 = 
chÆ_‘ime
;

454 
Çnd_‘ime
 = 
Çnd_¡ime
 + 
¥p
->
pg_wr_Ït
;

455 
lun
->
Ãxt_lun_avaž_time
 = 
Çnd_‘ime
;

456 
com¶‘ed_time
 = 
Çnd_‘ime
;

459 
NAND_ERASE
:

461 
Çnd_¡ime
 = 
	`max
(
lun
->
Ãxt_lun_avaž_time
, 
cmd_¡ime
);

462 
Çnd_‘ime
 = 
Çnd_¡ime
 + 
¥p
->
blk_”_Ït
;

463 
lun
->
Ãxt_lun_avaž_time
 = 
Çnd_‘ime
;

464 
com¶‘ed_time
 = 
Çnd_‘ime
;

467 
NAND_NOP
:

469 
Çnd_¡ime
 = 
	`max
(
lun
->
Ãxt_lun_avaž_time
, 
cmd_¡ime
);

470 
lun
->
Ãxt_lun_avaž_time
 = 
Çnd_¡ime
;

471 
com¶‘ed_time
 = 
Çnd_¡ime
;

475 
	`NVMEV_ERROR
("UnsuµÜ‹d NAND commªd: 0x%x\n", 
c
);

479  
com¶‘ed_time
;

480 
	}
}

482 
ušt64_t
 
	$ssd_Ãxt_idË_time
(
ssd
 *ssd)

484 
ssd·¿ms
 *
¥p
 = &
ssd
->
¥
;

485 
ušt32_t
 
i
, 
j
;

486 
ušt64_t
 
Ï‹¡
 = 
	`__g‘_ioþock
(
ssd
);

488 
i
 = 0; i < 
¥p
->
nchs
; i++) {

489 
ssd_chªÃl
 *
ch
 = &
ssd
->ch[
i
];

491 
j
 = 0; j < 
¥p
->
luns_³r_ch
; j++) {

492 
Çnd_lun
 *
lun
 = &
ch
->lun[
j
];

493 
Ï‹¡
 = 
	`max
Ö©e¡, 
lun
->
Ãxt_lun_avaž_time
);

497  
Ï‹¡
;

498 
	}
}

499 
ušt64_t
 
	$max_c¡ime_vs_ioþock
(
ušt64_t
 
cmd_¡ime
, 
ssd
 *ssd)

501  (
cmd_¡ime
 =ð0è? 
	`__g‘_ioþock
(
ssd
) : cmd_stime;

502 
	}
}

503 
	$adju¡_ál_Ï‹ncy
(
rg‘
, 
Ït
)

507 
ssd·¿ms
 *
¥p
;

508 
i
;

510 
i
 = 0; i < 
SSD_PARTITIONS
; i++) {

511 
¥p
 = &(
g_cÚv_áls
[
i
].
¥
);

512 
	`NVMEV_INFO
("BefÜÏ‹ncy: %d %d %d, chªgtØ%d\n", 
¥p
->
pg_rd_Ït
, sµ->
pg_wr_Ït
, sµ->
blk_”_Ït
, 
Ït
);

513 
rg‘
) {

514 
NAND_READ
:

515 
¥p
->
pg_rd_Ït
 = 
Ït
;

518 
NAND_WRITE
:

519 
¥p
->
pg_wr_Ït
 = 
Ït
;

522 
NAND_ERASE
:

523 
¥p
->
blk_”_Ït
 = 
Ït
;

527 
	`NVMEV_ERROR
("Unsupported NAND command\n");

529 
	`NVMEV_INFO
("Aá”†©’cy: %d %d %d\n", 
¥p
->
pg_rd_Ït
, sµ->
pg_wr_Ït
, sµ->
blk_”_Ït
);

532 
	}
}

	@ssd.h

3 #iâdeà
_NVMEVIRT_SSD_H


4 
	#_NVMEVIRT_SSD_H


	)

6 
	~<lšux/ty³s.h
>

7 
	~"pqueue/pqueue.h
"

8 
	~"ssd_cÚfig.h
"

9 
	~"chªÃl_mod–.h
"

10 
	~"nvmev.h
"

25 
	#Œªsãr_4
 4

	)

26 
	#Œªsãr_8
 8

	)

28 
	#INVALID_PPA
 (~(0ULL))

	)

29 
	#INVALID_LPN
 (~(0ULL))

	)

30 
	#UNMAPPED_PPA
 (~(0ULL))

	)

33 
	mNAND_READ
 = 0,

34 
	mNAND_WRITE
 = 1,

35 
	mNAND_ERASE
 = 2,

36 
	mNAND_NOP
 = 3,

40 
	mUSER_IO
 = 0,

41 
	mGC_IO
 = 1,

45 
	mSEC_FREE
 = 0,

46 
	mSEC_INVALID
 = 1,

47 
	mSEC_VALID
 = 2,

49 
	mPG_FREE
 = 0,

50 
	mPG_INVALID
 = 1,

51 
	mPG_VALID
 = 2

55 ’um { 
	mCELL_TYPE_LSB
, 
	mCELL_TYPE_MSB
, 
	mCELL_TYPE_CSB
, 
	mMAX_CELL_TYPES
 };

57 
	#TOTAL_PPA_BITS
 (64)

	)

58 
	#BLK_BITS
 (16)

	)

59 
	#PAGE_BITS
 (16)

	)

60 
	#PL_BITS
 (8)

	)

61 
	#LUN_BITS
 (8)

	)

62 
	#CH_BITS
 (8)

	)

63 
	#RSB_BITS
 (
TOTAL_PPA_BITS
 - (
BLK_BITS
 + 
PAGE_BITS
 + 
PL_BITS
 + 
LUN_BITS
 + 
CH_BITS
))

	)

66 
	sµa
 {

69 
ušt64_t
 
	mpg
 : 
PAGE_BITS
;

70 
ušt64_t
 
	mblk
 : 
BLK_BITS
;

71 
ušt64_t
 
	m¶
 : 
PL_BITS
;

72 
ušt64_t
 
	mlun
 : 
LUN_BITS
;

73 
ušt64_t
 
	mch
 : 
CH_BITS
;

74 
ušt64_t
 
	mrsv
 : 
RSB_BITS
;

75 } 
	mg
;

78 
	mušt64_t
 : 
PAGE_BITS
;

79 
ušt64_t
 
	mblk_š_ssd
 : 
BLK_BITS
 + 
PL_BITS
 + 
LUN_BITS
 + 
CH_BITS
;

80 
ušt64_t
 
	mrsv
 : 
RSB_BITS
;

81 } 
	mh
;

83 
ušt64_t
 
	mµa
;

87 
	tÇnd_£c_¡©us_t
;

89 
	sÇnd_·ge
 {

90 
Çnd_£c_¡©us_t
 *
	m£c
;

91 
	mn£cs
;

92 
	m¡©us
;

95 
	sÇnd_block
 {

96 
Çnd_·ge
 *
	mpg
;

97 
	mÅgs
;

98 
	mc
;

99 
	mvpc
;

100 
	m”a£_út
;

101 
	mwp
;

104 
	sÇnd_¶ªe
 {

105 
Çnd_block
 *
	mblk
;

106 
ušt64_t
 
	mÃxt_¶n_avaž_time
;

107 
	mnblks
;

110 
	sÇnd_lun
 {

111 
Çnd_¶ªe
 *
	m¶
;

112 
	mÅls
;

113 
ušt64_t
 
	mÃxt_lun_avaž_time
;

114 
boÞ
 
	mbusy
;

115 
ušt64_t
 
	mgc_’dtime
;

117 
boÞ
 
	mfœ¡_io
;

120 
	sssd_chªÃl
 {

121 
Çnd_lun
 *
	mlun
;

122 
	mÆuns
;

123 
ušt64_t
 
	mgc_’dtime
;

124 
chªÃl_mod–
 *
	m³rf_mod–
;

127 
	sssd_pc›
 {

128 
chªÃl_mod–
 *
	m³rf_mod–
;

131 
	sÇnd_cmd
 {

132 
	mty³
;

133 
	mcmd
;

134 
ušt64_t
 
	mxãr_size
;

135 
ušt64_t
 
	m¡ime
;

136 
boÞ
 
	mš‹¾—ve_pci_dma
;

137 
µa
 *
	mµa
;

140 
	sbufãr
 {

141 
size_t
 
	msize
;

142 
size_t
 
	m»maššg
;

143 
¥šlock_t
 
	mlock
;

154 
	sssd·¿ms
 {

155 
	m£csz
;

156 
	m£cs_³r_pg
;

157 
	mpgsz
;

158 
	mpgs_³r_æashpg
;

159 
	mæashpgs_³r_blk
;

160 
	mpgs_³r_ÚeshÙpg
;

161 
	mÚeshÙpgs_³r_blk
;

162 
	mpgs_³r_blk
;

163 
	mblks_³r_¶
;

164 
	m¶s_³r_lun
;

165 
	mluns_³r_ch
;

166 
	mnchs
;

167 
	mûÎ_mode
;

171 
	mwr™e_un™_size
;

172 
boÞ
 
	mwr™e_—¾y_com¶‘iÚ
;

174 
	mpg_4kb_rd_Ït


175 [
MAX_CELL_TYPES
];

176 
	mpg_rd_Ït
[
MAX_CELL_TYPES
];

177 
	mpg_wr_Ït
;

178 
	mblk_”_Ït
;

179 
	mmax_ch_xãr_size
;

181 
	mfw_4kb_rd_Ït
;

182 
	mfw_rd_Ït
;

183 
	mfw_wbuf_Ït0
;

184 
	mfw_wbuf_Ït1
;

185 
	mfw_ch_xãr_Ït
;

187 
ušt64_t
 
	mch_bªdwidth
;

188 
ušt64_t
 
	mpc›_bªdwidth
;

191 
	m£cs_³r_blk
;

192 
	m£cs_³r_¶
;

193 
	m£cs_³r_lun
;

194 
	m£cs_³r_ch
;

195 
	m‰_£cs
;

197 
	mpgs_³r_¶
;

198 
	mpgs_³r_lun
;

199 
	mpgs_³r_ch
;

200 
	m‰_pgs
;

202 
	mblks_³r_lun
;

203 
	mblks_³r_ch
;

204 
	m‰_blks
;

206 
	m£cs_³r_lše
;

207 
	mpgs_³r_lše
;

208 
	mblks_³r_lše
;

209 
	m‰_lšes
;

211 
	m¶s_³r_ch
;

212 
	m‰_¶s
;

214 
	m‰_luns
;

216 
	mwr™e_bufãr_size
;

218 
	mmax_cÚ
;

222 
	sssd
 {

223 
ssd·¿ms
 
	m¥
;

224 
ssd_chªÃl
 *
	mch
;

225 
ssd_pc›
 *
	mpc›
;

226 
bufãr
 *
	mwr™e_bufãr
;

227 
	mýu_Ä_di¥©ch”
;

229 
nvmev_ns
 *
	mp_ns
;

232 
ušt64_t
 
	mcouÁ
;

233 
ušt64_t
 
	mch_d›_couÁ”
;

234 
ušt64_t
 
	mch_d›_Ï‹ncy
;

235 
boÞ
 
	mcheckpošt
;

236 
boÞ
 * 
	mfœ¡_io
;

237 
boÞ
 
	mcheckšg
;

240 
šlše
 
ssd_chªÃl
 *
	$g‘_ch
(
ssd
 *ssd, 
µa
 *ppa)

242  &(
ssd
->
ch
[
µa
->
g
.ch]);

243 
	}
}

245 
šlše
 
Çnd_lun
 *
	$g‘_lun
(
ssd
 *ssd, 
µa
 *ppa)

247 
ssd_chªÃl
 *
ch
 = 
	`g‘_ch
(
ssd
, 
µa
);

248  &(
ch
->
lun
[
µa
->
g
.lun]);

249 
	}
}

251 
šlše
 
Çnd_¶ªe
 *
	$g‘_¶
(
ssd
 *ssd, 
µa
 *ppa)

253 
Çnd_lun
 *
lun
 = 
	`g‘_lun
(
ssd
, 
µa
);

254  &(
lun
->
¶
[
µa
->
g
.pl]);

255 
	}
}

257 
šlše
 
Çnd_block
 *
	$g‘_blk
(
ssd
 *ssd, 
µa
 *ppa)

259 
Çnd_¶ªe
 *
¶
 = 
	`g‘_¶
(
ssd
, 
µa
);

260  &(
¶
->
blk
[
µa
->
g
.blk]);

261 
	}
}

263 
šlše
 
Çnd_·ge
 *
	$g‘_pg
(
ssd
 *ssd, 
µa
 *ppa)

265 
Çnd_block
 *
blk
 = 
	`g‘_blk
(
ssd
, 
µa
);

266  &(
blk
->
pg
[
µa
->
g
.pg]);

267 
	}
}

269 
šlše
 
ušt32_t
 
	$g‘_ûÎ
(
ssd
 *ssd, 
µa
 *ppa)

271 
ssd·¿ms
 *
¥p
 = &
ssd
->
¥
;

272  (
µa
->
g
.
pg
 / 
¥p
->
pgs_³r_æashpg
è% (¥p->
ûÎ_mode
 + 1);

273 
	}
}

275 
ssd_š™_·¿ms
(
ssd·¿ms
 *
¥p
, 
ušt64_t
 
ÿ·c™y
, 
ušt32_t
 
Å¬ts
,

276 
ál_cÚfigs
 *
ál_cfgs
);

277 
ssd_š™
(
ssd
 *ssd, 
ssd·¿ms
 *
¥p
, 
ušt32_t
 
ýu_Ä_di¥©ch”
);

278 
ssd_»move
(
ssd
 *ssd);

280 
ušt64_t
 
ssd_advªû_Çnd
(
ssd
 *ssd, 
Çnd_cmd
 *
ncmd
);

281 
ušt64_t
 
ssd_advªû_pc›
(
ssd
 *ssd, ušt64_ˆ
»que¡_time
, ušt64_ˆ
Ëngth
);

282 
ušt64_t
 
ssd_advªû_pc›_cÝy
(
ssd
 *ssd, ušt64_ˆ
»que¡_time
, ušt64_ˆ
Ëngth
);

283 
ušt64_t
 
ssd_advªû_wr™e_bufãr
(
ssd
 *ssd, ušt64_ˆ
»que¡_time
, ušt64_ˆ
Ëngth
,

284 
Œªsãr_size_KB
);

285 
ušt64_t
 
ssd_Ãxt_idË_time
(
ssd
 *ssd);

287 
bufãr_š™
(
bufãr
 *
buf
, 
size_t
 
size
);

288 
ušt32_t
 
bufãr_®loÿ‹
(
bufãr
 *
buf
, 
size_t
 
size
);

289 
boÞ
 
bufãr_»Ëa£
(
bufãr
 *
buf
, 
size_t
 
size
);

290 
bufãr_»fžl
(
bufãr
 *
buf
);

292 
adju¡_ál_Ï‹ncy
(
rg‘
, 
Ït
);

293 
ušt64_t
 
max_c¡ime_vs_ioþock
(ušt64_ˆ
cmd_¡ime
, 
ssd
 *ssd);

	@ssd_config.c

1 
	~"nvmev.h
"

2 
	~"ssd_cÚfig.h
"

4 
	$lßd_sim¶e_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
)

6 
ál_cfgs
->
NS_SSD_TYPE
 = 
SSD_TYPE_NVM
;

9 
ál_cfgs
->
MDTS
 = 5;

10 
ál_cfgs
->
CELL_MODE
 = 
CELL_MODE_UNKNOWN
;

11 
	}
}

13 
	$lßd_cÚv_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
)

16 
ál_cfgs
->
NS_SSD_TYPE
 = 
SSD_TYPE_CONV
;

20 
ál_cfgs
->
MDTS
 = 6;

21 
ál_cfgs
->
CELL_MODE
 = 
CELL_MODE_MLC
;

23 
ál_cfgs
->
SSD_PARTITIONS
 = 4;

24 
ál_cfgs
->
NAND_CHANNELS
 = 8;

25 
ál_cfgs
->
LUNS_PER_NAND_CH
 = 2;

26 
ál_cfgs
->
PLNS_PER_LUN
 = 1;

27 
ál_cfgs
->
FLASH_PAGE_SIZE
 = 
	`KB
(32);

28 
ál_cfgs
->
ONESHOT_PAGE_SIZE
 = fŽ_cfgs->
FLASH_PAGE_SIZE
 * 1;

29 
ál_cfgs
->
BLKS_PER_PLN
 = 8192;

30 
ál_cfgs
->
BLK_SIZE
 = 0;

32 
	`NVMEV_ASSERT
((
ál_cfgs
->
ONESHOT_PAGE_SIZE
 % fŽ_cfgs->
FLASH_PAGE_SIZE
) == 0);

34 
ál_cfgs
->
MAX_CH_XFER_SIZE
 = 
	`KB
(16);

35 
ál_cfgs
->
WRITE_UNIT_SIZE
 = 512;

37 
ál_cfgs
->
NAND_CHANNEL_BANDWIDTH
 = 800ull;

38 
ál_cfgs
->
PCIE_BANDWIDTH
 = 3360ull;

40 
ál_cfgs
->
NAND_4KB_READ_LATENCY_LSB
 = 35760 - 6000;

41 
ál_cfgs
->
NAND_4KB_READ_LATENCY_MSB
 = 35760 + 6000;

42 
ál_cfgs
->
NAND_4KB_READ_LATENCY_CSB
 = 0;

43 
ál_cfgs
->
NAND_READ_LATENCY_LSB
 = 36013 - 6000;

44 
ál_cfgs
->
NAND_READ_LATENCY_MSB
 = 36013 + 6000;

45 
ál_cfgs
->
NAND_READ_LATENCY_CSB
 = 0;

46 
ál_cfgs
->
NAND_PROG_LATENCY
 = 185000;

48 
ál_cfgs
->
NAND_ERASE_LATENCY
 = 0;

51 
ál_cfgs
->
FW_4KB_READ_LATENCY
 = 21500;

52 
ál_cfgs
->
FW_READ_LATENCY
 = 30490;

53 
ál_cfgs
->
FW_WBUF_LATENCY0
 = 4000;

54 
ál_cfgs
->
FW_WBUF_LATENCY1
 = 460;

55 
ál_cfgs
->
FW_CH_XFER_LATENCY
 = 0;

58 
ál_cfgs
->
GLOBAL_WB_SIZE
 = fŽ_cfgs->
NAND_CHANNELS
 * fŽ_cfgs->
LUNS_PER_NAND_CH
 *

59 
ál_cfgs
->
ONESHOT_PAGE_SIZE
 * 2;

60 
ál_cfgs
->
WRITE_EARLY_COMPLETION
 = 
Œue
;

61 
	}
}

64 
	$lßd_zns_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
)

66 
zns_cÚfigs
 *
zns_cfgs
 = &
ál_cfgs
->
exŒa_cÚfigs
.
zns
;

67 
ál_cfgs
->
NS_SSD_TYPE
 = 
SSD_TYPE_ZNS
;

71 
ál_cfgs
->
MDTS
 = 6;

72 
ál_cfgs
->
CELL_MODE
 = 
CELL_MODE_TLC
;

74 
ál_cfgs
->
SSD_PARTITIONS
 = 1;

75 
ál_cfgs
->
NAND_CHANNELS
 = 8;

76 
ál_cfgs
->
LUNS_PER_NAND_CH
 = 4;

77 
ál_cfgs
->
PLNS_PER_LUN
 = 1;

78 
zns_cfgs
->
DIES_PER_ZONE
 = 
ál_cfgs
->
NAND_CHANNELS
 * fŽ_cfgs->
LUNS_PER_NAND_CH
;

80 
ál_cfgs
->
FLASH_PAGE_SIZE
 = 
	`KB
(16);

81 
ál_cfgs
->
ONESHOT_PAGE_SIZE
 = fŽ_cfgs->
FLASH_PAGE_SIZE
 * 3;

86 
zns_cfgs
->
ZONE_SIZE
 = 
	`MB
(2);

88 
	`NVMEV_ASSERT
((
ál_cfgs
->
ONESHOT_PAGE_SIZE
 % fŽ_cfgs->
FLASH_PAGE_SIZE
) == 0);

90 
ál_cfgs
->
MAX_CH_XFER_SIZE
 = fŽ_cfgs->
FLASH_PAGE_SIZE
;

91 
ál_cfgs
->
WRITE_UNIT_SIZE
 = 512;

93 
ál_cfgs
->
NAND_CHANNEL_BANDWIDTH
 = 450ull;

94 
ál_cfgs
->
PCIE_BANDWIDTH
 = 3050ull;

96 
ál_cfgs
->
NAND_4KB_READ_LATENCY_LSB
 = 50000;

97 
ál_cfgs
->
NAND_4KB_READ_LATENCY_MSB
 = 50000;

98 
ál_cfgs
->
NAND_4KB_READ_LATENCY_CSB
 = 50000;

99 
ál_cfgs
->
NAND_READ_LATENCY_LSB
 = 58000;

100 
ál_cfgs
->
NAND_READ_LATENCY_MSB
 = 58000;

101 
ál_cfgs
->
NAND_READ_LATENCY_CSB
 = 58000;

102 
ál_cfgs
->
NAND_PROG_LATENCY
 = 561000;

104 
ál_cfgs
->
NAND_ERASE_LATENCY
 = 3500000;

106 
ál_cfgs
->
FW_4KB_READ_LATENCY
 = 20000;

107 
ál_cfgs
->
FW_READ_LATENCY
 = 13000;

108 
ál_cfgs
->
FW_WBUF_LATENCY0
 = 5600;

109 
ál_cfgs
->
FW_WBUF_LATENCY1
 = 600;

110 
ál_cfgs
->
FW_CH_XFER_LATENCY
 = 0;

111 
ál_cfgs
->
OP_AREA_PERCENT
 = 0.07;

113 
zns_cfgs
->
ZONE_WB_SIZE
 = 10 * 
ál_cfgs
->
ONESHOT_PAGE_SIZE
;

114 
ál_cfgs
->
GLOBAL_WB_SIZE
 = 0;

115 
ál_cfgs
->
WRITE_EARLY_COMPLETION
 = 
Œue
;

119 
ál_cfgs
->
BLKS_PER_PLN
 = 0;

120 
ál_cfgs
->
BLK_SIZE
 = 
zns_cfgs
->
ZONE_SIZE
 / zns_cfgs->
DIES_PER_ZONE
;

122 
	`NVMEV_ASSERT
((
zns_cfgs
->
ZONE_SIZE
 % zns_cfgs->
DIES_PER_ZONE
) == 0);

125 
zns_cfgs
->
MAX_ZRWA_ZONES
 = 0;

126 
zns_cfgs
->
ZRWAFG_SIZE
 = 0;

127 
zns_cfgs
->
ZRWA_SIZE
 = 0;

128 
zns_cfgs
->
ZRWA_BUFFER_SIZE
 = 0;

130 
	}
}

132 
	$lßd_kv_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
)

134 
kv_cÚfigs
 *
kv_cfgs
 = &
ál_cfgs
->
exŒa_cÚfigs
.
kv
;

136 
ál_cfgs
->
NS_SSD_TYPE
 = 
SSD_TYPE_KV
;

139 
ál_cfgs
->
MDTS
 = 5;

140 
ál_cfgs
->
CELL_MODE
 = 
CELL_MODE_MLC
;

142 
kv_cfgs
->
KV_MAPPING_TABLE_SIZE
 = 
	`GB
(1);

143 
kv_cfgs
->
ALLOCATOR_TYPE
 = 
ALLOCATOR_TYPE_APPEND_ONLY
;

144 
	}
}

	@ssd_config.h

3 #iâdeà
_NVMEVIRT_SSD_CONFIG_H


4 
	#_NVMEVIRT_SSD_CONFIG_H


	)

7 
	#INTEL_OPTANE
 0

	)

8 
	#SAMSUNG_970PRO
 1

	)

9 
	#ZNS_PROTOTYPE
 2

	)

10 
	#KV_PROTOTYPE
 3

	)

11 
	#WD_ZN540
 4

	)

12 
	#MI
 5

	)

15 
	#SSD_TYPE_NVM
 0

	)

16 
	#SSD_TYPE_CONV
 1

	)

17 
	#SSD_TYPE_ZNS
 2

	)

18 
	#SSD_TYPE_KV
 3

	)

21 
	#CELL_MODE_UNKNOWN
 0

	)

22 
	#CELL_MODE_SLC
 1

	)

23 
	#CELL_MODE_MLC
 2

	)

24 
	#CELL_MODE_TLC
 3

	)

25 
	#CELL_MODE_QLC
 4

	)

27 
	szns_cÚfigs
 {

28 
ušt64_t
 
	mZONE_SIZE
;

29 
ušt32_t
 
	mDIES_PER_ZONE
;

30 
ušt32_t
 
	mZONE_WB_SIZE
;

32 
ušt32_t
 
	mMAX_ZRWA_ZONES
;

33 
ušt32_t
 
	mZRWAFG_SIZE
;

34 
ušt32_t
 
	mZRWA_SIZE
;

35 
ušt32_t
 
	mZRWA_BUFFER_SIZE
;

39 
	mALLOCATOR_TYPE_BITMAP
,

40 
	mALLOCATOR_TYPE_APPEND_ONLY
,

43 
	skv_cÚfigs
 {

44 
	mKV_MAPPING_TABLE_SIZE
;

45 
	mALLOCATOR_TYPE
;

48 
	uexŒa_cÚfigs
 {

49 
zns_cÚfigs
 
	mzns
;

50 
kv_cÚfigs
 
	mkv
;

53 
	sál_cÚfigs
 {

54 
	mmax_cÚ
;

55 
ušt32_t
 
	mNS_SSD_TYPE
;

57 
	mMDTS
;

58 
	mCELL_MODE
;

60 
ušt32_t
 
	mSSD_PARTITIONS
;

61 
	mNAND_CHANNELS
;

62 
	mLUNS_PER_NAND_CH
;

63 
	mPLNS_PER_LUN
;

64 
	mFLASH_PAGE_SIZE
;

65 
	mONESHOT_PAGE_SIZE
;

66 
	mBLKS_PER_PLN
;

67 
	mBLK_SIZE
;

69 
	mMAX_CH_XFER_SIZE
;

70 
	mWRITE_UNIT_SIZE
;

72 
ušt64_t
 
	mNAND_CHANNEL_BANDWIDTH
;

73 
ušt64_t
 
	mPCIE_BANDWIDTH
;

75 
	mNAND_4KB_READ_LATENCY_LSB
;

76 
	mNAND_4KB_READ_LATENCY_MSB
;

77 
	mNAND_4KB_READ_LATENCY_CSB
;

78 
	mNAND_READ_LATENCY_LSB
;

79 
	mNAND_READ_LATENCY_MSB
;

80 
	mNAND_READ_LATENCY_CSB
;

81 
	mNAND_PROG_LATENCY
;

82 
	mNAND_ERASE_LATENCY
;

84 
	mFW_4KB_READ_LATENCY
;

85 
	mFW_READ_LATENCY
;

86 
	mFW_WBUF_LATENCY0
;

87 
	mFW_WBUF_LATENCY1
;

88 
	mFW_CH_XFER_LATENCY
;

89 
	mOP_AREA_PERCENT
;

91 
	mGLOBAL_WB_SIZE
;

92 
boÞ
 
	mWRITE_EARLY_COMPLETION
;

94 
exŒa_cÚfigs
 
	mexŒa_cÚfigs
;

97 
lßd_sim¶e_cÚfigs
(
ál_cÚfigs
 *
æt_cfgs
);

98 
lßd_cÚv_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
);

99 
lßd_zns_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
);

100 
lßd_kv_cÚfigs
(
ál_cÚfigs
 *
ál_cfgs
);

105 #ià(
BASE_SSD
 =ð
MI
)

106 
	#NR_NAMESPACES
 1

	)

108 
	#NS_SSD_TYPE_0
 
SSD_TYPE_NVM


	)

109 
	#NS_CAPACITY_0
 (0)

	)

110 
	#NS_SSD_TYPE_1
 
SSD_TYPE_CONV


	)

111 
	#NS_CAPACITY_1
 (0)

	)

112 
	#NS_SSD_TYPE_2
 
SSD_TYPE_ZNS


	)

113 
	#NS_CAPACITY_2
 (0)

	)

114 
	#NS_SSD_TYPE_3
 
SSD_TYPE_KV


	)

115 
	#NS_CAPACITY_3
 (0)

	)

117 
	#CONV_OP_AREA_PERCENT
 (0.07)

	)

118 
	#ZNS_OP_AREA_PERCENT
 (0)

	)

120 #–ià(
BASE_SSD
 =ð
INTEL_OPTANE
)

121 
	#NR_NAMESPACES
 1

	)

123 
	#NS_SSD_TYPE_0
 
SSD_TYPE_NVM


	)

124 
	#NS_CAPACITY_0
 (0)

	)

125 
	#NS_SSD_TYPE_1
 
NS_SSD_TYPE_0


	)

126 
	#NS_CAPACITY_1
 (0)

	)

127 
	#MDTS
 (5)

	)

128 
	#CELL_MODE
 (
CELL_MODE_UNKNOWN
)

	)

130 #–ià(
BASE_SSD
 =ð
KV_PROTOTYPE
)

131 
	#NR_NAMESPACES
 1

	)

133 
	#NS_SSD_TYPE_0
 
SSD_TYPE_KV


	)

134 
	#NS_CAPACITY_0
 (0)

	)

135 
	#NS_SSD_TYPE_1
 
NS_SSD_TYPE_0


	)

136 
	#NS_CAPACITY_1
 (0)

	)

137 
	#MDTS
 (5)

	)

138 
	#CELL_MODE
 (
CELL_MODE_MLC
)

	)

141 
	mALLOCATOR_TYPE_BITMAP
,

142 
	mALLOCATOR_TYPE_APPEND_ONLY
,

145 
	#KV_MAPPING_TABLE_SIZE
 
	`GB
(1)

	)

146 
	#ALLOCATOR_TYPE
 
ALLOCATOR_TYPE_APPEND_ONLY


	)

148 #–ià(
BASE_SSD
 =ð
SAMSUNG_970PRO
)

149 
	#NR_NAMESPACES
 1

	)

151 
	#NS_SSD_TYPE_0
 
SSD_TYPE_CONV


	)

152 
	#NS_CAPACITY_0
 (0)

	)

153 
	#NS_SSD_TYPE_1
 
NS_SSD_TYPE_0


	)

154 
	#NS_CAPACITY_1
 (0)

	)

155 
	#MDTS
 (6)

	)

156 
	#CELL_MODE
 (
CELL_MODE_MLC
)

	)

158 
	#SSD_PARTITIONS
 (4)

	)

159 
	#NAND_CHANNELS
 (8)

	)

160 
	#LUNS_PER_NAND_CH
 (2)

	)

161 
	#PLNS_PER_LUN
 (1)

	)

162 
	#FLASH_PAGE_SIZE
 
	`KB
(32)

	)

163 
	#ONESHOT_PAGE_SIZE
 (
FLASH_PAGE_SIZE
 * 1)

	)

164 
	#BLKS_PER_PLN
 (8192)

	)

165 
	#BLK_SIZE
 (0è

	)

166 
¡©ic_as£¹
((
ONESHOT_PAGE_SIZE
 % 
FLASH_PAGE_SIZE
) == 0);

168 
	#MAX_CH_XFER_SIZE
 
	`KB
(16è

	)

169 
	#WRITE_UNIT_SIZE
 (512)

	)

171 
	#NAND_CHANNEL_BANDWIDTH
 (800ull)

172 
	#PCIE_BANDWIDTH
 (3360ull)

173 

	)

174 
	#NAND_4KB_READ_LATENCY_LSB
 (35760 - 6000)

175 
	#NAND_4KB_READ_LATENCY_MSB
 (35760 + 6000)

176 
	#NAND_4KB_READ_LATENCY_CSB
 (0)

177 
	#NAND_READ_LATENCY_LSB
 (36013 - 6000)

	)

178 
	#NAND_READ_LATENCY_MSB
 (36013 + 6000)

	)

179 
	#NAND_READ_LATENCY_CSB
 (0)

180 
	#NAND_PROG_LATENCY
 (185000)

	)

181 
	#NAND_ERASE_LATENCY
 (0)

	)

183 
	#FW_4KB_READ_LATENCY
 (21500)

	)

184 
	#FW_READ_LATENCY
 (30490)

	)

185 
	#FW_WBUF_LATENCY0
 (4000)

	)

186 
	#FW_WBUF_LATENCY1
 (460)

	)

187 
	#FW_CH_XFER_LATENCY
 (0)

	)

188 
	#OP_AREA_PERCENT
 (0.07)

	)

190 
	#GLOBAL_WB_SIZE
 (
NAND_CHANNELS
 * 
LUNS_PER_NAND_CH
 * 
ONESHOT_PAGE_SIZE
 * 2)

	)

191 
	#WRITE_EARLY_COMPLETION
 1

	)

193 #–ià(
BASE_SSD
 =ð
ZNS_PROTOTYPE
)

194 
	#NR_NAMESPACES
 1

	)

196 
	#NS_SSD_TYPE_0
 
SSD_TYPE_ZNS


	)

197 
	#NS_CAPACITY_0
 (0)

	)

198 
	#NS_SSD_TYPE_1
 
NS_SSD_TYPE_0


	)

199 
	#NS_CAPACITY_1
 (0)

	)

200 
	#MDTS
 (6)

	)

201 
	#CELL_MODE
 (
CELL_MODE_TLC
)

	)

203 
	#SSD_PARTITIONS
 (1)

	)

204 
	#NAND_CHANNELS
 (8)

	)

205 
	#LUNS_PER_NAND_CH
 (16)

	)

206 
	#FLASH_PAGE_SIZE
 
	`KB
(64)

	)

207 
	#PLNS_PER_LUN
 (1è

	)

208 
	#DIES_PER_ZONE
 (1)

	)

212 
	#ONESHOT_PAGE_SIZE
 (
FLASH_PAGE_SIZE
 * 3)

	)

213 
	#ZONE_SIZE
 
	`MB
(96è

	)

215 
	#ONESHOT_PAGE_SIZE
 (
FLASH_PAGE_SIZE
 * 2)

	)

216 
	#ZONE_SIZE
 
	`MB
(32)

	)

218 
¡©ic_as£¹
((
ONESHOT_PAGE_SIZE
 % 
FLASH_PAGE_SIZE
) == 0);

220 
	#MAX_CH_XFER_SIZE
 (
FLASH_PAGE_SIZE
è

	)

221 
	#WRITE_UNIT_SIZE
 (
ONESHOT_PAGE_SIZE
)

	)

223 
	#NAND_CHANNEL_BANDWIDTH
 (800ull)

224 
	#PCIE_BANDWIDTH
 (3200ull)

225 

	)

226 
	#NAND_4KB_READ_LATENCY_LSB
 (25485)

	)

227 
	#NAND_4KB_READ_LATENCY_MSB
 (25485)

	)

228 
	#NAND_4KB_READ_LATENCY_CSB
 (25485)

	)

229 
	#NAND_READ_LATENCY_LSB
 (40950)

	)

230 
	#NAND_READ_LATENCY_MSB
 (40950)

	)

231 
	#NAND_READ_LATENCY_CSB
 (40950)

	)

232 
	#NAND_PROG_LATENCY
 (1913640)

	)

233 
	#NAND_ERASE_LATENCY
 (0)

	)

235 
	#FW_4KB_READ_LATENCY
 (37540 - 7390 + 2000)

	)

236 
	#FW_READ_LATENCY
 (37540 - 7390 + 2000)

	)

237 
	#FW_WBUF_LATENCY0
 (0)

	)

238 
	#FW_WBUF_LATENCY1
 (0)

	)

239 
	#FW_CH_XFER_LATENCY
 (413)

	)

240 
	#OP_AREA_PERCENT
 (0)

	)

242 
	#GLOBAL_WB_SIZE
 (
NAND_CHANNELS
 * 
LUNS_PER_NAND_CH
 * 
ONESHOT_PAGE_SIZE
 * 2)

	)

243 
	#ZONE_WB_SIZE
 (0)

	)

244 
	#WRITE_EARLY_COMPLETION
 0

	)

247 
	#BLKS_PER_PLN
 0

	)

248 
	#BLK_SIZE
 (
ZONE_SIZE
 / 
DIES_PER_ZONE
)

	)

249 
¡©ic_as£¹
((
ZONE_SIZE
 % 
DIES_PER_ZONE
) == 0);

252 
	#MAX_ZRWA_ZONES
 (0)

	)

253 
	#ZRWAFG_SIZE
 (0)

	)

254 
	#ZRWA_SIZE
 (0)

	)

255 
	#ZRWA_BUFFER_SIZE
 (0)

	)

257 #–ià(
BASE_SSD
 =ð
WD_ZN540
)

258 
	#NR_NAMESPACES
 1

	)

260 
	#NS_SSD_TYPE_0
 
SSD_TYPE_ZNS


	)

261 
	#NS_CAPACITY_0
 (0)

	)

262 
	#NS_SSD_TYPE_1
 
NS_SSD_TYPE_0


	)

263 
	#NS_CAPACITY_1
 (0)

	)

264 
	#MDTS
 (6)

	)

265 
	#CELL_MODE
 (
CELL_MODE_TLC
)

	)

267 
	#SSD_PARTITIONS
 (1)

	)

268 
	#NAND_CHANNELS
 (8)

	)

269 
	#LUNS_PER_NAND_CH
 (4)

	)

270 
	#PLNS_PER_LUN
 (1è

	)

271 
	#DIES_PER_ZONE
 (
NAND_CHANNELS
 * 
LUNS_PER_NAND_CH
)

	)

273 
	#FLASH_PAGE_SIZE
 
	`KB
(32)

	)

274 
	#ONESHOT_PAGE_SIZE
 (
FLASH_PAGE_SIZE
 * 3)

	)

278 
	#ZONE_SIZE
 
	`GB
(2ULL)

	)

280 
¡©ic_as£¹
((
ONESHOT_PAGE_SIZE
 % 
FLASH_PAGE_SIZE
) == 0);

282 
	#MAX_CH_XFER_SIZE
 (
FLASH_PAGE_SIZE
è

	)

283 
	#WRITE_UNIT_SIZE
 (512)

	)

285 
	#NAND_CHANNEL_BANDWIDTH
 (450ull)

286 
	#PCIE_BANDWIDTH
 (3050ull)

287 

	)

288 
	#NAND_4KB_READ_LATENCY_LSB
 (50000)

	)

289 
	#NAND_4KB_READ_LATENCY_MSB
 (50000)

	)

290 
	#NAND_4KB_READ_LATENCY_CSB
 (50000)

	)

291 
	#NAND_READ_LATENCY_LSB
 (58000)

	)

292 
	#NAND_READ_LATENCY_MSB
 (58000)

	)

293 
	#NAND_READ_LATENCY_CSB
 (58000)

	)

294 
	#NAND_PROG_LATENCY
 (561000)

	)

295 
	#NAND_ERASE_LATENCY
 (0)

	)

297 
	#FW_4KB_READ_LATENCY
 (20000)

	)

298 
	#FW_READ_LATENCY
 (13000)

	)

299 
	#FW_WBUF_LATENCY0
 (5600)

	)

300 
	#FW_WBUF_LATENCY1
 (600)

	)

301 
	#FW_CH_XFER_LATENCY
 (0)

	)

302 
	#OP_AREA_PERCENT
 (0)

	)

304 
	#ZONE_WB_SIZE
 (10 * 
ONESHOT_PAGE_SIZE
)

	)

305 
	#GLOBAL_WB_SIZE
 (0)

	)

306 
	#WRITE_EARLY_COMPLETION
 1

	)

309 
	#BLKS_PER_PLN
 0

	)

310 
	#BLK_SIZE
 (
ZONE_SIZE
 / 
DIES_PER_ZONE
)

	)

311 
¡©ic_as£¹
((
ZONE_SIZE
 % 
DIES_PER_ZONE
) == 0);

314 
	#MAX_ZRWA_ZONES
 (0)

	)

315 
	#ZRWAFG_SIZE
 (0)

	)

316 
	#ZRWA_SIZE
 (0)

	)

317 
	#ZRWA_BUFFER_SIZE
 (0)

	)

321 cÚ¡ 
ušt32_t
 
	gns_ssd_ty³
[] = { 
NS_SSD_TYPE_0
, 
NS_SSD_TYPE_1
,

322 
NS_SSD_TYPE_2
, 
NS_SSD_TYPE_3
 };

323 cÚ¡ 
ušt64_t
 
	gns_ÿ·c™y
[] = { 
NS_CAPACITY_0
, 
NS_CAPACITY_1
,

324 
NS_CAPACITY_2
, 
NS_CAPACITY_3
 };

325 
	#NS_SSD_TYPE
(
ns
è(
ns_ssd_ty³
[ns])

	)

326 
	#NS_CAPACITY
(
ns
è(
ns_ÿ·c™y
[ns])

	)

329 
¡©ic_as£¹
(
NR_NAMESPACES
 <= 2);

331 
	#SUPPORTED_SSD_TYPE
(
ty³
) \

332 (
NS_SSD_TYPE_0
 =ð
SSD_TYPE_
##
ty³
 || 
NS_SSD_TYPE_1
 =ðSSD_TYPE_##ty³ || 
NS_SSD_TYPE_2
 =ðSSD_TYPE_##ty³ || 
NS_SSD_TYPE_3
 =ðSSD_TYPE_##ty³)

	)

	@zns_ftl.c

3 
	~<lšux/ktime.h
>

4 
	~<lšux/sched/þock.h
>

6 
	~"nvmev.h
"

7 
	~"ssd.h
"

8 
	~"zns_ál.h
"

10 
	$__š™_desütÜ
(
zns_ál
 *zns_ftl)

12 
zÚe_desütÜ
 *
zÚe_descs
;

13 
ušt32_t
 
zÚe_size
 = 
zns_ál
->
zp
.zone_size;

14 
ušt32_t
 
Ä_zÚes
 = 
zns_ál
->
zp
.nr_zones;

15 
ušt64_t
 
z¦ba
 = 0;

16 
ušt32_t
 
i
 = 0;

17 cÚ¡ 
ušt32_t
 
zrwa_bufãr_size
 = 
zns_ál
->
zp
.zrwa_buffer_size;

18 cÚ¡ 
ušt32_t
 
zÚe_wb_size
 = 
zns_ál
->
zp
.zone_wb_size;

20 
zns_ál
->
zÚe_descs
 = 
	`km®loc
((
zÚe_desütÜ
è* 
Ä_zÚes
, 
GFP_KERNEL
);

21 
zns_ál
->
»pÜt_bufãr
 = 
	`km®loc
(

22 (
zÚe_»pÜt
è+ (
zÚe_desütÜ
è* 
Ä_zÚes
, 
GFP_KERNEL
);

24 ià(
zrwa_bufãr_size
)

25 
zns_ál
->
zw¿_bufãr
 = 
	`km®loc
((
bufãr
è* 
Ä_zÚes
, 
GFP_KERNEL
);

27 ià(
zÚe_wb_size
)

28 
zns_ál
->
zÚe_wr™e_bufãr
 = 
	`km®loc
((
bufãr
è* 
Ä_zÚes
, 
GFP_KERNEL
);

30 
zÚe_descs
 = 
zns_ál
->zone_descs;

31 
	`mem£t
(
zÚe_descs
, 0, (
zÚe_desütÜ
è* 
zns_ál
->
zp
.
Ä_zÚes
);

33 
i
 = 0; i < 
Ä_zÚes
; i++) {

34 
zÚe_descs
[
i
].
¡©e
 = 
ZONE_STATE_EMPTY
;

35 
zÚe_descs
[
i
].
ty³
 = 
ZONE_TYPE_SEQ_WRITE_REQUIRED
;

37 
zÚe_descs
[
i
].
z¦ba
 = zslba;

38 
zÚe_descs
[
i
].
wp
 = 
z¦ba
;

39 
z¦ba
 +ð
	`BYTE_TO_LBA
(
zÚe_size
);

40 
zÚe_descs
[
i
].
zÚe_ÿ·c™y
 = 
	`BYTE_TO_LBA
(
zÚe_size
);

42 ià(
zrwa_bufãr_size
)

43 
	`bufãr_š™
(&(
zns_ál
->
zw¿_bufãr
[
i
]), 
zrwa_bufãr_size
);

45 ià(
zÚe_wb_size
)

46 
	`bufãr_š™
(&(
zns_ál
->
zÚe_wr™e_bufãr
[
i
]), 
zÚe_wb_size
);

48 
	`NVMEV_ZNS_DEBUG
("[i] z¦b¨0x%Îx zÚÿ·c™y 0x%Îx\n", 
zÚe_descs
[
i
].
z¦ba
,

49 
zÚe_descs
[
i
].
zÚe_ÿ·c™y
);

51 
	}
}

53 
	$__»move_desütÜ
(
zns_ál
 *zns_ftl)

55 ià(
zns_ál
->
zp
.
zrwa_bufãr_size
)

56 
	`kä“
(
zns_ál
->
zw¿_bufãr
);

58 ià(
zns_ál
->
zp
.
zÚe_wb_size
)

59 
	`kä“
(
zns_ál
->
zÚe_wr™e_bufãr
);

61 
	`kä“
(
zns_ál
->
»pÜt_bufãr
);

62 
	`kä“
(
zns_ál
->
zÚe_descs
);

63 
	}
}

65 
	$__š™_»sourû
(
zns_ál
 *zns_ftl)

67 
zÚe_»sourû_šfo
 *
»s_šfos
 = 
zns_ál
->res_infos;

69 
»s_šfos
[
ACTIVE_ZONE
] = (
zÚe_»sourû_šfo
){

70 .
tÙ®_út
 = 
zns_ál
->
zp
.
Ä_zÚes
,

71 .
acquœed_út
 = 0,

74 
»s_šfos
[
OPEN_ZONE
] = (
zÚe_»sourû_šfo
){

75 .
tÙ®_út
 = 
zns_ál
->
zp
.
Ä_zÚes
,

76 .
acquœed_út
 = 0,

79 
»s_šfos
[
ZRWA_ZONE
] = (
zÚe_»sourû_šfo
){

80 .
tÙ®_út
 = 
zns_ál
->
zp
.
Ä_zÚes
,

81 .
acquœed_út
 = 0,

83 
	}
}

85 
	$zns_š™_·¿ms
(
zn¥¬ams
 *
zµ
, 
ssd·¿ms
 *
¥p
, 
ušt64_t
 
ÿ·c™y
,

86 
ál_cÚfigs
 *
ál_cfgs
)

88 
zns_cÚfigs
 *
zns_cfgs
 = &
ál_cfgs
->
exŒa_cÚfigs
.
zns
;

89 *
zµ
 = (
zn¥¬ams
){

90 .
zÚe_size
 = 
zns_cfgs
->
ZONE_SIZE
,

91 .
Ä_zÚes
 = 
ÿ·c™y
 / 
zns_cfgs
->
ZONE_SIZE
,

92 .
d›s_³r_zÚe
 = 
zns_cfgs
->
DIES_PER_ZONE
,

93 .
Ä_aùive_zÚes
 = 
zµ
->
Ä_zÚes
,

94 .
Ä_Ý’_zÚes
 = 
zµ
->
Ä_zÚes
,

95 .
Ä_zrwa_zÚes
 = 
zns_cfgs
->
MAX_ZRWA_ZONES
,

96 .
zÚe_wb_size
 = 
zns_cfgs
->
ZONE_WB_SIZE
,

97 .
zrwa_size
 = 
zns_cfgs
->
ZRWA_SIZE
,

98 .
zrwafg_size
 = 
zns_cfgs
->
ZRWAFG_SIZE
,

99 .
zrwa_bufãr_size
 = 
zns_cfgs
->
ZRWA_BUFFER_SIZE
,

100 .
lbas_³r_zrwa
 = 
zµ
->
zrwa_size
 / 
¥p
->
£csz
,

101 .
lbas_³r_zrwafg
 = 
zµ
->
zrwafg_size
 / 
¥p
->
£csz
,

103 
	`NVMEV_ASSERT
((
ÿ·c™y
 % 
zµ
->
zÚe_size
) == 0);

105 
	`NVMEV_ASSERT
((
zµ
->
zÚe_size
 % 
¥p
->
pgsz
) == 0);

106 
	`NVMEV_INFO
("zÚe_size=%u(By‹),%u(MB), # zÚes=%d # d›/zÚe=%d \n", 
zµ
->
zÚe_size
,

107 
	`BYTE_TO_MB
(
zµ
->
zÚe_size
), zµ->
Ä_zÚes
, zµ->
d›s_³r_zÚe
);

108 
	}
}

110 
	$zns_š™_ál
(
zns_ál
 *zns_ál, 
zn¥¬ams
 *
zµ
, 
ssd
 *ssd,

111 *
m­³d_addr
)

113 *
zns_ál
 = (zns_ftl){

114 .
zp
 = *
zµ
,

116 .
ssd
 = ssd,

117 .
¡Üage_ba£_addr
 = 
m­³d_addr
,

120 
	`__š™_desütÜ
(
zns_ál
);

121 
	`__š™_»sourû
(
zns_ál
);

122 
	}
}

124 
	$zns_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

125 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
)

127 
ssd
 *ssd;

128 
zns_ál
 *zns_ftl;

130 
ssd·¿ms
 
¥p
;

131 
zn¥¬ams
 
zµ
;

133 cÚ¡ 
ušt32_t
 
Ä_·¹s
 = 1;

134 
	`NVMEV_ASSERT
(
Ä_·¹s
 == 1);

136 
ssd
 = 
	`km®loc
((ssd), 
GFP_KERNEL
);

137 
	`ssd_š™_·¿ms
(&
¥p
, 
size
, 
Ä_·¹s
, 
ál_cfgs
);

138 
	`ssd_š™
(
ssd
, &
¥p
, 
ýu_Ä_di¥©ch”
);

140 
ssd
->
p_ns
 = 
ns
;

142 
zns_ál
 = 
	`km®loc
((zns_álè* 
Ä_·¹s
, 
GFP_KERNEL
);

143 
	`zns_š™_·¿ms
(&
zµ
, &
¥p
, 
size
, 
ál_cfgs
);

144 
	`zns_š™_ál
(
zns_ál
, &
zµ
, 
ssd
, 
m­³d_addr
);

146 *
ns
 = (
nvmev_ns
){

147 .
id
 = id,

148 .
csi
 = 
NVME_CSI_ZNS
,

149 .
Ä_·¹s
 =‚r_parts,

150 .
áls
 = (*)
zns_ál
,

151 .
size
 = size,

152 .
m­³d
 = 
m­³d_addr
,

155 .
´oc_io_cmd
 = 
zns_´oc_nvme_io_cmd
,

158 
	}
}

160 
	$zns_»move_Çme¥aû
(
nvmev_ns
 *
ns
)

162 
zns_ál
 *zns_áÈð(zns_áÈ*)
ns
->
áls
;

164 
	`ssd_»move
(
zns_ál
->
ssd
);

166 
	`__»move_desütÜ
(
zns_ál
);

167 
	`kä“
(
zns_ál
->
ssd
);

168 
	`kä“
(
zns_ál
);

170 
ns
->
áls
 = 
NULL
;

171 
	}
}

173 
	$zns_æush
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

175 
ušt64_t
 
¡¬t
, 
Ï‹¡
;

176 
ušt32_t
 
i
;

177 
zns_ál
 *zns_áÈð(zns_áÈ*)
ns
->
áls
;

179 
¡¬t
 = 
	`loÿl_þock
();

180 
Ï‹¡
 = 
¡¬t
;

181 
i
 = 0; i < 
ns
->
Ä_·¹s
; i++) {

182 
Ï‹¡
 = 
	`max
Ö©e¡, 
	`ssd_Ãxt_idË_time
(
zns_ál
[
i
].
ssd
));

185 
	`NVMEV_DEBUG
("% Ï‹ncy=%Îu\n", 
__func__
, 
Ï‹¡
 - 
¡¬t
);

187 
»t
->
¡©us
 = 
NVME_SC_SUCCESS
;

188 
»t
->
n£cs_rg‘
 = 
Ï‹¡
;

190 
	}
}

192 
boÞ
 
	$zns_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
,

193 
nvmev_dev
 *
nvemv_vdev
)

195 
nvme_commªd
 *
cmd
 = 
»q
->cmd;

196 
	`NVMEV_ASSERT
(
ns
->
csi
 =ð
NVME_CSI_ZNS
);

198 
	`NVMEV_ASSERT
(
ns
->
Ä_·¹s
 == 1);

200 
cmd
->
commÚ
.
Ýcode
) {

201 
nvme_cmd_wr™e
:

202 
nvme_cmd_zÚe_­³nd
:

203 ià(!
	`zns_wr™e
(
ns
, 
»q
, 
»t
))

204  
çl£
;

206 
nvme_cmd_»ad
:

207 ià(!
	`zns_»ad
(
ns
, 
»q
, 
»t
))

208  
çl£
;

210 
nvme_cmd_æush
:

211 
	`zns_æush
(
ns
, 
»q
, 
»t
);

213 
nvme_cmd_zÚe_mgmt_£nd
:

214 
	`zns_zmgmt_£nd
(
ns
, 
»q
, 
»t
);

216 
nvme_cmd_zÚe_mgmt_»cv
:

217 
	`zns_zmgmt_»cv
(
ns
, 
»q
, 
»t
);

220 
	`NVMEV_ERROR
("%s: unim¶em’‹d commªd: %s(%d)\n", 
__func__
,

221 
	`nvme_Ýcode_¡ršg
(
cmd
->
commÚ
.
Ýcode
), cmd->common.opcode);

225  
Œue
;

226 
	}
}

	@zns_ftl.h

3 #iâdeà
_NVMEVIRT_ZNS_FTL_H


4 
	#_NVMEVIRT_ZNS_FTL_H


	)

6 
	~<lšux/ty³s.h
>

7 
	~"nvmev.h
"

8 
	~"nvme_zns.h
"

10 
	#NVMEV_ZNS_DEBUG
(
¡ršg
, 
¬gs
...)

11 

	)

13 
	szn¥¬ams
 {

14 
ušt32_t
 
	mÄ_zÚes
;

15 
ušt32_t
 
	mÄ_aùive_zÚes
;

16 
ušt32_t
 
	mÄ_Ý’_zÚes
;

17 
ušt32_t
 
	md›s_³r_zÚe
;

18 
ušt32_t
 
	mzÚe_size
;

19 
ušt32_t
 
	mzÚe_wb_size
;

22 
ušt32_t
 
	mÄ_zrwa_zÚes
;

23 
ušt32_t
 
	mzrwafg_size
;

24 
ušt32_t
 
	mzrwa_size
;

25 
ušt32_t
 
	mzrwa_bufãr_size
;

26 
ušt32_t
 
	mlbas_³r_zrwafg
;

27 
ušt32_t
 
	mlbas_³r_zrwa
;

30 
	szÚe_»sourû_šfo
 {

31 
__u32
 
	macquœed_út
;

32 
__u32
 
	mtÙ®_út
;

35 
	szns_ál
 {

36 
ssd
 *
	mssd
;

38 
zn¥¬ams
 
	mzp
;

39 
zÚe_»sourû_šfo
 
	m»s_šfos
[
RES_TYPE_COUNT
];

40 
zÚe_desütÜ
 *
	mzÚe_descs
;

41 
zÚe_»pÜt
 *
	m»pÜt_bufãr
;

42 
bufãr
 *
	mzÚe_wr™e_bufãr
;

43 
bufãr
 *
	mzw¿_bufãr
;

44 *
	m¡Üage_ba£_addr
;

48 
šlše
 *
	$g‘_¡Üage_addr_äom_zid
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
)

50  (*)((*)
zns_ál
->
¡Üage_ba£_addr
 + 
zid
 * zns_ál->
zp
.
zÚe_size
);

51 
	}
}

53 
šlše
 
boÞ
 
	$is_zÚe_»sourû_avaž
(
zns_ál
 *zns_ál, 
ušt32_t
 
ty³
)

55  
zns_ál
->
»s_šfos
[
ty³
].
acquœed_út
 < zns_ál->»s_šfos[ty³].
tÙ®_út
;

56 
	}
}

58 
šlše
 
boÞ
 
	$is_zÚe_»sourû_fuÎ
(
zns_ál
 *zns_ál, 
ušt32_t
 
ty³
)

60  
zns_ál
->
»s_šfos
[
ty³
].
acquœed_út
 =ðzns_ál->»s_šfos[ty³].
tÙ®_út
;

61 
	}
}

63 
šlše
 
boÞ
 
	$acquœe_zÚe_»sourû
(
zns_ál
 *zns_ál, 
ušt32_t
 
ty³
)

65 ià(
	`is_zÚe_»sourû_avaž
(
zns_ál
, 
ty³
)) {

66 
zns_ál
->
»s_šfos
[
ty³
].
acquœed_út
++;

67  
Œue
;

70  
çl£
;

71 
	}
}

73 
šlše
 
	$»Ëa£_zÚe_»sourû
(
zns_ál
 *zns_ál, 
ušt32_t
 
ty³
)

75 
	`ASSERT
(
zns_ál
->
»s_šfos
[
ty³
].
acquœed_út
 > 0);

77 
zns_ál
->
»s_šfos
[
ty³
].
acquœed_út
--;

78 
	}
}

80 
šlše
 
	$chªge_zÚe_¡©e
(
zns_ál
 *zns_ál, 
ušt32_t
 
zid
, 
zÚe_¡©e
 
¡©e
)

82 
	`NVMEV_ZNS_DEBUG
("chªg¡©zid %d from %dØ%d \n", 
zid
, 
zns_ál
->
zÚe_descs
[zid].
¡©e
,

83 
¡©e
);

86 
zns_ál
->
zÚe_descs
[
zid
].
¡©e
 = state;

87 
	}
}

89 
šlše
 
ušt32_t
 
	$Ín_to_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
Ín
)

91  (
Ín
è/ (
zns_ál
->
zp
.
zÚe_size
 / zns_ál->
ssd
->
¥
.
pgsz
);

92 
	}
}

94 
šlše
 
ušt64_t
 
	$zÚe_to_¦²
(
zns_ál
 *zns_ál, 
ušt32_t
 
zid
)

96  (
zid
è* (
zns_ál
->
zp
.
zÚe_size
 / zns_ál->
ssd
->
¥
.
pgsz
);

97 
	}
}

99 
šlše
 
ušt32_t
 
	$lba_to_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
lba
)

101  (
lba
è/ (
zns_ál
->
zp
.
zÚe_size
 / zns_ál->
ssd
->
¥
.
£csz
);

102 
	}
}

104 
šlše
 
ušt64_t
 
	$zÚe_to_¦ba
(
zns_ál
 *zns_ál, 
ušt32_t
 
zid
)

106  (
zid
è* (
zns_ál
->
zp
.
zÚe_size
 / zns_ál->
ssd
->
¥
.
£csz
);

107 
	}
}

109 
šlše
 
ušt64_t
 
	$zÚe_to_–ba
(
zns_ál
 *zns_ál, 
ušt32_t
 
zid
)

111  
	`zÚe_to_¦ba
(
zns_ál
, 
zid
 + 1) - 1;

112 
	}
}

114 
šlše
 
ušt64_t
 
	$zÚe_to_–²
(
zns_ál
 *zns_ál, 
ušt32_t
 
zid
)

116  
	`zÚe_to_–ba
(
zns_ál
, 
zid
è/ zns_ál->
ssd
->
¥
.
£cs_³r_pg
;

117 
	}
}

119 
šlše
 
ušt32_t
 
	$d›_to_chªÃl
(
zns_ál
 *zns_ál, 
ušt32_t
 
d›
)

121  (
d›
è% 
zns_ál
->
ssd
->
¥
.
nchs
;

122 
	}
}

124 
šlše
 
ušt32_t
 
	$d›_to_lun
(
zns_ál
 *zns_ál, 
ušt32_t
 
d›
)

126  (
d›
è/ 
zns_ál
->
ssd
->
¥
.
nchs
;

127 
	}
}

129 
šlše
 
ušt64_t
 
	$lba_to_Ín
(
zns_ál
 *zns_ál, 
ušt64_t
 
lba
)

131  
lba
 / 
zns_ál
->
ssd
->
¥
.
£cs_³r_pg
;

132 
	}
}

135 
zns_š™_Çme¥aû
(
nvmev_ns
 *
ns
, 
ušt32_t
 
id
, 
ušt64_t
 
size
, *
m­³d_addr
,

136 
ušt32_t
 
ýu_Ä_di¥©ch”
, 
ál_cÚfigs
 *
ál_cfgs
);

137 
zns_»move_Çme¥aû
(
nvmev_ns
 *
ns
);

139 
zns_zmgmt_»cv
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
);

140 
zns_zmgmt_£nd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
);

141 
boÞ
 
zns_wr™e
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
);

142 
boÞ
 
zns_»ad
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
);

143 
boÞ
 
zns_´oc_nvme_io_cmd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
,

144 
nvmev_dev
 *
nvmev_vdev
);

	@zns_mgmt_recv.c

3 
	~<lšux/kth»ad.h
>

4 
	~<lšux/jiff›s.h
>

5 
	~<lšux/ktime.h
>

6 
	~<lšux/highmem.h
>

7 
	~<lšux/sched/þock.h
>

9 
	~"nvmev.h
"

10 
	~"ssd.h
"

11 
	~"zns_ál.h
"

13 
ušt64_t
 
	$__´p_Œªsãr_d©a
(
ušt64_t
 
´p1
, ušt64_ˆ
´p2
, *
bufãr
, ušt64_ˆ
Ëngth
,

14 
ušt32_t
 
io
)

16 
size_t
 
off£t
;

17 
size_t
 
»maššg
;

18 
size_t
 
´p_offs
 = 0;

19 
size_t
 
´p2_offs
 = 0;

20 
ušt64_t
 
·ddr
;

21 
ušt64_t
 *
·ddr_li¡
 = 
NULL
;

22 
size_t
 
mem_offs
 = 0;

24 
off£t
 = 0;

25 
»maššg
 = 
Ëngth
;

27 
»maššg
) {

28 
size_t
 
io_size
;

29 *
vaddr
;

31 
mem_offs
 = 0;

32 
´p_offs
++;

33 ià(
´p_offs
 == 1) {

34 
·ddr
 = 
´p1
;

35 } ià(
´p_offs
 == 2) {

36 
·ddr
 = 
´p2
;

37 ià(
»maššg
 > 
PAGE_SIZE
) {

38 
·ddr_li¡
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
)) +

39 (
·ddr
 & 
PAGE_OFFSET_MASK
);

40 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

43 
·ddr
 = 
·ddr_li¡
[
´p2_offs
++];

46 
vaddr
 = 
	`km­_©omic_pâ
(
	`PRP_PFN
(
·ddr
));

48 
io_size
 = 
	`mš_t
(
size_t
, 
»maššg
, 
PAGE_SIZE
);

50 ià(
·ddr
 & 
PAGE_OFFSET_MASK
) {

51 
mem_offs
 = 
·ddr
 & 
PAGE_OFFSET_MASK
;

52 ià(
io_size
 + 
mem_offs
 > 
PAGE_SIZE
)

53 
io_size
 = 
PAGE_SIZE
 - 
mem_offs
;

56 ià(
io
 == 0)

57 
	`memýy
(
vaddr
 + 
mem_offs
, 
bufãr
 + 
off£t
, 
io_size
);

59 
	`memýy
(
bufãr
 + 
off£t
, 
vaddr
 + 
mem_offs
, 
io_size
);

61 
	`kunm­_©omic
(
vaddr
);

63 
»maššg
 -ð
io_size
;

64 
off£t
 +ð
io_size
;

67 ià(
·ddr_li¡
 !ð
NULL
)

68 
	`kunm­_©omic
(
·ddr_li¡
);

70  
Ëngth
;

71 
	}
}

73 
	$__fžl_zÚe_»pÜt
(
zns_ál
 *zns_ál, 
nvme_zÚe_mgmt_»cv
 *
cmd
,

74 
zÚe_»pÜt
 *
»pÜt
)

76 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

77 
ušt64_t
 
¦ba
 = 
cmd
->slba;

78 
ušt64_t
 
¡¬t_zid
 = 
	`lba_to_zÚe
(
zns_ál
, 
¦ba
);

80 
ušt64_t
 
by‹s_Œªsãr
 = (
cmd
->
Ä_dw
 + 1è* (
ušt32_t
);

82 
ušt64_t
 
Ä_zÚe_to_»pÜt
;

84 ià(
cmd
->
z¿_¥ecific_ã©u»s
 == 0)

85 
Ä_zÚe_to_»pÜt
 = 
zns_ál
->
zp
.
Ä_zÚes
 - 
¡¬t_zid
;

87 
Ä_zÚe_to_»pÜt
 = (
by‹s_Œªsãr
 / (
zÚe_desütÜ
)) - 1;

89 
»pÜt
->
Ä_zÚes
 = 
Ä_zÚe_to_»pÜt
;

91 
	`memýy
(
»pÜt
->
zd
, &(
zÚe_descs
[
¡¬t_zid
]),

92 (
zÚe_desütÜ
è* 
Ä_zÚe_to_»pÜt
);

93 
	}
}

95 
boÞ
 
	$__check_zmgmt_rcv_ÝtiÚ_suµÜ‹d
(
zns_ál
 *zns_ftl,

96 
nvme_zÚe_mgmt_»cv
 *
cmd
)

98 ià(
	`lba_to_zÚe
(
zns_ál
, 
cmd
->
¦ba
è>ðzns_ál->
zp
.
Ä_zÚes
) {

99 
	`NVMEV_ERROR
("Invalid†ba„ange\n");

102 ià(
cmd
->
z¿
 != 0) {

103 
	`NVMEV_ERROR
("Currently, Not support Extended Report Zones\n");

104  
çl£
;

107 ià(
cmd
->
z¿_¥ecific_f›ld
 != 0) {

108 
	`NVMEV_ERROR
("Currently, Only support†isting‡ll zone\n");

109  
çl£
;

112  
Œue
;

113 
	}
}

115 
	$zns_zmgmt_»cv
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

117 
zns_ál
 *zns_áÈð(zns_áÈ*)
ns
->
áls
;

118 
zÚe_»pÜt
 *
bufãr
 = 
zns_ál
->
»pÜt_bufãr
;

119 
nvme_zÚe_mgmt_»cv
 *
cmd
 = (nvme_zÚe_mgmt_»cv *)
»q
->cmd;

121 
ušt64_t
 
´p1
 = (ušt64_t)
cmd
->prp1;

122 
ušt64_t
 
´p2
 = (ušt64_t)
cmd
->prp2;

123 
ušt64_t
 
Ëngth
 = (
cmd
->
Ä_dw
 + 1è* (
ušt32_t
);

124 
ušt32_t
 
¡©us
;

126 
	`NVMEV_ZNS_DEBUG
("%s slba 0x%llx‚r_dw 0x%lx‡ction %u…artial %u‡ction_specific 0x%x\n",

127 
__func__
, 
cmd
->
¦ba
, 
Ëngth
, cmd->
z¿
, cmd->
z¿_¥ecific_ã©u»s
,

128 
cmd
->
z¿_¥ecific_f›ld
);

130 ià(
	`__check_zmgmt_rcv_ÝtiÚ_suµÜ‹d
(
zns_ál
, 
cmd
)) {

131 
	`__fžl_zÚe_»pÜt
(
zns_ál
, 
cmd
, 
bufãr
);

133 
	`__´p_Œªsãr_d©a
(
´p1
, 
´p2
, 
bufãr
, 
Ëngth
, 0);

134 
¡©us
 = 
NVME_SC_SUCCESS
;

136 
¡©us
 = 
NVME_SC_INVALID_FIELD
;

139 
»t
->
n£cs_rg‘
 = 
»q
->
n£cs_¡¬t
;

140 
»t
->
¡©us
 = status;

142 
	}
}

	@zns_mgmt_send.c

3 
	~"nvmev.h
"

4 
	~"ssd.h
"

5 
	~"zns_ál.h
"

6 
	~"zns_»ad_wr™e.h
"

7 
	#RESET_LATENCY
 2000000

	)

9 
ušt32_t
 
	$__zmgmt_£nd_þo£_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
)

11 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

12 
zÚe_¡©e
 
cur_¡©e
 = 
zÚe_descs
[
zid
].
¡©e
;

13 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

15 
cur_¡©e
) {

16 
ZONE_STATE_OPENED_IMPL
:

17 
ZONE_STATE_OPENED_EXPL
:

18 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_CLOSED
);

20 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
);

23 
ZONE_STATE_CLOSED
:

26 
¡©us
 = 
NVME_SC_ZNS_INVALID_TRANSITION
;

30  
¡©us
;

31 
	}
}

33 
ušt32_t
 
	$__zmgmt_£nd_fšish_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
)

35 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

36 
zÚe_¡©e
 
cur_¡©e
 = 
zÚe_descs
[
zid
].
¡©e
;

37 
boÞ
 
is_zrwa_zÚe
 = 
zÚe_descs
[
zid
].
zrwav
;

38 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

40 
cur_¡©e
) {

41 
ZONE_STATE_OPENED_IMPL
:

42 
ZONE_STATE_OPENED_EXPL
:

43 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
);

45 
ZONE_STATE_CLOSED
:

46 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ACTIVE_ZONE
);

48 ià(
is_zrwa_zÚe
)

49 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ZRWA_ZONE
);

51 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_FULL
);

54 
ZONE_STATE_EMPTY
:

55 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_FULL
);

57 
ZONE_STATE_FULL
:

61 
¡©us
 = 
NVME_SC_ZNS_INVALID_TRANSITION
;

65  
¡©us
;

66 
	}
}

68 
ušt32_t
 
	$__zmgmt_£nd_Ý’_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
, 
ušt32_t
 
zrwa
)

70 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

71 
zÚe_¡©e
 
cur_¡©e
 = 
zÚe_descs
[
zid
].
¡©e
;

72 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

74 
cur_¡©e
) {

75 
ZONE_STATE_EMPTY
:

76 ià(
	`is_zÚe_»sourû_fuÎ
(
zns_ál
, 
ACTIVE_ZONE
))

77  
NVME_SC_ZNS_NO_ACTIVE_ZONE
;

79 ià(
	`is_zÚe_»sourû_fuÎ
(
zns_ál
, 
OPEN_ZONE
))

80  
NVME_SC_ZNS_NO_OPEN_ZONE
;

82 ià(
zrwa
) {

83 ià(
	`is_zÚe_»sourû_fuÎ
(
zns_ál
, 
ZRWA_ZONE
))

84  
NVME_SC_ZNS_ZRWA_RSRC_UNAVAIL
;

86 
	`acquœe_zÚe_»sourû
(
zns_ál
, 
ZRWA_ZONE
);

87 
zÚe_descs
[
zid
].
zrwav
 = 1;

90 
	`acquœe_zÚe_»sourû
(
zns_ál
, 
ACTIVE_ZONE
);

92 
ZONE_STATE_CLOSED
:

93 ià(
	`acquœe_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
è=ð
çl£
)

94  
NVME_SC_ZNS_NO_OPEN_ZONE
;

96 
ZONE_STATE_OPENED_IMPL
:

97 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_OPENED_EXPL
);

100 
ZONE_STATE_OPENED_EXPL
:

103 
¡©us
 = 
NVME_SC_ZNS_INVALID_TRANSITION
;

107  
¡©us
;

108 
	}
}

110 
	$__»£t_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
)

112 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

113 
ušt32_t
 
zÚe_size
 = 
zns_ál
->
zp
.zone_size;

114 
ušt8_t
 *
zÚe_¡¬t_addr
 = (ušt8_ˆ*)
	`g‘_¡Üage_addr_äom_zid
(
zns_ál
, 
zid
);

116 
	`NVMEV_ZNS_DEBUG
("% n %d zid %lu s¹‡dd» 0x%Îx zÚe_siz%x \n", 
__func__
,

117 
zns_ál
->
ns
, 
zid
, (
ušt64_t
)
zÚe_¡¬t_addr
, 
zÚe_size
);

119 
	`mem£t
(
zÚe_¡¬t_addr
, 0, 
zÚe_size
);

121 
zÚe_descs
[
zid
].
wp
 = zÚe_descs[zid].
z¦ba
;

122 
zÚe_descs
[
zid
].
zrwav
 = 0;

124 ià(
zns_ál
->
zp
.
zrwa_bufãr_size
)

125 
	`bufãr_»fžl
(&
zns_ál
->
zw¿_bufãr
[
zid
]);

126 
	}
}

128 
ušt32_t
 
	$__zmgmt_£nd_»£t_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
)

130 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

131 
zÚe_¡©e
 
cur_¡©e
 = 
zÚe_descs
[
zid
].
¡©e
;

132 
boÞ
 
is_zrwa_zÚe
 = 
zÚe_descs
[
zid
].
zrwav
;

133 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

135 
cur_¡©e
) {

136 
ZONE_STATE_OPENED_IMPL
:

137 
ZONE_STATE_OPENED_EXPL
:

138 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
);

140 
ZONE_STATE_CLOSED
:

141 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ACTIVE_ZONE
);

143 ià(
is_zrwa_zÚe
)

144 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ZRWA_ZONE
);

146 
ZONE_STATE_FULL
:

147 
ZONE_STATE_EMPTY
:

148 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_EMPTY
);

149 
	`__»£t_zÚe
(
zns_ál
, 
zid
);

153 
¡©us
 = 
NVME_SC_ZNS_INVALID_TRANSITION
;

157  
¡©us
;

158 
	}
}

160 
ušt32_t
 
	$__zmgmt_£nd_ofæše_zÚe
(
zns_ál
 *zns_ál, 
ušt64_t
 
zid
)

162 
zÚe_¡©e
 
cur_¡©e
 = 
zns_ál
->
zÚe_descs
[
zid
].
¡©e
;

163 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

165 
cur_¡©e
) {

166 
ZONE_STATE_READ_ONLY
:

167 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_OFFLINE
);

169 
ZONE_STATE_OFFLINE
:

172 
¡©us
 = 
NVME_SC_ZNS_INVALID_TRANSITION
;

176  
¡©us
;

177 
	}
}

179 
ušt32_t
 
	$__zmgmt_£nd_æush_ex¶ic™_zrwa
(
zns_ál
 *zns_ál, 
ušt64_t
 
¦ba
)

181 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

182 
ušt64_t
 
zid
 = 
	`lba_to_zÚe
(
zns_ál
, 
¦ba
);

183 
ušt64_t
 
wp
 = 
zÚe_descs
[
zid
].wp;

184 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

185 
zÚe_¡©e
 
cur_¡©e
 = 
zÚe_descs
[
zid
].
¡©e
;

186 
ušt64_t
 
zÚe_ÿ·c™y
 = 
zÚe_descs
[
zid
].zone_capacity;

188 cÚ¡ 
ušt32_t
 
lbas_³r_zrwafg
 = 
zns_ál
->
zp
.lbas_per_zrwafg;

189 cÚ¡ 
ušt32_t
 
lbas_³r_zrwa
 = 
zns_ál
->
zp
.lbas_per_zrwa;

191 
ušt64_t
 
zrwa_¡¬t
 = 
wp
;

192 
ušt64_t
 
zrwa_’d
 = 
	`mš
(
zrwa_¡¬t
 + 
lbas_³r_zrwa
 - 1,

193 (
size_t
)
	`zÚe_to_¦ba
(
zns_ál
, 
zid
è+ 
zÚe_ÿ·c™y
 - 1);

194 
ušt64_t
 
Ä_lbas_æush
 = 
¦ba
 - 
wp
 + 1;

196 
	`NVMEV_ZNS_DEBUG
(

198 
__func__
, 
¦ba
, 
zrwa_¡¬t
, 
zrwa_’d
, 
zÚe_descs
[
zid
].
zrwav
);

200 ià(
zÚe_descs
[
zid
].
zrwav
 == 0)

201  
NVME_SC_ZNS_INVALID_ZONE_OPERATION
;

203 ià(!(
¦ba
 >ð
zrwa_¡¬t
 && slb¨<ð
zrwa_’d
))

204  
NVME_SC_ZNS_INVALID_ZONE_OPERATION
;

206 ià((
Ä_lbas_æush
 % 
lbas_³r_zrwafg
) != 0)

207  
NVME_SC_INVALID_FIELD
;

209 
cur_¡©e
) {

210 
ZONE_STATE_OPENED_EXPL
:

211 
ZONE_STATE_OPENED_IMPL
:

212 
ZONE_STATE_CLOSED
:

213 
zÚe_descs
[
zid
].
wp
 = 
¦ba
 + 1;

215 ià(
zÚe_descs
[
zid
].
wp
 =ð(
	`zÚe_to_¦ba
(
zns_ál
, zidè+ 
zÚe_ÿ·c™y
)) {

217 ià(
cur_¡©e
 !ð
ZONE_STATE_CLOSED
)

218 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
);

219 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ACTIVE_ZONE
);

220 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ZRWA_ZONE
);

221 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_FULL
);

225 
¡©us
 = 
NVME_SC_ZNS_INVALID_ZONE_OPERATION
;

229  
¡©us
;

230 
	}
}

232 
ušt32_t
 
	$__zmgmt_£nd
(
zns_ál
 *zns_ál, 
ušt64_t
 
¦ba
, 
ušt32_t
 
aùiÚ
,

233 
ušt32_t
 
ÝtiÚ
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

235 
ušt32_t
 
¡©us
;

236 
ušt64_t
 
zid
 = 
	`lba_to_zÚe
(
zns_ál
, 
¦ba
);

238 
ssd·¿ms
 *
¥p
 = &
zns_ál
->
ssd
->
¥
;

239 
zn¥¬ams
 *
zp
 = &
zns_ál
->zp;

241 
nvme_rw_commªd
 *
cmd
 = &(
»q
->cmd->
rw
);

243 
ušt64_t
 
¦²
, 
–²
, 
Ín
, 
zÚe_–²
;

244 
ušt64_t
 
pgs
 = 0;

245 
ušt64_t
 
Ä_lba
 = 
	`__Ä_lbas_äom_rw_cmd
(
cmd
);

246 
Çnd_lun
 *
lun
;

248 
¦²
 = 
	`lba_to_Ín
(
zns_ál
, 
¦ba
);

249 
–²
 = 
	`lba_to_Ín
(
zns_ál
, 
¦ba
 + 
Ä_lba
 - 1);

250 
zÚe_–²
 = 
	`zÚe_to_–²
(
zns_ál
, 
zid
);

252 
ušt64_t
 
n£cs_¡¬t
 = 
»q
->nsecs_start;

253 
ušt64_t
 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

255 
aùiÚ
) {

256 
ZSA_CLOSE_ZONE
:

257 
¡©us
 = 
	`__zmgmt_£nd_þo£_zÚe
(
zns_ál
, 
zid
);

259 
ZSA_FINISH_ZONE
:

260 
¡©us
 = 
	`__zmgmt_£nd_fšish_zÚe
(
zns_ál
, 
zid
);

262 
ZSA_OPEN_ZONE
:

263 
¡©us
 = 
	`__zmgmt_£nd_Ý’_zÚe
(
zns_ál
, 
zid
, 
ÝtiÚ
);

265 
ZSA_RESET_ZONE
:

266 
¡©us
 = 
	`__zmgmt_£nd_»£t_zÚe
(
zns_ál
, 
zid
);

267 
ušt64_t
 
Ït
 = 0;

268 
ušt64_t
 
maxÏt
 = 0;

269 
ušt64_t
 
cmd_¡ime
 = 
»q
->
n£cs_¡¬t
;

270 
Ín
 = 
¦²
;†² <ð
–²
;†² +ð
pgs
) {

271 
µa
…pa;

272 
ušt64_t
 
pg_off
;

274 
µa
 = 
	`__Ín_to_µa
(
zns_ál
, 
Ín
);

275 
pg_off
 = 
µa
.
g
.
pg
 % 
¥p
->
pgs_³r_ÚeshÙpg
;

276 
pgs
 = 
	`mš
(
–²
 - 
Ín
 + 1, (
ušt64_t
)(
¥p
->
pgs_³r_ÚeshÙpg
 - 
pg_off
));

278 ià(((
pg_off
 + 
pgs
è=ð
¥p
->
pgs_³r_ÚeshÙpg
) ||

279 ((
Ín
 + 
pgs
 - 1è=ð
zÚe_–²
)) {

280 
cmd_¡ime
 = 
	`max_c¡ime_vs_ioþock
(cmd_¡ime, 
zns_ál
->
ssd
);

281 
lun
 = 
	`g‘_lun
(
zns_ál
->
ssd
, &
µa
);

282 
lun
->
Ãxt_lun_avaž_time
 =

283 
	`max
(
lun
->
Ãxt_lun_avaž_time
, 
cmd_¡ime
è+ 
RESET_LATENCY
;

284 
Ït
 = 
lun
->
Ãxt_lun_avaž_time
 - 
cmd_¡ime
;

285 
maxÏt
 = 
	`max
(
Ït
, maxlat);

288 
»t
->
n£cs_rg‘
 +ð
maxÏt
;

290 
ZSA_OFFLINE_ZONE
:

291 
¡©us
 = 
	`__zmgmt_£nd_ofæše_zÚe
(
zns_ál
, 
zid
);

293 
ZSA_FLUSH_EXPL_ZRWA
:

294 
¡©us
 = 
	`__zmgmt_£nd_æush_ex¶ic™_zrwa
(
zns_ál
, 
¦ba
);

298  
¡©us
;

299 
	}
}

301 
	$zns_zmgmt_£nd
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

303 
zns_ál
 *zns_áÈð(zns_áÈ*)
ns
->
áls
;

304 
nvme_zÚe_mgmt_£nd
 *
cmd
 = (nvme_zÚe_mgmt_£nd *)
»q
->cmd;

305 
ušt32_t
 
£Ëù_®l
 = 
cmd
->select_all;

306 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

308 
ušt32_t
 
aùiÚ
 = 
cmd
->
z§
;

309 
ušt32_t
 
ÝtiÚ
 = 
cmd
->
z§so
;

310 
ušt64_t
 
¦ba
 = 
cmd
->slba;

311 
ušt64_t
 
zid
 = 
	`lba_to_zÚe
(
zns_ál
, 
¦ba
);

313 
»t
->
n£cs_rg‘
 = 
»q
->
n£cs_¡¬t
;

315 ià(
£Ëù_®l
) {

316 
zid
 = 0; zid < 
zns_ál
->
zp
.
Ä_zÚes
; zid++)

317 
	`__zmgmt_£nd
(
zns_ál
, 
	`zÚe_to_¦ba
(zns_ál, 
zid
), 
aùiÚ
, 
ÝtiÚ
, 
»q
, 
»t
);

319 
¡©us
 = 
	`__zmgmt_£nd
(
zns_ál
, 
¦ba
, 
aùiÚ
, 
ÝtiÚ
, 
»q
, 
»t
);

322 
	`NVMEV_ZNS_DEBUG
("%s slba %llx zid %lu select_all %lu‡ction %u status %lu option %lu\n",

323 
__func__
, 
cmd
->
¦ba
, 
zid
, 
£Ëù_®l
, cmd->
z§
, 
¡©us
, 
ÝtiÚ
);

325 
»t
->
¡©us
 = status;

327 
	}
}

	@zns_read_write.c

3 
	~"nvmev.h
"

4 
	~"ssd.h
"

5 
	~"zns_ál.h
"

7 
	~"zns_»ad_wr™e.h
"

8 
scheduË_š‹º®_Ý”©iÚ
(
sqid
, 
n£cs_rg‘
,

9 
bufãr
 *
wr™e_bufãr
, 
size_t
 
buffs_to_»Ëa£
,

10 
nvmev_dev
 *
nvmev_vdev
);

12 
boÞ
 
	$__check_bound¬y_”rÜ
(
zns_ál
 *zns_ál, 
ušt64_t
 
¦ba
, 
ušt32_t
 
Ä_lba
)

14  
	`lba_to_zÚe
(
zns_ál
, 
¦ba
è=ðlba_to_zÚe(zns_ál, slb¨+ 
Ä_lba
 - 1);

15 
	}
}

17 
	$__šü—£_wr™e_±r
(
zns_ál
 *zns_ál, 
ušt32_t
 
zid
, ušt32_ˆ
Ä_lba
)

19 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

20 
ušt64_t
 
cur_wr™e_±r
 = 
zÚe_descs
[
zid
].
wp
;

21 
ušt64_t
 
zÚe_ÿ·c™y
 = 
zÚe_descs
[
zid
].zone_capacity;

23 
cur_wr™e_±r
 +ð
Ä_lba
;

25 
zÚe_descs
[
zid
].
wp
 = 
cur_wr™e_±r
;

27 ià(
cur_wr™e_±r
 =ð(
	`zÚe_to_¦ba
(
zns_ál
, 
zid
è+ 
zÚe_ÿ·c™y
)) {

29 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
);

30 
	`»Ëa£_zÚe_»sourû
(
zns_ál
, 
ACTIVE_ZONE
);

32 ià(
zÚe_descs
[
zid
].
zrwav
)

33 
	`ASSERT
(0);

35 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_FULL
);

36 } ià(
cur_wr™e_±r
 > (
	`zÚe_to_¦ba
(
zns_ál
, 
zid
è+ 
zÚe_ÿ·c™y
)) {

37 
	`NVMEV_ERROR
("[%s] Wr™Bound¬yƒ¼Ü!!\n", 
__func__
);

39 
	}
}

41 
boÞ
 
	$__zns_wr™e
(
nvmev_ns
 *
ns
, 
zns_ál
 *zns_ál, 
nvmev_»que¡
 *
»q
,

42 
nvmev_»suÉ
 *
»t
)

44 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

45 
ssd·¿ms
 *
¥p
 = &
zns_ál
->
ssd
->
¥
;

46 
nvme_rw_commªd
 *
cmd
 = &(
»q
->cmd->
rw
);

48 
ušt64_t
 
¦ba
 = 
cmd
->slba;

49 
ušt64_t
 
Ä_lba
 = 
	`__Ä_lbas_äom_rw_cmd
(
cmd
);

50 
ušt64_t
 
¦²
, 
–²
, 
Ín
, 
zÚe_–²
;

52 
ušt32_t
 
zid
 = 
	`lba_to_zÚe
(
zns_ál
, 
¦ba
);

53 
zÚe_¡©e
 
¡©e
 = 
zÚe_descs
[
zid
].state;

55 
ušt64_t
 
n£cs_¡¬t
 = 
»q
->nsecs_start;

56 
ušt64_t
 
n£cs_xãr_com¶‘ed
 = 
n£cs_¡¬t
;

57 
ušt64_t
 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

58 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

60 
ušt64_t
 
pgs
 = 0;

62 
bufãr
 *
wr™e_bufãr
;

64 ià(
cmd
->
Ýcode
 =ð
nvme_cmd_zÚe_­³nd
) {

65 
¦ba
 = 
zÚe_descs
[
zid
].
wp
;

66 
cmd
->
¦ba
 = slba;

69 
¦²
 = 
	`lba_to_Ín
(
zns_ál
, 
¦ba
);

70 
–²
 = 
	`lba_to_Ín
(
zns_ál
, 
¦ba
 + 
Ä_lba
 - 1);

71 
zÚe_–²
 = 
	`zÚe_to_–²
(
zns_ál
, 
zid
);

73 
	`NVMEV_ZNS_DEBUG
("% ¦b¨0x%Îx‚r_lb¨0x%lx zÚe_id %d s‹ %d\n", 
__func__
, 
¦ba
, 
Ä_lba
,

74 
zid
, 
¡©e
);

76 ià(
zns_ál
->
zp
.
zÚe_wb_size
)

77 
wr™e_bufãr
 = &(
zns_ál
->
zÚe_wr™e_bufãr
[
zid
]);

79 
wr™e_bufãr
 = 
zns_ál
->
ssd
->write_buffer;

81 ià(
	`bufãr_®loÿ‹
(
wr™e_bufãr
, 
	`LBA_TO_BYTE
(
Ä_lba
)) < LBA_TO_BYTE(nr_lba))

82  
çl£
;

84 ià((
	`LBA_TO_BYTE
(
Ä_lba
è% 
¥p
->
wr™e_un™_size
) != 0) {

85 
¡©us
 = 
NVME_SC_ZNS_INVALID_WRITE
;

86 
out
;

89 ià(
	`__check_bound¬y_”rÜ
(
zns_ál
, 
¦ba
, 
Ä_lba
è=ð
çl£
) {

91 
¡©us
 = 
NVME_SC_ZNS_ERR_BOUNDARY
;

92 
out
;

96 ià(
¦ba
 !ð
zÚe_descs
[
zid
].
wp
) {

97 
	`NVMEV_ERROR
("%s WPƒrror slba 0x%llx‚r_lba 0x%llx zone_id %d wp %llx state %d\n",

98 
__func__
, 
¦ba
, 
Ä_lba
, 
zid
, 
zns_ál
->
zÚe_descs
[zid].
wp
, 
¡©e
);

99 
¡©us
 = 
NVME_SC_ZNS_INVALID_WRITE
;

100 
out
;

103 
¡©e
) {

104 
ZONE_STATE_EMPTY
: {

106 ià(
¦ba
 !ð
zÚe_descs
[
zid
].
z¦ba
) {

107 
¡©us
 = 
NVME_SC_ZNS_INVALID_WRITE
;

108 
out
;

111 ià(
	`is_zÚe_»sourû_fuÎ
(
zns_ál
, 
ACTIVE_ZONE
)) {

112 
¡©us
 = 
NVME_SC_ZNS_NO_ACTIVE_ZONE
;

113 
out
;

115 ià(
	`is_zÚe_»sourû_fuÎ
(
zns_ál
, 
OPEN_ZONE
)) {

116 
¡©us
 = 
NVME_SC_ZNS_NO_OPEN_ZONE
;

117 
out
;

119 
	`acquœe_zÚe_»sourû
(
zns_ál
, 
ACTIVE_ZONE
);

122 
ZONE_STATE_CLOSED
: {

123 ià(
	`acquœe_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
è=ð
çl£
) {

124 
¡©us
 = 
NVME_SC_ZNS_NO_OPEN_ZONE
;

125 
out
;

129 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_OPENED_IMPL
);

132 
ZONE_STATE_OPENED_IMPL
:

133 
ZONE_STATE_OPENED_EXPL
: {

136 
ZONE_STATE_FULL
:

137 
¡©us
 = 
NVME_SC_ZNS_ERR_FULL
;

138 
ZONE_STATE_READ_ONLY
:

139 
¡©us
 = 
NVME_SC_ZNS_ERR_READ_ONLY
;

140 
ZONE_STATE_OFFLINE
:

141 
¡©us
 = 
NVME_SC_ZNS_ERR_OFFLINE
;

142 
out
;

145 
	`__šü—£_wr™e_±r
(
zns_ál
, 
zid
, 
Ä_lba
);

148 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

149 
n£cs_Ï‹¡
 = 
	`ssd_advªû_wr™e_bufãr
(
zns_ál
->
ssd
,‚secs_latest,

150 
	`LBA_TO_BYTE
(
Ä_lba
), 
Œªsãr_4
);

151 
n£cs_xãr_com¶‘ed
 = 
n£cs_Ï‹¡
;

153 
Ín
 = 
¦²
;†² <ð
–²
;†² +ð
pgs
) {

154 
µa
…pa;

155 
ušt64_t
 
pg_off
;

157 
µa
 = 
	`__Ín_to_µa
(
zns_ál
, 
Ín
);

158 
pg_off
 = 
µa
.
g
.
pg
 % 
¥p
->
pgs_³r_ÚeshÙpg
;

159 
pgs
 = 
	`mš
(
–²
 - 
Ín
 + 1, (
ušt64_t
)(
¥p
->
pgs_³r_ÚeshÙpg
 - 
pg_off
));

162 ià(((
pg_off
 + 
pgs
è=ð
¥p
->
pgs_³r_ÚeshÙpg
è|| ((
Ín
 +…g - 1è=ð
zÚe_–²
)) {

163 
Çnd_cmd
 
swr
 = {

164 .
ty³
 = 
USER_IO
,

165 .
cmd
 = 
NAND_WRITE
,

166 .
¡ime
 = 
n£cs_xãr_com¶‘ed
,

167 .
xãr_size
 = 
¥p
->
pgs_³r_ÚeshÙpg
 * sµ->
pgsz
,

168 .
š‹¾—ve_pci_dma
 = 
çl£
,

169 .
µa
 = &ppa,

171 
size_t
 
bufs_to_»Ëa£
;

172 
ušt32_t
 
uÇligÃd_¥aû
 =

173 
zns_ál
->
zp
.
zÚe_size
 % (
¥p
->
pgs_³r_ÚeshÙpg
 * sµ->
pgsz
);

174 
ušt64_t
 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd
(
zns_ál
->
ssd
, &
swr
);

176 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

177 
	`NVMEV_ZNS_DEBUG
("%s Flush slba 0x%llx‚r_lba 0x%lx zone_id %d state %d\n",

178 
__func__
, 
¦ba
, 
Ä_lba
, 
zid
, 
¡©e
);

180 ià(((
Ín
 + 
pgs
 - 1è=ð
zÚe_–²
è&& (
uÇligÃd_¥aû
 > 0))

181 
bufs_to_»Ëa£
 = 
uÇligÃd_¥aû
;

183 
bufs_to_»Ëa£
 = 
¥p
->
pgs_³r_ÚeshÙpg
 * sµ->
pgsz
;

185 
	`scheduË_š‹º®_Ý”©iÚ
(
»q
->
sq_id
, 
n£cs_com¶‘ed
, 
wr™e_bufãr
,

186 
bufs_to_»Ëa£
, 
ns
->
p_dev
);

190 
out
:

191 
»t
->
¡©us
 = status;

192 ià((
cmd
->
cÚŒÞ
 & 
NVME_RW_FUA
) ||

193 (
¥p
->
wr™e_—¾y_com¶‘iÚ
 == 0))

194 
»t
->
n£cs_rg‘
 = 
n£cs_Ï‹¡
;

196 
»t
->
n£cs_rg‘
 = 
n£cs_xãr_com¶‘ed
;

198  
Œue
;

199 
	}
}

201 
boÞ
 
	$__zns_wr™e_zrwa
(
nvmev_ns
 *
ns
, 
zns_ál
 *zns_ftl,

202 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

204 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

205 
ssd·¿ms
 *
¥p
 = &
zns_ál
->
ssd
->
¥
;

206 
zn¥¬ams
 *
zµ
 = &
zns_ál
->
zp
;

207 
nvme_rw_commªd
 *
cmd
 = &(
»q
->cmd->
rw
);

208 
ušt64_t
 
¦ba
 = 
cmd
->slba;

209 
ušt64_t
 
Ä_lba
 = 
	`__Ä_lbas_äom_rw_cmd
(
cmd
);

210 
ušt64_t
 
–ba
 = 
cmd
->
¦ba
 + 
Ä_lba
 - 1;

213 
ušt32_t
 
zid
 = 
	`lba_to_zÚe
(
zns_ál
, 
¦ba
);

214 
zÚe_¡©e
 
¡©e
 = 
zÚe_descs
[
zid
].state;

216 
ušt64_t
 
´ev_wp
 = 
zÚe_descs
[
zid
].
wp
;

217 cÚ¡ 
ušt32_t
 
lbas_³r_zrwa
 = 
zµ
->lbas_per_zrwa;

218 cÚ¡ 
ušt32_t
 
lbas_³r_zrwafg
 = 
zµ
->lbas_per_zrwafg;

219 
ušt64_t
 
zrwa_im¶_¡¬t
 = 
´ev_wp
 + 
lbas_³r_zrwa
;

220 
ušt64_t
 
zrwa_im¶_’d
 = 
´ev_wp
 + (2 * 
lbas_³r_zrwa
) - 1;

222 
ušt64_t
 
n£cs_¡¬t
 = 
»q
->nsecs_start;

223 
ušt64_t
 
n£cs_com¶‘ed
 = 
n£cs_¡¬t
;

224 
ušt64_t
 
n£cs_xãr_com¶‘ed
 = 
n£cs_¡¬t
;

225 
ušt64_t
 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

226 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

228 
µa
…pa;

229 
Çnd_cmd
 
swr
;

231 
ušt64_t
 
Ä_lbas_æush
 = 0, 
Ín
, 
»maššg
, 
pgs
 = 0, 
pg_off
;

233 
	`NVMEV_DEBUG
(

235 
__func__
, 
¦ba
, 
Ä_lba
, 
zid
, 
¡©e
, 
´ev_wp
, 
zrwa_im¶_¡¬t
, 
zrwa_im¶_’d
,

236 
zns_ál
->
zw¿_bufãr
[
zid
].
»maššg
);

238 ià((
	`LBA_TO_BYTE
(
Ä_lba
è% 
¥p
->
wr™e_un™_size
) != 0) {

239 
¡©us
 = 
NVME_SC_ZNS_INVALID_WRITE
;

240 
out
;

243 ià(
	`__check_bound¬y_”rÜ
(
zns_ál
, 
¦ba
, 
Ä_lba
è=ð
çl£
) {

245 
¡©us
 = 
NVME_SC_ZNS_ERR_BOUNDARY
;

246 
out
;

250 ià(
¦ba
 < 
zÚe_descs
[
zid
].
wp
 || 
–ba
 > 
zrwa_im¶_’d
) {

251 
	`NVMEV_ERROR
("%s slba 0x%llx‚r_lba 0x%llx zone_id %d wp 0x%llx state %d\n",

252 
__func__
, 
¦ba
, 
Ä_lba
, 
zid
, 
zÚe_descs
[zid].
wp
, 
¡©e
);

253 
¡©us
 = 
NVME_SC_ZNS_INVALID_WRITE
;

254 
out
;

257 
¡©e
) {

258 
ZONE_STATE_CLOSED
:

259 
ZONE_STATE_EMPTY
: {

260 ià(
	`acquœe_zÚe_»sourû
(
zns_ál
, 
OPEN_ZONE
è=ð
çl£
) {

261 
¡©us
 = 
NVME_SC_ZNS_NO_OPEN_ZONE
;

262 
out
;

265 ià(!
	`bufãr_®loÿ‹
(&
zns_ál
->
zw¿_bufãr
[
zid
], 
zµ
->
zrwa_size
))

266 
	`NVMEV_ASSERT
(0);

269 
	`chªge_zÚe_¡©e
(
zns_ál
, 
zid
, 
ZONE_STATE_OPENED_IMPL
);

272 
ZONE_STATE_OPENED_IMPL
:

273 
ZONE_STATE_OPENED_EXPL
: {

276 
ZONE_STATE_FULL
:

277 
¡©us
 = 
NVME_SC_ZNS_ERR_FULL
;

278 
out
;

279 
ZONE_STATE_READ_ONLY
:

280 
¡©us
 = 
NVME_SC_ZNS_ERR_READ_ONLY
;

281 
out
;

282 
ZONE_STATE_OFFLINE
:

283 
¡©us
 = 
NVME_SC_ZNS_ERR_OFFLINE
;

284 
out
;

286 
ZONE_STATE_EMPTY
 :

287  
NVME_SC_ZNS_INVALID_ZONE_OPERATION
;

291 ià(
–ba
 >ð
zrwa_im¶_¡¬t
) {

292 
Ä_lbas_æush
 = 
	`DIV_ROUND_UP
((
–ba
 - 
zrwa_im¶_¡¬t
 + 1), 
lbas_³r_zrwafg
) *

293 
lbas_³r_zrwafg
;

295 
	`NVMEV_DEBUG
("%s implicitly flush zid %d wp before 0x%llx‡fter 0x%llx buffer %lu",

296 
__func__
, 
zid
, 
´ev_wp
, 
zÚe_descs
[zid].
wp
 + 
Ä_lbas_æush
,

297 
zns_ál
->
zw¿_bufãr
[
zid
].
»maššg
);

298 } ià(
–ba
 =ð
	`zÚe_to_–ba
(
zns_ál
, 
zid
)) {

300 
Ä_lbas_æush
 = 
–ba
 - 
´ev_wp
 + 1;

302 
	`NVMEV_DEBUG
("%sƒnd of zone zid %d wp before 0x%llx‡fter 0x%llx buffer %lu",

303 
__func__
, 
zid
, 
´ev_wp
, 
zÚe_descs
[zid].
wp
 + 
Ä_lbas_æush
,

304 
zns_ál
->
zw¿_bufãr
[
zid
].
»maššg
);

307 ià(
Ä_lbas_æush
 > 0) {

308 ià(!
	`bufãr_®loÿ‹
(&
zns_ál
->
zw¿_bufãr
[
zid
], 
	`LBA_TO_BYTE
(
Ä_lbas_æush
)))

309  
çl£
;

311 
	`__šü—£_wr™e_±r
(
zns_ál
, 
zid
, 
Ä_lbas_æush
);

314 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

315 
n£cs_Ï‹¡
 = 
	`ssd_advªû_wr™e_bufãr
(
zns_ál
->
ssd
,‚secs_latest,

316 
	`LBA_TO_BYTE
(
Ä_lba
), 
Œªsãr_4
);

317 
n£cs_xãr_com¶‘ed
 = 
n£cs_Ï‹¡
;

319 
Ín
 = 
	`lba_to_Ín
(
zns_ál
, 
´ev_wp
);

320 
»maššg
 = 
Ä_lbas_æush
 / 
¥p
->
£cs_³r_pg
;

322 
»maššg
 > 0) {

323 
µa
 = 
	`__Ín_to_µa
(
zns_ál
, 
Ín
);

324 
pg_off
 = 
µa
.
g
.
pg
 % 
¥p
->
pgs_³r_ÚeshÙpg
;

325 
pgs
 = 
	`mš
(
»maššg
, (
ušt64_t
)(
¥p
->
pgs_³r_ÚeshÙpg
 - 
pg_off
));

327 ià((
pg_off
 + 
pgs
è=ð
¥p
->
pgs_³r_ÚeshÙpg
) {

328 
swr
.
ty³
 = 
USER_IO
;

329 
swr
.
cmd
 = 
NAND_WRITE
;

330 
swr
.
¡ime
 = 
n£cs_xãr_com¶‘ed
;

331 
swr
.
xãr_size
 = 
¥p
->
pgs_³r_ÚeshÙpg
 * sµ->
pgsz
;

332 
swr
.
š‹¾—ve_pci_dma
 = 
çl£
;

333 
swr
.
µa
 = &ppa;

335 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd
(
zns_ál
->
ssd
, &
swr
);

336 
n£cs_Ï‹¡
 = 
	`max
(
n£cs_com¶‘ed
,‚secs_latest);

338 
	`scheduË_š‹º®_Ý”©iÚ
(
»q
->
sq_id
, 
n£cs_com¶‘ed
,

339 &
zns_ál
->
zw¿_bufãr
[
zid
],

340 
¥p
->
pgs_³r_ÚeshÙpg
 * sµ->
pgsz
, 
ns
->
p_dev
);

343 
Ín
 +ð
pgs
;

344 
»maššg
 -ð
pgs
;

347 
out
:

348 
»t
->
¡©us
 = status;

350 ià((
cmd
->
cÚŒÞ
 & 
NVME_RW_FUA
) ||

351 (
¥p
->
wr™e_—¾y_com¶‘iÚ
 == 0))

352 
»t
->
n£cs_rg‘
 = 
n£cs_Ï‹¡
;

354 
»t
->
n£cs_rg‘
 = 
n£cs_xãr_com¶‘ed
;

356  
Œue
;

357 
	}
}

359 
boÞ
 
	$zns_wr™e
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

361 
zns_ál
 *zns_áÈð(zns_áÈ*)
ns
->
áls
;

362 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

363 
nvme_rw_commªd
 *
cmd
 = &(
»q
->cmd->
rw
);

364 
ušt64_t
 
¦²
 = 
	`lba_to_Ín
(
zns_ál
, 
cmd
->
¦ba
);

367 
ušt32_t
 
zid
 = 
	`Ín_to_zÚe
(
zns_ál
, 
¦²
);

369 
	`NVMEV_DEBUG
("% ¦b¨0x%Îx zÚe_id %d \n", 
__func__
, 
cmd
->
¦ba
, 
zid
);

371 ià(
zÚe_descs
[
zid
].
zrwav
 == 0)

372  
	`__zns_wr™e
(
ns
, 
zns_ál
, 
»q
, 
»t
);

374  
	`__zns_wr™e_zrwa
(
ns
, 
zns_ál
, 
»q
, 
»t
);

375 
	}
}

377 
boÞ
 
	$zns_»ad
(
nvmev_ns
 *
ns
, 
nvmev_»que¡
 *
»q
, 
nvmev_»suÉ
 *
»t
)

379 
zns_ál
 *zns_áÈð(zns_áÈ*)
ns
->
áls
;

380 
ssd·¿ms
 *
¥p
 = &
zns_ál
->
ssd
->
¥
;

381 
zÚe_desütÜ
 *
zÚe_descs
 = 
zns_ál
->zone_descs;

382 
nvme_rw_commªd
 *
cmd
 = &(
»q
->cmd->
rw
);

384 
ušt64_t
 
¦ba
 = 
cmd
->slba;

385 
ušt64_t
 
Ä_lba
 = 
	`__Ä_lbas_äom_rw_cmd
(
cmd
);

387 
ušt64_t
 
¦²
 = 
	`lba_to_Ín
(
zns_ál
, 
¦ba
);

388 
ušt64_t
 
–²
 = 
	`lba_to_Ín
(
zns_ál
, 
¦ba
 + 
Ä_lba
 - 1);

389 
ušt64_t
 
Ín
;

392 
ušt32_t
 
zid
 = 
	`Ín_to_zÚe
(
zns_ál
, 
¦²
);

393 
ušt32_t
 
¡©us
 = 
NVME_SC_SUCCESS
;

394 
ušt64_t
 
n£cs_¡¬t
 = 
»q
->nsecs_start;

395 
ušt64_t
 
n£cs_com¶‘ed
 = 
n£cs_¡¬t
, 
n£cs_Ï‹¡
 = 0;

396 
ušt64_t
 
pgs
 = 0, 
pg_off
;

397 
µa
…pa;

398 
Çnd_cmd
 
swr
;

400 
	`NVMEV_ZNS_DEBUG
(

402 
__func__
, 
¦ba
, 
Ä_lba
, 
zid
, 
zÚe_descs
[zid].
¡©e
, zÚe_descs[zid].
wp
,

403 (
¦ba
 + 
Ä_lba
 - 1));

405 ià(
zÚe_descs
[
zid
].
¡©e
 =ð
ZONE_STATE_OFFLINE
) {

406 
¡©us
 = 
NVME_SC_ZNS_ERR_OFFLINE
;

407 } ià(
	`__check_bound¬y_”rÜ
(
zns_ál
, 
¦ba
, 
Ä_lba
è=ð
çl£
) {

409 
¡©us
 = 
NVME_SC_ZNS_ERR_BOUNDARY
;

413 
n£cs_Ï‹¡
 = 
n£cs_¡¬t
;

414 ià(
	`LBA_TO_BYTE
(
Ä_lba
è<ð
	`KB
(4))

415 
n£cs_Ï‹¡
 +ð
¥p
->
fw_4kb_rd_Ït
;

417 
n£cs_Ï‹¡
 +ð
¥p
->
fw_rd_Ït
;

419 
swr
.
ty³
 = 
USER_IO
;

420 
swr
.
cmd
 = 
NAND_READ
;

421 
swr
.
¡ime
 = 
n£cs_Ï‹¡
;

422 
swr
.
š‹¾—ve_pci_dma
 = 
çl£
;

424 
Ín
 = 
¦²
;†² <ð
–²
;†² +ð
pgs
) {

425 
µa
 = 
	`__Ín_to_µa
(
zns_ál
, 
Ín
);

426 
pg_off
 = 
µa
.
g
.
pg
 % 
¥p
->
pgs_³r_æashpg
;

427 
pgs
 = 
	`mš
(
–²
 - 
Ín
 + 1, (
ušt64_t
)(
¥p
->
pgs_³r_æashpg
 - 
pg_off
));

428 
swr
.
xãr_size
 = 
pgs
 * 
¥p
->
pgsz
;

429 
swr
.
µa
 = &ppa;

430 
n£cs_com¶‘ed
 = 
	`ssd_advªû_Çnd
(
zns_ál
->
ssd
, &
swr
);

431 
n£cs_Ï‹¡
 = (
n£cs_com¶‘ed
 >‚secs_latest) ?‚secs_completed :‚secs_latest;

434 ià(
swr
.
š‹¾—ve_pci_dma
 =ð
çl£
) {

435 
n£cs_com¶‘ed
 = 
	`ssd_advªû_pc›
(
zns_ál
->
ssd
, 
n£cs_Ï‹¡
, 
Ä_lba
 * 
¥p
->
£csz
);

436 
n£cs_Ï‹¡
 = (
n£cs_com¶‘ed
 >‚secs_latest) ?‚secs_completed :‚secs_latest;

439 
»t
->
¡©us
 = status;

440 
»t
->
n£cs_rg‘
 = 
n£cs_Ï‹¡
;

441  
Œue
;

442 
	}
}

	@zns_read_write.h

1 #iâdeà
_NVMEVIRT_ZNS_READ_WRITE_H


2 
	#_NVMEVIRT_ZNS_READ_WRITE_H


	)

4 
	~"zns_ál.h
"

6 
šlše
 
ušt32_t
 
	$__Ä_lbas_äom_rw_cmd
(
nvme_rw_commªd
 *
cmd
)

8  
cmd
->
Ëngth
 + 1;

9 
	}
}

10 
šlše
 
µa
 
	$__Ín_to_µa
(
zns_ál
 *zns_ál, 
ušt64_t
 
Ín
)

12 
ssd·¿ms
 *
¥p
 = &
zns_ál
->
ssd
->
¥
;

13 
zn¥¬ams
 *
zµ
 = &
zns_ál
->
zp
;

14 
ušt64_t
 
zÚe
 = 
	`Ín_to_zÚe
(
zns_ál
, 
Ín
);

15 
ušt64_t
 
off
 = 
Ín
 - 
	`zÚe_to_¦²
(
zns_ál
, 
zÚe
);

17 
ušt32_t
 
sd›
 = (
zÚe
 * 
zµ
->
d›s_³r_zÚe
è% 
¥p
->
‰_luns
;

18 
ušt32_t
 
d›
 = 
sd›
 + ((
off
 / 
¥p
->
pgs_³r_ÚeshÙpg
è% 
zµ
->
d›s_³r_zÚe
);

20 
ušt32_t
 
chªÃl
 = 
	`d›_to_chªÃl
(
zns_ál
, 
d›
);

21 
ušt32_t
 
lun
 = 
	`d›_to_lun
(
zns_ál
, 
d›
);

22 
µa
…pa = {

23 .
g
 = {

24 .
lun
 =†un,

25 .
ch
 = 
chªÃl
,

26 .
pg
 = 
off
 % 
¥p
->
pgs_³r_ÚeshÙpg
,

30  
µa
;

31 
	}
}

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fsüy±.h
>

19 
	~<lšux/mouÁ.h
>

32 #undeà
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0è

	)

47 
	#RENAME_EXCHANGE
 (1 << 1è

	)

48 
	#RENAME_WHITEOUT
 (1 << 2è

	)

50 
	sfže_þÚe_¿nge
 {

51 
__s64
 
	m¤c_fd
;

52 
__u64
 
	m¤c_off£t
;

53 
__u64
 
	m¤c_Ëngth
;

54 
__u64
 
	mde¡_off£t
;

57 
	sf¡rim_¿nge
 {

58 
__u64
 
	m¡¬t
;

59 
__u64
 
	mËn
;

60 
__u64
 
	mmšËn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfže_dedu³_¿nge_šfo
 {

69 
__s64
 
	mde¡_fd
;

70 
__u64
 
	mde¡_off£t
;

71 
__u64
 
	mby‹s_dedu³d
;

78 
__s32
 
	m¡©us
;

79 
__u32
 
	m»£rved
;

83 
	sfže_dedu³_¿nge
 {

84 
__u64
 
	m¤c_off£t
;

85 
__u64
 
	m¤c_Ëngth
;

86 
__u16
 
	mde¡_couÁ
;

87 
__u16
 
	m»£rved1
;

88 
__u32
 
	m»£rved2
;

89 
fže_dedu³_¿nge_šfo
 
	mšfo
[];

93 
	sfžes_¡©_¡ruù
 {

94 
	mÄ_fžes
;

95 
	mÄ_ä“_fžes
;

96 
	mmax_fžes
;

99 
	sšodes_¡©_t
 {

100 
	mÄ_šodes
;

101 
	mÄ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©Œ
 {

112 
__u32
 
	mfsx_xæags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_Ãx‹Ás
;

115 
__u32
 
	mfsx_´ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_·d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

183 
	#BLKGETDISKSEQ
 
	`_IOR
(0x12,128,
__u64
)

	)

189 
	#BMAP_IOCTL
 1

	)

190 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

191 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

192 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

193 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

194 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

195 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

196 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fže_þÚe_¿nge
)

	)

197 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fže_dedu³_¿nge
)

	)

199 
	#FSLABEL_MAX
 256

	)

201 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

202 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

203 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

204 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

205 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

206 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

207 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

208 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

209 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

210 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

211 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

212 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

213 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

235 
	#FS_SECRM_FL
 0x00000001

	)

236 
	#FS_UNRM_FL
 0x00000002

	)

237 
	#FS_COMPR_FL
 0x00000004

	)

238 
	#FS_SYNC_FL
 0x00000008

	)

239 
	#FS_IMMUTABLE_FL
 0x00000010

	)

240 
	#FS_APPEND_FL
 0x00000020

	)

241 
	#FS_NODUMP_FL
 0x00000040

	)

242 
	#FS_NOATIME_FL
 0x00000080

	)

244 
	#FS_DIRTY_FL
 0x00000100

	)

245 
	#FS_COMPRBLK_FL
 0x00000200

	)

246 
	#FS_NOCOMP_FL
 0x00000400

	)

248 
	#FS_ENCRYPT_FL
 0x00000800

	)

249 
	#FS_BTREE_FL
 0x00001000

	)

250 
	#FS_INDEX_FL
 0x00001000

	)

251 
	#FS_IMAGIC_FL
 0x00002000

	)

252 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

253 
	#FS_NOTAIL_FL
 0x00008000

	)

254 
	#FS_DIRSYNC_FL
 0x00010000

	)

255 
	#FS_TOPDIR_FL
 0x00020000

	)

256 
	#FS_HUGE_FILE_FL
 0x00040000

	)

257 
	#FS_EXTENT_FL
 0x00080000

	)

258 
	#FS_VERITY_FL
 0x00100000

	)

259 
	#FS_EA_INODE_FL
 0x00200000

	)

260 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

261 
	#FS_NOCOW_FL
 0x00800000

	)

262 
	#FS_DAX_FL
 0x02000000

	)

263 
	#FS_INLINE_DATA_FL
 0x10000000

	)

264 
	#FS_PROJINHERIT_FL
 0x20000000

	)

265 
	#FS_CASEFOLD_FL
 0x40000000

	)

266 
	#FS_RESERVED_FL
 0x80000000

	)

268 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

269 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

272 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

273 
	#SYNC_FILE_RANGE_WRITE
 2

	)

274 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

275 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

276 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

277 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

283 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

286 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

289 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

292 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

295 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

298 
	#RWF_APPEND
 ((
__k”Ãl_rwf_t
)0x00000010)

	)

301 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

302 
RWF_APPEND
)

	)

	@/usr/include/linux/kernel.h

2 #iâdeà
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<lšux/sysšfo.h
>

6 
	~<lšux/cÚ¡.h
>

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/mman.h

2 #iâdeà
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mmª.h
>

6 
	~<asm-g’”ic/hug‘lb_’code.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

10 
	#MREMAP_DONTUNMAP
 4

	)

12 
	#OVERCOMMIT_GUESS
 0

	)

13 
	#OVERCOMMIT_ALWAYS
 1

	)

14 
	#OVERCOMMIT_NEVER
 2

	)

16 
	#MAP_SHARED
 0x01

	)

17 
	#MAP_PRIVATE
 0x02

	)

18 
	#MAP_SHARED_VALIDATE
 0x03

	)

27 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

28 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

30 
	#MAP_HUGE_16KB
 
HUGETLB_FLAG_ENCODE_16KB


	)

31 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

32 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

33 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

34 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

35 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

36 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

37 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

38 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

39 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

40 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

41 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

42 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

8 
	#MODULE_INIT_COMPRESSED_FILE
 4

	)

	@/usr/include/linux/mount.h

1 #iâdeà
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

4 
	~<lšux/ty³s.h
>

13 
	#MS_RDONLY
 1

	)

14 
	#MS_NOSUID
 2

	)

15 
	#MS_NODEV
 4

	)

16 
	#MS_NOEXEC
 8

	)

17 
	#MS_SYNCHRONOUS
 16

	)

18 
	#MS_REMOUNT
 32

	)

19 
	#MS_MANDLOCK
 64

	)

20 
	#MS_DIRSYNC
 128

	)

21 
	#MS_NOSYMFOLLOW
 256

	)

22 
	#MS_NOATIME
 1024

	)

23 
	#MS_NODIRATIME
 2048

	)

24 
	#MS_BIND
 4096

	)

25 
	#MS_MOVE
 8192

	)

26 
	#MS_REC
 16384

	)

27 
	#MS_VERBOSE
 32768

	)

29 
	#MS_SILENT
 32768

	)

30 
	#MS_POSIXACL
 (1<<16è

	)

31 
	#MS_UNBINDABLE
 (1<<17è

	)

32 
	#MS_PRIVATE
 (1<<18è

	)

33 
	#MS_SLAVE
 (1<<19è

	)

34 
	#MS_SHARED
 (1<<20è

	)

35 
	#MS_RELATIME
 (1<<21è

	)

36 
	#MS_KERNMOUNT
 (1<<22è

	)

37 
	#MS_I_VERSION
 (1<<23è

	)

38 
	#MS_STRICTATIME
 (1<<24è

	)

39 
	#MS_LAZYTIME
 (1<<25è

	)

42 
	#MS_SUBMOUNT
 (1<<26)

	)

43 
	#MS_NOREMOTELOCK
 (1<<27)

	)

44 
	#MS_NOSEC
 (1<<28)

	)

45 
	#MS_BORN
 (1<<29)

	)

46 
	#MS_ACTIVE
 (1<<30)

	)

47 
	#MS_NOUSER
 (1<<31)

	)

52 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

53 
MS_LAZYTIME
)

	)

58 
	#MS_MGC_VAL
 0xC0ED0000

	)

59 
	#MS_MGC_MSK
 0xffff0000

	)

64 
	#OPEN_TREE_CLONE
 1

	)

65 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

70 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

71 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

72 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

73 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

74 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

75 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

76 
	#MOVE_MOUNT_SET_GROUP
 0x00000100

	)

77 
	#MOVE_MOUNT__MASK
 0x00000177

	)

82 
	#FSOPEN_CLOEXEC
 0x00000001

	)

87 
	#FSPICK_CLOEXEC
 0x00000001

	)

88 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

89 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

90 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

95 
	efscÚfig_commªd
 {

96 
	mFSCONFIG_SET_FLAG
 = 0,

97 
	mFSCONFIG_SET_STRING
 = 1,

98 
	mFSCONFIG_SET_BINARY
 = 2,

99 
	mFSCONFIG_SET_PATH
 = 3,

100 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

101 
	mFSCONFIG_SET_FD
 = 5,

102 
	mFSCONFIG_CMD_CREATE
 = 6,

103 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

109 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

114 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

115 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

116 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

117 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

118 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

119 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

120 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

121 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

122 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

123 
	#MOUNT_ATTR_IDMAP
 0x00100000

	)

124 
	#MOUNT_ATTR_NOSYMFOLLOW
 0x00200000

	)

129 
	smouÁ_©Œ
 {

130 
__u64
 
	m©Œ_£t
;

131 
__u64
 
	m©Œ_þr
;

132 
__u64
 
	m´Ýag©iÚ
;

133 
__u64
 
	mu£ºs_fd
;

137 
	#MOUNT_ATTR_SIZE_VER0
 32

	)

	@/usr/include/linux/pci.h

18 #iâdeà
LINUX_PCI_H


19 
	#LINUX_PCI_H


	)

21 
	~<lšux/pci_»gs.h
>

31 
	#PCI_DEVFN
(
¦Ù
, 
func
è((((¦Ùè& 0x1fè<< 3è| ((funcè& 0x07))

	)

32 
	#PCI_SLOT
(
devâ
è(((devâè>> 3è& 0x1f)

	)

33 
	#PCI_FUNC
(
devâ
è((devâè& 0x07)

	)

36 
	#PCIIOC_BASE
 ('P' << 24 | 'C' << 16 | 'I' << 8)

	)

37 
	#PCIIOC_CONTROLLER
 (
PCIIOC_BASE
 | 0x00è

	)

38 
	#PCIIOC_MMAP_IS_IO
 (
PCIIOC_BASE
 | 0x01è

	)

39 
	#PCIIOC_MMAP_IS_MEM
 (
PCIIOC_BASE
 | 0x02è

	)

40 
	#PCIIOC_WRITE_COMBINE
 (
PCIIOC_BASE
 | 0x03è

	)

	@/usr/include/linux/random.h

8 #iâdeà
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/ioùl.h
>

13 
	~<lšux/œqÄ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
Ð'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
Ð'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
Ð'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
Ð'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
Ð'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
Ð'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
Ð'R', 0x07 )

	)

41 
	s¿nd_poÞ_šfo
 {

42 
	m’ŒÝy_couÁ
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[];

54 
	#GRND_NONBLOCK
 0x0001

	)

55 
	#GRND_RANDOM
 0x0002

	)

56 
	#GRND_INSECURE
 0x0004

	)

	@/usr/include/linux/sched.h

2 #iâdeà
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<lšux/ty³s.h
>

10 
	#CSIGNAL
 0x000000fà

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

37 
	#CLONE_CLEAR_SIGHAND
 0x100000000ULL

	)

38 
	#CLONE_INTO_CGROUP
 0x200000000ULL

	)

44 
	#CLONE_NEWTIME
 0x00000080

	)

46 #iâdeà
__ASSEMBLY__


92 
	sþÚe_¬gs
 {

93 
__®igÃd_u64
 
	mæags
;

94 
__®igÃd_u64
 
	mpidfd
;

95 
__®igÃd_u64
 
	mchžd_tid
;

96 
__®igÃd_u64
 
	m·»Á_tid
;

97 
__®igÃd_u64
 
	mex™_sigÇl
;

98 
__®igÃd_u64
 
	m¡ack
;

99 
__®igÃd_u64
 
	m¡ack_size
;

100 
__®igÃd_u64
 
	mŽs
;

101 
__®igÃd_u64
 
	m£t_tid
;

102 
__®igÃd_u64
 
	m£t_tid_size
;

103 
__®igÃd_u64
 
	mcgroup
;

107 
	#CLONE_ARGS_SIZE_VER0
 64

	)

108 
	#CLONE_ARGS_SIZE_VER1
 80

	)

109 
	#CLONE_ARGS_SIZE_VER2
 88

	)

114 
	#SCHED_NORMAL
 0

	)

115 
	#SCHED_FIFO
 1

	)

116 
	#SCHED_RR
 2

	)

117 
	#SCHED_BATCH
 3

	)

119 
	#SCHED_IDLE
 5

	)

120 
	#SCHED_DEADLINE
 6

	)

123 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

128 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

129 
	#SCHED_FLAG_RECLAIM
 0x02

	)

130 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

131 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

132 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

133 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

134 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

136 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

137 
SCHED_FLAG_KEEP_PARAMS
)

	)

139 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

140 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

142 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

143 
SCHED_FLAG_RECLAIM
 | \

144 
SCHED_FLAG_DL_OVERRUN
 | \

145 
SCHED_FLAG_KEEP_ALL
 | \

146 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stat.h

2 #iâdeà
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<lšux/ty³s.h
>

7 #ià
defšed
(
__KERNEL__
è|| !defšed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
è(((mè& 
S_IFMT
è=ð
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
è(((mè& 
S_IFMT
è=ð
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
è(((mè& 
S_IFMT
è=ð
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
è(((mè& 
S_IFMT
è=ð
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
è(((mè& 
S_IFMT
è=ð
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
è(((mè& 
S_IFMT
è=ð
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
è(((mè& 
S_IFMT
è=ð
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s¡©x_time¡amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__»£rved
;

99 
	s¡©x
 {

101 
__u32
 
	m¡x_mask
;

102 
__u32
 
	m¡x_blksize
;

103 
__u64
 
	m¡x_©Œibu‹s
;

105 
__u32
 
	m¡x_Æšk
;

106 
__u32
 
	m¡x_uid
;

107 
__u32
 
	m¡x_gid
;

108 
__u16
 
	m¡x_mode
;

109 
__u16
 
	m__¥¬e0
[1];

111 
__u64
 
	m¡x_šo
;

112 
__u64
 
	m¡x_size
;

113 
__u64
 
	m¡x_blocks
;

114 
__u64
 
	m¡x_©Œibu‹s_mask
;

116 
¡©x_time¡amp
 
	m¡x_©ime
;

117 
¡©x_time¡amp
 
	m¡x_btime
;

118 
¡©x_time¡amp
 
	m¡x_ùime
;

119 
¡©x_time¡amp
 
	m¡x_mtime
;

121 
__u32
 
	m¡x_rdev_majÜ
;

122 
__u32
 
	m¡x_rdev_mšÜ
;

123 
__u32
 
	m¡x_dev_majÜ
;

124 
__u32
 
	m¡x_dev_mšÜ
;

126 
__u64
 
	m¡x_mÁ_id
;

127 
__u32
 
	m¡x_dio_mem_®ign
;

128 
__u32
 
	m¡x_dio_off£t_®ign
;

130 
__u64
 
	m__¥¬e3
[12];

142 
	#STATX_TYPE
 0x00000001U

	)

143 
	#STATX_MODE
 0x00000002U

	)

144 
	#STATX_NLINK
 0x00000004U

	)

145 
	#STATX_UID
 0x00000008U

	)

146 
	#STATX_GID
 0x00000010U

	)

147 
	#STATX_ATIME
 0x00000020U

	)

148 
	#STATX_MTIME
 0x00000040U

	)

149 
	#STATX_CTIME
 0x00000080U

	)

150 
	#STATX_INO
 0x00000100U

	)

151 
	#STATX_SIZE
 0x00000200U

	)

152 
	#STATX_BLOCKS
 0x00000400U

	)

153 
	#STATX_BASIC_STATS
 0x000007ffU

	)

154 
	#STATX_BTIME
 0x00000800U

	)

155 
	#STATX_MNT_ID
 0x00001000U

	)

156 
	#STATX_DIOALIGN
 0x00002000U

	)

158 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ALL
 0x00000fffU

	)

181 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

182 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

183 
	#STATX_ATTR_APPEND
 0x00000020

	)

184 
	#STATX_ATTR_NODUMP
 0x00000040

	)

185 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

186 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

187 
	#STATX_ATTR_MOUNT_ROOT
 0x00002000

	)

188 
	#STATX_ATTR_VERITY
 0x00100000

	)

189 
	#STATX_ATTR_DAX
 0x00200000

	)

	@/usr/include/linux/string.h

2 #iâdeà
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<¡ršg.h
>

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

18 #ifdeà
__CHECKER__


19 
	#__b™wi£
 
	`__©Œibu‹__
((
b™wi£
))

	)

21 
	#__b™wi£


	)

25 
	#__b™wi£__
 
__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_s64
 
__s64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

49 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

51 
	t__b™wi£
 
	t__pÞl_t
;

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 393619

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ ((cè> 255 ? 255 : (c)))

	)

3 
	#LINUX_VERSION_MAJOR
 6

	)

4 
	#LINUX_VERSION_PATCHLEVEL
 1

	)

5 
	#LINUX_VERSION_SUBLEVEL
 147

	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #iâdeà
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_16KB
 (14U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_64KB
 (16U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_512KB
 (19U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_1MB
 (20U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_2MB
 (21U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_8MB
 (23U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_16MB
 (24U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_32MB
 (25U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_256MB
 (28U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_512MB
 (29U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_1GB
 (30U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_2GB
 (31U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

35 
	#HUGETLB_FLAG_ENCODE_16GB
 (34U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/const.h

4 #iâdeà
_LINUX_CONST_H


5 
	#_LINUX_CONST_H


	)

16 #ifdeà
__ASSEMBLY__


17 
	#_AC
(
X
,
Y
è
	)
X

18 
	#_AT
(
T
,
X
è
	)
X

20 
	#__AC
(
X
,
Y
è(X##Y)

	)

21 
	#_AC
(
X
,
Y
è
	`__AC
(X,Y)

	)

22 
	#_AT
(
T
,
X
è((T)(X))

	)

25 
	#_UL
(
x
è(
	`_AC
(x, 
UL
))

	)

26 
	#_ULL
(
x
è(
	`_AC
(x, 
ULL
))

	)

28 
	#_BITUL
(
x
è(
	`_UL
(1è<< (x))

	)

29 
	#_BITULL
(
x
è(
	`_ULL
(1è<< (x))

	)

31 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`__ty³of__
(x))×è- 1)

	)

32 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

34 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
è((Òè+ (dè- 1è/ (d))

	)

	@/usr/include/linux/fscrypt.h

8 #iâdeà
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<lšux/ioùl.h
>

12 
	~<lšux/ty³s.h
>

15 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

20 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

21 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_64
 0x08

	)

22 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_32
 0x10

	)

25 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

26 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

27 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

28 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

29 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

30 
	#FSCRYPT_MODE_AES_256_HCTR2
 10

	)

39 
	#FSCRYPT_POLICY_V1
 0

	)

40 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

41 
	sfsüy±_pÞicy_v1
 {

42 
__u8
 
	mv”siÚ
;

43 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

44 
__u8
 
	mfž’ames_’üy±iÚ_mode
;

45 
__u8
 
	mæags
;

46 
__u8
 
	mma¡”_key_desütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

53 
	#FSCRYPT_KEY_DESC_PREFIX
 "fsüy±:"

	)

54 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

55 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

56 
	sfsüy±_key
 {

57 
__u32
 
	mmode
;

58 
__u8
 
	m¿w
[
FSCRYPT_MAX_KEY_SIZE
];

59 
__u32
 
	msize
;

65 
	#FSCRYPT_POLICY_V2
 2

	)

66 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

67 
	sfsüy±_pÞicy_v2
 {

68 
__u8
 
	mv”siÚ
;

69 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

70 
__u8
 
	mfž’ames_’üy±iÚ_mode
;

71 
__u8
 
	mæags
;

72 
__u8
 
	m__»£rved
[4];

73 
__u8
 
	mma¡”_key_id’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

77 
	sfsüy±_g‘_pÞicy_ex_¬g
 {

78 
__u64
 
	mpÞicy_size
;

80 
__u8
 
	mv”siÚ
;

81 
fsüy±_pÞicy_v1
 
	mv1
;

82 
fsüy±_pÞicy_v2
 
	mv2
;

83 } 
	mpÞicy
;

90 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

97 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

103 
	sfsüy±_key_¥ecif›r
 {

104 
__u32
 
	mty³
;

105 
__u32
 
	m__»£rved
;

107 
__u8
 
	m__»£rved
[32];

108 
__u8
 
	mdesütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

109 
__u8
 
	mid’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

110 } 
	mu
;

117 
	sfsüy±_´ovisiÚšg_key_·ylßd
 {

118 
__u32
 
	mty³
;

119 
__u32
 
	m__»£rved
;

120 
__u8
 
	m¿w
[];

124 
	sfsüy±_add_key_¬g
 {

125 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

126 
__u32
 
	m¿w_size
;

127 
__u32
 
	mkey_id
;

128 
__u32
 
	m__»£rved
[8];

129 
__u8
 
	m¿w
[];

133 
	sfsüy±_»move_key_¬g
 {

134 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

135 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

136 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

137 
__u32
 
	m»mov®_¡©us_æags
;

138 
__u32
 
	m__»£rved
[5];

142 
	sfsüy±_g‘_key_¡©us_¬g
 {

144 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

145 
__u32
 
	m__»£rved
[6];

148 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

149 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

150 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

151 
__u32
 
	m¡©us
;

152 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

153 
__u32
 
	m¡©us_æags
;

154 
__u32
 
	mu£r_couÁ
;

155 
__u32
 
	m__out_»£rved
[13];

158 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pÞicy_v1
)

	)

159 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

160 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pÞicy_v1
)

	)

161 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]è

	)

162 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fsüy±_add_key_¬g
)

	)

163 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fsüy±_»move_key_¬g
)

	)

164 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fsüy±_»move_key_¬g
)

	)

165 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fsüy±_g‘_key_¡©us_¬g
)

	)

166 
	#FS_IOC_GET_ENCRYPTION_NONCE
 
	`_IOR
('f', 27, 
__u8
[16])

	)

171 
	#fsüy±_pÞicy
 
fsüy±_pÞicy_v1


	)

172 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

173 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

174 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

175 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

176 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

177 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

178 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

179 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

180 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

181 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

182 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

183 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

184 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

185 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

186 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

187 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

188 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

189 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

190 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

191 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

192 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/pci_regs.h

21 #iâdeà
LINUX_PCI_REGS_H


22 
	#LINUX_PCI_REGS_H


	)

29 
	#PCI_CFG_SPACE_SIZE
 256

	)

30 
	#PCI_CFG_SPACE_EXP_SIZE
 4096

	)

36 
	#PCI_STD_HEADER_SIZEOF
 64

	)

37 
	#PCI_STD_NUM_BARS
 6

	)

38 
	#PCI_VENDOR_ID
 0x00

	)

39 
	#PCI_DEVICE_ID
 0x02

	)

40 
	#PCI_COMMAND
 0x04

	)

41 
	#PCI_COMMAND_IO
 0x1

	)

42 
	#PCI_COMMAND_MEMORY
 0x2

	)

43 
	#PCI_COMMAND_MASTER
 0x4

	)

44 
	#PCI_COMMAND_SPECIAL
 0x8

	)

45 
	#PCI_COMMAND_INVALIDATE
 0x10

	)

46 
	#PCI_COMMAND_VGA_PALETTE
 0x20

	)

47 
	#PCI_COMMAND_PARITY
 0x40

	)

48 
	#PCI_COMMAND_WAIT
 0x80

	)

49 
	#PCI_COMMAND_SERR
 0x100

	)

50 
	#PCI_COMMAND_FAST_BACK
 0x200

	)

51 
	#PCI_COMMAND_INTX_DISABLE
 0x400

	)

53 
	#PCI_STATUS
 0x06

	)

54 
	#PCI_STATUS_IMM_READY
 0x01

	)

55 
	#PCI_STATUS_INTERRUPT
 0x08

	)

56 
	#PCI_STATUS_CAP_LIST
 0x10

	)

57 
	#PCI_STATUS_66MHZ
 0x20

	)

58 
	#PCI_STATUS_UDF
 0x40

	)

59 
	#PCI_STATUS_FAST_BACK
 0x80

	)

60 
	#PCI_STATUS_PARITY
 0x100

	)

61 
	#PCI_STATUS_DEVSEL_MASK
 0x600

	)

62 
	#PCI_STATUS_DEVSEL_FAST
 0x000

	)

63 
	#PCI_STATUS_DEVSEL_MEDIUM
 0x200

	)

64 
	#PCI_STATUS_DEVSEL_SLOW
 0x400

	)

65 
	#PCI_STATUS_SIG_TARGET_ABORT
 0x800

	)

66 
	#PCI_STATUS_REC_TARGET_ABORT
 0x1000

	)

67 
	#PCI_STATUS_REC_MASTER_ABORT
 0x2000

	)

68 
	#PCI_STATUS_SIG_SYSTEM_ERROR
 0x4000

	)

69 
	#PCI_STATUS_DETECTED_PARITY
 0x8000

	)

71 
	#PCI_CLASS_REVISION
 0x08

	)

72 
	#PCI_REVISION_ID
 0x08

	)

73 
	#PCI_CLASS_PROG
 0x09

	)

74 
	#PCI_CLASS_DEVICE
 0x0¨

	)

76 
	#PCI_CACHE_LINE_SIZE
 0x0ø

	)

77 
	#PCI_LATENCY_TIMER
 0x0d

	)

78 
	#PCI_HEADER_TYPE
 0x0

	)

79 
	#PCI_HEADER_TYPE_MASK
 0x7f

	)

80 
	#PCI_HEADER_TYPE_NORMAL
 0

	)

81 
	#PCI_HEADER_TYPE_BRIDGE
 1

	)

82 
	#PCI_HEADER_TYPE_CARDBUS
 2

	)

84 
	#PCI_BIST
 0x0à

	)

85 
	#PCI_BIST_CODE_MASK
 0x0à

	)

86 
	#PCI_BIST_START
 0x40

	)

87 
	#PCI_BIST_CAPABLE
 0x80

	)

95 
	#PCI_BASE_ADDRESS_0
 0x10

	)

96 
	#PCI_BASE_ADDRESS_1
 0x14

	)

97 
	#PCI_BASE_ADDRESS_2
 0x18

	)

98 
	#PCI_BASE_ADDRESS_3
 0x1ø

	)

99 
	#PCI_BASE_ADDRESS_4
 0x20

	)

100 
	#PCI_BASE_ADDRESS_5
 0x24

	)

101 
	#PCI_BASE_ADDRESS_SPACE
 0x01

	)

102 
	#PCI_BASE_ADDRESS_SPACE_IO
 0x01

	)

103 
	#PCI_BASE_ADDRESS_SPACE_MEMORY
 0x00

	)

104 
	#PCI_BASE_ADDRESS_MEM_TYPE_MASK
 0x06

	)

105 
	#PCI_BASE_ADDRESS_MEM_TYPE_32
 0x00

	)

106 
	#PCI_BASE_ADDRESS_MEM_TYPE_1M
 0x02

	)

107 
	#PCI_BASE_ADDRESS_MEM_TYPE_64
 0x04

	)

108 
	#PCI_BASE_ADDRESS_MEM_PREFETCH
 0x08

	)

109 
	#PCI_BASE_ADDRESS_MEM_MASK
 (~0x0fUL)

	)

110 
	#PCI_BASE_ADDRESS_IO_MASK
 (~0x03UL)

	)

114 
	#PCI_CARDBUS_CIS
 0x28

	)

115 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2c

	)

116 
	#PCI_SUBSYSTEM_ID
 0x2e

	)

117 
	#PCI_ROM_ADDRESS
 0x30

	)

118 
	#PCI_ROM_ADDRESS_ENABLE
 0x01

	)

119 
	#PCI_ROM_ADDRESS_MASK
 (~0x7ffU)

	)

121 
	#PCI_CAPABILITY_LIST
 0x34

	)

124 
	#PCI_INTERRUPT_LINE
 0x3ø

	)

125 
	#PCI_INTERRUPT_PIN
 0x3d

	)

126 
	#PCI_MIN_GNT
 0x3

	)

127 
	#PCI_MAX_LAT
 0x3à

	)

130 
	#PCI_PRIMARY_BUS
 0x18

	)

131 
	#PCI_SECONDARY_BUS
 0x19

	)

132 
	#PCI_SUBORDINATE_BUS
 0x1¨

	)

133 
	#PCI_SEC_LATENCY_TIMER
 0x1b

	)

134 
	#PCI_IO_BASE
 0x1ø

	)

135 
	#PCI_IO_LIMIT
 0x1d

	)

136 
	#PCI_IO_RANGE_TYPE_MASK
 0x0fUL

	)

137 
	#PCI_IO_RANGE_TYPE_16
 0x00

	)

138 
	#PCI_IO_RANGE_TYPE_32
 0x01

	)

139 
	#PCI_IO_RANGE_MASK
 (~0x0fULè

	)

140 
	#PCI_IO_1K_RANGE_MASK
 (~0x03ULè

	)

141 
	#PCI_SEC_STATUS
 0x1

	)

142 
	#PCI_MEMORY_BASE
 0x20

	)

143 
	#PCI_MEMORY_LIMIT
 0x22

	)

144 
	#PCI_MEMORY_RANGE_TYPE_MASK
 0x0fUL

	)

145 
	#PCI_MEMORY_RANGE_MASK
 (~0x0fUL)

	)

146 
	#PCI_PREF_MEMORY_BASE
 0x24

	)

147 
	#PCI_PREF_MEMORY_LIMIT
 0x26

	)

148 
	#PCI_PREF_RANGE_TYPE_MASK
 0x0fUL

	)

149 
	#PCI_PREF_RANGE_TYPE_32
 0x00

	)

150 
	#PCI_PREF_RANGE_TYPE_64
 0x01

	)

151 
	#PCI_PREF_RANGE_MASK
 (~0x0fUL)

	)

152 
	#PCI_PREF_BASE_UPPER32
 0x28

	)

153 
	#PCI_PREF_LIMIT_UPPER32
 0x2c

	)

154 
	#PCI_IO_BASE_UPPER16
 0x30

	)

155 
	#PCI_IO_LIMIT_UPPER16
 0x32

	)

158 
	#PCI_ROM_ADDRESS1
 0x38

	)

160 
	#PCI_BRIDGE_CONTROL
 0x3e

	)

161 
	#PCI_BRIDGE_CTL_PARITY
 0x01

	)

162 
	#PCI_BRIDGE_CTL_SERR
 0x02

	)

163 
	#PCI_BRIDGE_CTL_ISA
 0x04

	)

164 
	#PCI_BRIDGE_CTL_VGA
 0x08

	)

165 
	#PCI_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

166 
	#PCI_BRIDGE_CTL_BUS_RESET
 0x40

	)

167 
	#PCI_BRIDGE_CTL_FAST_BACK
 0x80

	)

170 
	#PCI_CB_CAPABILITY_LIST
 0x14

	)

172 
	#PCI_CB_SEC_STATUS
 0x16

	)

173 
	#PCI_CB_PRIMARY_BUS
 0x18

	)

174 
	#PCI_CB_CARD_BUS
 0x19

	)

175 
	#PCI_CB_SUBORDINATE_BUS
 0x1¨

	)

176 
	#PCI_CB_LATENCY_TIMER
 0x1b

	)

177 
	#PCI_CB_MEMORY_BASE_0
 0x1c

	)

178 
	#PCI_CB_MEMORY_LIMIT_0
 0x20

	)

179 
	#PCI_CB_MEMORY_BASE_1
 0x24

	)

180 
	#PCI_CB_MEMORY_LIMIT_1
 0x28

	)

181 
	#PCI_CB_IO_BASE_0
 0x2c

	)

182 
	#PCI_CB_IO_BASE_0_HI
 0x2e

	)

183 
	#PCI_CB_IO_LIMIT_0
 0x30

	)

184 
	#PCI_CB_IO_LIMIT_0_HI
 0x32

	)

185 
	#PCI_CB_IO_BASE_1
 0x34

	)

186 
	#PCI_CB_IO_BASE_1_HI
 0x36

	)

187 
	#PCI_CB_IO_LIMIT_1
 0x38

	)

188 
	#PCI_CB_IO_LIMIT_1_HI
 0x3a

	)

189 
	#PCI_CB_IO_RANGE_MASK
 (~0x03UL)

	)

191 
	#PCI_CB_BRIDGE_CONTROL
 0x3e

	)

192 
	#PCI_CB_BRIDGE_CTL_PARITY
 0x01

	)

193 
	#PCI_CB_BRIDGE_CTL_SERR
 0x02

	)

194 
	#PCI_CB_BRIDGE_CTL_ISA
 0x04

	)

195 
	#PCI_CB_BRIDGE_CTL_VGA
 0x08

	)

196 
	#PCI_CB_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

197 
	#PCI_CB_BRIDGE_CTL_CB_RESET
 0x40

	)

198 
	#PCI_CB_BRIDGE_CTL_16BIT_INT
 0x80

	)

199 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM0
 0x100

	)

200 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM1
 0x200

	)

201 
	#PCI_CB_BRIDGE_CTL_POST_WRITES
 0x400

	)

202 
	#PCI_CB_SUBSYSTEM_VENDOR_ID
 0x40

	)

203 
	#PCI_CB_SUBSYSTEM_ID
 0x42

	)

204 
	#PCI_CB_LEGACY_MODE_BASE
 0x44

	)

209 
	#PCI_CAP_LIST_ID
 0

	)

210 
	#PCI_CAP_ID_PM
 0x01

	)

211 
	#PCI_CAP_ID_AGP
 0x02

	)

212 
	#PCI_CAP_ID_VPD
 0x03

	)

213 
	#PCI_CAP_ID_SLOTID
 0x04

	)

214 
	#PCI_CAP_ID_MSI
 0x05

	)

215 
	#PCI_CAP_ID_CHSWP
 0x06

	)

216 
	#PCI_CAP_ID_PCIX
 0x07

	)

217 
	#PCI_CAP_ID_HT
 0x08

	)

218 
	#PCI_CAP_ID_VNDR
 0x09

	)

219 
	#PCI_CAP_ID_DBG
 0x0A

	)

220 
	#PCI_CAP_ID_CCRC
 0x0B

	)

221 
	#PCI_CAP_ID_SHPC
 0x0C

	)

222 
	#PCI_CAP_ID_SSVID
 0x0D

	)

223 
	#PCI_CAP_ID_AGP3
 0x0E

	)

224 
	#PCI_CAP_ID_SECDEV
 0x0F

	)

225 
	#PCI_CAP_ID_EXP
 0x10

	)

226 
	#PCI_CAP_ID_MSIX
 0x11

	)

227 
	#PCI_CAP_ID_SATA
 0x12

	)

228 
	#PCI_CAP_ID_AF
 0x13

	)

229 
	#PCI_CAP_ID_EA
 0x14

	)

230 
	#PCI_CAP_ID_MAX
 
PCI_CAP_ID_EA


	)

231 
	#PCI_CAP_LIST_NEXT
 1

	)

232 
	#PCI_CAP_FLAGS
 2

	)

233 
	#PCI_CAP_SIZEOF
 4

	)

237 
	#PCI_PM_PMC
 2

	)

238 
	#PCI_PM_CAP_VER_MASK
 0x0007

	)

239 
	#PCI_PM_CAP_PME_CLOCK
 0x0008

	)

240 
	#PCI_PM_CAP_RESERVED
 0x0010

	)

241 
	#PCI_PM_CAP_DSI
 0x0020

	)

242 
	#PCI_PM_CAP_AUX_POWER
 0x01C0

	)

243 
	#PCI_PM_CAP_D1
 0x0200

	)

244 
	#PCI_PM_CAP_D2
 0x0400

	)

245 
	#PCI_PM_CAP_PME
 0x0800

	)

246 
	#PCI_PM_CAP_PME_MASK
 0xF800

	)

247 
	#PCI_PM_CAP_PME_D0
 0x0800

	)

248 
	#PCI_PM_CAP_PME_D1
 0x1000

	)

249 
	#PCI_PM_CAP_PME_D2
 0x2000

	)

250 
	#PCI_PM_CAP_PME_D3hÙ
 0x4000

	)

251 
	#PCI_PM_CAP_PME_D3cÞd
 0x8000

	)

252 
	#PCI_PM_CAP_PME_SHIFT
 11

	)

253 
	#PCI_PM_CTRL
 4

	)

254 
	#PCI_PM_CTRL_STATE_MASK
 0x0003

	)

255 
	#PCI_PM_CTRL_NO_SOFT_RESET
 0x0008

	)

256 
	#PCI_PM_CTRL_PME_ENABLE
 0x0100

	)

257 
	#PCI_PM_CTRL_DATA_SEL_MASK
 0x1e00

	)

258 
	#PCI_PM_CTRL_DATA_SCALE_MASK
 0x6000

	)

259 
	#PCI_PM_CTRL_PME_STATUS
 0x8000

	)

260 
	#PCI_PM_PPB_EXTENSIONS
 6

	)

261 
	#PCI_PM_PPB_B2_B3
 0x40

	)

262 
	#PCI_PM_BPCC_ENABLE
 0x80

	)

263 
	#PCI_PM_DATA_REGISTER
 7

	)

264 
	#PCI_PM_SIZEOF
 8

	)

268 
	#PCI_AGP_VERSION
 2

	)

269 
	#PCI_AGP_RFU
 3

	)

270 
	#PCI_AGP_STATUS
 4

	)

271 
	#PCI_AGP_STATUS_RQ_MASK
 0xff000000

	)

272 
	#PCI_AGP_STATUS_SBA
 0x0200

	)

273 
	#PCI_AGP_STATUS_64BIT
 0x0020

	)

274 
	#PCI_AGP_STATUS_FW
 0x0010

	)

275 
	#PCI_AGP_STATUS_RATE4
 0x0004

	)

276 
	#PCI_AGP_STATUS_RATE2
 0x0002

	)

277 
	#PCI_AGP_STATUS_RATE1
 0x0001

	)

278 
	#PCI_AGP_COMMAND
 8

	)

279 
	#PCI_AGP_COMMAND_RQ_MASK
 0xff000000

	)

280 
	#PCI_AGP_COMMAND_SBA
 0x0200

	)

281 
	#PCI_AGP_COMMAND_AGP
 0x0100

	)

282 
	#PCI_AGP_COMMAND_64BIT
 0x0020

	)

283 
	#PCI_AGP_COMMAND_FW
 0x0010

	)

284 
	#PCI_AGP_COMMAND_RATE4
 0x0004

	)

285 
	#PCI_AGP_COMMAND_RATE2
 0x0002

	)

286 
	#PCI_AGP_COMMAND_RATE1
 0x0001

	)

287 
	#PCI_AGP_SIZEOF
 12

	)

291 
	#PCI_VPD_ADDR
 2

	)

292 
	#PCI_VPD_ADDR_MASK
 0x7ffà

	)

293 
	#PCI_VPD_ADDR_F
 0x8000

	)

294 
	#PCI_VPD_DATA
 4

	)

295 
	#PCI_CAP_VPD_SIZEOF
 8

	)

299 
	#PCI_SID_ESR
 2

	)

300 
	#PCI_SID_ESR_NSLOTS
 0x1à

	)

301 
	#PCI_SID_ESR_FIC
 0x20

	)

302 
	#PCI_SID_CHASSIS_NR
 3

	)

306 
	#PCI_MSI_FLAGS
 0x02

	)

307 
	#PCI_MSI_FLAGS_ENABLE
 0x0001

	)

308 
	#PCI_MSI_FLAGS_QMASK
 0x000

	)

309 
	#PCI_MSI_FLAGS_QSIZE
 0x0070

	)

310 
	#PCI_MSI_FLAGS_64BIT
 0x0080

	)

311 
	#PCI_MSI_FLAGS_MASKBIT
 0x0100

	)

312 
	#PCI_MSI_RFU
 3

	)

313 
	#PCI_MSI_ADDRESS_LO
 0x04

	)

314 
	#PCI_MSI_ADDRESS_HI
 0x08

	)

315 
	#PCI_MSI_DATA_32
 0x08

	)

316 
	#PCI_MSI_MASK_32
 0x0ø

	)

317 
	#PCI_MSI_PENDING_32
 0x10

	)

318 
	#PCI_MSI_DATA_64
 0x0ø

	)

319 
	#PCI_MSI_MASK_64
 0x10

	)

320 
	#PCI_MSI_PENDING_64
 0x14

	)

323 
	#PCI_MSIX_FLAGS
 2

	)

324 
	#PCI_MSIX_FLAGS_QSIZE
 0x07FF

	)

325 
	#PCI_MSIX_FLAGS_MASKALL
 0x4000

	)

326 
	#PCI_MSIX_FLAGS_ENABLE
 0x8000

	)

327 
	#PCI_MSIX_TABLE
 4

	)

328 
	#PCI_MSIX_TABLE_BIR
 0x00000007

	)

329 
	#PCI_MSIX_TABLE_OFFSET
 0xfffffff8

	)

330 
	#PCI_MSIX_PBA
 8

	)

331 
	#PCI_MSIX_PBA_BIR
 0x00000007

	)

332 
	#PCI_MSIX_PBA_OFFSET
 0xfffffff8

	)

333 
	#PCI_MSIX_FLAGS_BIRMASK
 
PCI_MSIX_PBA_BIR


	)

334 
	#PCI_CAP_MSIX_SIZEOF
 12

	)

337 
	#PCI_MSIX_ENTRY_SIZE
 16

	)

338 
	#PCI_MSIX_ENTRY_LOWER_ADDR
 0x0

	)

339 
	#PCI_MSIX_ENTRY_UPPER_ADDR
 0x4

	)

340 
	#PCI_MSIX_ENTRY_DATA
 0x8

	)

341 
	#PCI_MSIX_ENTRY_VECTOR_CTRL
 0xø

	)

342 
	#PCI_MSIX_ENTRY_CTRL_MASKBIT
 0x00000001

	)

346 
	#PCI_CHSWP_CSR
 2

	)

347 
	#PCI_CHSWP_DHA
 0x01

	)

348 
	#PCI_CHSWP_EIM
 0x02

	)

349 
	#PCI_CHSWP_PIE
 0x04

	)

350 
	#PCI_CHSWP_LOO
 0x08

	)

351 
	#PCI_CHSWP_PI
 0x30

	)

352 
	#PCI_CHSWP_EXT
 0x40

	)

353 
	#PCI_CHSWP_INS
 0x80

	)

357 
	#PCI_AF_LENGTH
 2

	)

358 
	#PCI_AF_CAP
 3

	)

359 
	#PCI_AF_CAP_TP
 0x01

	)

360 
	#PCI_AF_CAP_FLR
 0x02

	)

361 
	#PCI_AF_CTRL
 4

	)

362 
	#PCI_AF_CTRL_FLR
 0x01

	)

363 
	#PCI_AF_STATUS
 5

	)

364 
	#PCI_AF_STATUS_TP
 0x01

	)

365 
	#PCI_CAP_AF_SIZEOF
 6

	)

369 
	#PCI_EA_NUM_ENT
 2

	)

370 
	#PCI_EA_NUM_ENT_MASK
 0x3à

	)

371 
	#PCI_EA_FIRST_ENT
 4

	)

372 
	#PCI_EA_FIRST_ENT_BRIDGE
 8

	)

373 
	#PCI_EA_ES
 0x00000007

	)

374 
	#PCI_EA_BEI
 0x000000f0

	)

377 
	#PCI_EA_SEC_BUS_MASK
 0xff

	)

378 
	#PCI_EA_SUB_BUS_MASK
 0xff00

	)

379 
	#PCI_EA_SUB_BUS_SHIFT
 8

	)

382 
	#PCI_EA_BEI_BAR0
 0

	)

383 
	#PCI_EA_BEI_BAR5
 5

	)

384 
	#PCI_EA_BEI_BRIDGE
 6

	)

385 
	#PCI_EA_BEI_ENI
 7

	)

386 
	#PCI_EA_BEI_ROM
 8

	)

388 
	#PCI_EA_BEI_VF_BAR0
 9

	)

389 
	#PCI_EA_BEI_VF_BAR5
 14

	)

390 
	#PCI_EA_BEI_RESERVED
 15

	)

391 
	#PCI_EA_PP
 0x0000ff00

	)

392 
	#PCI_EA_SP
 0x00ff0000

	)

393 
	#PCI_EA_P_MEM
 0x00

	)

394 
	#PCI_EA_P_MEM_PREFETCH
 0x01

	)

395 
	#PCI_EA_P_IO
 0x02

	)

396 
	#PCI_EA_P_VF_MEM_PREFETCH
 0x03

	)

397 
	#PCI_EA_P_VF_MEM
 0x04

	)

398 
	#PCI_EA_P_BRIDGE_MEM
 0x05

	)

399 
	#PCI_EA_P_BRIDGE_MEM_PREFETCH
 0x06

	)

400 
	#PCI_EA_P_BRIDGE_IO
 0x07

	)

402 
	#PCI_EA_P_MEM_RESERVED
 0xfd

	)

403 
	#PCI_EA_P_IO_RESERVED
 0xã

	)

404 
	#PCI_EA_P_UNAVAILABLE
 0xfà

	)

405 
	#PCI_EA_WRITABLE
 0x40000000

	)

406 
	#PCI_EA_ENABLE
 0x80000000

	)

407 
	#PCI_EA_BASE
 4

	)

408 
	#PCI_EA_MAX_OFFSET
 8

	)

410 
	#PCI_EA_IS_64
 0x00000002

	)

411 
	#PCI_EA_FIELD_MASK
 0xfffffffø

	)

415 
	#PCI_X_CMD
 2

	)

416 
	#PCI_X_CMD_DPERR_E
 0x0001

	)

417 
	#PCI_X_CMD_ERO
 0x0002

	)

418 
	#PCI_X_CMD_READ_512
 0x0000

	)

419 
	#PCI_X_CMD_READ_1K
 0x0004

	)

420 
	#PCI_X_CMD_READ_2K
 0x0008

	)

421 
	#PCI_X_CMD_READ_4K
 0x000ø

	)

422 
	#PCI_X_CMD_MAX_READ
 0x000ø

	)

424 
	#PCI_X_CMD_SPLIT_1
 0x0000

	)

425 
	#PCI_X_CMD_SPLIT_2
 0x0010

	)

426 
	#PCI_X_CMD_SPLIT_3
 0x0020

	)

427 
	#PCI_X_CMD_SPLIT_4
 0x0030

	)

428 
	#PCI_X_CMD_SPLIT_8
 0x0040

	)

429 
	#PCI_X_CMD_SPLIT_12
 0x0050

	)

430 
	#PCI_X_CMD_SPLIT_16
 0x0060

	)

431 
	#PCI_X_CMD_SPLIT_32
 0x0070

	)

432 
	#PCI_X_CMD_MAX_SPLIT
 0x0070

	)

433 
	#PCI_X_CMD_VERSION
(
x
è(((xè>> 12è& 3è

	)

434 
	#PCI_X_STATUS
 4

	)

435 
	#PCI_X_STATUS_DEVFN
 0x000000fà

	)

436 
	#PCI_X_STATUS_BUS
 0x0000ff00

	)

437 
	#PCI_X_STATUS_64BIT
 0x00010000

	)

438 
	#PCI_X_STATUS_133MHZ
 0x00020000

	)

439 
	#PCI_X_STATUS_SPL_DISC
 0x00040000

	)

440 
	#PCI_X_STATUS_UNX_SPL
 0x00080000

	)

441 
	#PCI_X_STATUS_COMPLEX
 0x00100000

	)

442 
	#PCI_X_STATUS_MAX_READ
 0x00600000

	)

443 
	#PCI_X_STATUS_MAX_SPLIT
 0x03800000

	)

444 
	#PCI_X_STATUS_MAX_CUM
 0x1c000000

	)

445 
	#PCI_X_STATUS_SPL_ERR
 0x20000000

	)

446 
	#PCI_X_STATUS_266MHZ
 0x40000000

	)

447 
	#PCI_X_STATUS_533MHZ
 0x80000000

	)

448 
	#PCI_X_ECC_CSR
 8

	)

449 
	#PCI_CAP_PCIX_SIZEOF_V0
 8

	)

450 
	#PCI_CAP_PCIX_SIZEOF_V1
 24

	)

451 
	#PCI_CAP_PCIX_SIZEOF_V2
 
PCI_CAP_PCIX_SIZEOF_V1


	)

455 
	#PCI_X_BRIDGE_SSTATUS
 2

	)

456 
	#PCI_X_SSTATUS_64BIT
 0x0001

	)

457 
	#PCI_X_SSTATUS_133MHZ
 0x0002

	)

458 
	#PCI_X_SSTATUS_FREQ
 0x03c0

	)

459 
	#PCI_X_SSTATUS_VERS
 0x3000

	)

460 
	#PCI_X_SSTATUS_V1
 0x1000

	)

461 
	#PCI_X_SSTATUS_V2
 0x2000

	)

462 
	#PCI_X_SSTATUS_266MHZ
 0x4000

	)

463 
	#PCI_X_SSTATUS_533MHZ
 0x8000

	)

464 
	#PCI_X_BRIDGE_STATUS
 4

	)

468 
	#PCI_SSVID_VENDOR_ID
 4

	)

469 
	#PCI_SSVID_DEVICE_ID
 6

	)

473 
	#PCI_EXP_FLAGS
 0x02

	)

474 
	#PCI_EXP_FLAGS_VERS
 0x000à

	)

475 
	#PCI_EXP_FLAGS_TYPE
 0x00f0

	)

476 
	#PCI_EXP_TYPE_ENDPOINT
 0x0

	)

477 
	#PCI_EXP_TYPE_LEG_END
 0x1

	)

478 
	#PCI_EXP_TYPE_ROOT_PORT
 0x4

	)

479 
	#PCI_EXP_TYPE_UPSTREAM
 0x5

	)

480 
	#PCI_EXP_TYPE_DOWNSTREAM
 0x6

	)

481 
	#PCI_EXP_TYPE_PCI_BRIDGE
 0x7

	)

482 
	#PCI_EXP_TYPE_PCIE_BRIDGE
 0x8

	)

483 
	#PCI_EXP_TYPE_RC_END
 0x9

	)

484 
	#PCI_EXP_TYPE_RC_EC
 0x¨

	)

485 
	#PCI_EXP_FLAGS_SLOT
 0x0100

	)

486 
	#PCI_EXP_FLAGS_IRQ
 0x3e00

	)

487 
	#PCI_EXP_DEVCAP
 0x04

	)

488 
	#PCI_EXP_DEVCAP_PAYLOAD
 0x00000007

	)

489 
	#PCI_EXP_DEVCAP_PHANTOM
 0x00000018

	)

490 
	#PCI_EXP_DEVCAP_EXT_TAG
 0x00000020

	)

491 
	#PCI_EXP_DEVCAP_L0S
 0x000001c0

	)

492 
	#PCI_EXP_DEVCAP_L1
 0x00000e00

	)

493 
	#PCI_EXP_DEVCAP_ATN_BUT
 0x00001000

	)

494 
	#PCI_EXP_DEVCAP_ATN_IND
 0x00002000

	)

495 
	#PCI_EXP_DEVCAP_PWR_IND
 0x00004000

	)

496 
	#PCI_EXP_DEVCAP_RBER
 0x00008000

	)

497 
	#PCI_EXP_DEVCAP_PWR_VAL
 0x03fc0000

	)

498 
	#PCI_EXP_DEVCAP_PWR_SCL
 0x0c000000

	)

499 
	#PCI_EXP_DEVCAP_FLR
 0x10000000

	)

500 
	#PCI_EXP_DEVCTL
 0x08

	)

501 
	#PCI_EXP_DEVCTL_CERE
 0x0001

	)

502 
	#PCI_EXP_DEVCTL_NFERE
 0x0002

	)

503 
	#PCI_EXP_DEVCTL_FERE
 0x0004

	)

504 
	#PCI_EXP_DEVCTL_URRE
 0x0008

	)

505 
	#PCI_EXP_DEVCTL_RELAX_EN
 0x0010

	)

506 
	#PCI_EXP_DEVCTL_PAYLOAD
 0x00e0

	)

507 
	#PCI_EXP_DEVCTL_PAYLOAD_128B
 0x0000

	)

508 
	#PCI_EXP_DEVCTL_PAYLOAD_256B
 0x0020

	)

509 
	#PCI_EXP_DEVCTL_PAYLOAD_512B
 0x0040

	)

510 
	#PCI_EXP_DEVCTL_PAYLOAD_1024B
 0x0060

	)

511 
	#PCI_EXP_DEVCTL_PAYLOAD_2048B
 0x0080

	)

512 
	#PCI_EXP_DEVCTL_PAYLOAD_4096B
 0x00a0

	)

513 
	#PCI_EXP_DEVCTL_EXT_TAG
 0x0100

	)

514 
	#PCI_EXP_DEVCTL_PHANTOM
 0x0200

	)

515 
	#PCI_EXP_DEVCTL_AUX_PME
 0x0400

	)

516 
	#PCI_EXP_DEVCTL_NOSNOOP_EN
 0x0800

	)

517 
	#PCI_EXP_DEVCTL_READRQ
 0x7000

	)

518 
	#PCI_EXP_DEVCTL_READRQ_128B
 0x0000

	)

519 
	#PCI_EXP_DEVCTL_READRQ_256B
 0x1000

	)

520 
	#PCI_EXP_DEVCTL_READRQ_512B
 0x2000

	)

521 
	#PCI_EXP_DEVCTL_READRQ_1024B
 0x3000

	)

522 
	#PCI_EXP_DEVCTL_READRQ_2048B
 0x4000

	)

523 
	#PCI_EXP_DEVCTL_READRQ_4096B
 0x5000

	)

524 
	#PCI_EXP_DEVCTL_BCR_FLR
 0x8000

	)

525 
	#PCI_EXP_DEVSTA
 0x0¨

	)

526 
	#PCI_EXP_DEVSTA_CED
 0x0001

	)

527 
	#PCI_EXP_DEVSTA_NFED
 0x0002

	)

528 
	#PCI_EXP_DEVSTA_FED
 0x0004

	)

529 
	#PCI_EXP_DEVSTA_URD
 0x0008

	)

530 
	#PCI_EXP_DEVSTA_AUXPD
 0x0010

	)

531 
	#PCI_EXP_DEVSTA_TRPND
 0x0020

	)

532 
	#PCI_CAP_EXP_RC_ENDPOINT_SIZEOF_V1
 12

	)

533 
	#PCI_EXP_LNKCAP
 0x0ø

	)

534 
	#PCI_EXP_LNKCAP_SLS
 0x0000000à

	)

535 
	#PCI_EXP_LNKCAP_SLS_2_5GB
 0x00000001

	)

536 
	#PCI_EXP_LNKCAP_SLS_5_0GB
 0x00000002

	)

537 
	#PCI_EXP_LNKCAP_SLS_8_0GB
 0x00000003

	)

538 
	#PCI_EXP_LNKCAP_SLS_16_0GB
 0x00000004

	)

539 
	#PCI_EXP_LNKCAP_SLS_32_0GB
 0x00000005

	)

540 
	#PCI_EXP_LNKCAP_SLS_64_0GB
 0x00000006

	)

541 
	#PCI_EXP_LNKCAP_MLW
 0x000003f0

	)

542 
	#PCI_EXP_LNKCAP_ASPMS
 0x00000c00

	)

543 
	#PCI_EXP_LNKCAP_ASPM_L0S
 0x00000400

	)

544 
	#PCI_EXP_LNKCAP_ASPM_L1
 0x00000800

	)

545 
	#PCI_EXP_LNKCAP_L0SEL
 0x00007000

	)

546 
	#PCI_EXP_LNKCAP_L1EL
 0x00038000

	)

547 
	#PCI_EXP_LNKCAP_CLKPM
 0x00040000

	)

548 
	#PCI_EXP_LNKCAP_SDERC
 0x00080000

	)

549 
	#PCI_EXP_LNKCAP_DLLLARC
 0x00100000

	)

550 
	#PCI_EXP_LNKCAP_LBNC
 0x00200000

	)

551 
	#PCI_EXP_LNKCAP_PN
 0xff000000

	)

552 
	#PCI_EXP_LNKCTL
 0x10

	)

553 
	#PCI_EXP_LNKCTL_ASPMC
 0x0003

	)

554 
	#PCI_EXP_LNKCTL_ASPM_L0S
 0x0001

	)

555 
	#PCI_EXP_LNKCTL_ASPM_L1
 0x0002

	)

556 
	#PCI_EXP_LNKCTL_RCB
 0x0008

	)

557 
	#PCI_EXP_LNKCTL_LD
 0x0010

	)

558 
	#PCI_EXP_LNKCTL_RL
 0x0020

	)

559 
	#PCI_EXP_LNKCTL_CCC
 0x0040

	)

560 
	#PCI_EXP_LNKCTL_ES
 0x0080

	)

561 
	#PCI_EXP_LNKCTL_CLKREQ_EN
 0x0100

	)

562 
	#PCI_EXP_LNKCTL_HAWD
 0x0200

	)

563 
	#PCI_EXP_LNKCTL_LBMIE
 0x0400

	)

564 
	#PCI_EXP_LNKCTL_LABIE
 0x0800

	)

565 
	#PCI_EXP_LNKSTA
 0x12

	)

566 
	#PCI_EXP_LNKSTA_CLS
 0x000à

	)

567 
	#PCI_EXP_LNKSTA_CLS_2_5GB
 0x0001

	)

568 
	#PCI_EXP_LNKSTA_CLS_5_0GB
 0x0002

	)

569 
	#PCI_EXP_LNKSTA_CLS_8_0GB
 0x0003

	)

570 
	#PCI_EXP_LNKSTA_CLS_16_0GB
 0x0004

	)

571 
	#PCI_EXP_LNKSTA_CLS_32_0GB
 0x0005

	)

572 
	#PCI_EXP_LNKSTA_CLS_64_0GB
 0x0006

	)

573 
	#PCI_EXP_LNKSTA_NLW
 0x03f0

	)

574 
	#PCI_EXP_LNKSTA_NLW_X1
 0x0010

	)

575 
	#PCI_EXP_LNKSTA_NLW_X2
 0x0020

	)

576 
	#PCI_EXP_LNKSTA_NLW_X4
 0x0040

	)

577 
	#PCI_EXP_LNKSTA_NLW_X8
 0x0080

	)

578 
	#PCI_EXP_LNKSTA_NLW_SHIFT
 4

	)

579 
	#PCI_EXP_LNKSTA_LT
 0x0800

	)

580 
	#PCI_EXP_LNKSTA_SLC
 0x1000

	)

581 
	#PCI_EXP_LNKSTA_DLLLA
 0x2000

	)

582 
	#PCI_EXP_LNKSTA_LBMS
 0x4000

	)

583 
	#PCI_EXP_LNKSTA_LABS
 0x8000

	)

584 
	#PCI_CAP_EXP_ENDPOINT_SIZEOF_V1
 20

	)

585 
	#PCI_EXP_SLTCAP
 0x14

	)

586 
	#PCI_EXP_SLTCAP_ABP
 0x00000001

	)

587 
	#PCI_EXP_SLTCAP_PCP
 0x00000002

	)

588 
	#PCI_EXP_SLTCAP_MRLSP
 0x00000004

	)

589 
	#PCI_EXP_SLTCAP_AIP
 0x00000008

	)

590 
	#PCI_EXP_SLTCAP_PIP
 0x00000010

	)

591 
	#PCI_EXP_SLTCAP_HPS
 0x00000020

	)

592 
	#PCI_EXP_SLTCAP_HPC
 0x00000040

	)

593 
	#PCI_EXP_SLTCAP_SPLV
 0x00007f80

	)

594 
	#PCI_EXP_SLTCAP_SPLS
 0x00018000

	)

595 
	#PCI_EXP_SLTCAP_EIP
 0x00020000

	)

596 
	#PCI_EXP_SLTCAP_NCCS
 0x00040000

	)

597 
	#PCI_EXP_SLTCAP_PSN
 0xfff80000

	)

598 
	#PCI_EXP_SLTCTL
 0x18

	)

599 
	#PCI_EXP_SLTCTL_ABPE
 0x0001

	)

600 
	#PCI_EXP_SLTCTL_PFDE
 0x0002

	)

601 
	#PCI_EXP_SLTCTL_MRLSCE
 0x0004

	)

602 
	#PCI_EXP_SLTCTL_PDCE
 0x0008

	)

603 
	#PCI_EXP_SLTCTL_CCIE
 0x0010

	)

604 
	#PCI_EXP_SLTCTL_HPIE
 0x0020

	)

605 
	#PCI_EXP_SLTCTL_AIC
 0x00c0

	)

606 
	#PCI_EXP_SLTCTL_ATTN_IND_SHIFT
 6

	)

607 
	#PCI_EXP_SLTCTL_ATTN_IND_ON
 0x0040

	)

608 
	#PCI_EXP_SLTCTL_ATTN_IND_BLINK
 0x0080

	)

609 
	#PCI_EXP_SLTCTL_ATTN_IND_OFF
 0x00c0

	)

610 
	#PCI_EXP_SLTCTL_PIC
 0x0300

	)

611 
	#PCI_EXP_SLTCTL_PWR_IND_ON
 0x0100

	)

612 
	#PCI_EXP_SLTCTL_PWR_IND_BLINK
 0x0200

	)

613 
	#PCI_EXP_SLTCTL_PWR_IND_OFF
 0x0300

	)

614 
	#PCI_EXP_SLTCTL_PCC
 0x0400

	)

615 
	#PCI_EXP_SLTCTL_PWR_ON
 0x0000

	)

616 
	#PCI_EXP_SLTCTL_PWR_OFF
 0x0400

	)

617 
	#PCI_EXP_SLTCTL_EIC
 0x0800

	)

618 
	#PCI_EXP_SLTCTL_DLLSCE
 0x1000

	)

619 
	#PCI_EXP_SLTCTL_ASPL_DISABLE
 0x2000

	)

620 
	#PCI_EXP_SLTCTL_IBPD_DISABLE
 0x4000

	)

621 
	#PCI_EXP_SLTSTA
 0x1¨

	)

622 
	#PCI_EXP_SLTSTA_ABP
 0x0001

	)

623 
	#PCI_EXP_SLTSTA_PFD
 0x0002

	)

624 
	#PCI_EXP_SLTSTA_MRLSC
 0x0004

	)

625 
	#PCI_EXP_SLTSTA_PDC
 0x0008

	)

626 
	#PCI_EXP_SLTSTA_CC
 0x0010

	)

627 
	#PCI_EXP_SLTSTA_MRLSS
 0x0020

	)

628 
	#PCI_EXP_SLTSTA_PDS
 0x0040

	)

629 
	#PCI_EXP_SLTSTA_EIS
 0x0080

	)

630 
	#PCI_EXP_SLTSTA_DLLSC
 0x0100

	)

631 
	#PCI_EXP_RTCTL
 0x1ø

	)

632 
	#PCI_EXP_RTCTL_SECEE
 0x0001

	)

633 
	#PCI_EXP_RTCTL_SENFEE
 0x0002

	)

634 
	#PCI_EXP_RTCTL_SEFEE
 0x0004

	)

635 
	#PCI_EXP_RTCTL_PMEIE
 0x0008

	)

636 
	#PCI_EXP_RTCTL_CRSSVE
 0x0010

	)

637 
	#PCI_EXP_RTCAP
 0x1

	)

638 
	#PCI_EXP_RTCAP_CRSVIS
 0x0001

	)

639 
	#PCI_EXP_RTSTA
 0x20

	)

640 
	#PCI_EXP_RTSTA_PME
 0x00010000

	)

641 
	#PCI_EXP_RTSTA_PENDING
 0x00020000

	)

650 
	#PCI_EXP_DEVCAP2
 0x24

	)

651 
	#PCI_EXP_DEVCAP2_COMP_TMOUT_DIS
 0x00000010

	)

652 
	#PCI_EXP_DEVCAP2_ARI
 0x00000020

	)

653 
	#PCI_EXP_DEVCAP2_ATOMIC_ROUTE
 0x00000040

	)

654 
	#PCI_EXP_DEVCAP2_ATOMIC_COMP32
 0x00000080

	)

655 
	#PCI_EXP_DEVCAP2_ATOMIC_COMP64
 0x00000100

	)

656 
	#PCI_EXP_DEVCAP2_ATOMIC_COMP128
 0x00000200

	)

657 
	#PCI_EXP_DEVCAP2_LTR
 0x00000800

	)

658 
	#PCI_EXP_DEVCAP2_OBFF_MASK
 0x000c0000

	)

659 
	#PCI_EXP_DEVCAP2_OBFF_MSG
 0x00040000

	)

660 
	#PCI_EXP_DEVCAP2_OBFF_WAKE
 0x00080000

	)

661 
	#PCI_EXP_DEVCAP2_EE_PREFIX
 0x00200000

	)

662 
	#PCI_EXP_DEVCTL2
 0x28

	)

663 
	#PCI_EXP_DEVCTL2_COMP_TIMEOUT
 0x000à

	)

664 
	#PCI_EXP_DEVCTL2_COMP_TMOUT_DIS
 0x0010

	)

665 
	#PCI_EXP_DEVCTL2_ARI
 0x0020

	)

666 
	#PCI_EXP_DEVCTL2_ATOMIC_REQ
 0x0040

	)

667 
	#PCI_EXP_DEVCTL2_ATOMIC_EGRESS_BLOCK
 0x0080

	)

668 
	#PCI_EXP_DEVCTL2_IDO_REQ_EN
 0x0100

	)

669 
	#PCI_EXP_DEVCTL2_IDO_CMP_EN
 0x0200

	)

670 
	#PCI_EXP_DEVCTL2_LTR_EN
 0x0400

	)

671 
	#PCI_EXP_DEVCTL2_OBFF_MSGA_EN
 0x2000

	)

672 
	#PCI_EXP_DEVCTL2_OBFF_MSGB_EN
 0x4000

	)

673 
	#PCI_EXP_DEVCTL2_OBFF_WAKE_EN
 0x6000

	)

674 
	#PCI_EXP_DEVSTA2
 0x2¨

	)

675 
	#PCI_CAP_EXP_RC_ENDPOINT_SIZEOF_V2
 0x2ø

	)

676 
	#PCI_EXP_LNKCAP2
 0x2ø

	)

677 
	#PCI_EXP_LNKCAP2_SLS_2_5GB
 0x00000002

	)

678 
	#PCI_EXP_LNKCAP2_SLS_5_0GB
 0x00000004

	)

679 
	#PCI_EXP_LNKCAP2_SLS_8_0GB
 0x00000008

	)

680 
	#PCI_EXP_LNKCAP2_SLS_16_0GB
 0x00000010

	)

681 
	#PCI_EXP_LNKCAP2_SLS_32_0GB
 0x00000020

	)

682 
	#PCI_EXP_LNKCAP2_SLS_64_0GB
 0x00000040

	)

683 
	#PCI_EXP_LNKCAP2_CROSSLINK
 0x00000100

	)

684 
	#PCI_EXP_LNKCTL2
 0x30

	)

685 
	#PCI_EXP_LNKCTL2_TLS
 0x000f

	)

686 
	#PCI_EXP_LNKCTL2_TLS_2_5GT
 0x0001

	)

687 
	#PCI_EXP_LNKCTL2_TLS_5_0GT
 0x0002

	)

688 
	#PCI_EXP_LNKCTL2_TLS_8_0GT
 0x0003

	)

689 
	#PCI_EXP_LNKCTL2_TLS_16_0GT
 0x0004

	)

690 
	#PCI_EXP_LNKCTL2_TLS_32_0GT
 0x0005

	)

691 
	#PCI_EXP_LNKCTL2_TLS_64_0GT
 0x0006

	)

692 
	#PCI_EXP_LNKCTL2_ENTER_COMP
 0x0010

	)

693 
	#PCI_EXP_LNKCTL2_TX_MARGIN
 0x0380

	)

694 
	#PCI_EXP_LNKCTL2_HASD
 0x0020

	)

695 
	#PCI_EXP_LNKSTA2
 0x32

	)

696 
	#PCI_CAP_EXP_ENDPOINT_SIZEOF_V2
 0x32

	)

697 
	#PCI_EXP_SLTCAP2
 0x34

	)

698 
	#PCI_EXP_SLTCAP2_IBPD
 0x00000001

	)

699 
	#PCI_EXP_SLTCTL2
 0x38

	)

700 
	#PCI_EXP_SLTSTA2
 0x3¨

	)

703 
	#PCI_EXT_CAP_ID
(
h—d”
è(h—d” & 0x0000ffff)

	)

704 
	#PCI_EXT_CAP_VER
(
h—d”
è((h—d” >> 16è& 0xf)

	)

705 
	#PCI_EXT_CAP_NEXT
(
h—d”
è((h—d” >> 20è& 0xffc)

	)

707 
	#PCI_EXT_CAP_ID_ERR
 0x01

	)

708 
	#PCI_EXT_CAP_ID_VC
 0x02

	)

709 
	#PCI_EXT_CAP_ID_DSN
 0x03

	)

710 
	#PCI_EXT_CAP_ID_PWR
 0x04

	)

711 
	#PCI_EXT_CAP_ID_RCLD
 0x05

	)

712 
	#PCI_EXT_CAP_ID_RCILC
 0x06

	)

713 
	#PCI_EXT_CAP_ID_RCEC
 0x07

	)

714 
	#PCI_EXT_CAP_ID_MFVC
 0x08

	)

715 
	#PCI_EXT_CAP_ID_VC9
 0x09

	)

716 
	#PCI_EXT_CAP_ID_RCRB
 0x0A

	)

717 
	#PCI_EXT_CAP_ID_VNDR
 0x0B

	)

718 
	#PCI_EXT_CAP_ID_CAC
 0x0C

	)

719 
	#PCI_EXT_CAP_ID_ACS
 0x0D

	)

720 
	#PCI_EXT_CAP_ID_ARI
 0x0E

	)

721 
	#PCI_EXT_CAP_ID_ATS
 0x0F

	)

722 
	#PCI_EXT_CAP_ID_SRIOV
 0x10

	)

723 
	#PCI_EXT_CAP_ID_MRIOV
 0x11

	)

724 
	#PCI_EXT_CAP_ID_MCAST
 0x12

	)

725 
	#PCI_EXT_CAP_ID_PRI
 0x13

	)

726 
	#PCI_EXT_CAP_ID_AMD_XXX
 0x14

	)

727 
	#PCI_EXT_CAP_ID_REBAR
 0x15

	)

728 
	#PCI_EXT_CAP_ID_DPA
 0x16

	)

729 
	#PCI_EXT_CAP_ID_TPH
 0x17

	)

730 
	#PCI_EXT_CAP_ID_LTR
 0x18

	)

731 
	#PCI_EXT_CAP_ID_SECPCI
 0x19

	)

732 
	#PCI_EXT_CAP_ID_PMUX
 0x1A

	)

733 
	#PCI_EXT_CAP_ID_PASID
 0x1B

	)

734 
	#PCI_EXT_CAP_ID_DPC
 0x1D

	)

735 
	#PCI_EXT_CAP_ID_L1SS
 0x1E

	)

736 
	#PCI_EXT_CAP_ID_PTM
 0x1F

	)

737 
	#PCI_EXT_CAP_ID_DVSEC
 0x23

	)

738 
	#PCI_EXT_CAP_ID_DLF
 0x25

	)

739 
	#PCI_EXT_CAP_ID_PL_16GT
 0x26

	)

740 
	#PCI_EXT_CAP_ID_DOE
 0x2E

	)

741 
	#PCI_EXT_CAP_ID_MAX
 
PCI_EXT_CAP_ID_DOE


	)

743 
	#PCI_EXT_CAP_DSN_SIZEOF
 12

	)

744 
	#PCI_EXT_CAP_MCAST_ENDPOINT_SIZEOF
 40

	)

747 
	#PCI_ERR_UNCOR_STATUS
 0x04

	)

748 
	#PCI_ERR_UNC_UND
 0x00000001

	)

749 
	#PCI_ERR_UNC_DLP
 0x00000010

	)

750 
	#PCI_ERR_UNC_SURPDN
 0x00000020

	)

751 
	#PCI_ERR_UNC_POISON_TLP
 0x00001000

	)

752 
	#PCI_ERR_UNC_FCP
 0x00002000

	)

753 
	#PCI_ERR_UNC_COMP_TIME
 0x00004000

	)

754 
	#PCI_ERR_UNC_COMP_ABORT
 0x00008000

	)

755 
	#PCI_ERR_UNC_UNX_COMP
 0x00010000

	)

756 
	#PCI_ERR_UNC_RX_OVER
 0x00020000

	)

757 
	#PCI_ERR_UNC_MALF_TLP
 0x00040000

	)

758 
	#PCI_ERR_UNC_ECRC
 0x00080000

	)

759 
	#PCI_ERR_UNC_UNSUP
 0x00100000

	)

760 
	#PCI_ERR_UNC_ACSV
 0x00200000

	)

761 
	#PCI_ERR_UNC_INTN
 0x00400000

	)

762 
	#PCI_ERR_UNC_MCBTLP
 0x00800000

	)

763 
	#PCI_ERR_UNC_ATOMEG
 0x01000000

	)

764 
	#PCI_ERR_UNC_TLPPRE
 0x02000000

	)

765 
	#PCI_ERR_UNCOR_MASK
 0x08

	)

767 
	#PCI_ERR_UNCOR_SEVER
 0x0ø

	)

769 
	#PCI_ERR_COR_STATUS
 0x10

	)

770 
	#PCI_ERR_COR_RCVR
 0x00000001

	)

771 
	#PCI_ERR_COR_BAD_TLP
 0x00000040

	)

772 
	#PCI_ERR_COR_BAD_DLLP
 0x00000080

	)

773 
	#PCI_ERR_COR_REP_ROLL
 0x00000100

	)

774 
	#PCI_ERR_COR_REP_TIMER
 0x00001000

	)

775 
	#PCI_ERR_COR_ADV_NFAT
 0x00002000

	)

776 
	#PCI_ERR_COR_INTERNAL
 0x00004000

	)

777 
	#PCI_ERR_COR_LOG_OVER
 0x00008000

	)

778 
	#PCI_ERR_COR_MASK
 0x14

	)

780 
	#PCI_ERR_CAP
 0x18

	)

781 
	#PCI_ERR_CAP_FEP
(
x
è((xè& 0x1fè

	)

782 
	#PCI_ERR_CAP_ECRC_GENC
 0x00000020

	)

783 
	#PCI_ERR_CAP_ECRC_GENE
 0x00000040

	)

784 
	#PCI_ERR_CAP_ECRC_CHKC
 0x00000080

	)

785 
	#PCI_ERR_CAP_ECRC_CHKE
 0x00000100

	)

786 
	#PCI_ERR_HEADER_LOG
 0x1ø

	)

787 
	#PCI_ERR_ROOT_COMMAND
 0x2ø

	)

788 
	#PCI_ERR_ROOT_CMD_COR_EN
 0x00000001

	)

789 
	#PCI_ERR_ROOT_CMD_NONFATAL_EN
 0x00000002

	)

790 
	#PCI_ERR_ROOT_CMD_FATAL_EN
 0x00000004

	)

791 
	#PCI_ERR_ROOT_STATUS
 0x30

	)

792 
	#PCI_ERR_ROOT_COR_RCV
 0x00000001

	)

793 
	#PCI_ERR_ROOT_MULTI_COR_RCV
 0x00000002

	)

794 
	#PCI_ERR_ROOT_UNCOR_RCV
 0x00000004

	)

795 
	#PCI_ERR_ROOT_MULTI_UNCOR_RCV
 0x00000008

	)

796 
	#PCI_ERR_ROOT_FIRST_FATAL
 0x00000010

	)

797 
	#PCI_ERR_ROOT_NONFATAL_RCV
 0x00000020

	)

798 
	#PCI_ERR_ROOT_FATAL_RCV
 0x00000040

	)

799 
	#PCI_ERR_ROOT_AER_IRQ
 0xf8000000

	)

800 
	#PCI_ERR_ROOT_ERR_SRC
 0x34

	)

803 
	#PCI_VC_PORT_CAP1
 0x04

	)

804 
	#PCI_VC_CAP1_EVCC
 0x00000007

	)

805 
	#PCI_VC_CAP1_LPEVCC
 0x00000070

	)

806 
	#PCI_VC_CAP1_ARB_SIZE
 0x00000c00

	)

807 
	#PCI_VC_PORT_CAP2
 0x08

	)

808 
	#PCI_VC_CAP2_32_PHASE
 0x00000002

	)

809 
	#PCI_VC_CAP2_64_PHASE
 0x00000004

	)

810 
	#PCI_VC_CAP2_128_PHASE
 0x00000008

	)

811 
	#PCI_VC_CAP2_ARB_OFF
 0xff000000

	)

812 
	#PCI_VC_PORT_CTRL
 0x0c

	)

813 
	#PCI_VC_PORT_CTRL_LOAD_TABLE
 0x00000001

	)

814 
	#PCI_VC_PORT_STATUS
 0x0e

	)

815 
	#PCI_VC_PORT_STATUS_TABLE
 0x00000001

	)

816 
	#PCI_VC_RES_CAP
 0x10

	)

817 
	#PCI_VC_RES_CAP_32_PHASE
 0x00000002

	)

818 
	#PCI_VC_RES_CAP_64_PHASE
 0x00000004

	)

819 
	#PCI_VC_RES_CAP_128_PHASE
 0x00000008

	)

820 
	#PCI_VC_RES_CAP_128_PHASE_TB
 0x00000010

	)

821 
	#PCI_VC_RES_CAP_256_PHASE
 0x00000020

	)

822 
	#PCI_VC_RES_CAP_ARB_OFF
 0xff000000

	)

823 
	#PCI_VC_RES_CTRL
 0x14

	)

824 
	#PCI_VC_RES_CTRL_LOAD_TABLE
 0x00010000

	)

825 
	#PCI_VC_RES_CTRL_ARB_SELECT
 0x000e0000

	)

826 
	#PCI_VC_RES_CTRL_ID
 0x07000000

	)

827 
	#PCI_VC_RES_CTRL_ENABLE
 0x80000000

	)

828 
	#PCI_VC_RES_STATUS
 0x1a

	)

829 
	#PCI_VC_RES_STATUS_TABLE
 0x00000001

	)

830 
	#PCI_VC_RES_STATUS_NEGO
 0x00000002

	)

831 
	#PCI_CAP_VC_BASE_SIZEOF
 0x10

	)

832 
	#PCI_CAP_VC_PER_VC_SIZEOF
 0x0c

	)

835 
	#PCI_PWR_DSR
 0x04

	)

836 
	#PCI_PWR_DATA
 0x08

	)

837 
	#PCI_PWR_DATA_BASE
(
x
è((xè& 0xffè

	)

838 
	#PCI_PWR_DATA_SCALE
(
x
è(((xè>> 8è& 3è

	)

839 
	#PCI_PWR_DATA_PM_SUB
(
x
è(((xè>> 10è& 7è

	)

840 
	#PCI_PWR_DATA_PM_STATE
(
x
è(((xè>> 13è& 3è

	)

841 
	#PCI_PWR_DATA_TYPE
(
x
è(((xè>> 15è& 7è

	)

842 
	#PCI_PWR_DATA_RAIL
(
x
è(((xè>> 18è& 7è

	)

843 
	#PCI_PWR_CAP
 0x0ø

	)

844 
	#PCI_PWR_CAP_BUDGET
(
x
è((xè& 1è

	)

845 
	#PCI_EXT_CAP_PWR_SIZEOF
 0x10

	)

848 
	#PCI_RCEC_RCIEP_BITMAP
 4

	)

849 
	#PCI_RCEC_BUSN
 8

	)

850 
	#PCI_RCEC_BUSN_REG_VER
 0x02

	)

851 
	#PCI_RCEC_BUSN_NEXT
(
x
è(((xè>> 8è& 0xff)

	)

852 
	#PCI_RCEC_BUSN_LAST
(
x
è(((xè>> 16è& 0xff)

	)

855 
	#PCI_VNDR_HEADER
 4

	)

856 
	#PCI_VNDR_HEADER_ID
(
x
è((xè& 0xffff)

	)

857 
	#PCI_VNDR_HEADER_REV
(
x
è(((xè>> 16è& 0xf)

	)

858 
	#PCI_VNDR_HEADER_LEN
(
x
è(((xè>> 20è& 0xfff)

	)

868 
	#HT_3BIT_CAP_MASK
 0xE0

	)

869 
	#HT_CAPTYPE_SLAVE
 0x00

	)

870 
	#HT_CAPTYPE_HOST
 0x20

	)

872 
	#HT_5BIT_CAP_MASK
 0xF8

	)

873 
	#HT_CAPTYPE_IRQ
 0x80

	)

874 
	#HT_CAPTYPE_REMAPPING_40
 0xA0

	)

875 
	#HT_CAPTYPE_REMAPPING_64
 0xA2

	)

876 
	#HT_CAPTYPE_UNITID_CLUMP
 0x90

	)

877 
	#HT_CAPTYPE_EXTCONF
 0x98

	)

878 
	#HT_CAPTYPE_MSI_MAPPING
 0xA8

	)

879 
	#HT_MSI_FLAGS
 0x02

	)

880 
	#HT_MSI_FLAGS_ENABLE
 0x1

	)

881 
	#HT_MSI_FLAGS_FIXED
 0x2

	)

882 
	#HT_MSI_FIXED_ADDR
 0x00000000FEE00000ULL

	)

883 
	#HT_MSI_ADDR_LO
 0x04

	)

884 
	#HT_MSI_ADDR_LO_MASK
 0xFFF00000

	)

885 
	#HT_MSI_ADDR_HI
 0x08

	)

886 
	#HT_CAPTYPE_DIRECT_ROUTE
 0xB0

	)

887 
	#HT_CAPTYPE_VCSET
 0xB8

	)

888 
	#HT_CAPTYPE_ERROR_RETRY
 0xC0

	)

889 
	#HT_CAPTYPE_GEN3
 0xD0

	)

890 
	#HT_CAPTYPE_PM
 0xE0

	)

891 
	#HT_CAP_SIZEOF_LONG
 28

	)

892 
	#HT_CAP_SIZEOF_SHORT
 24

	)

895 
	#PCI_ARI_CAP
 0x04

	)

896 
	#PCI_ARI_CAP_MFVC
 0x0001

	)

897 
	#PCI_ARI_CAP_ACS
 0x0002

	)

898 
	#PCI_ARI_CAP_NFN
(
x
è(((xè>> 8è& 0xffè

	)

899 
	#PCI_ARI_CTRL
 0x06

	)

900 
	#PCI_ARI_CTRL_MFVC
 0x0001

	)

901 
	#PCI_ARI_CTRL_ACS
 0x0002

	)

902 
	#PCI_ARI_CTRL_FG
(
x
è(((xè>> 4è& 7è

	)

903 
	#PCI_EXT_CAP_ARI_SIZEOF
 8

	)

906 
	#PCI_ATS_CAP
 0x04

	)

907 
	#PCI_ATS_CAP_QDEP
(
x
è((xè& 0x1fè

	)

908 
	#PCI_ATS_MAX_QDEP
 32

	)

909 
	#PCI_ATS_CAP_PAGE_ALIGNED
 0x0020

	)

910 
	#PCI_ATS_CTRL
 0x06

	)

911 
	#PCI_ATS_CTRL_ENABLE
 0x8000

	)

912 
	#PCI_ATS_CTRL_STU
(
x
è((xè& 0x1fè

	)

913 
	#PCI_ATS_MIN_STU
 12

	)

914 
	#PCI_EXT_CAP_ATS_SIZEOF
 8

	)

917 
	#PCI_PRI_CTRL
 0x04

	)

918 
	#PCI_PRI_CTRL_ENABLE
 0x0001

	)

919 
	#PCI_PRI_CTRL_RESET
 0x0002

	)

920 
	#PCI_PRI_STATUS
 0x06

	)

921 
	#PCI_PRI_STATUS_RF
 0x0001

	)

922 
	#PCI_PRI_STATUS_UPRGI
 0x0002

	)

923 
	#PCI_PRI_STATUS_STOPPED
 0x0100

	)

924 
	#PCI_PRI_STATUS_PASID
 0x8000

	)

925 
	#PCI_PRI_MAX_REQ
 0x08

	)

926 
	#PCI_PRI_ALLOC_REQ
 0x0ø

	)

927 
	#PCI_EXT_CAP_PRI_SIZEOF
 16

	)

930 
	#PCI_PASID_CAP
 0x04

	)

931 
	#PCI_PASID_CAP_EXEC
 0x02

	)

932 
	#PCI_PASID_CAP_PRIV
 0x04

	)

933 
	#PCI_PASID_CTRL
 0x06

	)

934 
	#PCI_PASID_CTRL_ENABLE
 0x01

	)

935 
	#PCI_PASID_CTRL_EXEC
 0x02

	)

936 
	#PCI_PASID_CTRL_PRIV
 0x04

	)

937 
	#PCI_EXT_CAP_PASID_SIZEOF
 8

	)

940 
	#PCI_SRIOV_CAP
 0x04

	)

941 
	#PCI_SRIOV_CAP_VFM
 0x00000001

	)

942 
	#PCI_SRIOV_CAP_INTR
(
x
è((xè>> 21è

	)

943 
	#PCI_SRIOV_CTRL
 0x08

	)

944 
	#PCI_SRIOV_CTRL_VFE
 0x0001

	)

945 
	#PCI_SRIOV_CTRL_VFM
 0x0002

	)

946 
	#PCI_SRIOV_CTRL_INTR
 0x0004

	)

947 
	#PCI_SRIOV_CTRL_MSE
 0x0008

	)

948 
	#PCI_SRIOV_CTRL_ARI
 0x0010

	)

949 
	#PCI_SRIOV_STATUS
 0x0¨

	)

950 
	#PCI_SRIOV_STATUS_VFM
 0x0001

	)

951 
	#PCI_SRIOV_INITIAL_VF
 0x0ø

	)

952 
	#PCI_SRIOV_TOTAL_VF
 0x0

	)

953 
	#PCI_SRIOV_NUM_VF
 0x10

	)

954 
	#PCI_SRIOV_FUNC_LINK
 0x12

	)

955 
	#PCI_SRIOV_VF_OFFSET
 0x14

	)

956 
	#PCI_SRIOV_VF_STRIDE
 0x16

	)

957 
	#PCI_SRIOV_VF_DID
 0x1¨

	)

958 
	#PCI_SRIOV_SUP_PGSIZE
 0x1ø

	)

959 
	#PCI_SRIOV_SYS_PGSIZE
 0x20

	)

960 
	#PCI_SRIOV_BAR
 0x24

	)

961 
	#PCI_SRIOV_NUM_BARS
 6

	)

962 
	#PCI_SRIOV_VFM
 0x3ø

	)

963 
	#PCI_SRIOV_VFM_BIR
(
x
è((xè& 7è

	)

964 
	#PCI_SRIOV_VFM_OFFSET
(
x
è((xè& ~7è

	)

965 
	#PCI_SRIOV_VFM_UA
 0x0

	)

966 
	#PCI_SRIOV_VFM_MI
 0x1

	)

967 
	#PCI_SRIOV_VFM_MO
 0x2

	)

968 
	#PCI_SRIOV_VFM_AV
 0x3

	)

969 
	#PCI_EXT_CAP_SRIOV_SIZEOF
 0x40

	)

971 
	#PCI_LTR_MAX_SNOOP_LAT
 0x4

	)

972 
	#PCI_LTR_MAX_NOSNOOP_LAT
 0x6

	)

973 
	#PCI_LTR_VALUE_MASK
 0x000003ff

	)

974 
	#PCI_LTR_SCALE_MASK
 0x00001c00

	)

975 
	#PCI_LTR_SCALE_SHIFT
 10

	)

976 
	#PCI_EXT_CAP_LTR_SIZEOF
 8

	)

979 
	#PCI_ACS_CAP
 0x04

	)

980 
	#PCI_ACS_SV
 0x0001

	)

981 
	#PCI_ACS_TB
 0x0002

	)

982 
	#PCI_ACS_RR
 0x0004

	)

983 
	#PCI_ACS_CR
 0x0008

	)

984 
	#PCI_ACS_UF
 0x0010

	)

985 
	#PCI_ACS_EC
 0x0020

	)

986 
	#PCI_ACS_DT
 0x0040

	)

987 
	#PCI_ACS_EGRESS_BITS
 0x05

	)

988 
	#PCI_ACS_CTRL
 0x06

	)

989 
	#PCI_ACS_EGRESS_CTL_V
 0x08

	)

991 
	#PCI_VSEC_HDR
 4

	)

992 
	#PCI_VSEC_HDR_LEN_SHIFT
 20

	)

995 
	#PCI_SATA_REGS
 4

	)

996 
	#PCI_SATA_REGS_MASK
 0xF

	)

997 
	#PCI_SATA_REGS_INLINE
 0xF

	)

998 
	#PCI_SATA_SIZEOF_SHORT
 8

	)

999 
	#PCI_SATA_SIZEOF_LONG
 16

	)

1002 
	#PCI_REBAR_CAP
 4

	)

1003 
	#PCI_REBAR_CAP_SIZES
 0x00FFFFF0

	)

1004 
	#PCI_REBAR_CTRL
 8

	)

1005 
	#PCI_REBAR_CTRL_BAR_IDX
 0x00000007

	)

1006 
	#PCI_REBAR_CTRL_NBAR_MASK
 0x000000E0

	)

1007 
	#PCI_REBAR_CTRL_NBAR_SHIFT
 5

	)

1008 
	#PCI_REBAR_CTRL_BAR_SIZE
 0x00001F00

	)

1009 
	#PCI_REBAR_CTRL_BAR_SHIFT
 8

	)

1012 
	#PCI_DPA_CAP
 4

	)

1013 
	#PCI_DPA_CAP_SUBSTATE_MASK
 0x1F

	)

1014 
	#PCI_DPA_BASE_SIZEOF
 16

	)

1017 
	#PCI_TPH_CAP
 4

	)

1018 
	#PCI_TPH_CAP_LOC_MASK
 0x600

	)

1019 
	#PCI_TPH_LOC_NONE
 0x000

	)

1020 
	#PCI_TPH_LOC_CAP
 0x200

	)

1021 
	#PCI_TPH_LOC_MSIX
 0x400

	)

1022 
	#PCI_TPH_CAP_ST_MASK
 0x07FF0000

	)

1023 
	#PCI_TPH_CAP_ST_SHIFT
 16

	)

1024 
	#PCI_TPH_BASE_SIZEOF
 0xø

	)

1027 
	#PCI_EXP_DPC_CAP
 0x04

	)

1028 
	#PCI_EXP_DPC_IRQ
 0x001F

	)

1029 
	#PCI_EXP_DPC_CAP_RP_EXT
 0x0020

	)

1030 
	#PCI_EXP_DPC_CAP_POISONED_TLP
 0x0040

	)

1031 
	#PCI_EXP_DPC_CAP_SW_TRIGGER
 0x0080

	)

1032 
	#PCI_EXP_DPC_RP_PIO_LOG_SIZE
 0x0F00

	)

1033 
	#PCI_EXP_DPC_CAP_DL_ACTIVE
 0x1000

	)

1035 
	#PCI_EXP_DPC_CTL
 0x06

	)

1036 
	#PCI_EXP_DPC_CTL_EN_FATAL
 0x0001

	)

1037 
	#PCI_EXP_DPC_CTL_EN_NONFATAL
 0x0002

	)

1038 
	#PCI_EXP_DPC_CTL_INT_EN
 0x0008

	)

1040 
	#PCI_EXP_DPC_STATUS
 0x08

	)

1041 
	#PCI_EXP_DPC_STATUS_TRIGGER
 0x0001

	)

1042 
	#PCI_EXP_DPC_STATUS_TRIGGER_RSN
 0x0006

	)

1043 
	#PCI_EXP_DPC_STATUS_INTERRUPT
 0x0008

	)

1044 
	#PCI_EXP_DPC_RP_BUSY
 0x0010

	)

1045 
	#PCI_EXP_DPC_STATUS_TRIGGER_RSN_EXT
 0x0060

	)

1046 
	#PCI_EXP_DPC_RP_PIO_FEP
 0x1f00

	)

1048 
	#PCI_EXP_DPC_SOURCE_ID
 0x0A

	)

1050 
	#PCI_EXP_DPC_RP_PIO_STATUS
 0x0C

	)

1051 
	#PCI_EXP_DPC_RP_PIO_MASK
 0x10

	)

1052 
	#PCI_EXP_DPC_RP_PIO_SEVERITY
 0x14

	)

1053 
	#PCI_EXP_DPC_RP_PIO_SYSERROR
 0x18

	)

1054 
	#PCI_EXP_DPC_RP_PIO_EXCEPTION
 0x1C

	)

1055 
	#PCI_EXP_DPC_RP_PIO_HEADER_LOG
 0x20

	)

1056 
	#PCI_EXP_DPC_RP_PIO_IMPSPEC_LOG
 0x30

	)

1057 
	#PCI_EXP_DPC_RP_PIO_TLPPREFIX_LOG
 0x34

	)

1060 
	#PCI_PTM_CAP
 0x04

	)

1061 
	#PCI_PTM_CAP_REQ
 0x00000001

	)

1062 
	#PCI_PTM_CAP_ROOT
 0x00000004

	)

1063 
	#PCI_PTM_GRANULARITY_MASK
 0x0000FF00

	)

1064 
	#PCI_PTM_CTRL
 0x08

	)

1065 
	#PCI_PTM_CTRL_ENABLE
 0x00000001

	)

1066 
	#PCI_PTM_CTRL_ROOT
 0x00000002

	)

1069 
	#PCI_L1SS_CAP
 0x04

	)

1070 
	#PCI_L1SS_CAP_PCIPM_L1_2
 0x00000001

	)

1071 
	#PCI_L1SS_CAP_PCIPM_L1_1
 0x00000002

	)

1072 
	#PCI_L1SS_CAP_ASPM_L1_2
 0x00000004

	)

1073 
	#PCI_L1SS_CAP_ASPM_L1_1
 0x00000008

	)

1074 
	#PCI_L1SS_CAP_L1_PM_SS
 0x00000010

	)

1075 
	#PCI_L1SS_CAP_CM_RESTORE_TIME
 0x0000ff00

	)

1076 
	#PCI_L1SS_CAP_P_PWR_ON_SCALE
 0x00030000

	)

1077 
	#PCI_L1SS_CAP_P_PWR_ON_VALUE
 0x00f80000

	)

1078 
	#PCI_L1SS_CTL1
 0x08

	)

1079 
	#PCI_L1SS_CTL1_PCIPM_L1_2
 0x00000001

	)

1080 
	#PCI_L1SS_CTL1_PCIPM_L1_1
 0x00000002

	)

1081 
	#PCI_L1SS_CTL1_ASPM_L1_2
 0x00000004

	)

1082 
	#PCI_L1SS_CTL1_ASPM_L1_1
 0x00000008

	)

1083 
	#PCI_L1SS_CTL1_L1_2_MASK
 0x00000005

	)

1084 
	#PCI_L1SS_CTL1_L1SS_MASK
 0x0000000f

	)

1085 
	#PCI_L1SS_CTL1_CM_RESTORE_TIME
 0x0000ff00

	)

1086 
	#PCI_L1SS_CTL1_LTR_L12_TH_VALUE
 0x03ff0000

	)

1087 
	#PCI_L1SS_CTL1_LTR_L12_TH_SCALE
 0xe0000000

	)

1088 
	#PCI_L1SS_CTL2
 0x0ø

	)

1091 
	#PCI_DVSEC_HEADER1
 0x4

	)

1092 
	#PCI_DVSEC_HEADER1_VID
(
x
è((xè& 0xffff)

	)

1093 
	#PCI_DVSEC_HEADER1_REV
(
x
è(((xè>> 16è& 0xf)

	)

1094 
	#PCI_DVSEC_HEADER1_LEN
(
x
è(((xè>> 20è& 0xfff)

	)

1095 
	#PCI_DVSEC_HEADER2
 0x8

	)

1096 
	#PCI_DVSEC_HEADER2_ID
(
x
è((xè& 0xffff)

	)

1099 
	#PCI_DLF_CAP
 0x04

	)

1100 
	#PCI_DLF_EXCHANGE_ENABLE
 0x80000000

	)

1103 
	#PCI_PL_16GT_LE_CTRL
 0x20

	)

1104 
	#PCI_PL_16GT_LE_CTRL_DSP_TX_PRESET_MASK
 0x0000000F

	)

1105 
	#PCI_PL_16GT_LE_CTRL_USP_TX_PRESET_MASK
 0x000000F0

	)

1106 
	#PCI_PL_16GT_LE_CTRL_USP_TX_PRESET_SHIFT
 4

	)

1109 
	#PCI_DOE_CAP
 0x04

	)

1110 
	#PCI_DOE_CAP_INT_SUP
 0x00000001

	)

1111 
	#PCI_DOE_CAP_INT_MSG_NUM
 0x00000fã

	)

1112 
	#PCI_DOE_CTRL
 0x08

	)

1113 
	#PCI_DOE_CTRL_ABORT
 0x00000001

	)

1114 
	#PCI_DOE_CTRL_INT_EN
 0x00000002

	)

1115 
	#PCI_DOE_CTRL_GO
 0x80000000

	)

1116 
	#PCI_DOE_STATUS
 0x0ø

	)

1117 
	#PCI_DOE_STATUS_BUSY
 0x00000001

	)

1118 
	#PCI_DOE_STATUS_INT_STATUS
 0x00000002

	)

1119 
	#PCI_DOE_STATUS_ERROR
 0x00000004

	)

1120 
	#PCI_DOE_STATUS_DATA_OBJECT_READY
 0x80000000

	)

1121 
	#PCI_DOE_WRITE
 0x10

	)

1122 
	#PCI_DOE_READ
 0x14

	)

1125 
	#PCI_DOE_DATA_OBJECT_HEADER_1_VID
 0x0000ffff

	)

1126 
	#PCI_DOE_DATA_OBJECT_HEADER_1_TYPE
 0x00ff0000

	)

1127 
	#PCI_DOE_DATA_OBJECT_HEADER_2_LENGTH
 0x0003ffff

	)

1129 
	#PCI_DOE_DATA_OBJECT_DISC_REQ_3_INDEX
 0x000000ff

	)

1130 
	#PCI_DOE_DATA_OBJECT_DISC_RSP_3_VID
 0x0000ffff

	)

1131 
	#PCI_DOE_DATA_OBJECT_DISC_RSP_3_PROTOCOL
 0x00ff0000

	)

1132 
	#PCI_DOE_DATA_OBJECT_DISC_RSP_3_NEXT_INDEX
 0xff000000

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/sysinfo.h

2 #iâdeà
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<lšux/ty³s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysšfo
 {

9 
__k”Ãl_lÚg_t
 
	mu±ime
;

10 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

11 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

12 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

13 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

14 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

15 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

16 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

17 
__u16
 
	m´ocs
;

18 
__u16
 
	m·d
;

19 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

20 
__k”Ãl_ulÚg_t
 
	mä“high
;

21 
__u32
 
	mmem_un™
;

22 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ýlu¥lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_þªg_´”eq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$memýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

44 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

47 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

48 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memcýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 1, 4));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

64 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

80 
	$__memcm³q
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

81 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

84 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


87 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

88 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

89 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

90 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

92 #ifdeà
__OPTIMIZE__


93 
__ex‹º_®ways_šlše
 *

94 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


96  
	`__bužtš_memchr
 (
__s
, 
__c
, 
__n
);

99 
__ex‹º_®ways_šlše
 const *

100 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


102  
	`__bužtš_memchr
 (
__s
, 
__c
, 
__n
);

105 
	}
}

107 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

108 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__USE_GNU


114 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


115 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

116 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

118 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

120 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

125 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


126 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

127 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1))

128 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 3));

129 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

130 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1))

131 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 3));

133 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

134 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1))

135 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 3));

141 *
	$¡rýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

142 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

144 *
	$¡ºýy
 (*
__»¡riù
 
__de¡
,

145 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

146 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

149 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

150 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

153 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

156 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

157 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

159 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

160 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

163 
	$¡rcÞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

164 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

166 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

167 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

168 
__THROW
 
	`__nÚnuÎ
 ((2)è
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 1, 3));

170 #ifdeà
__USE_XOPEN2K8


172 
	~<b™s/ty³s/loÿË_t.h
>

175 
	$¡rcÞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

176 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

179 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

180 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4))

181 
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 1, 3));

184 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

185 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| 
	$__GLIBC_USE
 (
ISOC2X
))

187 *
	$¡rdup
 (cÚ¡ *
__s
)

188 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

194 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| __GLIBC_USE (
ISOC2X
)

195 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

196 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

199 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


201 
	#¡rdu·
(
s
) \

202 (
__ex‹nsiÚ__
 \

204 cÚ¡ *
__Þd
 = (
s
); \

205 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Þd
) + 1; \

206 *
__Ãw
 = (*è
	`__bužtš_®loÿ
 (
__Ën
); \

207 (*è
	`memýy
 (
__Ãw
, 
__Þd
, 
__Ën
); \

208 
	}
}))

	)

211 
	#¡ºdu·
(
s
, 
n
) \

212 (
__ex‹nsiÚ__
 \

214 cÚ¡ *
__Þd
 = (
s
); \

215 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Þd
, (
n
)); \

216 *
__Ãw
 = (*è
	`__bužtš_®loÿ
 (
__Ën
 + 1); \

217 
__Ãw
[
__Ën
] = '\0'; \

218 (*è
	`memýy
 (
__Ãw
, 
__Þd
, 
__Ën
); \

219 }))

	)

223 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


226 *
¡rchr
 (*
__s
, 
__c
)

227 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

228 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

229 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

231 #ifdeà
__OPTIMIZE__


232 
__ex‹º_®ways_šlše
 *

233 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


235  
__bužtš_¡rchr
 (
__s
, 
__c
);

238 
__ex‹º_®ways_šlše
 const *

239 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


241  
__bužtš_¡rchr
 (
__s
, 
__c
);

246 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

247 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

250 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


253 *
	`¡¼chr
 (*
__s
, 
__c
)

254 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

255 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

256 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

258 #ifdeà
__OPTIMIZE__


259 
__ex‹º_®ways_šlše
 *

260 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


262  
	`__bužtš_¡¼chr
 (
__s
, 
__c
);

265 
__ex‹º_®ways_šlše
 const *

266 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


268  
	`__bužtš_¡¼chr
 (
__s
, 
__c
);

271 
	}
}

273 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

274 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 #ifdeà
__USE_GNU


280 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


281 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

282 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

283 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

284 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

286 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

287 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

293 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

294 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

297 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

298 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

300 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


303 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

304 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

305 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

306 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

308 #ifdeà
__OPTIMIZE__


309 
__ex‹º_®ways_šlše
 *

310 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


312  
	`__bužtš_¡½brk
 (
__s
, 
__acû±
);

315 
__ex‹º_®ways_šlše
 const *

316 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


318  
	`__bužtš_¡½brk
 (
__s
, 
__acû±
);

321 
	}
}

323 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

324 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


330 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

331 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

332 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

333 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 #ifdeà
__OPTIMIZE__


336 
__ex‹º_®ways_šlše
 *

337 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


339  
	`__bužtš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

342 
__ex‹º_®ways_šlše
 const *

343 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


345  
	`__bužtš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

348 
	}
}

350 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

351 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

356 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

357 
__THROW
 
	`__nÚnuÎ
 ((2));

361 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

362 cÚ¡ *
__»¡riù
 
__d–im
,

363 **
__»¡riù
 
__§ve_±r
)

364 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

365 #ifdeà
__USE_POSIX


366 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

367 **
__»¡riù
 
__§ve_±r
)

368 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

371 #ifdeà
__USE_GNU


373 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


374 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

375 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

376 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

377 cÚ¡ *
__ÃedË
)

378 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

380 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

381 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

385 #ifdeà
__USE_GNU


389 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

390 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

391 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3))

392 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 2))

393 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 3, 4));

397 *
	$__mempýy
 (*
__»¡riù
 
__de¡
,

398 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

399 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

400 *
	$mempýy
 (*
__»¡riù
 
__de¡
,

401 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

402 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

407 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

408 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

410 #ifdef 
__USE_XOPEN2K8


413 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

414 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

419 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

420 #ifdeà
__USE_XOPEN2K


428 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


431 #ifdeà
__REDIRECT_NTH


432 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

433 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

434 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2))

435 
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 2, 3));

437 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

438 
__THROW
 
	`__nÚnuÎ
 ((2)è
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 2, 3));

439 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

444 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

445 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
 
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 2, 3));

448 #ifdeà
__USE_GNU


450 cÚ¡ *
	$¡»¼Üdesc_Å
 (
__”r
è
__THROW
;

452 cÚ¡ *
	$¡»¼ÜÇme_Å
 (
__”r
è
__THROW
;

456 #ifdeà
__USE_XOPEN2K8


458 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

461 #ifdeà
__USE_MISC


462 
	~<¡ršgs.h
>

466 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1))

467 
	`__fÜtif›d_©Œ_acûss
 (
__wr™e_Úly__
, 1, 2);

471 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

472 cÚ¡ *
__»¡riù
 
__d–im
)

473 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

476 #ifdef 
__USE_XOPEN2K8


478 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

480 #ifdeà
__USE_GNU


482 cÚ¡ *
	$sigabb»v_Å
 (
__sig
è
__THROW
;

485 cÚ¡ *
	$sigdesü_Å
 (
__sig
è
__THROW
;

489 *
	$__¡pýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

490 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

491 *
	$¡pýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

492 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

496 *
	$__¡²ýy
 (*
__»¡riù
 
__de¡
,

497 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

498 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

499 *
	$¡²ýy
 (*
__»¡riù
 
__de¡
,

500 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

501 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

504 #ifdef 
__USE_GNU


506 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

507 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

510 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

513 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1))

514 
	`__©Œ_acûss
 ((
__»ad_wr™e__
, 1, 2));

516 #iâdeà
ba£Çme


521 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


522 "C++" *
	$ba£Çme
 (*
__fž’ame
)

523 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

524 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__fž’ame
)

525 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

527 *
	$ba£Çme
 (cÚ¡ *
__fž’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

532 #ià
	`__GNUC_PREREQ
 (3,4)

533 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


535 
	~<b™s/¡ršg_fÜtif›d.h
>

539 
__END_DECLS


	@/usr/include/linux/stddef.h

2 #iâdeà
_LINUX_STDDEF_H


3 
	#_LINUX_STDDEF_H


	)

7 #iâdeà
__®ways_šlše


8 
	#__®ways_šlše
 
__šlše__


	)

12 #iâdeà
__ýlu¥lus


13 
	#__¡ruù_group_g
(
TAG
è
	)
TAG

15 
	#__¡ruù_group_g
(
TAG
)

	)

33 
	#__¡ruù_group
(
TAG
, 
NAME
, 
ATTRS
, 
MEMBERS
...) \

35 ¡ruù { 
MEMBERS
 } 
ATTRS
; \

36 
	`__¡ruù_group_g
(
TAG
è{ 
MEMBERS
 } 
ATTRS
 
NAME
; \

37 } 
ATTRS


	)

49 
	#__DECLARE_FLEX_ARRAY
(
TYPE
, 
NAME
) \

51 ¡ruù { } 
__em±y_
 ## 
NAME
; \

52 
TYPE
 
NAME
[]; \

53 }

	)

	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ýlu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcÝy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__bužtš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__bužtš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__bužtš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__bužtš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

126 #undeà
__USE_ISOC11


127 #undeà
__USE_ISOC99


128 #undeà
__USE_ISOC95


129 #undeà
__USE_ISOCXX11


130 #undeà
__USE_POSIX


131 #undeà
__USE_POSIX2


132 #undeà
__USE_POSIX199309


133 #undeà
__USE_POSIX199506


134 #undeà
__USE_XOPEN


135 #undeà
__USE_XOPEN_EXTENDED


136 #undeà
__USE_UNIX98


137 #undeà
__USE_XOPEN2K


138 #undeà
__USE_XOPEN2KXSI


139 #undeà
__USE_XOPEN2K8


140 #undeà
__USE_XOPEN2K8XSI


141 #undeà
__USE_LARGEFILE


142 #undeà
__USE_LARGEFILE64


143 #undeà
__USE_FILE_OFFSET64


144 #undeà
__USE_MISC


145 #undeà
__USE_ATFILE


146 #undeà
__USE_DYNAMIC_STACK_SIZE


147 #undeà
__USE_GNU


148 #undeà
__USE_FORTIFY_LEVEL


149 #undeà
__KERNEL_STRICT_NAMES


150 #undeà
__GLIBC_USE_ISOC2X


151 #undeà
__GLIBC_USE_DEPRECATED_GETS


152 #undeà
__GLIBC_USE_DEPRECATED_SCANF


156 #iâdeà
_LOOSE_KERNEL_NAMES


157 
	#__KERNEL_STRICT_NAMES


	)

167 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


168 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

169 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ð((
maj
è<< 16è+ (
mš
))

	)

171 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

178 #ià
defšed
 
__þªg_majÜ__
 && defšed 
__þªg_mšÜ__


179 
	#__glibc_þªg_´”eq
(
maj
, 
mš
) \

180 ((
__þªg_majÜ__
 << 16è+ 
__þªg_mšÜ__
 >ð((
maj
è<< 16è+ (
mš
))

	)

182 
	#__glibc_þªg_´”eq
(
maj
, 
mš
è0

	)

186 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

192 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

193 && !
defšed
 
	g_DEFAULT_SOURCE


195 #undeà
_DEFAULT_SOURCE


196 
	#_DEFAULT_SOURCE
 1

	)

200 #ifdeà
_GNU_SOURCE


201 #undeà
_ISOC95_SOURCE


202 
	#_ISOC95_SOURCE
 1

	)

203 #undeà
_ISOC99_SOURCE


204 
	#_ISOC99_SOURCE
 1

	)

205 #undeà
_ISOC11_SOURCE


206 
	#_ISOC11_SOURCE
 1

	)

207 #undeà
_ISOC2X_SOURCE


208 
	#_ISOC2X_SOURCE
 1

	)

209 #undeà
_POSIX_SOURCE


210 
	#_POSIX_SOURCE
 1

	)

211 #undeà
_POSIX_C_SOURCE


212 
	#_POSIX_C_SOURCE
 200809L

	)

213 #undeà
_XOPEN_SOURCE


214 
	#_XOPEN_SOURCE
 700

	)

215 #undeà
_XOPEN_SOURCE_EXTENDED


216 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

217 #undeà
_LARGEFILE64_SOURCE


218 
	#_LARGEFILE64_SOURCE
 1

	)

219 #undeà
_DEFAULT_SOURCE


220 
	#_DEFAULT_SOURCE
 1

	)

221 #undeà
_ATFILE_SOURCE


222 
	#_ATFILE_SOURCE
 1

	)

223 #undeà
_DYNAMIC_STACK_SIZE_SOURCE


224 
	#_DYNAMIC_STACK_SIZE_SOURCE
 1

	)

229 #ià(
defšed
 
_DEFAULT_SOURCE
 \

230 || (!
defšed
 
	g__STRICT_ANSI__
 \

231 && !
defšed
 
	g_ISOC99_SOURCE
 && !defšed 
	g_ISOC11_SOURCE
 \

232 && !
defšed
 
	g_ISOC2X_SOURCE
 \

233 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

234 && !
defšed
 
	g_XOPEN_SOURCE
))

235 #undeà
_DEFAULT_SOURCE


236 
	#_DEFAULT_SOURCE
 1

	)

240 #ià(
defšed
 
_ISOC2X_SOURCE
 \

241 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

242 
	#__GLIBC_USE_ISOC2X
 1

	)

244 
	#__GLIBC_USE_ISOC2X
 0

	)

248 #ià(
defšed
 
_ISOC11_SOURCE
 || defšed 
_ISOC2X_SOURCE
 \

249 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

250 
	#__USE_ISOC11
 1

	)

254 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

255 || 
defšed
 
_ISOC2X_SOURCE
 \

256 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

257 
	#__USE_ISOC99
 1

	)

261 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

262 || 
defšed
 
_ISOC2X_SOURCE
 \

263 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

264 
	#__USE_ISOC95
 1

	)

267 #ifdeà
__ýlu¥lus


269 #ià
__ýlu¥lus
 >= 201703L

270 
	#__USE_ISOC11
 1

	)

274 #ià
__ýlu¥lus
 >ð201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


275 
	#__USE_ISOCXX11
 1

	)

276 
	#__USE_ISOC99
 1

	)

283 #ifdeà
_DEFAULT_SOURCE


284 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


285 
	#__USE_POSIX_IMPLICITLY
 1

	)

287 #undeà
_POSIX_SOURCE


288 
	#_POSIX_SOURCE
 1

	)

289 #undeà
_POSIX_C_SOURCE


290 
	#_POSIX_C_SOURCE
 200809L

	)

293 #ià((!
defšed
 
__STRICT_ANSI__
 \

294 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

295 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

296 
	#_POSIX_SOURCE
 1

	)

297 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

298 
	#_POSIX_C_SOURCE
 2

	)

299 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

300 
	#_POSIX_C_SOURCE
 199506L

	)

301 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

302 
	#_POSIX_C_SOURCE
 200112L

	)

304 
	#_POSIX_C_SOURCE
 200809L

	)

306 
	#__USE_POSIX_IMPLICITLY
 1

	)

315 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

316 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

317 
	#_POSIX_SOURCE
 1

	)

318 #undeà
_POSIX_C_SOURCE


319 
	#_POSIX_C_SOURCE
 199506L

	)

322 #ià(
defšed
 
_POSIX_SOURCE
 \

323 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

324 || 
defšed
 
_XOPEN_SOURCE
)

325 
	#__USE_POSIX
 1

	)

328 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ð2 || defšed 
_XOPEN_SOURCE


329 
	#__USE_POSIX2
 1

	)

332 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

333 
	#__USE_POSIX199309
 1

	)

336 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

337 
	#__USE_POSIX199506
 1

	)

340 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

341 
	#__USE_XOPEN2K
 1

	)

342 #undeà
__USE_ISOC95


343 
	#__USE_ISOC95
 1

	)

344 #undeà
__USE_ISOC99


345 
	#__USE_ISOC99
 1

	)

348 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

349 
	#__USE_XOPEN2K8
 1

	)

350 #undeà
_ATFILE_SOURCE


351 
	#_ATFILE_SOURCE
 1

	)

354 #ifdef 
_XOPEN_SOURCE


355 
	#__USE_XOPEN
 1

	)

356 #ià(
_XOPEN_SOURCE
 - 0) >= 500

357 
	#__USE_XOPEN_EXTENDED
 1

	)

358 
	#__USE_UNIX98
 1

	)

359 #undeà
_LARGEFILE_SOURCE


360 
	#_LARGEFILE_SOURCE
 1

	)

361 #ià(
_XOPEN_SOURCE
 - 0) >= 600

362 #ià(
_XOPEN_SOURCE
 - 0) >= 700

363 
	#__USE_XOPEN2K8
 1

	)

364 
	#__USE_XOPEN2K8XSI
 1

	)

366 
	#__USE_XOPEN2K
 1

	)

367 
	#__USE_XOPEN2KXSI
 1

	)

368 #undeà
__USE_ISOC95


369 
	#__USE_ISOC95
 1

	)

370 #undeà
__USE_ISOC99


371 
	#__USE_ISOC99
 1

	)

374 #ifdeà
_XOPEN_SOURCE_EXTENDED


375 
	#__USE_XOPEN_EXTENDED
 1

	)

380 #ifdeà
_LARGEFILE_SOURCE


381 
	#__USE_LARGEFILE
 1

	)

384 #ifdeà
_LARGEFILE64_SOURCE


385 
	#__USE_LARGEFILE64
 1

	)

388 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

389 
	#__USE_FILE_OFFSET64
 1

	)

392 
	~<ã©u»s-time64.h
>

394 #ià
defšed
 
_DEFAULT_SOURCE


395 
	#__USE_MISC
 1

	)

398 #ifdef 
_ATFILE_SOURCE


399 
	#__USE_ATFILE
 1

	)

402 #ifdef 
_DYNAMIC_STACK_SIZE_SOURCE


403 
	#__USE_DYNAMIC_STACK_SIZE
 1

	)

406 #ifdef 
_GNU_SOURCE


407 
	#__USE_GNU
 1

	)

410 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

411 && 
defšed
 
__OPTIMIZE__
 && __OPTIMIZE__ > 0

412 #ià!
__GNUC_PREREQ
 (4, 1)

413 #w¬nšg 
_FORTIFY_SOURCE
 
»quœes
 
GCC
 4.1 
Ü
 
Ï‹r


414 #–ià
_FORTIFY_SOURCE
 > 2 && (
__glibc_þªg_´”eq
 (9, 0) \

415 || 
	$__GNUC_PREREQ
 (12, 0))

417 #ià
_FORTIFY_SOURCE
 > 3

418 #w¬nšg 
_FORTIFY_SOURCE
 > 3 
is
 
Œ—‹d
 
like
 3 
Ú
 
this
 
¶©fÜm


420 
	#__USE_FORTIFY_LEVEL
 3

	)

421 #–ià
_FORTIFY_SOURCE
 > 1

422 #ià
_FORTIFY_SOURCE
 > 2

423 #w¬nšg 
_FORTIFY_SOURCE
 > 2 
is
 
Œ—‹d
 
like
 2 
Ú
 
this
 
¶©fÜm


425 
	#__USE_FORTIFY_LEVEL
 2

	)

427 
	#__USE_FORTIFY_LEVEL
 1

	)

430 #iâdeà
__USE_FORTIFY_LEVEL


431 
	#__USE_FORTIFY_LEVEL
 0

	)

438 #ià
defšed
 
__ýlu¥lus
 ? __ýlu¥lu >ð201402L : defšed 
__USE_ISOC11


439 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

441 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

456 #ià(
defšed
 
__USE_GNU
 \

457 && (
defšed
 
__ýlu¥lus
 \

458 ? (
__ýlu¥lus
 < 201103L && !
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
) \

459 : (!
defšed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

460 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

462 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

467 
	~<¡dc-´edef.h
>

475 #undeà
__GNU_LIBRARY__


476 
	#__GNU_LIBRARY__
 6

	)

480 
	#__GLIBC__
 2

	)

481 
	#__GLIBC_MINOR__
 36

	)

483 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

484 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ð((
maj
è<< 16è+ (
mš
))

	)

487 #iâdeà
__ASSEMBLER__


488 #iâdeà
_SYS_CDEFS_H


489 
	~<sys/cdefs.h
>

494 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


495 
	#__USE_LARGEFILE
 1

	)

496 
	#__USE_LARGEFILE64
 1

	)

502 #ià
	`__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

503 && !
defšed
 
__OPTIMIZE_SIZE__
 && !defšed 
__NO_INLINE__
 \

504 && 
defšed
 
__ex‹º_šlše


505 
	#__USE_EXTERN_INLINES
 1

	)

513 
	~<gnu/¡ubs.h
>

	@/usr/include/features-time64.h

20 
	~<b™s/wÜdsize.h
>

21 
	~<b™s/timesize.h
>

23 #ià
defšed
 
_TIME_BITS


24 #ià
_TIME_BITS
 == 64

25 #ià! 
defšed
 (
_FILE_OFFSET_BITS
) || _FILE_OFFSET_BITS != 64

27 #–ià
__TIMESIZE
 == 32

28 
	#__USE_TIME_BITS64
 1

	)

30 #–ià
_TIME_BITS
 == 32

31 #ià
__TIMESIZE
 > 32

35 #”rÜ 
Inv®id
 
_TIME_BITS
 
v®ue
 (
ÿn
 
Úly
 
be
 32 
Ü
 64-
b™
)

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

39 
	#__STDC_IEC_60559_BFP__
 201404L

	)

42 
	#__STDC_IEC_559__
 1

	)

43 
	#__STDC_IEC_60559_BFP__
 201404L

	)

46 #ifdeà
__GCC_IEC_559_COMPLEX


47 #ià
__GCC_IEC_559_COMPLEX
 > 0

48 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

52 
	#__STDC_IEC_559_COMPLEX__
 1

	)

53 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

62 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
69
1242
admin.c
append_only.c
append_only.h
bitmap.c
bitmap.h
channel_model.c
channel_model.h
check_phfrag.c
check_phfrag.h
conv_ftl.c
conv_ftl.h
dma.c
dma.h
io.c
kv_ftl.c
kv_ftl.h
main.c
nvme.h
nvme_kv.h
nvme_zns.h
nvmev.h
nvmev.mod.c
pci.c
pci.h
pqueue/pqueue.c
pqueue/pqueue.h
pqueue/pqueue_linked.c
pqueue/pqueue_linked.h
save_load.c
save_load.h
simple_ftl.c
simple_ftl.h
ssd.c
ssd.h
ssd_config.c
ssd_config.h
zns_ftl.c
zns_ftl.h
zns_mgmt_recv.c
zns_mgmt_send.c
zns_read_write.c
zns_read_write.h
/usr/include/linux/fs.h
/usr/include/linux/kernel.h
/usr/include/linux/limits.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/pci.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/types.h
/usr/include/linux/version.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/const.h
/usr/include/linux/fscrypt.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/pci_regs.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/features-time64.h
/usr/include/stdc-predef.h
